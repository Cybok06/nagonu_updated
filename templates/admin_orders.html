<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Orders (Mobile‑first)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#2563eb;--primary-2:#1d4ed8;--primary-3:#3b82f6;
      --bg:#f8fafc;--bg-2:#f1f5f9;--card:#ffffff;--border:#e2e8f0;
      --text:#0b1b2b;--muted:#64748b;
      --ok:#16a34a;--ok-soft:#ecfdf5;          /* delivered */
      --warn:#f59e0b;--warn-soft:#fffbeb;      /* pending  */
      --info:#0ea5e9;--info-soft:#e6f6fe;      /* processing */
      --bad:#ef4444;--bad-soft:#fef2f2;        /* failed */
      --violet:#6366f1;--violet-soft:#eef2ff;  /* refunded */
      --teal:#14b8a6;--teal-soft:#e6fffb;      /* completed */
      --shadow-sm:0 2px 6px rgba(2,10,28,.06);
      --shadow-md:0 8px 18px rgba(2,10,28,.08);
      --shadow-lg:0 16px 32px rgba(2,10,28,.12);
      --radius:16px;
    }

    body{background:linear-gradient(135deg,var(--bg) 0%,var(--bg-2) 100%);color:var(--text);font-family:Inter,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:1400px}
    h2{color:var(--primary);font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)}

    /* --- FILTERS: Mobile toolbar + desktop bar --- */
    .mobile-toolbar{position:sticky;top:0;z-index:1000;background:linear-gradient(180deg,#ffffff 0%,rgba(255,255,255,.9) 100%);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .mobile-toolbar .search{display:flex;gap:.5rem;padding:.75rem}
    .mobile-toolbar input[type="search"]{flex:1;border:2px solid var(--border);border-radius:10px;padding:.6rem .8rem}
    .pill-row{display:flex;gap:.5rem;overflow:auto hidden;padding:.5rem .75rem}
    .pill{white-space:nowrap;border:1px solid var(--border);padding:.35rem .65rem;border-radius:999px;background:#fff;box-shadow:var(--shadow-sm);font-size:.85rem}
    .pill.active{border-color:var(--primary);color:var(--primary);background:rgba(37,99,235,.08)}

    .filter-bar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-md);padding:1rem 1.25rem;position:sticky;top:.5rem;z-index:10}
    .filter-row{row-gap:.75rem}
    .form-select,.form-control{border:2px solid var(--border);border-radius:10px;padding:.55rem .8rem}
    .form-select:focus,.form-control:focus{border-color:var(--primary);box-shadow:0 0 0 .2rem rgba(37,99,235,.25)}

    /* --- TABLE (md+) --- */
    .table-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-md);overflow:hidden}
    table.table{margin:0}
    thead th{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-2) 100%);color:#fff;border:none;text-transform:uppercase;font-size:.8rem;letter-spacing:.6px}
    tbody tr:hover{background:#f0f7ff}
    td,th{vertical-align:middle}

    /* --- Status chips --- */
    .status-chip{display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .65rem;border-radius:999px;font-size:.75rem;font-weight:700;border:1px solid transparent}
    .st-delivered{color:var(--ok);background:var(--ok-soft);border-color:#a7f3d0}
    .st-failed{color:var(--bad);background:var(--bad-soft);border-color:#fecaca}
    .st-processing{color:var(--info);background:var(--info-soft);border-color:#bae6fd}
    .st-refunded{color:var(--violet);background:var(--violet-soft);border-color:#c7d2fe}
    .st-pending{color:var(--warn);background:var(--warn-soft);border-color:#fde68a}
    .st-completed{color:var(--teal);background:var(--teal-soft);border-color:#99f6e4}

    /* --- Paid-from badges --- */
    .pf-badge{border-radius:999px;padding:.35rem .6rem;font-weight:700;font-size:.75rem;border:1px solid var(--border)}
    .pf-wallet{background:#ecfeff;color:#155e75;border-color:#a5f3fc}
    .pf-card{background:#f0f9ff;color:#1e3a8a;border-color:#bfdbfe}
    .pf-momo{background:#fefce8;color:#713f12;border-color:#fde68a}
    .pf-paystack{background:#eef2ff;color:#1e1b4b;border-color:#c7d2fe}
    .pf-flutterwave{background:#fff7ed;color:#7c2d12;border-color:#fed7aa}
    .pf-bank{background:#f5f3ff;color:#4c1d95;border-color:#ddd6fe}

    /* --- CARD LIST (xs-sm) --- */
    .cards{display:grid;gap:.9rem}
    .order-card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow-md);padding:.9rem}
    .order-card .header{display:flex;gap:.5rem;align-items:flex-start;justify-content:space-between}
    .order-card .badge-id{font-weight:800}
    .meta{color:var(--muted);font-size:.85rem}
    .items{margin:.4rem 0 0}
    .it{display:flex;justify-content:space-between;border-top:1px dashed var(--border);padding-top:.5rem;margin-top:.5rem;gap:.5rem}
    .it .amt{font-weight:700}
    .touch-btn{padding:.5rem .75rem;border-radius:999px}

    /* show table only on md+ */
    @media (max-width: 767.98px){ .table-wrap{display:none} }
    @media (min-width: 768px){ .cards, .mobile-toolbar, .mobile-fab, .bottombar{display:none} }

    /* --- Floating action button (mobile) --- */
    .mobile-fab{position:fixed;right:16px;bottom:88px;z-index:1020}
    .mobile-fab .btn{box-shadow:var(--shadow-lg);border-radius:999px}

    /* --- Bottom selection/action bar (mobile) --- */
    .bottombar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);box-shadow:0 -8px 24px rgba(2,10,28,.06);padding:.6rem .9rem;z-index:1020}
    .bottombar .count{font-weight:800}
    .bottombar .btn{border-radius:999px}

    /* accessibility */
    .row-check{transform:scale(1.25)}
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' %}

  <div class="mobile-toolbar">
    <div class="search">
      <form class="d-flex w-100" method="get" action="{{ url_for('admin_orders.admin_view_orders') }}">
        <input type="search" name="order_id" value="{{ order_id_q or '' }}" class="form-control" placeholder="Search order id, name, phone…"/>
        <button class="btn btn-primary ms-2"><i class="fa-solid fa-magnifying-glass"></i></button>
      </form>
    </div>
    <div class="pill-row">
      {# Quick status pills keep current query but override status #}
      {% for s in ['', 'processing','delivered','failed','refunded','pending','completed'] %}
        {% set label = (s or 'All')|capitalize %}
        {% set is_active = (s==status_filter) or (s=='' and not status_filter) %}
        <a class="pill {{ 'active' if is_active }}" href="{{ url_for('admin_orders.admin_view_orders', **request.args.to_dict()|dict(exclude=['status'])) }}{% if '?' in request.full_path %}&{% else %}?{% endif %}status={{ s }}">{{ label }}</a>
      {% endfor %}
    </div>
  </div>

  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex flex-wrap justify-content-between align-items-start mb-2">
      <div class="mb-2">
        <h2 class="mb-1"><i class="fas fa-box me-2"></i>Customer Orders</h2>
        <div class="muted">Total: {{ total_orders or 0 }}{% if status_filter %} • Status: {{ status_filter|capitalize }}{% endif %}</div>
      </div>
      <div class="d-none d-md-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#jobsOffcanvas"><i class="fa-solid fa-clock-rotate-left me-1"></i>Scheduled</button>
        <form method="POST" action="{{ url_for('admin_orders.bulk_deliver_orders') }}{% if filters_query %}?{{ filters_query }}{% endif %}">
          <button class="btn btn-success" data-confirm="Mark ALL processing orders in the current filters as DELIVERED?"><i class="fa-solid fa-truck-fast me-1"></i>Mark All Processing → Delivered</button>
        </form>
        <button class="btn btn-dark" id="openScheduleSelected" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-calendar-plus me-1"></i>Schedule (Selected)</button>
      </div>
    </div>

    <!-- Desktop filters -->
    <form method="get" class="filter-bar mb-3 d-none d-md-block">
      <div class="row filter-row">
        <div class="col-12 col-md-3">
          <label class="form-label"><i class="fa-solid fa-hashtag me-1"></i>Order ID</label>
          <input type="text" name="order_id" value="{{ order_id_q or '' }}" class="form-control" placeholder="Paste or type order id">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><i class="fa-solid fa-user me-1"></i>Customer</label>
          <input type="text" name="customer" value="{{ customer_q or '' }}" class="form-control" placeholder="Name / email / phone / username">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-clipboard-check me-1"></i>Status</label>
          <select name="status" class="form-select">
            <option value="">All</option>
            {% for s in ['processing','delivered','failed','refunded','pending','completed'] %}
              <option value="{{ s }}" {% if s == status_filter %}selected{% endif %}>{{ s|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-wallet me-1"></i>Paid From</label>
          <select name="paid_from" class="form-select">
            <option value="">Any</option>
            {% for src in ['wallet','card','momo','paystack','flutterwave','bank'] %}
              <option value="{{ src }}" {% if (paid_from or '')==src %}selected{% endif %}>{{ src|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-arrow-down-1-9 me-1"></i>Min Total (₵)</label>
          <input type="number" step="0.01" name="min_total" value="{{ min_total or '' }}" class="form-control" placeholder="0.00">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-arrow-up-9-1 me-1"></i>Max Total (₵)</label>
          <input type="number" step="0.01" name="max_total" value="{{ max_total or '' }}" class="form-control" placeholder="1000.00">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-calendar-day me-1"></i>From</label>
          <input type="date" name="date_from" value="{{ date_from or '' }}" class="form-control">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-calendar-check me-1"></i>To</label>
          <input type="date" name="date_to" value="{{ date_to or '' }}" class="form-control">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><i class="fa-solid fa-boxes-stacked me-1"></i>Item Service</label>
          <input type="text" name="item_service" value="{{ item_service or '' }}" class="form-control" placeholder="e.g., Bigtime Data">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><i class="fa-solid fa-tags me-1"></i>Item Offer</label>
          <input type="text" name="item_offer" value="{{ item_offer or '' }}" class="form-control" placeholder="e.g., 1GB">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label"><i class="fa-solid fa-mobile-screen-button me-1"></i>Item Phone</label>
          <input type="text" name="item_phone" value="{{ item_phone or '' }}" class="form-control" placeholder="e.g., 055xxxxxxx">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-sort me-1"></i>Sort</label>
          <select name="sort" class="form-select">
            <option value="newest" {% if (sort or '')=='newest' %}selected{% endif %}>Newest first</option>
            <option value="oldest" {% if (sort or '')=='oldest' %}selected{% endif %}>Oldest first</option>
            <option value="amount_desc" {% if (sort or '')=='amount_desc' %}selected{% endif %}>Amount: High → Low</option>
            <option value="amount_asc" {% if (sort or '')=='amount_asc' %}selected{% endif %}>Amount: Low → High</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label"><i class="fa-solid fa-list-ol me-1"></i>Per Page</label>
          <select name="per_page" class="form-select">
            {% for n in [10,20,30,50,100] %}
              <option value="{{ n }}" {% if (per_page or 10)|int == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-md-3 d-flex align-items-end gap-2">
          <button type="submit" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass me-1"></i>Apply Filters</button>
          <a href="{{ url_for('admin_orders.admin_view_orders') }}" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate-left me-1"></i>Reset</a>
        </div>
      </div>
    </form>

    <!-- TABLE (md+) -->
    <div class="table-wrap mb-3">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="text-center">
            <tr>
              <th style="width:42px"><input class="form-check-input" type="checkbox" id="checkAll"></th>
              <th><i class="fas fa-receipt me-1"></i>Order ID</th>
              <th><i class="fas fa-user me-1"></i>Customer</th>
              <th><i class="fas fa-shopping-cart me-1"></i>Items</th>
              <th><i class="fas fa-money-bill-wave me-1"></i>Total (₵)</th>
              <th><i class="fas fa-tasks me-1"></i>Status</th>
              <th><i class="fas fa-credit-card me-1"></i>Paid From</th>
              <th><i class="fas fa-calendar me-1"></i>Date</th>
              <th style="width:100px">Quick</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            {% set st = (order.get('status') or '').lower() %}
            <tr>
              <td class="text-center"><input class="form-check-input row-check" type="checkbox" value="{{ order['_id'] }}"></td>
              <td class="fw-semibold">{{ order["order_id"] }}</td>
              <td>
                <div class="fw-semibold">{{ (order["user"] or {}).get("first_name","") }} {{ (order["user"] or {}).get("last_name","") }}</div>
                <div class="small text-muted"><i class="fas fa-envelope me-1"></i>{{ (order["user"] or {}).get("email","") }}<br><i class="fas fa-phone-alt me-1"></i><strong>{{ (order["user"] or {}).get("phone","") }}</strong></div>
              </td>
              <td>
                <ul class="list-unstyled small mb-0">
                  {% for item in order["items"] %}
                  <li class="mb-1 border-bottom pb-1"><strong>{{ item["serviceName"] }}</strong> – {{ item.get("value","") }}<br><span class="d-block"><i class="fas fa-mobile-alt me-1 text-muted"></i><strong>{{ item.get("phone","") }}</strong></span><span class="d-block mt-1"><i class="fas fa-tag me-1 text-muted"></i>₵{{ "%.2f"|format(item.get("amount") or 0) }}</span></li>
                  {% endfor %}
                </ul>
              </td>
              <td class="text-center fw-semibold text-success"><i class="fas fa-coins me-1"></i>₵{{ "%.2f"|format(order.get("total_amount", 0) or 0) }}</td>
              <td class="text-center">
                <span class="status-chip {% if st=='delivered' %}st-delivered{% elif st=='failed' %}st-failed{% elif st=='processing' %}st-processing{% elif st=='refunded' %}st-refunded{% elif st=='pending' %}st-pending{% elif st=='completed' %}st-completed{% else %}st-processing{% endif %}"><i class="fa-solid fa-circle"></i> {{ st|capitalize }}</span>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" data-toggle-actions="actions-{{ order['_id'] }}">Change</button>
                <div id="actions-{{ order['_id'] }}" class="status-actions d-none mt-2">
                  {% for target in ['failed','refunded','processing','delivered'] %}
                  <form method="POST" class="d-inline" action="{{ url_for('admin_orders.update_order_status', order_id=order['_id']) }}{% if filters_query %}?{{ filters_query }}{% endif %}">
                    <input type="hidden" name="status" value="{{ target }}">
                    <button type="submit" class="btn btn-outline-{{ 'danger' if target=='failed' else ('success' if target=='delivered' else ('info' if target=='processing' else 'primary')) }} btn-sm" data-confirm="Mark this order as {{ target|capitalize }}?">{{ target|capitalize }}</button>
                  </form>
                  {% endfor %}
                </div>
              </td>
              <td class="text-center">
                {% set pf = (order.get("paid_from") or "N/A")|lower %}
                <span class="pf-badge {% if pf=='wallet' %}pf-wallet{% elif pf=='card' %}pf-card{% elif pf=='momo' %}pf-momo{% elif pf=='paystack' %}pf-paystack{% elif pf=='flutterwave' %}pf-flutterwave{% elif pf=='bank' %}pf-bank{% else %}pf-card{% endif %}"><i class="fas fa-wallet me-1"></i>{{ pf|capitalize }}</span>
              </td>
              <td class="text-center"><small class="muted"><i class="fas fa-clock me-1"></i>{{ order.get("created_at").strftime('%Y-%m-%d %H:%M') if order.get("created_at") else 'N/A' }}</small></td>
              <td class="text-center"><button class="btn btn-sm btn-dark" data-quick-schedule="{{ order['_id'] }}" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-calendar-plus"></i></button></td>
            </tr>
            {% else %}
            <tr><td colspan="9" class="text-center text-muted py-5"><i class="fas fa-inbox fa-3x mb-3 d-block"></i><h5>No orders found</h5><p class="mb-0">Try adjusting your filter criteria</p></td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- CARD LIST (xs-sm) -->
    <div class="cards mb-5">
      {% for order in orders %}
      {% set st = (order.get('status') or '').lower() %}
      <div class="order-card" data-order-card>
        <div class="d-flex align-items-center gap-2 mb-2">
          <input class="form-check-input row-check" type="checkbox" value="{{ order['_id'] }}">
          <span class="badge text-bg-light badge-id">#{{ order["order_id"] }}</span>
          <span class="ms-auto status-chip {% if st=='delivered' %}st-delivered{% elif st=='failed' %}st-failed{% elif st=='processing' %}st-processing{% elif st=='refunded' %}st-refunded{% elif st=='pending' %}st-pending{% elif st=='completed' %}st-completed{% else %}st-processing{% endif %}"><i class="fa-solid fa-circle"></i> {{ st|capitalize }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-start gap-3">
          <div>
            <div class="fw-bold">{{ (order["user"] or {}).get("first_name","") }} {{ (order["user"] or {}).get("last_name","") }}</div>
            <div class="meta"><i class="fa-regular fa-clock"></i> {{ order.get("created_at").strftime('%Y-%m-%d %H:%M') if order.get("created_at") else 'N/A' }}</div>
            <div class="mt-1"><span class="pf-badge {% set pf=(order.get('paid_from') or 'N/A')|lower %}{% if pf=='wallet' %}pf-wallet{% elif pf=='card' %}pf-card{% elif pf=='momo' %}pf-momo{% elif pf=='paystack' %}pf-paystack{% elif pf=='flutterwave' %}pf-flutterwave{% elif pf=='bank' %}pf-bank{% else %}pf-card{% endif %}"><i class="fas fa-wallet me-1"></i>{{ pf|capitalize }}</span></div>
          </div>
          <div class="text-end">
            <div class="small text-muted">Total</div>
            <div class="fs-5 fw-bold text-success">₵{{ "%.2f"|format(order.get("total_amount", 0) or 0) }}</div>
          </div>
        </div>
        <div class="items">
          {% for item in order["items"] %}
          <div class="it">
            <div>
              <strong>{{ item["serviceName"] }}</strong> – {{ item.get("value","") }}<br>
              <small class="text-muted"><i class="fas fa-mobile-alt me-1"></i>{{ item.get("phone","") }}</small>
            </div>
            <div class="amt">₵{{ "%.2f"|format(item.get("amount") or 0) }}</div>
          </div>
          {% endfor %}
        </div>
        <div class="d-flex flex-wrap gap-2 mt-3">
          {# Inline status quick actions (touch friendly) #}
          {% for target in ['processing','delivered','failed','refunded'] %}
          <form method="POST" action="{{ url_for('admin_orders.update_order_status', order_id=order['_id']) }}{% if filters_query %}?{{ filters_query }}{% endif %}" class="m-0">
            <input type="hidden" name="status" value="{{ target }}">
            <button class="btn btn-sm btn-outline-{{ 'success' if target=='delivered' else ('danger' if target=='failed' else ('info' if target=='processing' else 'primary')) }} touch-btn" data-confirm="Mark order {{ order['order_id'] }} as {{ target|capitalize }}?">
              {{ target|capitalize }}
            </button>
          </form>
          {% endfor %}
          <button class="btn btn-sm btn-dark ms-auto" data-quick-schedule="{{ order['_id'] }}" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-calendar-plus me-1"></i>Schedule</button>
        </div>
      </div>
      {% else %}
      <div class="text-center text-muted py-5"><i class="fas fa-inbox fa-3x mb-3 d-block"></i><h5>No orders found</h5><p class="mb-0">Try a different search or filter.</p></div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="d-flex justify-content-between align-items-center mt-2 mb-5">
      <div class="text-muted small">Page {{ page }} of {{ total_pages }}</div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          {% if page > 1 %}
          <li class="page-item"><a class="page-link" href="{{ url_for('admin_orders.admin_view_orders', page=page-1) }}{% if filters_query %}&{{ filters_query }}{% endif %}"><i class="fas fa-chevron-left"></i> Prev</a></li>
          {% endif %}
          {% for p in range(1, total_pages+1) %}
          <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('admin_orders.admin_view_orders', page=p) }}{% if filters_query %}&{{ filters_query }}{% endif %}">{{ p }}</a></li>
          {% endfor %}
          {% if page < total_pages %}
          <li class="page-item"><a class="page-link" href="{{ url_for('admin_orders.admin_view_orders', page=page+1) }}{% if filters_query %}&{{ filters_query }}{% endif %}">Next <i class="fas fa-chevron-right"></i></a></li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}
  </div>

  <!-- Floating quick actions (mobile) -->
  <div class="mobile-fab d-md-none">
    <button class="btn btn-primary" id="fabSelectAll"><i class="fa-solid fa-square-check me-2"></i>Select All</button>
  </div>

  <!-- Bottom bar (mobile) -->
  <div class="bottombar d-md-none">
    <div class="d-flex align-items-center gap-2">
      <span class="count"><span id="selCount">0</span> selected</span>
      <div class="ms-auto d-flex gap-2">
        <form id="bulkDeliverForm" method="POST" action="{{ url_for('admin_orders.bulk_deliver_orders') }}{% if filters_query %}?{{ filters_query }}{% endif %}">
          <button class="btn btn-success" data-confirm="Mark ALL processing orders (selected/filtered) as DELIVERED?"><i class="fa-solid fa-truck-fast me-1"></i>Deliver</button>
        </form>
        <button class="btn btn-dark" id="mobileScheduleBtn" data-bs-toggle="modal" data-bs-target="#scheduleModal"><i class="fa-solid fa-calendar-plus me-1"></i>Schedule</button>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" method="POST" action="{{ url_for('admin_orders.schedule_status') }}">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Schedule Status Change</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Orders Selected</label>
            <div class="small text-muted">This fills automatically from your selections.</div>
            <div id="selectedOrdersPreview" class="mt-2"></div>
          </div>
          <input type="hidden" name="order_ids" id="scheduleOrderIds">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">New Status</label>
              <select name="status" class="form-select" required>
                {% for s in ['processing','delivered','failed','refunded','pending','completed'] %}
                  <option value="{{ s }}">{{ s|capitalize }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Delay (minutes)</label>
              <input type="number" min="0" step="1" class="form-control" name="delay_minutes" id="delayMinutes" placeholder="e.g., 10">
              <div class="form-text">Set a delay OR specify an exact time below.</div>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Run At (UTC)</label>
              <input type="datetime-local" class="form-control" id="runAtLocal" placeholder="YYYY-MM-DD HH:MM">
              <input type="hidden" name="run_at" id="runAtUtc">
            </div>
            <div class="col-12">
              <label class="form-label">Note (optional)</label>
              <input type="text" class="form-control" name="note" placeholder="Reason or extra info for audit">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit"><i class="fa-solid fa-calendar-check me-1"></i>Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Offcanvas: Scheduled Jobs -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="jobsOffcanvas" aria-labelledby="jobsLabel">
    <div class="offcanvas-header">
      <h5 id="jobsLabel" class="mb-0"><i class="fa-solid fa-clock-rotate-left me-2"></i>Scheduled Jobs</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div id="jobsList" class="small"></div>
      <div class="text-center mt-3"><button class="btn btn-outline-primary btn-sm" id="refreshJobs"><i class="fa-solid fa-rotate"></i> Refresh</button></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- helpers ----------
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
    const $  = (sel, root=document)=>root.querySelector(sel);

    // Toggle inline actions tray (desktop)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-toggle-actions]');
      if (!btn) return;
      const id = btn.getAttribute('data-toggle-actions');
      const target = document.getElementById(id);
      if (!target) return;
      const cell = btn.closest('td') || document;
      $$('.status-actions', cell).forEach(x => { if (x !== target) x.classList.add('d-none'); });
      target.classList.toggle('d-none');
    });

    // Centralized confirm
    document.addEventListener('click', (e) => {
      const submitBtn = e.target.closest('button[type="submit"][data-confirm], .btn[data-confirm]');
      if (!submitBtn) return;
      const msg = submitBtn.getAttribute('data-confirm') || 'Are you sure?';
      if (!window.confirm(msg)) { e.preventDefault(); e.stopPropagation(); }
    });

    // Select all / per-row selection
    const checkAll = document.getElementById('checkAll');
    checkAll?.addEventListener('change', () => { $$('.row-check').forEach(c => c.checked = checkAll.checked); updateSelCount(); });

    function getSelectedIds(){ return $$('.row-check').filter(c => c.checked).map(c => c.value); }
    function updateSelCount(){ const n = getSelectedIds().length; const el = document.getElementById('selCount'); if (el) el.textContent = n; }

    document.addEventListener('change', (e)=>{ if(e.target.classList?.contains('row-check')) updateSelCount(); });

    // Mobile: FAB select all toggles all in view
    document.getElementById('fabSelectAll')?.addEventListener('click', ()=>{
      const allChecked = getSelectedIds().length === $$('.row-check').length;
      $$('.row-check').forEach(c => c.checked = !allChecked);
      updateSelCount();
    });

    // Open schedule modal for selected
    const openSelBtn = document.getElementById('openScheduleSelected');
    const scheduleModal = document.getElementById('scheduleModal');
    const scheduleOrderIds = document.getElementById('scheduleOrderIds');
    const selectedOrdersPreview = document.getElementById('selectedOrdersPreview');

    function renderSelectedPreview(){
      const ids = getSelectedIds();
      scheduleOrderIds.value = ids.join(',');
      selectedOrdersPreview.innerHTML = ids.length
        ? ids.map(id=>`<code class="me-1">${id}</code>`).join('')
        : `<span class="text-danger">No orders selected yet — tick checkboxes on the list.</span>`;
    }

    openSelBtn?.addEventListener('click', renderSelectedPreview);
    document.getElementById('mobileScheduleBtn')?.addEventListener('click', renderSelectedPreview);

    // Per-row quick schedule opens modal with that id
    document.addEventListener('click', (e) => {
      const b = e.target.closest('[data-quick-schedule]');
      if (!b) return;
      const id = b.getAttribute('data-quick-schedule');
      const current = scheduleOrderIds.value ? scheduleOrderIds.value.split(',').filter(Boolean) : [];
      if (!current.includes(id)) current.push(id);
      scheduleOrderIds.value = current.join(',');
      selectedOrdersPreview.innerHTML = `<span class="badge text-bg-dark">${current.length}</span> selected`;
      // ensure modal opens on mobile if triggered programmatically
    });

    // Convert datetime-local (assumed local) -> UTC string "YYYY-MM-DD HH:MM"
    const runAtLocal = document.getElementById('runAtLocal');
    const runAtUtc = document.getElementById('runAtUtc');
    function pad2(n){ return String(n).padStart(2,'0'); }
    runAtLocal?.addEventListener('change', () => {
      if (!runAtLocal.value){ runAtUtc.value = ''; return; }
      const dt = new Date(runAtLocal.value);
      const y = dt.getUTCFullYear(), m = pad2(dt.getUTCMonth()+1), d = pad2(dt.getUTCDate());
      const hh = pad2(dt.getUTCHours()), mm = pad2(dt.getUTCMinutes());
      runAtUtc.value = `${y}-${m}-${d} ${hh}:${mm}`;
    });

    // Jobs offcanvas loader
    async function loadJobs(){
      const list = document.getElementById('jobsList');
      list.innerHTML = '<div class="text-center text-muted py-2"><i class="fa-solid fa-spinner fa-spin me-2"></i>Loading…</div>';
      try{
        const res = await fetch('{{ url_for("admin_orders.list_schedules") }}', {credentials:'same-origin'});
        if (!res.ok) throw new Error('Network');
        const data = await res.json();
        if (!data.jobs || !data.jobs.length){ list.innerHTML = '<div class="text-center text-muted">No scheduled jobs.</div>'; return; }
        list.innerHTML = data.jobs.map(j => `
          <div class="d-flex align-items-center justify-content-between border-bottom py-2">
            <div>
              <div><strong>ID:</strong> <code>${j.id}</code></div>
              <div class="muted"><i class="fa-regular fa-clock me-1"></i>${j.next_run_time ?? '—'}</div>
              <div class="muted"><small>${Array.isArray(j.args) ? (j.args[1] ? ('Status → <b>'+j.args[1]+'</b>') : '') : ''}</small></div>
            </div>
            <form method="POST" action="${'{{ url_for("admin_orders.cancel_schedule", job_id="__JOB__") }}'.replace('__JOB__', j.id)}">
              <button class="btn btn-sm btn-outline-danger" data-confirm="Cancel this schedule?"><i class="fa-solid fa-trash"></i></button>
            </form>
          </div>`).join('');
      }catch(e){ list.innerHTML = '<div class="text-danger">Failed to load schedules.</div>'; }
    }
    const jobsOffcanvas = document.getElementById('jobsOffcanvas');
    jobsOffcanvas?.addEventListener('shown.bs.offcanvas', loadJobs);
    document.getElementById('refreshJobs')?.addEventListener('click', loadJobs);

    // Ensure selection count correct on load
    updateSelCount();
  </script>
</body>
</html>
