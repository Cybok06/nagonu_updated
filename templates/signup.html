<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Up â€¢ Nagonu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --focus:#0ea5e9;
      --glass-bg: rgba(255,255,255,.12);
      --glass-border: rgba(255,255,255,.25);
    }
    .bg-wrap{ position:fixed; inset:0; z-index:-2; overflow:hidden; }
    .bg-wrap::before{
      content:""; position:absolute; inset:0;
      background:url("https://res.cloudinary.com/dcmewvlyx/image/upload/v1754393415/two_people_tewigi.webp") center/cover no-repeat;
      filter:blur(10px) brightness(.9);
      transform:scale(1.08);
    }
    .bg-dim{ position:fixed; inset:0; z-index:-1; background: radial-gradient(1200px 800px at 70% 20%, rgba(0,0,0,.25), rgba(0,0,0,.55)); }

    .auth-container{ min-height:100dvh; display:grid; place-items:center; padding:clamp(16px,3vw,32px); }
    .auth-inner{ width:min(96vw, 560px); }

    .auth-card{
      backdrop-filter: blur(10px);
      background: var(--glass-bg);
      border:1px solid var(--glass-border);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      animation: slideIn .6s cubic-bezier(.2,.7,.2,1) both;
    }
    @keyframes slideIn{ from{opacity:0; transform: translateY(12px) scale(.98);} to{opacity:1; transform:translateY(0) scale(1);} }
    @media (prefers-reduced-motion: reduce){ .auth-card{ animation:none; } }

    .brand{ display:flex; align-items:center; gap:.6rem; justify-content:center; }
    .brand img{ width:48px; height:48px; object-fit:cover; border-radius:12px; border:2px solid #0ea5e9; background:#fff; }
    .brand .name{ font-weight:800; color:#fff; letter-spacing:.3px; }
    .brand .tag{ color:rgba(255,255,255,.85); font-size:.9rem; }

    .form-label{ color:#e9eef6; }
    .form-text, .small-muted{ color:rgba(255,255,255,.8); }
    .form-control, .form-select{
      background: rgba(255,255,255,.07);
      color:#fff;
      border:1px solid rgba(255,255,255,.25);
    }
    .form-control::placeholder{ color:rgba(255,255,255,.7); }
    .input-group-text{
      background: rgba(255,255,255,.08);
      color:#fff;
      border-color: rgba(255,255,255,.25);
    }
    .form-control:focus{
      border-color: var(--focus);
      box-shadow: 0 0 0 .2rem rgba(14,165,233,.25);
      background: rgba(255,255,255,.12);
      color:#fff;
    }

    .strength{ height:8px; border-radius:6px; overflow:hidden; background:rgba(255,255,255,.15); }
    .strength-bar{ height:100%; width:0%; transition:width .25s; }
    .caps-hint{ display:none; color:#ffdf7e; }
    .caps-hint.show{ display:inline-flex; align-items:center; gap:.35rem; }

    .btn-primary{ background:#0ea5e9; border-color:#0ea5e9; }
    .btn-primary:hover{ filter:brightness(.95); }

    .flash-wrap .alert{
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,.15);
      border:1px solid rgba(255,255,255,.3);
      color:#fff;
    }

    .tiny-indicator{ font-size:.85rem; }
  </style>
</head>
<body>
  <div class="bg-wrap"></div>
  <div class="bg-dim"></div>

  <main class="auth-container">
    <div class="auth-inner">

      <!-- Brand -->
      <div class="brand mb-3 text-center">
        <img src="https://res.cloudinary.com/dcmewvlyx/image/upload/v1754392905/Ngonu_Logo_xntvbm.jpg" alt="Nagonu Logo">
        <div class="text-start">
          <div class="name">Nagonu</div>
          <div class="tag">Create your account</div>
        </div>
      </div>

      <!-- Flash messages -->
      <div class="flash-wrap mb-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mb-2 py-2 px-3" role="alert">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <!-- Card -->
      <div class="auth-card p-4 p-md-4">
        <h1 class="h4 text-white text-center mb-3">Sign Up</h1>

        <!-- We keep novalidate to show our custom messages -->
        <form method="POST" action="/signup" id="signupForm" novalidate>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="first_name">First Name</label>
              <input id="first_name" name="first_name" type="text" class="form-control"
                     placeholder="First Name" required minlength="2" autocomplete="given-name"
                     pattern=".*\S.*" />
            </div>

            <div class="col-md-6">
              <label class="form-label" for="last_name">Last Name</label>
              <input id="last_name" name="last_name" type="text" class="form-control"
                     placeholder="Last Name" required minlength="2" autocomplete="family-name"
                     pattern=".*\S.*" />
            </div>

            <div class="col-md-6">
              <label class="form-label" for="username">Username</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-person"></i></span>
                <input id="username" name="username" type="text" class="form-control"
                       placeholder="Username" required autocomplete="username" minlength="3"
                       pattern="^[a-zA-Z0-9._-]{3,}$" />
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="email">Email</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                <input id="email" name="email" type="email" class="form-control"
                       placeholder="you@example.com" required autocomplete="email" />
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="phone">Phone</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                <input id="phone" name="phone" type="tel" class="form-control"
                       placeholder="e.g., 0551234567" required autocomplete="tel"
                       pattern="^0\d{9}$" />
              </div>
              <div class="form-text">Use a valid Ghana number (starts with 0, 10 digits).</div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="whatsapp">WhatsApp</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-whatsapp"></i></span>
                <input id="whatsapp" name="whatsapp" type="tel" class="form-control"
                       placeholder="WhatsApp Number" required autocomplete="tel"
                       pattern="^0\d{9}$" />
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="business_name">Business Name</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-briefcase"></i></span>
                <input id="business_name" name="business_name" type="text" class="form-control"
                       placeholder="Business Name" required minlength="2" pattern=".*\S.*" />
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="referral">Referral Code</label>
              <div class="input-group has-validation">
                <span class="input-group-text"><i class="bi bi-gift"></i></span>
                <input id="referral" name="referral" type="text" class="form-control"
                       placeholder="Referral Code" required pattern=".*\S.*"
                       value="{{ referral_code }}" />
                <span class="input-group-text border-start-0 bg-transparent" id="refState" aria-live="polite">
                  <span class="tiny-indicator text-warning" id="refMsg"></span>
                </span>
              </div>
              <div class="form-text" id="refHelp">Enter a valid referral code to continue.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label d-flex justify-content-between align-items-center" for="password">
                <span>Password</span>
                <small id="capsHint" class="caps-hint"><i class="bi bi-exclamation-triangle"></i> Caps Lock is ON</small>
              </label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-lock"></i></span>
                <input id="password" name="password" type="password" class="form-control"
                       placeholder="Create a strong password" required autocomplete="new-password"
                       minlength="8" />
                <button class="btn btn-outline-light" type="button" id="togglePw"><i class="bi bi-eye"></i></button>
              </div>
              <div class="strength mt-2"><div class="strength-bar" id="strengthBar"></div></div>
              <div class="form-text">At least 8 characters. Mix letters, numbers & symbols.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label" for="confirm_password">Confirm Password</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-shield-check"></i></span>
                <input id="confirm_password" name="confirm_password" type="password" class="form-control"
                       placeholder="Repeat password" required autocomplete="new-password" minlength="8" />
                <button class="btn btn-outline-light" type="button" id="togglePw2"><i class="bi bi-eye"></i></button>
              </div>
              <div class="form-text" id="matchText"></div>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="terms" required>
                <label class="form-check-label small-muted" for="terms">
                  I agree to the <a class="text-decoration-underline text-white" href="#" tabindex="0">Terms</a> & <a class="text-decoration-underline text-white" href="#" tabindex="0">Privacy Policy</a>.
                </label>
              </div>
            </div>

            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit" id="submitBtn" disabled>
                <span class="btn-text">Create Account</span>
                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
              </button>
            </div>

            <div class="col-12">
              <a href="/login" class="btn btn-outline-light w-100">
                <i class="bi bi-box-arrow-in-right me-1"></i> Already have an account? Log in
              </a>
            </div>
          </div>
        </form>

        <p class="text-center mt-3 small-muted mb-0">Need help? Chat us on WhatsApp.</p>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const form = document.getElementById('signupForm');
      const btn = document.getElementById('submitBtn');
      const spinner = btn.querySelector('.spinner-border');
      const btnText = btn.querySelector('.btn-text');

      const fields = [
        'first_name','last_name','username','email','phone','whatsapp',
        'business_name','referral','password','confirm_password'
      ].map(id => document.getElementById(id));

      const pw = document.getElementById('password');
      const pw2 = document.getElementById('confirm_password');
      const togglePw = document.getElementById('togglePw');
      const togglePw2 = document.getElementById('togglePw2');
      const strengthBar = document.getElementById('strengthBar');
      const capsHint = document.getElementById('capsHint');
      const matchText = document.getElementById('matchText');

      // Referral live validation bits
      const referralInput = document.getElementById('referral');
      const refMsg = document.getElementById('refMsg');
      const refHelp = document.getElementById('refHelp');
      let refValid = false;
      let refTimer = null;
      const setBtnState = () => { btn.disabled = !refValid; };

      function showRefStatus(state){
        // state: 'idle' | 'checking' | 'valid' | 'invalid'
        referralInput.classList.remove('is-valid','is-invalid');
        refMsg.classList.remove('text-warning','text-success','text-danger');
        if (state === 'checking'){
          refMsg.textContent = 'Checkingâ€¦';
          refMsg.classList.add('text-warning');
        } else if (state === 'valid'){
          referralInput.classList.add('is-valid');
          refMsg.textContent = 'Valid âœ“';
          refMsg.classList.add('text-success');
        } else if (state === 'invalid'){
          referralInput.classList.add('is-invalid');
          refMsg.textContent = 'Invalid code';
          refMsg.classList.add('text-danger');
        } else {
          refMsg.textContent = '';
        }
      }

      async function validateReferral(code){
        const clean = (code || '').trim().toUpperCase();
        if (!clean){ refValid = false; showRefStatus('idle'); setBtnState(); return; }
        showRefStatus('checking');
        try{
          const r = await fetch(`/signup/api/referral/validate?code=${encodeURIComponent(clean)}`, {cache:'no-store'});
          const data = await r.json();
          refValid = !!data.ok;
          showRefStatus(refValid ? 'valid' : 'invalid');
        }catch(e){
          refValid = false;
          showRefStatus('invalid');
        }
        setBtnState();
      }

      referralInput.addEventListener('input', () => {
        if (refTimer) clearTimeout(refTimer);
        refTimer = setTimeout(() => validateReferral(referralInput.value), 350); // debounce
      });

      // If prefilled via ?ref=, validate on load
      if (referralInput.value) {
        validateReferral(referralInput.value);
      } else {
        setBtnState();
      }

      function toggleVisibility(input, btn){
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        btn.innerHTML = isPwd ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        input.focus();
      }
      togglePw.addEventListener('click', () => toggleVisibility(pw, togglePw));
      togglePw2.addEventListener('click', () => toggleVisibility(pw2, togglePw2));

      function caps(e){ const on = e.getModifierState && e.getModifierState('CapsLock'); capsHint.classList.toggle('show', !!on); }
      pw.addEventListener('keydown', caps); pw.addEventListener('keyup', caps);

      function scorePassword(p){
        let score = 0;
        if (!p) return 0;
        const letters = {};
        for (let i=0; i<p.length; i++){ letters[p[i]] = (letters[p[i]] || 0) + 1; score += 5.0 / letters[p[i]]; }
        const variations = { digits: /\d/.test(p), lower: /[a-z]/.test(p), upper: /[A-Z]/.test(p), nonWords: /\W/.test(p) };
        let variationCount = 0;
        for (let check in variations){ variationCount += variations[check] ? 1 : 0; }
        score += (variationCount - 1) * 10;
        if (p.length >= 12) score += 10;
        return Math.min(100, Math.floor(score));
      }
      function renderStrength(val){
        strengthBar.style.width = val + '%';
        if (val < 30){ strengthBar.style.background = '#f87171'; }
        else if (val < 60){ strengthBar.style.background = '#fbbf24'; }
        else if (val < 85){ strengthBar.style.background = '#34d399'; }
        else { strengthBar.style.background = '#22c55e'; }
      }
      pw.addEventListener('input', () => renderStrength(scorePassword(pw.value)));

      function checkMatch(){
        if (!pw2.value){ matchText.textContent = ''; return; }
        if (pw.value === pw2.value){
          matchText.textContent = 'Passwords match.';
          matchText.style.color = '#a7f3d0';
          pw2.setCustomValidity('');
        } else {
          matchText.textContent = 'Passwords do not match.';
          matchText.style.color = '#fecaca';
          pw2.setCustomValidity('Passwords do not match');
        }
      }
      pw.addEventListener('input', checkMatch);
      pw2.addEventListener('input', checkMatch);

      // Trim on blur so spaces don't bypass "required"
      fields.forEach(el => {
        el.addEventListener('blur', () => { if (el.value) el.value = el.value.trim(); });
      });

      // Custom friendly messages
      const messages = {
        first_name: 'First name is required.',
        last_name: 'Last name is required.',
        username: 'Username is required (min 3 chars, letters/digits/._-).',
        email: 'A valid email is required.',
        phone: 'Valid Ghana phone required (0 + 9 digits).',
        whatsapp: 'Valid WhatsApp number required (0 + 9 digits).',
        business_name: 'Business name is required.',
        referral: 'Referral code is required.',
        password: 'Password is required (min 8 chars).',
        confirm_password: 'Please confirm your password (must match).'
      };

      form.addEventListener('submit', function(e){
        // Trim values before validating
        fields.forEach(el => { if (el.value) el.value = el.value.trim(); });

        // Recheck password match
        checkMatch();

        // Ensure referral valid before allowing submit
        if (!refValid){
          e.preventDefault();
          e.stopPropagation();
          referralInput.focus();
          referralInput.classList.add('is-invalid');
          showRefStatus('invalid');
          return;
        }

        // Per-field messages
        fields.forEach(el => {
          el.setCustomValidity('');
          if (!el.checkValidity()){
            if (messages[el.id]) el.setCustomValidity(messages[el.id]);
          }
        });

        if (!form.checkValidity() || pw.value !== pw2.value){
          e.preventDefault();
          e.stopPropagation();
          form.classList.add('was-validated');
          const firstInvalid = form.querySelector(':invalid');
          if (firstInvalid) firstInvalid.focus();
          return;
        }

        // Submit UX
        btn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'Creating...';
      }, {passive:false});
    })();
  </script>
</body>
</html>
