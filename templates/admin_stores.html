<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin • Stores Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <style>
    :root{
      --clr-bg:#f9fafb;
      --clr-card:#ffffff;
      --clr-text:#111827;
      --clr-muted:#6b7280;
      --clr-ring:#e5e7eb;

      --clr-primary:#0ea5e9;
      --clr-green:#22c55e;
      --clr-orange:#f59e0b;
      --clr-red:#ef4444;

      --radius-lg:20px;
      --radius-md:14px;
      --shadow-soft:0 18px 45px rgba(15,23,42,.08);
      --shadow-card:0 12px 30px rgba(15,23,42,.06);
    }

    *{box-sizing:border-box;}
    body{background:var(--clr-bg); color:var(--clr-text);}

    /* Header */
    .nav-shell{
      border-bottom:1px solid var(--clr-ring);
      backdrop-filter: blur(10px);
      background:#ffffff;
      position:sticky; top:0; z-index:1050;
      box-shadow:0 8px 24px rgba(15,23,42,.04);
    }
    .page-wrap{max-width:1180px; margin:0 auto; padding:0 1rem;}
    .app-nav{
      display:flex; align-items:center; justify-content:space-between; gap:1rem;
      padding:.75rem 0;
    }
    .app-title{display:flex; align-items:center; gap:.75rem;}
    .logo-pill{
      width:42px;height:42px;border-radius:999px; display:grid; place-items:center;
      background:radial-gradient(circle at 30% 0, #e0f2fe, #0ea5e9);
      border:1px solid var(--clr-ring);
      box-shadow:0 10px 24px rgba(14,165,233,.22);
      color:#0f172a;
    }
    .app-heading{font-size:1.05rem; font-weight:800; letter-spacing:.02em;}
    .app-sub{font-size:.8rem; color:var(--clr-muted);}

    /* Toolbar */
    .toolbar{
      display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; justify-content:flex-end;
    }
    .toolbar .form-control,
    .toolbar .form-select{
      border-radius:999px; border:1px solid var(--clr-ring);
      font-size:.85rem;
    }
    .btn-ghost{
      border-radius:999px;
      padding:.44rem .9rem;
      font-size:.83rem;
      display:inline-flex; align-items:center; gap:.45rem;
      border:1px solid var(--clr-ring);
      color:#374151; background:#ffffff; text-decoration:none;
    }
    .btn-ghost:hover{background:#f3f4f6;}
    .btn-glow{
      border-radius:999px;
      border:none;
      padding:.46rem .95rem;
      font-size:.85rem;
      font-weight:700;
      display:inline-flex; align-items:center; gap:.45rem;
      color:#ffffff;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 12px 30px rgba(34,197,94,.28);
      text-decoration:none;
    }
    .btn-warn{
      border-radius:999px;
      border:none;
      padding:.46rem .95rem;
      font-size:.85rem;
      font-weight:700;
      display:inline-flex; align-items:center; gap:.45rem;
      color:#111827;
      background:linear-gradient(135deg,#fde68a,#f59e0b);
      box-shadow:0 12px 30px rgba(245,158,11,.25);
    }

    /* Summary cards */
    .summary-grid{
      margin:1.25rem auto .75rem;
      display:grid;
      grid-template-columns:repeat(5,minmax(0,1fr));
      gap:1rem;
    }
    @media(max-width: 1100px){ .summary-grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
    @media(max-width: 767px){ .summary-grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(max-width: 520px){ .summary-grid{grid-template-columns:repeat(1,minmax(0,1fr));} }

    .summary-card{
      border-radius:var(--radius-md);
      border:1px solid var(--clr-ring);
      background:var(--clr-card);
      box-shadow:var(--shadow-card);
      padding:.9rem 1rem;
    }
    .summary-label{
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--clr-muted);
    }
    .summary-value{
      font-size:1.2rem;
      font-weight:900;
      margin-top:.25rem;
    }
    .summary-value.money{ color:#15803d; }

    /* Cards grid */
    .grid{
      margin:1.25rem auto 2.5rem;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:1rem;
    }
    @media(max-width: 991px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media(max-width: 640px){ .grid{grid-template-columns:repeat(1,minmax(0,1fr));} }

    .store-card{
      border-radius:var(--radius-lg);
      border:1px solid var(--clr-ring);
      background:var(--clr-card);
      box-shadow:var(--shadow-card);
      overflow:hidden;
      position:relative;
      transition: transform .15s ease, box-shadow .15s ease;
      cursor:pointer;
    }
    .store-card:hover{
      transform: translateY(-2px);
      box-shadow:0 18px 45px rgba(15,23,42,.10);
    }

    /* Loading skeletons */
    @keyframes shimmer {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .skeleton{
      position:relative;
      overflow:hidden;
      background:#eef2f7;
      color:transparent !important;
    }
    .skeleton::after{
      content:"";
      position:absolute;
      inset:0;
      transform:translateX(-100%);
      background:linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    .store-card.skeleton-card{ cursor:default; }
    .skeleton-line,
    .skeleton-pill{
      position:relative;
      overflow:hidden;
      background:#eef2f7;
    }
    .skeleton-line{
      height:12px;
      border-radius:999px;
      margin:8px 0;
    }
    .skeleton-pill{
      height:18px;
      border-radius:999px;
      width:120px;
    }
    .skeleton-line::after,
    .skeleton-pill::after{
      content:"";
      position:absolute;
      inset:0;
      transform:translateX(-100%);
      background:linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%);
      animation: shimmer 1.2s infinite;
    }
    .store-card .top{
      padding:1rem 1rem .75rem;
      background:
        radial-gradient(circle at 0 -30%, rgba(56,189,248,.18), transparent 55%),
        radial-gradient(circle at 110% 0, rgba(34,197,94,.14), transparent 60%),
        linear-gradient(135deg,#ffffff,#f9fafb);
      border-bottom:1px solid var(--clr-ring);
    }
    .store-title{
      display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem;
    }
    .name{
      font-weight:900; font-size:1.02rem;
      margin:0; line-height:1.1;
    }
    .slug{
      margin-top:.2rem;
      font-size:.8rem; color:var(--clr-muted);
    }
    .chip{
      border-radius:999px;
      padding:.18rem .6rem;
      font-size:.74rem;
      font-weight:700;
      border:1px solid var(--clr-ring);
      background:#f9fafb;
      color:#374151;
      white-space:nowrap;
    }
    .chip.published{ background:rgba(34,197,94,.12); color:#15803d; border-color:rgba(34,197,94,.25); }
    .chip.suspended{ background:rgba(245,158,11,.14); color:#92400e; border-color:rgba(245,158,11,.30); }
    .chip.draft{ background:rgba(148,163,184,.18); color:#334155; border-color:rgba(148,163,184,.35); }
    .chip.deleted{ background:rgba(239,68,68,.12); color:#991b1b; border-color:rgba(239,68,68,.25); }

    .meta{ padding:.8rem 1rem 1rem; }
    .meta .rowx{
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      font-size:.86rem;
      padding:.35rem 0;
      border-bottom:1px dashed rgba(229,231,235,.8);
    }
    .meta .rowx:last-child{border-bottom:none;}
    .muted{color:var(--clr-muted);}
    .val{font-weight:800;}
    .val.green{color:#15803d;}
    .val.blue{color:#0369a1;}

    .actions{
      padding:0 1rem 1rem;
      display:flex; flex-wrap:wrap; gap:.5rem;
    }
    .btn-mini{
      border-radius:999px;
      padding:.35rem .7rem;
      border:1px solid var(--clr-ring);
      background:#fff;
      font-size:.8rem;
      display:inline-flex; align-items:center; gap:.4rem;
      color:#374151;
    }
    .btn-mini:hover{background:#f3f4f6;}
    .btn-mini.danger{border-color:rgba(239,68,68,.35); color:#b91c1c;}
    .btn-mini.warn{border-color:rgba(245,158,11,.35); color:#92400e;}
    .btn-mini.ok{border-color:rgba(34,197,94,.35); color:#15803d;}
    .btn-mini.primary{border-color:rgba(14,165,233,.35); color:#0369a1;}

    /* Withdrawable pulse */
    @keyframes pulseRing {
      0%   { box-shadow: 0 0 0 0 rgba(34,197,94,.30); }
      70%  { box-shadow: 0 0 0 14px rgba(34,197,94,0); }
      100% { box-shadow: 0 0 0 0 rgba(34,197,94,0); }
    }
    .needs-withdraw{ border-color:rgba(34,197,94,.45) !important; }
    .needs-withdraw::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:var(--radius-lg);
      pointer-events:none;
      animation:pulseRing 1.6s infinite;
    }
    .withdraw-pill{
      display:inline-flex; align-items:center; gap:.35rem;
      border-radius:999px;
      padding:.18rem .65rem;
      font-size:.74rem; font-weight:800;
      background:rgba(34,197,94,.12);
      color:#15803d;
      border:1px solid rgba(34,197,94,.25);
    }

    /* Requests pill */
    .req-pill{
      display:inline-flex; align-items:center; gap:.35rem;
      border-radius:999px;
      padding:.18rem .65rem;
      font-size:.74rem; font-weight:900;
      background:rgba(245,158,11,.16);
      color:#92400e;
      border:1px solid rgba(245,158,11,.30);
    }

    /* NEW: global requests header pill */
    @keyframes blink {
      0%, 100% { transform: translateY(0); box-shadow:0 10px 24px rgba(245,158,11,.10); }
      50% { transform: translateY(-1px); box-shadow:0 14px 30px rgba(245,158,11,.22); }
    }
    .req-global{
      border-radius:999px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.14);
      color:#92400e;
      font-weight:900;
      padding:.46rem .9rem;
      display:inline-flex; align-items:center; gap:.5rem;
      cursor:pointer;
      user-select:none;
    }
    .req-global.blink{ animation: blink 1.1s infinite; }
    .req-global .count{
      display:inline-grid; place-items:center;
      min-width:22px; height:22px; padding:0 .4rem;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(245,158,11,.35);
      font-size:.8rem;
    }

    /* Modal polish */
    .modal-content{
      border-radius:18px;
      border:1px solid var(--clr-ring);
      box-shadow:var(--shadow-soft);
    }
    .kpi{
      border-radius:16px;
      border:1px solid var(--clr-ring);
      background:#fff;
      padding:.85rem .9rem;
    }
    .kpi-title{font-size:.78rem; color:var(--clr-muted); text-transform:uppercase; letter-spacing:.08em;}
    .kpi-value{font-size:1.15rem; font-weight:900; margin-top:.2rem;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .copy-btn{border:1px dashed var(--clr-ring); background:#fff;}
    .copy-group .btn{border-radius:10px;}
    .table-sm td,.table-sm th{padding:.5rem .6rem;}

    .spinner-inline{ display:inline-flex; align-items:center; gap:.45rem; color:var(--clr-muted); font-size:.85rem; }
    .hint{
      border:1px dashed rgba(148,163,184,.6);
      background:#fff;
      border-radius:14px;
      padding:.7rem .85rem;
      color:#475569;
      font-size:.88rem;
    }

    .btn-xs{
      border-radius:999px;
      padding:.25rem .55rem;
      font-size:.75rem;
      border:1px solid var(--clr-ring);
      background:#fff;
    }
    .btn-xs:hover{background:#f3f4f6;}
    .btn-xs.ok{border-color:rgba(34,197,94,.35); color:#15803d;}
    .btn-xs.bad{border-color:rgba(239,68,68,.35); color:#b91c1c;}
    .btn-xs.primary{border-color:rgba(14,165,233,.35); color:#0369a1;}

    .mini-select{
      font-size:.78rem;
      padding:.18rem .45rem;
      border-radius:999px;
      border:1px solid var(--clr-ring);
      background:#fff;
      max-width:150px;
    }

    .momo-box{ line-height:1.2; }
    .momo-line{ font-size:.78rem; color:#334155; }
    .momo-line .k{ color:#64748b; }
    .momo-line .v{ font-weight:800; }
    .momo-actions{
      display:flex; justify-content:flex-end; gap:.35rem; flex-wrap:wrap;
    }

    @media (max-width: 767.98px){
      .app-nav{flex-direction:column; align-items:flex-start;}
      .toolbar{justify-content:flex-start; width:100%;}
      .toolbar .form-control{width:100%;}
    }
  </style>
</head>

<body>

  <div class="customer-content">
  <!-- Top bar -->
  <div class="nav-shell">
    <div class="page-wrap app-nav">
      <div class="app-title">
        <div class="logo-pill"><i class="bi bi-shop-window"></i></div>
        <div>
          <div class="app-heading">Stores • Admin Control</div>
          <div class="app-sub">Card view · click a store to open details & actions</div>
        </div>
      </div>

      <div class="toolbar">
        <a class="btn-ghost" href="/admin/dashboard" aria-label="Back to admin dashboard">
          <i class="bi bi-arrow-left"></i>Back
        </a>
        <!-- NEW: Global Requests -->
        <div id="reqGlobal" class="req-global d-none" title="View all withdrawal requests">
          <i class="bi bi-bell-fill"></i>
          Requests
          <span class="count" id="reqGlobalCount">0</span>
        </div>

        <input id="q" class="form-control form-control-sm" placeholder="Search store / owner / slug" />
        <select id="status" class="form-select form-select-sm" style="width:170px;">
          <option value="">All statuses</option>
          <option value="published">Published</option>
          <option value="suspended">Suspended</option>
          <option value="draft">Draft</option>
        </select>
        <select id="sort" class="form-select form-select-sm" style="width:200px;">
          <option value="updated">Sort: recent updates</option>
          <option value="sales_desc">Sort: highest sales</option>
          <option value="profit_balance_desc">Sort: profit balance</option>
        </select>
        <button id="btnFilter" class="btn-ghost" type="button"><i class="bi bi-filter"></i>Filter</button>
        <button id="btnSuspendAll" class="btn-warn" type="button"><i class="bi bi-pause-circle"></i>Suspend All</button>
      </div>
    </div>
  </div>

  <main class="page-wrap">
    <section class="summary-grid" id="summaryGrid">
      <div class="summary-card">
        <div class="summary-label">Total Stores</div>
        <div class="summary-value"><span id="statTotal">0</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total Published</div>
        <div class="summary-value"><span id="statPublished">0</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total Draft</div>
        <div class="summary-value"><span id="statDraft">0</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total Suspended</div>
        <div class="summary-value"><span id="statSuspended">0</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Total Outstanding Payouts</div>
        <div class="summary-value money">GHS <span id="statOutstanding">0.00</span></div>
      </div>
    </section>

    <div id="grid" class="grid">
      <div class="store-card skeleton-card">
        <div class="top">
          <div class="skeleton-pill" style="width:140px;"></div>
          <div class="skeleton-line" style="width:70%;"></div>
          <div class="skeleton-line" style="width:45%;"></div>
        </div>
        <div class="meta">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line" style="width:55%;"></div>
        </div>
        <div class="actions">
          <div class="skeleton-pill" style="width:90px;"></div>
          <div class="skeleton-pill" style="width:90px;"></div>
          <div class="skeleton-pill" style="width:90px;"></div>
        </div>
      </div>
      <div class="store-card skeleton-card">
        <div class="top">
          <div class="skeleton-pill" style="width:140px;"></div>
          <div class="skeleton-line" style="width:70%;"></div>
          <div class="skeleton-line" style="width:45%;"></div>
        </div>
        <div class="meta">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line" style="width:55%;"></div>
        </div>
        <div class="actions">
          <div class="skeleton-pill" style="width:90px;"></div>
          <div class="skeleton-pill" style="width:90px;"></div>
          <div class="skeleton-pill" style="width:90px;"></div>
        </div>
      </div>
      <div class="store-card skeleton-card">
        <div class="top">
          <div class="skeleton-pill" style="width:140px;"></div>
          <div class="skeleton-line" style="width:70%;"></div>
          <div class="skeleton-line" style="width:45%;"></div>
        </div>
        <div class="meta">
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line" style="width:55%;"></div>
        </div>
        <div class="actions">
          <div class="skeleton-pill" style="width:90px;"></div>
          <div class="skeleton-pill" style="width:90px;"></div>
          <div class="skeleton-pill" style="width:90px;"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index:3000;">
    <div id="appToast" class="toast text-bg-dark border-0">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Done</div>
        <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Store Details Modal (UNCHANGED content kept) -->
  <div class="modal fade" id="storeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h6 class="modal-title d-flex align-items-center gap-2">
              <span class="logo-pill" style="width:36px;height:36px;"><i class="bi bi-shop"></i></span>
              <span id="m_name">Store</span>
              <span id="m_status" class="chip draft">draft</span>
              <span id="m_req_badge" class="req-pill d-none"><i class="bi bi-bell-fill"></i><span id="m_req_count">0</span> requests</span>
            </h6>
            <div class="text-muted small">/s/<span id="m_slug"></span></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <!-- KPI row -->
          <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
              <div class="kpi h-100">
                <div class="kpi-title">Owner</div>
                <div class="kpi-value" id="m_owner">—</div>
                <div class="text-muted small">Wallet: <strong>GHS <span id="m_wallet">0.00</span></strong></div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="kpi h-100">
                <div class="kpi-title">Profit Balance</div>
                <div class="kpi-value text-success">GHS <span id="m_withdrawable">0.00</span></div>
                <div class="text-muted small">
                  Reserved/Withdrawn: <strong>GHS <span id="m_withdrawn_reserved">0.00</span></strong>
                </div>
                <div class="text-muted small">
                  Paid: <strong>GHS <span id="m_withdrawn_paid">0.00</span></strong>
                </div>
                <div class="text-muted small">
                  Requests: <strong><span id="m_pending_requests">0</span></strong>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="kpi h-100">
                <div class="kpi-title">Last Updated</div>
                <div class="kpi-value" style="font-size:1rem;" id="m_updated">—</div>
                <div class="text-muted small">Withdrawals tab: view MoMo details + update status</div>
              </div>
            </div>
          </div>

          <!-- Tabs -->
          <ul class="nav nav-tabs mb-3" id="mTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-summary" data-bs-toggle="tab" data-bs-target="#pane-summary" type="button" role="tab">
                <i class="bi bi-bar-chart-line me-1"></i>Summary
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-payout" data-bs-toggle="tab" data-bs-target="#pane-payout" type="button" role="tab">
                <i class="bi bi-credit-card-2-front me-1"></i>Payout
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-withdrawals" data-bs-toggle="tab" data-bs-target="#pane-withdrawals" type="button" role="tab">
                <i class="bi bi-clock-history me-1"></i>Withdrawals
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-actions" data-bs-toggle="tab" data-bs-target="#pane-actions" type="button" role="tab">
                <i class="bi bi-gear me-1"></i>Actions
              </button>
            </li>
          </ul>

          <div class="tab-content">
            <!-- Summary -->
            <div class="tab-pane fade show active" id="pane-summary" role="tabpanel">
              <div class="row g-3">
                <div class="col-12 col-lg-6">
                  <div class="kpi h-100">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="kpi-title">Today</div>
                      <span class="chip" id="m_today_orders_chip">0 orders</span>
                    </div>
                    <div class="row text-center mt-2">
                      <div class="col">
                        <div class="text-muted small">Sales</div>
                        <div class="fw-bold">GHS <span id="m_today_sales">0.00</span></div>
                      </div>
                      <div class="col">
                        <div class="text-muted small">Profit</div>
                        <div class="fw-bold text-success">GHS <span id="m_today_profit">0.00</span></div>
                      </div>
                      <div class="col">
                        <div class="text-muted small">Orders</div>
                        <div class="fw-bold"><span id="m_today_orders">0</span></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12 col-lg-6">
                  <div class="kpi h-100">
                    <div class="d-flex align-items-center justify-content-between">
                      <div class="kpi-title">All-time</div>
                      <span class="chip" id="m_all_orders_chip">0 orders</span>
                    </div>
                    <div class="row text-center mt-2">
                      <div class="col">
                        <div class="text-muted small">Sales</div>
                        <div class="fw-bold">GHS <span id="m_all_sales">0.00</span></div>
                      </div>
                      <div class="col">
                        <div class="text-muted small">Profit</div>
                        <div class="fw-bold text-success">GHS <span id="m_all_profit">0.00</span></div>
                      </div>
                      <div class="col">
                        <div class="text-muted small">Orders</div>
                        <div class="fw-bold"><span id="m_all_orders">0</span></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <div class="hint">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Withdrawal flow:</strong>
                    <span class="ms-1">Owner requests show as <strong>REQUESTED</strong>. Admin can move to <strong>PENDING</strong> (MoMo initiated) then <strong>PAID</strong>.</span>
                    <span class="ms-2">Wallet becomes <strong>SUCCESS</strong> when credited.</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payout -->
            <div class="tab-pane fade" id="pane-payout" role="tabpanel">
              <div class="kpi">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div class="fw-bold"><i class="bi bi-shield-check me-1"></i>Current payout details</div>
                  <div class="btn-group btn-group-sm copy-group">
                    <button class="btn btn-outline-secondary copy-btn" data-copy="#p_name" title="Copy name"><i class="bi bi-person-lines-fill"></i></button>
                    <button class="btn btn-outline-secondary copy-btn" data-copy="#p_phone" title="Copy phone"><i class="bi bi-telephone"></i></button>
                    <button class="btn btn-outline-secondary copy-btn" data-copy="#p_network" title="Copy network"><i class="bi bi-reception-4"></i></button>
                    <button class="btn btn-outline-secondary copy-btn" data-copy="#p_all" title="Copy all"><i class="bi bi-clipboard-check"></i></button>
                  </div>
                </div>

                <div class="row gy-2">
                  <div class="col-12 col-md-6">
                    <div class="text-muted small">Name</div>
                    <div class="fw-bold" id="p_name">—</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="text-muted small">Phone</div>
                    <div class="fw-bold mono" id="p_phone">—</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="text-muted small">Network</div>
                    <span class="badge text-bg-light border" id="p_network">—</span>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="text-muted small">Last updated</div>
                    <div class="text-muted" id="p_updated">—</div>
                  </div>
                </div>

                <div id="p_all" class="d-none"></div>
                <div class="small text-muted mt-2" id="p_history_hint">—</div>
              </div>
            </div>

            <!-- Withdrawals -->
            <div class="tab-pane fade" id="pane-withdrawals" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Reference</th>
                      <th class="text-end">Amount (GHS)</th>
                      <th>Method</th>
                      <th>MoMo Details</th>
                      <th>Status</th>
                      <th>Created</th>
                      <th>Verified</th>
                      <th>Note</th>
                      <th class="text-end">Admin Action</th>
                    </tr>
                  </thead>
                  <tbody id="w_body">
                    <tr><td colspan="9" class="text-muted text-center py-3">No data.</td></tr>
                  </tbody>
                </table>
              </div>
              <nav aria-label="Withdrawals pages" class="mt-2">
                <ul class="pagination pagination-sm justify-content-end gap-1" id="w_pager"></ul>
              </nav>
              <div class="small text-muted mt-2">
                Tip: You can <strong>Mark Paid</strong> / <strong>Reject</strong>, or use <strong>Set Status</strong> dropdown for full control.
              </div>
            </div>

            <!-- Actions -->
            <div class="tab-pane fade" id="pane-actions" role="tabpanel">
              <div class="d-flex flex-wrap gap-2">
                <button class="btn-glow" id="m_act_withdraw" type="button"><i class="bi bi-wallet2"></i>Withdraw</button>
                <button class="btn-warn" id="m_act_suspend" type="button"><i class="bi bi-pause-circle"></i>Suspend</button>
                <button class="btn-ghost" id="m_act_resume" type="button"><i class="bi bi-play-circle"></i>Resume</button>
                <button class="btn-ghost" id="m_act_delete" type="button" style="border-color:rgba(239,68,68,.35); color:#b91c1c;">
                  <i class="bi bi-trash"></i>Delete
                </button>
                <a class="btn-ghost" target="_blank" id="m_open_store"><i class="bi bi-box-arrow-up-right"></i>Open Store</a>
              </div>

              <div class="small text-muted mt-3">
                Card pulse = <strong>withdrawable profit</strong>. Orange “Requests” pill = <strong>withdrawal waiting for admin</strong>.
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Withdraw modal (UNCHANGED) -->
  <div class="modal fade" id="wdrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title"><i class="bi bi-cash-stack me-1"></i>Withdraw Profit</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-2 small text-muted">
            Store: <strong id="wdrStore"></strong><br>
            Profit Balance: <strong>GHS <span id="wdrAvail">0.00</span></strong>
          </div>

          <div class="mb-3">
            <label class="form-label mb-1">Withdrawal method</label>
            <select id="wdrMethod" class="form-select" style="border-radius:14px;">
              <option value="wallet">Wallet (credit owner wallet)</option>
              <option value="momo">MoMo (send to payout number)</option>
            </select>
            <div class="small text-muted mt-1" id="wdrMethodHint">
              Wallet credits the owner’s wallet balance.
            </div>
          </div>

          <div class="kpi mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold"><i class="bi bi-credit-card-2-front me-1"></i>Payout details (MoMo)</div>
              <div class="btn-group btn-group-sm copy-group" role="group" aria-label="Copy payout">
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayName" title="Copy name"><i class="bi bi-person-lines-fill"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayPhone" title="Copy phone"><i class="bi bi-telephone"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayNetwork" title="Copy network"><i class="bi bi-reception-4"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayAll" title="Copy all"><i class="bi bi-clipboard-check"></i></button>
              </div>
            </div>
            <div class="small text-muted">Name</div>
            <div class="fw-bold" id="wdrPayName">—</div>
            <div class="small text-muted mt-2">Phone</div>
            <div class="fw-bold mono" id="wdrPayPhone">—</div>
            <div class="small text-muted mt-2">Network</div>
            <span class="badge text-bg-light border" id="wdrPayNetwork">—</span>
            <div id="wdrPayAll" class="d-none"></div>
            <div class="small text-muted mt-2" id="wdrPayUpdated"></div>
          </div>

          <label class="form-label">Amount (leave blank for ALL)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="wdrAmount" placeholder="e.g. 120.00" style="border-radius:14px;">
        </div>

        <div class="modal-footer">
          <button class="btn btn-light" data-bs-dismiss="modal" style="border-radius:999px;">Cancel</button>
          <button class="btn btn-success" id="wdrGo" style="border-radius:999px;">
            <span class="btn-text">Process</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Global Requests Modal -->
  <div class="modal fade" id="reqModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <div class="d-flex align-items-center gap-2">
            <span class="logo-pill" style="width:36px;height:36px;"><i class="bi bi-bell"></i></span>
            <div>
              <div class="fw-bold">Withdrawal Requests</div>
              <div class="text-muted small">All stores • status REQUESTED/PENDING</div>
            </div>
          </div>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
            <div class="d-flex gap-2 flex-wrap align-items-center">
              <select id="reqStatus" class="form-select form-select-sm" style="width:180px; border-radius:999px;">
                <option value="all">requested + pending</option>
                <option value="requested">requested</option>
                <option value="pending">pending</option>
              </select>
              <input id="reqQ" class="form-control form-control-sm" placeholder="Search store / owner / reference" style="min-width:260px; border-radius:999px;">
              <button id="reqReload" class="btn-ghost" type="button"><i class="bi bi-arrow-repeat"></i>Reload</button>
            </div>
            <div class="text-muted small">
              Total: <strong id="reqTotal">0</strong>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>Store</th>
                  <th>Owner</th>
                  <th>Reference</th>
                  <th class="text-end">Amount</th>
                  <th>Method</th>
                  <th>MoMo</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th class="text-end">Admin Action</th>
                </tr>
              </thead>
              <tbody id="reqBody">
                <tr><td colspan="9" class="text-muted text-center py-3">Loading…</td></tr>
              </tbody>
            </table>
          </div>

          <nav class="mt-2">
            <ul class="pagination pagination-sm justify-content-end gap-1" id="reqPager"></ul>
          </nav>

          <div class="small text-muted mt-2">
            Tip: Click a store name to open that store’s details modal immediately.
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function(){
      /* ---------- Toast ---------- */
      const toastEl = document.getElementById('appToast');
      const toast = new bootstrap.Toast(toastEl,{delay:2400});
      function tell(m){
        document.getElementById('toastBody').textContent = m || 'Done';
        toast.show();
      }

      /* ---------- Elements ---------- */
      const grid = document.getElementById('grid');
      const qEl = document.getElementById('q');
      const statusEl = document.getElementById('status');
      const sortEl = document.getElementById('sort');
      document.getElementById('btnFilter').addEventListener('click', load);
      document.getElementById('btnSuspendAll').addEventListener('click', suspendAll);

      // NEW: header global requests
      const reqGlobal = document.getElementById('reqGlobal');
      const reqGlobalCount = document.getElementById('reqGlobalCount');

      let cachedRows = [];
      let currentDetailSlug = null;
      let currentDetailData = null;

      const statTotal = document.getElementById('statTotal');
      const statPublished = document.getElementById('statPublished');
      const statDraft = document.getElementById('statDraft');
      const statSuspended = document.getElementById('statSuspended');
      const statOutstanding = document.getElementById('statOutstanding');

      /* ---------- Utils ---------- */
      function money(n){ return (Number(n||0)).toFixed(2); }
      function escapeHtml(s){
        return String(s==null?'':s)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }
      function clsStatus(s){
        const t = String(s||'draft').toLowerCase();
        if(t==='published') return 'published';
        if(t==='suspended') return 'suspended';
        if(t==='deleted') return 'deleted';
        return 'draft';
      }
      function statusChip(s){
        const t = String(s||'draft').toLowerCase();
        const c = clsStatus(t);
        return `<span class="chip ${c}">${escapeHtml(t)}</span>`;
      }

      function setStatsLoading(on){
        const list = [statTotal, statPublished, statDraft, statSuspended, statOutstanding];
        list.forEach(el=>{
          if(!el) return;
          if(on){
            el.classList.add('skeleton');
          }else{
            el.classList.remove('skeleton');
          }
        });
      }

      function renderStats(stats){
        const s = stats || {};
        statTotal.textContent = String(Number(s.total_stores || 0));
        statPublished.textContent = String(Number(s.published || 0));
        statDraft.textContent = String(Number(s.draft || 0));
        statSuspended.textContent = String(Number(s.suspended || 0));
        statOutstanding.textContent = money(s.outstanding_payouts || 0);
      }

      async function copyText(text){
        try{
          if(navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(text);
          }else{
            const ta=document.createElement('textarea');
            ta.value=text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
          }
          tell('Copied');
        }catch(e){
          tell('Copy failed');
        }
      }
      function bindCopyClicks(scope){
        const root = scope || document;
        root.querySelectorAll('[data-copy]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const target = btn.getAttribute('data-copy');
            const el = document.querySelector(target);
            if(!el) return;
            const txt = (el.textContent || '').trim();
            if(txt) copyText(txt);
          });
        });
      }

      /* ---------- Load & Render cards ---------- */
      function renderLoadingCards(){
        const card = `
          <div class="store-card skeleton-card">
            <div class="top">
              <div class="skeleton-pill" style="width:140px;"></div>
              <div class="skeleton-line" style="width:70%;"></div>
              <div class="skeleton-line" style="width:45%;"></div>
            </div>
            <div class="meta">
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line" style="width:55%;"></div>
            </div>
            <div class="actions">
              <div class="skeleton-pill" style="width:90px;"></div>
              <div class="skeleton-pill" style="width:90px;"></div>
              <div class="skeleton-pill" style="width:90px;"></div>
            </div>
          </div>
        `;
        grid.innerHTML = Array.from({length:6}).map(()=>card).join('');
      }

      function applySort(rows){
        const mode = String(sortEl.value || 'updated');
        const out = (rows || []).slice();
        if(mode === 'sales_desc'){
          out.sort((a,b)=> Number(b.total_sales||0) - Number(a.total_sales||0));
        }else if(mode === 'profit_balance_desc'){
          out.sort((a,b)=> Number(b.withdrawable||0) - Number(a.withdrawable||0));
        }
        return out;
      }

      async function load(){
        setStatsLoading(true);
        renderLoadingCards();
        /* grid.innerHTML = `
          <div class="store-card">
            <div class="top">
              <div class="spinner-inline">
                <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                Loading stores…
              </div>
            </div>
          </div>
        `; */

        const params = new URLSearchParams();
        const q = (qEl.value || '').trim();
        if(q) params.set('q', q);
        const st = (statusEl.value || '').trim();
        if(st) params.set('status', st);
        params.set('limit','200');

        try{
          const r = await fetch('/admin/api/stores?' + params.toString());
          const j = await r.json();
          if(!r.ok || !j.success){
            grid.innerHTML = `<div class="text-danger small">Failed to load.</div>`;
            setStatsLoading(false);
            return;
          }
          cachedRows = j.rows || [];
          renderStats(j.stats || {});
          setStatsLoading(false);
          render(applySort(cachedRows));
          refreshGlobalRequestsBadgeFromRows(cachedRows);
        }catch(e){
          grid.innerHTML = `<div class="text-danger small">Network error.</div>`;
          setStatsLoading(false);
        }
      }

      function refreshGlobalRequestsBadgeFromRows(rows){
        const totalReq = (rows || []).reduce((a,x)=> a + Number(x.pending_requests||0), 0);
        if(totalReq > 0){
          reqGlobal.classList.remove('d-none');
          reqGlobalCount.textContent = String(totalReq);
          reqGlobal.classList.add('blink');
        }else{
          reqGlobalCount.textContent = '0';
          reqGlobal.classList.remove('blink');
          reqGlobal.classList.add('d-none');
        }
      }

      function render(rows){
        if(!rows.length){
          grid.innerHTML = `
            <div class="store-card">
              <div class="top">
                <div class="text-muted small">No stores found.</div>
              </div>
            </div>
          `;
          return;
        }

        const out = [];
        for(const x of rows){
          const withdrawable = Number(x.withdrawable || 0);
          const pendingReq = Number(x.pending_requests || 0);

          const pulseCls = withdrawable > 0 ? 'needs-withdraw' : '';
          const withdrawPill = withdrawable > 0
            ? `<span class="withdraw-pill"><i class="bi bi-cash-stack"></i>Profit Balance: GHS ${money(withdrawable)}</span>`
            : `<span class="chip">Profit Balance: GHS ${money(withdrawable)}</span>`;

          const reqPill = pendingReq > 0
            ? `<span class="req-pill"><i class="bi bi-bell-fill"></i>${pendingReq} request${pendingReq===1?'':'s'}</span>`
            : ``;

          out.push(`
            <div class="store-card ${pulseCls}" data-slug="${escapeHtml(x.slug)}">
              <div class="top">
                <div class="store-title">
                  <div>
                    <p class="name mb-0">${escapeHtml(x.name || x.slug || 'Store')}</p>
                    <div class="slug">/s/${escapeHtml(x.slug || '')}</div>
                    <div class="mt-2 d-flex flex-wrap gap-2 align-items-center">
                      ${withdrawPill}
                      ${reqPill}
                      ${statusChip(x.status)}
                    </div>
                  </div>
                  <div class="text-end">
                    <div class="text-muted small">Owner</div>
                    <div class="fw-bold">${escapeHtml(x.owner_name || '-')}</div>
                  </div>
                </div>
              </div>

              <div class="meta">
                <div class="rowx">
                  <span class="muted">Today Sales</span>
                  <span class="val blue">GHS ${money(x.sales_today)}</span>
                </div>
                <div class="rowx">
                  <span class="muted">Today Profit</span>
                  <span class="val green">GHS ${money(x.profit_today)}</span>
                </div>
                <div class="rowx">
                  <span class="muted">All Sales</span>
                  <span class="val">GHS ${money(x.total_sales)}</span>
                </div>
                <div class="rowx">
                  <span class="muted">All Profit</span>
                  <span class="val green">GHS ${money(x.total_profit)}</span>
                </div>
                <div class="rowx">
                  <span class="muted">Orders</span>
                  <span class="val">${Number(x.orders_count || 0)}</span>
                </div>
              </div>

              <div class="actions">
                <button class="btn-mini primary" data-act="open" data-slug="${escapeHtml(x.slug)}"><i class="bi bi-info-circle"></i>Details</button>
                <button class="btn-mini ok" data-act="withdraw" data-slug="${escapeHtml(x.slug)}"><i class="bi bi-cash-stack"></i>Withdraw</button>
                <button class="btn-mini warn" data-act="suspend" data-slug="${escapeHtml(x.slug)}"><i class="bi bi-pause-circle"></i>Suspend</button>
                <button class="btn-mini" data-act="resume" data-slug="${escapeHtml(x.slug)}"><i class="bi bi-play-circle"></i>Resume</button>
                <button class="btn-mini danger" data-act="delete" data-slug="${escapeHtml(x.slug)}"><i class="bi bi-trash"></i>Delete</button>
              </div>
            </div>
          `);
        }
        grid.innerHTML = out.join('');
      }

      async function suspendAll(){
        if(!confirm('Suspend ALL non-deleted stores?')) return;
        try{
          const r = await fetch('/admin/api/stores/suspend_all', {method:'POST'});
          const j = await r.json();
          if(j.success){
            tell('Suspended ' + (j.affected||0) + ' stores');
            load();
          }else{
            tell(j.message || 'Failed.');
          }
        }catch(e){
          tell('Network error.');
        }
      }

      /* ---------- Store modal ---------- */
      const storeModalEl = document.getElementById('storeModal');
      const storeModal = new bootstrap.Modal(storeModalEl);

      const m_name = document.getElementById('m_name');
      const m_slug = document.getElementById('m_slug');
      const m_owner = document.getElementById('m_owner');
      const m_wallet = document.getElementById('m_wallet');
      const m_withdrawable = document.getElementById('m_withdrawable');
      const m_withdrawn_reserved = document.getElementById('m_withdrawn_reserved');
      const m_withdrawn_paid = document.getElementById('m_withdrawn_paid');
      const m_updated = document.getElementById('m_updated');

      const m_pending_requests = document.getElementById('m_pending_requests');
      const m_req_badge = document.getElementById('m_req_badge');
      const m_req_count = document.getElementById('m_req_count');

      const m_today_sales = document.getElementById('m_today_sales');
      const m_today_profit = document.getElementById('m_today_profit');
      const m_today_orders = document.getElementById('m_today_orders');
      const m_all_sales = document.getElementById('m_all_sales');
      const m_all_profit = document.getElementById('m_all_profit');
      const m_all_orders = document.getElementById('m_all_orders');

      const m_today_orders_chip = document.getElementById('m_today_orders_chip');
      const m_all_orders_chip = document.getElementById('m_all_orders_chip');

      const m_status = document.getElementById('m_status');
      const m_open_store = document.getElementById('m_open_store');

      // payout fields (tab)
      const p_name = document.getElementById('p_name');
      const p_phone = document.getElementById('p_phone');
      const p_network = document.getElementById('p_network');
      const p_updated = document.getElementById('p_updated');
      const p_all = document.getElementById('p_all');
      const p_history_hint = document.getElementById('p_history_hint');

      // actions
      const m_act_withdraw = document.getElementById('m_act_withdraw');
      const m_act_suspend  = document.getElementById('m_act_suspend');
      const m_act_resume   = document.getElementById('m_act_resume');
      const m_act_delete   = document.getElementById('m_act_delete');

      function setPayout(p){
        const name    = p && (p.recipient_name || p.name || p.account_name) ? (p.recipient_name || p.name || p.account_name) : '—';
        const phone   = p && (p.msisdn || p.phone) ? (p.msisdn || p.phone) : '—';
        const network = p && (p.network || p.provider) ? (p.network || p.provider) : '—';

        p_name.textContent = name;
        p_phone.textContent = phone;
        p_network.textContent = network;
        p_all.textContent = name + ' • ' + phone + ' • ' + network;

        const upd = p && p.updated_at ? new Date(p.updated_at).toLocaleString() : '—';
        p_updated.textContent = upd;

        const hc = Number((p && p.history_count) ? p.history_count : 0);
        p_history_hint.textContent = hc > 0 ? (hc + ' change' + (hc===1?'':'s') + ' logged for this payout account') : 'No change history recorded';
      }

      async function openStoreModal(slug){
        currentDetailSlug = slug;
        currentDetailData = null;

        // reset UI
        m_name.textContent = 'Loading…';
        m_slug.textContent = slug || '';
        m_owner.textContent = '—';
        m_wallet.textContent = '0.00';
        m_withdrawable.textContent = '0.00';
        m_withdrawn_reserved.textContent = '0.00';
        m_withdrawn_paid.textContent = '0.00';
        m_updated.textContent = '—';

        m_pending_requests.textContent = '0';
        m_req_badge.classList.add('d-none');
        m_req_count.textContent = '0';

        m_today_sales.textContent = '0.00';
        m_today_profit.textContent = '0.00';
        m_today_orders.textContent = '0';
        m_all_sales.textContent = '0.00';
        m_all_profit.textContent = '0.00';
        m_all_orders.textContent = '0';

        m_today_orders_chip.textContent = '0 orders';
        m_all_orders_chip.textContent = '0 orders';

        m_status.className = 'chip draft';
        m_status.textContent = 'draft';

        setPayout(null);

        // ensure first tab active
        const tabBtn = document.getElementById('tab-summary');
        if(tabBtn){ new bootstrap.Tab(tabBtn).show(); }

        storeModal.show();

        try{
          const r = await fetch('/admin/api/stores/' + encodeURIComponent(slug));
          const j = await r.json();
          if(!r.ok || !j.success){
            tell(j.message || 'Failed to load store');
            return;
          }

          const s = j.store || {};
          currentDetailData = s;

          m_name.textContent = s.name || slug;
          m_slug.textContent = s.slug || slug;

          const st = String(s.status || 'draft').toLowerCase();
          m_status.className = 'chip ' + clsStatus(st);
          m_status.textContent = st;

          m_owner.textContent = s.owner_name || '—';
          m_wallet.textContent = money(s.owner_wallet);

          m_withdrawable.textContent = money(s.withdrawable);
          m_withdrawn_reserved.textContent = money(s.withdrawn_reserved);
          m_withdrawn_paid.textContent = money(s.withdrawn_paid);

          m_updated.textContent = s.updated_at ? new Date(s.updated_at).toLocaleString() : '—';

          const pr = Number(s.pending_requests || 0);
          m_pending_requests.textContent = String(pr);
          if(pr > 0){
            m_req_count.textContent = String(pr);
            m_req_badge.classList.remove('d-none');
          }else{
            m_req_badge.classList.add('d-none');
          }

          const today = s.today || {};
          const all = s.all_time || {};

          m_today_sales.textContent = money(today.sales);
          m_today_profit.textContent = money(today.profit);
          m_today_orders.textContent = String(Number(today.orders||0));
          m_today_orders_chip.textContent = String(Number(today.orders||0)) + ' orders';

          m_all_sales.textContent = money(all.sales);
          m_all_profit.textContent = money(all.profit);
          m_all_orders.textContent = String(Number(all.orders||0));
          m_all_orders_chip.textContent = String(Number(all.orders||0)) + ' orders';

          setPayout(s.payout || {});
          m_open_store.href = '/s/' + encodeURIComponent(slug);

          // actions
          m_act_withdraw.onclick = function(){
            openWithdrawModal(slug, s.name || slug, Number(s.withdrawable||0));
          };
          m_act_suspend.onclick  = function(){ updateStatus(slug, 'suspend'); };
          m_act_resume.onclick   = function(){ updateStatus(slug, 'resume'); };
          m_act_delete.onclick   = function(){ if(confirm('Delete this store?')) updateStatus(slug, 'delete'); };

          // load withdrawals list
          loadWithdrawals(slug, 1);

        }catch(e){
          tell('Network error.');
        }
      }

      async function updateStatus(slug, action){
        try{
          const r = await fetch('/admin/api/stores/' + encodeURIComponent(slug) + '/status', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({action: action})
          });
          const j = await r.json();
          if(j.success){
            tell('Done: ' + action);
            load();
            openStoreModal(slug);
          }else{
            tell(j.message || 'Failed.');
          }
        }catch(e){
          tell('Network error.');
        }
      }

      /* ---------- Withdrawals tab (existing) ---------- */
      const w_body  = document.getElementById('w_body');
      const w_pager = document.getElementById('w_pager');
      let currentWPage = 1;
      const currentWLimit = 10;

      function statusBadgeSimple(s){
        const t = String(s||'').toLowerCase();
        if(t === 'success' || t === 'paid') return '<span class="chip published">' + escapeHtml(t) + '</span>';
        if(t === 'pending') return '<span class="chip suspended">pending</span>';
        if(t === 'requested') return '<span class="chip suspended">requested</span>';
        if(t === 'failed' || t === 'rejected') return '<span class="chip deleted">' + escapeHtml(t) + '</span>';
        return '<span class="chip draft">' + escapeHtml(t||'-') + '</span>';
      }
      function methodBadge(m){
        const t = String(m||'wallet').toLowerCase();
        if(t === 'momo') return '<span class="chip suspended">momo</span>';
        return '<span class="chip">wallet</span>';
      }

      function momoDetailsCell(it){
        const m = String(it.method||'wallet').toLowerCase();
        if(m !== 'momo'){
          return `<span class="text-muted small">—</span>`;
        }
        const mm = it.momo || {};
        const name = mm.name || '-';
        const phone = mm.phone || '-';
        const net = mm.network || '-';
        const copyAll = `MoMo • ${net} • ${phone} • ${name}`;
        return `
          <div class="momo-box">
            <div class="momo-line"><span class="k">Name:</span> <span class="v">${escapeHtml(name)}</span></div>
            <div class="momo-line"><span class="k">No:</span> <span class="v mono">${escapeHtml(phone)}</span></div>
            <div class="momo-line"><span class="k">Net:</span> <span class="v">${escapeHtml(net)}</span></div>
            <div class="mt-1">
              <button class="btn-xs primary" data-copytext="${escapeHtml(copyAll)}" title="Copy MoMo details">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
        `;
      }

      async function markPaid(txId){
        const note = prompt('Optional admin note (e.g., "MoMo sent" / "Paid at counter"):', '') || '';
        try{
          const r = await fetch('/admin/api/withdrawals/' + encodeURIComponent(txId) + '/mark_paid', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({admin_note: note})
          });
          const j = await r.json();
          if(j.success){
            tell('Marked paid');
            if(currentDetailSlug){
              loadWithdrawals(currentDetailSlug, currentWPage);
              openStoreModal(currentDetailSlug);
            }
            load();
            loadGlobalRequests(); // refresh global requests too
          }else{
            tell(j.message || 'Failed.');
          }
        }catch(e){
          tell('Network error.');
        }
      }

      async function rejectTx(txId){
        const note = prompt('Reason for rejection:', '') || '';
        if(!note.trim()){
          if(!confirm('Reject without a reason?')) return;
        }
        try{
          const r = await fetch('/admin/api/withdrawals/' + encodeURIComponent(txId) + '/reject', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({admin_note: note})
          });
          const j = await r.json();
          if(j.success){
            tell('Rejected');
            if(currentDetailSlug){
              loadWithdrawals(currentDetailSlug, currentWPage);
              openStoreModal(currentDetailSlug);
            }
            load();
            loadGlobalRequests();
          }else{
            tell(j.message || 'Failed.');
          }
        }catch(e){
          tell('Network error.');
        }
      }

      async function setStatus(txId, status){
        const note = prompt('Optional admin note (leave blank if none):', '') || '';
        try{
          const r = await fetch('/admin/api/withdrawals/' + encodeURIComponent(txId) + '/set_status', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({status: status, admin_note: note})
          });
          const j = await r.json();
          if(j.success){
            tell('Status set to ' + status);
            if(currentDetailSlug){
              loadWithdrawals(currentDetailSlug, currentWPage);
              openStoreModal(currentDetailSlug);
            }
            load();
            loadGlobalRequests();
          }else{
            tell(j.message || 'Failed.');
          }
        }catch(e){
          tell('Network error.');
        }
      }

      async function loadWithdrawals(slug, page){
        currentWPage = page || 1;
        w_body.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-3">Loading…</td></tr>';
        w_pager.innerHTML = '';
        try{
          const r = await fetch('/admin/api/stores/' + encodeURIComponent(slug) + '/withdrawals?limit=' + currentWLimit + '&page=' + currentWPage);
          const j = await r.json();
          if(!r.ok || !j.success){
            w_body.innerHTML = '<tr><td colspan="9" class="text-danger text-center py-3">Failed to load.</td></tr>';
            return;
          }
          const items = j.items || [];
          if(!items.length){
            w_body.innerHTML = '<tr><td colspan="9" class="text-muted text-center py-3">No withdrawals yet.</td></tr>';
          }else{
            w_body.innerHTML = items.map(function(it){
              const created = it.created_at ? new Date(it.created_at).toLocaleString() : '-';
              const verified = it.verified_at ? new Date(it.verified_at).toLocaleString() : '-';
              const st = String(it.status||'').toLowerCase();
              const canAct = (st === 'requested' || st === 'pending');

              const quickBtns = canAct ? `
                <div class="momo-actions">
                  <button class="btn-xs ok" data-pay="${escapeHtml(it.id)}" title="Mark Paid"><i class="bi bi-check2-circle"></i> Paid</button>
                  <button class="btn-xs bad" data-rej="${escapeHtml(it.id)}" title="Reject"><i class="bi bi-x-circle"></i> Reject</button>
                </div>
              ` : `<span class="text-muted small">—</span>`;

              const statusSelect = `
                <div class="d-flex justify-content-end gap-1 align-items-center">
                  <select class="mini-select" data-stsel="${escapeHtml(it.id)}">
                    <option value="requested" ${st==='requested'?'selected':''}>requested</option>
                    <option value="pending" ${st==='pending'?'selected':''}>pending</option>
                    <option value="paid" ${st==='paid'?'selected':''}>paid</option>
                    <option value="success" ${st==='success'?'selected':''}>success</option>
                    <option value="rejected" ${st==='rejected'?'selected':''}>rejected</option>
                    <option value="failed" ${st==='failed'?'selected':''}>failed</option>
                  </select>
                  <button class="btn-xs primary" data-stapply="${escapeHtml(it.id)}" title="Apply status">
                    <i class="bi bi-save2"></i>
                  </button>
                </div>
              `;

              const note = (it.admin_note ? ('Admin: ' + it.admin_note + (it.note ? ' • ' : '')) : '') + (it.note ? it.note : '');

              return `
                <tr>
                  <td>${escapeHtml(it.reference || '-')}</td>
                  <td class="text-end">${money(it.amount)}</td>
                  <td>${methodBadge(it.method)}</td>
                  <td>${momoDetailsCell(it)}</td>
                  <td>${statusBadgeSimple(it.status)}</td>
                  <td>${created}</td>
                  <td>${verified}</td>
                  <td class="text-muted small">${escapeHtml(note || '')}</td>
                  <td class="text-end">
                    ${quickBtns}
                    <div class="mt-1">${statusSelect}</div>
                  </td>
                </tr>
              `;
            }).join('');
          }

          const total = Number(j.total || 0);
          const pages = Math.max(1, Math.ceil(total / currentWLimit));

          const parts = [];
          function mk(p, lbl, dis, act){
            return `
              <li class="page-item ${dis?'disabled':''} ${act?'active':''}">
                <button class="page-link" data-wpage="${p}" ${dis?'tabindex="-1" aria-disabled="true"':''}>${lbl}</button>
              </li>
            `;
          }

          parts.push(mk(Math.max(1, currentWPage-1), '&laquo;', currentWPage<=1, false));
          for(let p=1; p<=pages && p<=8; p++){
            parts.push(mk(p, String(p), false, p===currentWPage));
          }
          if(pages>8){
            parts.push('<li class="page-item disabled"><span class="page-link">…</span></li>');
            parts.push(mk(pages, String(pages), false, currentWPage===pages));
          }
          parts.push(mk(Math.min(pages, currentWPage+1), '&raquo;', currentWPage>=pages, false));
          w_pager.innerHTML = parts.join('');

        }catch(e){
          w_body.innerHTML = '<tr><td colspan="9" class="text-danger text-center py-3">Network error.</td></tr>';
        }
      }

      w_pager.addEventListener('click', function(e){
        const b = e.target.closest('button[data-wpage]');
        if(!b) return;
        const p = Number(b.getAttribute('data-wpage') || '1');
        if(currentDetailSlug) loadWithdrawals(currentDetailSlug, p);
      });

      // Actions in withdrawals table
      document.getElementById('pane-withdrawals').addEventListener('click', function(e){
        const payBtn = e.target.closest('button[data-pay]');
        const rejBtn = e.target.closest('button[data-rej]');
        const applyBtn = e.target.closest('button[data-stapply]');
        const copyBtn = e.target.closest('button[data-copytext]');

        if(copyBtn){
          const txt = copyBtn.getAttribute('data-copytext') || '';
          if(txt) copyText(txt);
          return;
        }
        if(payBtn){
          const id = payBtn.getAttribute('data-pay');
          if(id) markPaid(id);
          return;
        }
        if(rejBtn){
          const id = rejBtn.getAttribute('data-rej');
          if(id) rejectTx(id);
          return;
        }
        if(applyBtn){
          const id = applyBtn.getAttribute('data-stapply');
          const sel = document.querySelector('select[data-stsel="'+CSS.escape(id)+'"]');
          const st = sel ? String(sel.value||'').toLowerCase() : '';
          if(id && st) setStatus(id, st);
          return;
        }
      });

      /* ---------- Withdraw modal (existing) ---------- */
      const wdrModal = new bootstrap.Modal(document.getElementById('wdrModal'));
      const wdrStoreEl = document.getElementById('wdrStore');
      const wdrAvailEl = document.getElementById('wdrAvail');
      const wdrAmountEl = document.getElementById('wdrAmount');
      const wdrGo = document.getElementById('wdrGo');

      const wdrMethodEl = document.getElementById('wdrMethod');
      const wdrMethodHint = document.getElementById('wdrMethodHint');

      const wdrPayName = document.getElementById('wdrPayName');
      const wdrPayPhone = document.getElementById('wdrPayPhone');
      const wdrPayNetwork = document.getElementById('wdrPayNetwork');
      const wdrPayUpdated = document.getElementById('wdrPayUpdated');
      const wdrPayAll = document.getElementById('wdrPayAll');

      let wdrSlug = null;

      function setLoading(btn,on){
        const txt = btn.querySelector('.btn-text');
        const sp  = btn.querySelector('.spinner-border');
        btn.disabled = !!on;
        if(on){ if(txt) txt.classList.add('d-none'); if(sp) sp.classList.remove('d-none'); }
        else  { if(txt) txt.classList.remove('d-none'); if(sp) sp.classList.add('d-none'); }
      }

      function setWdrPayout(p){
        const name    = p && (p.recipient_name || p.name || p.account_name) ? (p.recipient_name || p.name || p.account_name) : '—';
        const phone   = p && (p.msisdn || p.phone) ? (p.msisdn || p.phone) : '—';
        const network = p && (p.network || p.provider) ? (p.network || p.provider) : '—';

        wdrPayName.textContent = name;
        wdrPayPhone.textContent = phone;
        wdrPayNetwork.textContent = network;

        wdrPayAll.textContent = name + ' • ' + phone + ' • ' + network;

        const upd = p && p.updated_at ? ('Updated ' + new Date(p.updated_at).toLocaleString()) : '';
        wdrPayUpdated.textContent = upd;
      }

      function refreshWithdrawBtnText(){
        const m = String(wdrMethodEl.value || 'wallet').toLowerCase();
        const txt = wdrGo.querySelector('.btn-text');
        if(!txt) return;
        if(m === 'momo'){
          txt.textContent = 'Create MoMo Payout';
          wdrMethodHint.textContent = "MoMo creates a PENDING payout (no wallet credit). After sending, mark it PAID in the Withdrawals tab.";
        }else{
          txt.textContent = 'Credit Wallet';
          wdrMethodHint.textContent = "Wallet credits the owner’s wallet balance.";
        }
      }
      wdrMethodEl.addEventListener('change', refreshWithdrawBtnText);

      async function openWithdrawModal(slug, name, avail){
        wdrSlug = slug;
        wdrStoreEl.textContent = (name || slug) + ' (/s/' + slug + ')';
        wdrAvailEl.textContent = money(avail);
        wdrAmountEl.value = '';
        wdrMethodEl.value = 'wallet';
        refreshWithdrawBtnText();

        if(currentDetailData && currentDetailData.slug === slug){
          setWdrPayout(currentDetailData.payout || {});
        }else{
          try{
            const r = await fetch('/admin/api/stores/' + encodeURIComponent(slug));
            const j = await r.json();
            if(j && j.success && j.store){
              setWdrPayout((j.store.payout || {}));
            }
          }catch(_){}
        }

        wdrModal.show();
      }

      wdrGo.addEventListener('click', async function(){
        if(!wdrSlug) return;

        const raw = (wdrAmountEl.value || '').trim();
        const method = String(wdrMethodEl.value || 'wallet').toLowerCase();
        const payload = raw ? {amount: Number(raw), method} : {amount: 'all', method};

        setLoading(wdrGo,true);
        try{
          const r = await fetch('/admin/api/stores/' + encodeURIComponent(wdrSlug) + '/withdraw', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const j = await r.json();

          if(j.success){
            if(j.method === 'momo'){
              tell('MoMo payout created (PENDING): ' + escapeHtml(j.reference || ''));
            }else{
              tell('Credited GHS ' + money(j.credited) + ' to owner wallet.');
            }
            wdrModal.hide();
            load();
            if(currentDetailSlug === wdrSlug){
              openStoreModal(wdrSlug);
            }
            loadGlobalRequests();
          }else{
            tell(j.message || 'Withdraw failed.');
          }
        }catch(e){
          tell('Network error.');
        }
        setLoading(wdrGo,false);
      });

      /* ---------- NEW: Global Requests modal logic ---------- */
      const reqModal = new bootstrap.Modal(document.getElementById('reqModal'));
      const reqStatus = document.getElementById('reqStatus');
      const reqQ = document.getElementById('reqQ');
      const reqReload = document.getElementById('reqReload');
      const reqTotal = document.getElementById('reqTotal');
      const reqBody = document.getElementById('reqBody');
      const reqPager = document.getElementById('reqPager');

      let reqPage = 1;
      const reqLimit = 15;

      function momoCell(mm){
        if(!mm) return `<span class="text-muted small">—</span>`;
        const name = mm.name || '-';
        const phone = mm.phone || '-';
        const net = mm.network || '-';
        const copyAll = `MoMo • ${net} • ${phone} • ${name}`;
        return `
          <div class="momo-box">
            <div class="momo-line"><span class="k">Net:</span> <span class="v">${escapeHtml(net)}</span></div>
            <div class="momo-line"><span class="k">No:</span> <span class="v mono">${escapeHtml(phone)}</span></div>
            <div class="momo-line"><span class="k">Name:</span> <span class="v">${escapeHtml(name)}</span></div>
            <div class="mt-1">
              <button class="btn-xs primary" data-copytext="${escapeHtml(copyAll)}" title="Copy MoMo details">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
          </div>
        `;
      }

      async function loadGlobalRequests(page){
        reqPage = page || 1;
        const params = new URLSearchParams();
        params.set('page', String(reqPage));
        params.set('limit', String(reqLimit));
        params.set('status', String(reqStatus.value || 'all'));
        const qq = (reqQ.value || '').trim();
        if(qq) params.set('q', qq);

        reqBody.innerHTML = `<tr><td colspan="9" class="text-muted text-center py-3">Loading…</td></tr>`;
        reqPager.innerHTML = '';

        try{
          const r = await fetch('/admin/api/withdrawals/requests?' + params.toString());
          const j = await r.json();
          if(!r.ok || !j.success){
            reqBody.innerHTML = `<tr><td colspan="9" class="text-danger text-center py-3">Failed to load.</td></tr>`;
            return;
          }

          reqTotal.textContent = String(Number(j.total||0));
          const items = j.items || [];
          if(!items.length){
            reqBody.innerHTML = `<tr><td colspan="9" class="text-muted text-center py-3">No requests.</td></tr>`;
          }else{
            reqBody.innerHTML = items.map(it=>{
              const created = it.created_at ? new Date(it.created_at).toLocaleString() : '-';
              const st = String(it.status||'').toLowerCase();
              const canAct = (st==='requested' || st==='pending');

              const quickBtns = canAct ? `
                <div class="momo-actions">
                  <button class="btn-xs ok" data-pay="${escapeHtml(it.id)}"><i class="bi bi-check2-circle"></i> Paid</button>
                  <button class="btn-xs bad" data-rej="${escapeHtml(it.id)}"><i class="bi bi-x-circle"></i> Reject</button>
                </div>
              ` : `<span class="text-muted small">—</span>`;

              const statusSelect = `
                <div class="d-flex justify-content-end gap-1 align-items-center">
                  <select class="mini-select" data-stsel="${escapeHtml(it.id)}">
                    <option value="requested" ${st==='requested'?'selected':''}>requested</option>
                    <option value="pending" ${st==='pending'?'selected':''}>pending</option>
                    <option value="paid" ${st==='paid'?'selected':''}>paid</option>
                    <option value="success" ${st==='success'?'selected':''}>success</option>
                    <option value="rejected" ${st==='rejected'?'selected':''}>rejected</option>
                    <option value="failed" ${st==='failed'?'selected':''}>failed</option>
                  </select>
                  <button class="btn-xs primary" data-stapply="${escapeHtml(it.id)}"><i class="bi bi-save2"></i></button>
                </div>
              `;

              const note = (it.admin_note ? ('Admin: ' + it.admin_note + (it.note ? ' • ' : '')) : '') + (it.note ? it.note : '');

              return `
                <tr>
                  <td>
                    <button class="btn btn-link p-0 text-decoration-none fw-bold" data-openstore="${escapeHtml(it.store_slug||'')}">
                      ${escapeHtml(it.store_name || it.store_slug || '-')}
                    </button>
                    <div class="text-muted small">/s/${escapeHtml(it.store_slug||'')}</div>
                  </td>
                  <td>${escapeHtml(it.owner_name || '-')}</td>
                  <td class="mono">${escapeHtml(it.reference || '-')}</td>
                  <td class="text-end">${money(it.amount)}</td>
                  <td>${methodBadge(it.method)}</td>
                  <td>${momoCell(it.momo)}</td>
                  <td>${statusBadgeSimple(it.status)}</td>
                  <td>${created}</td>
                  <td class="text-end">
                    ${quickBtns}
                    <div class="mt-1">${statusSelect}</div>
                    ${note ? `<div class="small text-muted mt-1">${escapeHtml(note)}</div>` : ``}
                  </td>
                </tr>
              `;
            }).join('');
          }

          const total = Number(j.total || 0);
          const pages = Math.max(1, Math.ceil(total / reqLimit));

          const parts = [];
          function mk(p, lbl, dis, act){
            return `
              <li class="page-item ${dis?'disabled':''} ${act?'active':''}">
                <button class="page-link" data-rpage="${p}" ${dis?'tabindex="-1" aria-disabled="true"':''}>${lbl}</button>
              </li>
            `;
          }

          parts.push(mk(Math.max(1, reqPage-1), '&laquo;', reqPage<=1, false));
          for(let p=1; p<=pages && p<=8; p++){
            parts.push(mk(p, String(p), false, p===reqPage));
          }
          if(pages>8){
            parts.push('<li class="page-item disabled"><span class="page-link">…</span></li>');
            parts.push(mk(pages, String(pages), false, reqPage===pages));
          }
          parts.push(mk(Math.min(pages, reqPage+1), '&raquo;', reqPage>=pages, false));
          reqPager.innerHTML = parts.join('');

        }catch(e){
          reqBody.innerHTML = `<tr><td colspan="9" class="text-danger text-center py-3">Network error.</td></tr>`;
        }
      }

      reqPager.addEventListener('click', function(e){
        const b = e.target.closest('button[data-rpage]');
        if(!b) return;
        const p = Number(b.getAttribute('data-rpage') || '1');
        loadGlobalRequests(p);
      });

      document.getElementById('reqModal').addEventListener('click', function(e){
        const payBtn = e.target.closest('button[data-pay]');
        const rejBtn = e.target.closest('button[data-rej]');
        const applyBtn = e.target.closest('button[data-stapply]');
        const copyBtn = e.target.closest('button[data-copytext]');
        const openStoreBtn = e.target.closest('button[data-openstore]');

        if(copyBtn){
          const txt = copyBtn.getAttribute('data-copytext') || '';
          if(txt) copyText(txt);
          return;
        }
        if(openStoreBtn){
          const slug = openStoreBtn.getAttribute('data-openstore');
          if(slug){
            reqModal.hide();
            openStoreModal(slug);
          }
          return;
        }
        if(payBtn){
          const id = payBtn.getAttribute('data-pay');
          if(id) markPaid(id);
          return;
        }
        if(rejBtn){
          const id = rejBtn.getAttribute('data-rej');
          if(id) rejectTx(id);
          return;
        }
        if(applyBtn){
          const id = applyBtn.getAttribute('data-stapply');
          const sel = document.querySelector('select[data-stsel="'+CSS.escape(id)+'"]');
          const st = sel ? String(sel.value||'').toLowerCase() : '';
          if(id && st) setStatus(id, st);
          return;
        }
      });

      reqReload.addEventListener('click', ()=> loadGlobalRequests(1));
      reqStatus.addEventListener('change', ()=> loadGlobalRequests(1));
      let reqTmr=null;
      reqQ.addEventListener('input', ()=>{
        clearTimeout(reqTmr);
        reqTmr=setTimeout(()=>loadGlobalRequests(1), 220);
      });

      reqGlobal.addEventListener('click', ()=>{
        reqModal.show();
        loadGlobalRequests(1);
      });

      /* ---------- Grid click handling ---------- */
      grid.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-act]');
        const card = e.target.closest('.store-card[data-slug]');
        const slug = (btn && btn.getAttribute('data-slug')) || (card && card.getAttribute('data-slug'));
        if(!slug) return;

        const act = btn ? btn.getAttribute('data-act') : 'open';

        const row = cachedRows.find(function(x){ return String(x.slug) === String(slug); }) || {};
        if(act === 'open'){
          openStoreModal(slug);
          return;
        }
        if(act === 'withdraw'){
          openWithdrawModal(slug, row.name || slug, Number(row.withdrawable || 0));
          return;
        }
        if(act === 'suspend' || act === 'resume' || act === 'delete'){
          if(act === 'delete' && !confirm('Delete this store?')) return;
          updateStatus(slug, act);
          return;
        }

        if(!btn){
          openStoreModal(slug);
        }
      });

      // Copy buttons
      bindCopyClicks(document);

      // Auto-filter typing
      let tmr = null;
      qEl.addEventListener('input', function(){
        clearTimeout(tmr);
        tmr = setTimeout(load, 220);
      });
      statusEl.addEventListener('change', load);
      sortEl.addEventListener('change', function(){
        render(applySort(cachedRows));
      });

      // initial load
      load();
    })();
  </script>
</body>
</html>
