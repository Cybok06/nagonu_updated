<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin • Stores Overview</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <style>
    :root{
      --grad-a:#0b6fa1; --grad-b:#0ea5e9;
      --ring:#e7eef7; --muted:#6b7280; --ink:#0b3b52;
      --card:#fff; --soft:#eef6ff; --shadow:0 10px 24px rgba(2,6,23,.08);
    }
    body{ background:#f6f9fc; }
    .page-header{
      background:linear-gradient(90deg,var(--grad-a),var(--grad-b));
      color:#fff; padding:16px 0; margin-bottom:16px;
    }
    .toolbar .form-control, .toolbar .form-select { border-radius:10px; }
    .card-clean{ border:none; border-radius:16px; box-shadow:var(--shadow); }
    .table thead th{ white-space:nowrap; }
    .badge-soft{ background:var(--soft); color:var(--ink); border:1px solid #e4effc; }
    .pill{ border-radius:999px; padding:.2rem .6rem; border:1px solid #e2e8f0; background:#fff; }
    .btn-icon{ display:inline-flex; align-items:center; justify-content:center; gap:.4rem; }
    .btn-icon .bi{ font-size:1rem; }

    /* Offcanvas details */
    .offcanvas-end{ width:min(920px, 100vw); } /* a little wider for payout grid */
    .kpi{
      background:var(--card); border:1px solid var(--ring); border-radius:14px; padding:14px;
    }
    .kpi .bi{ font-size:1.3rem; }
    .kpi-title{ color:var(--muted); font-size:.9rem; }
    .kpi-value{ font-weight:800; color:var(--ink); font-size:1.15rem; }
    .status-chip{ border-radius:999px; padding:.25rem .6rem; font-weight:600; border:1px solid var(--ring); }
    .status-published{ background:#ecfdf5; color:#059669; border-color:#bbf7d0; }
    .status-suspended{ background:#fffbeb; color:#b45309; border-color:#fde68a; }
    .status-draft{ background:#f3f4f6; color:#374151; border-color:#e5e7eb; }
    .status-deleted{ background:#fef2f2; color:#b91c1c; border-color:#fecaca; }
    .mini-avatar{
      width:36px; height:36px; border-radius:50%; background:#eaf2fb; display:inline-flex; align-items:center; justify-content:center;
      border:1px solid var(--ring);
    }
    .table-sm td, .table-sm th{ padding:.45rem .6rem; }
    .pagination .page-link{ border-radius:8px; }

    /* Payout UI */
    .field-row{ display:flex; align-items:center; gap:.5rem; }
    .field-label{ min-width:120px; color:var(--muted); }
    .field-value{ font-weight:700; color:var(--ink); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .copy-btn{ border:1px dashed var(--ring); background:#fff; }
    .copy-group .btn{ border-radius:10px; }
    .info-card{ border:1px solid var(--ring); background:var(--card); border-radius:14px; padding:14px; }
    .dim{ color:#6b7280; }
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' %}

  <!-- HEADER -->
  <header class="page-header">
    <div class="container d-flex justify-content-between align-items-center">
      <h1 class="h5 m-0 fw-bold"><i class="bi bi-shop-window me-2"></i>Stores (Admin)</h1>
      <div class="d-flex gap-2 toolbar">
        <input id="q" class="form-control form-control-sm" placeholder="Search store / owner">
        <select id="status" class="form-select form-select-sm" style="width:160px;">
          <option value="">All statuses</option>
          <option value="published">Published</option>
          <option value="suspended">Suspended</option>
          <option value="draft">Draft</option>
        </select>
        <button id="btnFilter" class="btn btn-light btn-sm btn-icon"><i class="bi bi-filter"></i><span>Filter</span></button>
        <button id="btnSuspendAll" class="btn btn-warning btn-sm btn-icon"><i class="bi bi-pause-circle"></i><span>Suspend All</span></button>
      </div>
    </div>
  </header>

  <!-- TABLE -->
  <main class="container">
    <div class="card card-clean">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Store</th>
              <th>Owner</th>
              <th class="text-end">Today Sales</th>
              <th class="text-end">Today Profit</th>
              <th class="text-end">All Sales</th>
              <th class="text-end">All Profit</th>
              <th class="text-center">Orders</th>
              <th class="text-end">Withdrawable</th>
              <th>Status</th>
              <th class="text-end" style="width:360px;">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" class="text-center text-muted py-4">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- TOAST -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="appToast" class="toast text-bg-dark border-0">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Done</div>
        <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- WITHDRAW MODAL -->
  <div class="modal fade" id="wdrModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-wallet2 me-1"></i>Withdraw to Owner Wallet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2 small text-muted">
            Store: <strong id="wdrStore"></strong><br>
            Withdrawable: <strong>GHS <span id="wdrAvail">0.00</span></strong>
          </div>

          <!-- Payout details (read-only, copyable) -->
          <div class="info-card mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold"><i class="bi bi-credit-card-2-front me-1"></i>Payout details</div>
              <div class="copy-group btn-group btn-group-sm" role="group" aria-label="Copy payout">
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayName" title="Copy name"><i class="bi bi-person-lines-fill"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayPhone" title="Copy phone"><i class="bi bi-telephone"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayNetwork" title="Copy network"><i class="bi bi-reception-4"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#wdrPayAll" title="Copy all"><i class="bi bi-clipboard-check"></i></button>
              </div>
            </div>
            <div class="field-row">
              <div class="field-label">Name</div>
              <div class="field-value" id="wdrPayName">—</div>
            </div>
            <div class="field-row">
              <div class="field-label">Phone</div>
              <div class="field-value mono" id="wdrPayPhone">—</div>
            </div>
            <div class="field-row">
              <div class="field-label">Network</div>
              <span class="badge text-bg-light border" id="wdrPayNetwork">—</span>
            </div>
            <div id="wdrPayAll" class="d-none"></div>
            <div class="small dim mt-2" id="wdrPayUpdated"></div>
          </div>

          <label class="form-label">Amount (leave blank for ALL)</label>
          <input type="number" step="0.01" min="0" class="form-control" id="wdrAmount" placeholder="e.g. 120.00">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" id="wdrGo">
            <span class="btn-text">Credit Wallet</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- DETAILS DRAWER -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="detailsDrawer" aria-labelledby="detailsDrawerLabel">
    <div class="offcanvas-header">
      <div>
        <h5 class="offcanvas-title d-flex align-items-center gap-2" id="detailsDrawerLabel">
          <span class="mini-avatar"><i class="bi bi-shop"></i></span>
          <span id="d_name">Store</span>
        </h5>
        <div class="text-muted small">/s/<span id="d_slug"></span></div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <!-- Top summary -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-md-6 col-lg-4">
          <div class="kpi h-100">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="bi bi-person-badge"></i><div class="kpi-title">Owner</div>
            </div>
            <div class="kpi-value" id="d_owner">—</div>
            <div class="small text-muted">Wallet: GHS <span id="d_wallet">0.00</span></div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="kpi h-100">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="bi bi-cash-coin"></i><div class="kpi-title">Withdrawable</div>
            </div>
            <div class="kpi-value">GHS <span id="d_withdrawable">0.00</span></div>
            <div class="small text-muted">Withdrawn so far: GHS <span id="d_withdrawn">0.00</span></div>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-4">
          <div class="kpi h-100">
            <div class="d-flex align-items-center gap-2 mb-1">
              <i class="bi bi-patch-check"></i><div class="kpi-title">Status</div>
            </div>
            <div id="d_status_chip">—</div>
            <div class="small text-muted">Updated <span id="d_updated">—</span></div>
          </div>
        </div>
      </div>

      <!-- KPIs grid -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-lg-6">
          <div class="kpi h-100">
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="bi bi-calendar2-day"></i><div class="kpi-title">Today</div>
            </div>
            <div class="row text-center">
              <div class="col">
                <div class="text-muted small">Sales</div>
                <div class="fw-bold">GHS <span id="d_today_sales">0.00</span></div>
              </div>
              <div class="col">
                <div class="text-muted small">Profit</div>
                <div class="fw-bold text-success">GHS <span id="d_today_profit">0.00</span></div>
              </div>
              <div class="col">
                <div class="text-muted small">Orders</div>
                <div class="fw-bold"><span id="d_today_orders">0</span></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="kpi h-100">
            <div class="d-flex align-items-center gap-2 mb-2">
              <i class="bi bi-bar-chart-steps"></i><div class="kpi-title">All-time</div>
            </div>
            <div class="row text-center">
              <div class="col">
                <div class="text-muted small">Sales</div>
                <div class="fw-bold">GHS <span id="d_all_sales">0.00</span></div>
              </div>
              <div class="col">
                <div class="text-muted small">Profit</div>
                <div class="fw-bold text-success">GHS <span id="d_all_profit">0.00</span></div>
              </div>
              <div class="col">
                <div class="text-muted small">Orders</div>
                <div class="fw-bold"><span id="d_all_orders">0</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="detailTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-actions" data-bs-toggle="tab" data-bs-target="#pane-actions" type="button" role="tab">
            <i class="bi bi-gear-wide-connected me-1"></i>Actions
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-payout" data-bs-toggle="tab" data-bs-target="#pane-payout" type="button" role="tab">
            <i class="bi bi-credit-card-2-back me-1"></i>Payout
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-withdrawals" data-bs-toggle="tab" data-bs-target="#pane-withdrawals" type="button" role="tab">
            <i class="bi bi-clock-history me-1"></i>Withdrawals History
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- Actions -->
        <div class="tab-pane fade show active" id="pane-actions" role="tabpanel">
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-success btn-icon" id="d_act_withdraw"><i class="bi bi-wallet2"></i><span>Withdraw</span></button>
            <button class="btn btn-warning btn-icon" id="d_act_suspend"><i class="bi bi-pause-circle"></i><span>Suspend</span></button>
            <button class="btn btn-primary btn-icon" id="d_act_resume"><i class="bi bi-play-circle"></i><span>Resume</span></button>
            <button class="btn btn-danger btn-icon" id="d_act_delete"><i class="bi bi-trash"></i><span>Delete</span></button>
            <a class="btn btn-outline-secondary btn-icon" target="_blank" id="d_open_store"><i class="bi bi-box-arrow-up-right"></i><span>Open Store</span></a>
          </div>
        </div>

        <!-- Payout (read-only) -->
        <div class="tab-pane fade" id="pane-payout" role="tabpanel">
          <div class="info-card">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-semibold"><i class="bi bi-shield-check me-1"></i>Current payout details</div>
              <div class="btn-group btn-group-sm copy-group">
                <button class="btn btn-outline-secondary copy-btn" data-copy="#p_name" title="Copy name"><i class="bi bi-person-lines-fill"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#p_phone" title="Copy phone"><i class="bi bi-telephone"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#p_network" title="Copy network"><i class="bi bi-reception-4"></i></button>
                <button class="btn btn-outline-secondary copy-btn" data-copy="#p_all" title="Copy all"><i class="bi bi-clipboard-check"></i></button>
              </div>
            </div>
            <div class="row gy-2">
              <div class="col-12 col-md-6">
                <div class="field-label">Name</div>
                <div class="field-value" id="p_name">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="field-label">Phone</div>
                <div class="field-value mono" id="p_phone">—</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="field-label">Network</div>
                <span class="badge text-bg-light border" id="p_network">—</span>
              </div>
              <div class="col-12 col-md-6">
                <div class="field-label">Last updated</div>
                <div class="dim" id="p_updated">—</div>
              </div>
            </div>
            <div id="p_all" class="d-none"></div>
            <div class="small mt-2 dim" id="p_history_hint">—</div>
          </div>
        </div>

        <!-- Withdrawals -->
        <div class="tab-pane fade" id="pane-withdrawals" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th>Reference</th>
                  <th class="text-end">Amount (GHS)</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Verified</th>
                  <th>Note</th>
                </tr>
              </thead>
              <tbody id="w_body">
                <tr><td colspan="6" class="text-muted text-center py-3">No data.</td></tr>
              </tbody>
            </table>
          </div>
          <nav aria-label="Withdrawals pages" class="mt-2">
            <ul class="pagination pagination-sm justify-content-end gap-1" id="w_pager"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      /* ---------- Toast ---------- */
      const toastEl = document.getElementById('appToast');
      const toast = new bootstrap.Toast(toastEl,{delay:2200});
      function tell(m){ document.getElementById('toastBody').textContent = m || 'Done'; toast.show(); }

      /* ---------- Elements ---------- */
      const tbody = document.getElementById('tbody');
      const qEl = document.getElementById('q');
      const statusEl = document.getElementById('status');
      document.getElementById('btnFilter').addEventListener('click', load);
      document.getElementById('btnSuspendAll').addEventListener('click', suspendAll);

      let cachedRows = [];

      /* ---------- Utils ---------- */
      function money(n){ return (Number(n||0)).toFixed(2); }
      function escapeHtml(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
      function attr(s){ return escapeHtml(String(s==null?'':s)); }
      function statusBadge(s){
        s = (s||'').toLowerCase();
        const map = { published:'status-published', suspended:'status-suspended', draft:'status-draft', deleted:'status-deleted' };
        const cls = map[s] || 'status-draft';
        return `<span class="status-chip ${cls}">${escapeHtml(s||'-')}</span>`;
      }
      async function copyText(text){
        try{
          if(navigator.clipboard && navigator.clipboard.writeText){
            await navigator.clipboard.writeText(text);
          }else{
            const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
            document.execCommand('copy'); ta.remove();
          }
          tell('Copied');
        }catch(e){ tell('Copy failed'); }
      }
      function bindCopyClicks(scope){
        scope.querySelectorAll('[data-copy]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const target = btn.getAttribute('data-copy');
            const el = scope.querySelector(target) || document.querySelector(target);
            if(!el) return;
            const txt = (el.textContent || '').trim();
            if(txt) copyText(txt);
          });
        });
      }

      /* ---------- Load & Render grid ---------- */
      async function load(){
        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Loading…</td></tr>';
        const params = new URLSearchParams();
        if(qEl.value.trim()) params.set('q', qEl.value.trim());
        if(statusEl.value) params.set('status', statusEl.value);
        params.set('limit','200');
        try{
          const r = await fetch('/admin/api/stores?'+params.toString());
          const j = await r.json();
          if(!r.ok || !j.success){ tbody.innerHTML = '<tr><td colspan="10" class="text-danger text-center py-4">Failed to load.</td></tr>'; return; }
          cachedRows = j.rows || [];
          render(cachedRows);
        }catch(e){
          tbody.innerHTML = '<tr><td colspan="10" class="text-danger text-center py-4">Network error.</td></tr>';
        }
      }

      function render(rows){
        if(!rows.length){
          tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No stores found.</td></tr>';
          return;
        }
        const out=[];
        for(const x of rows){
          out.push(
            `<tr>
              <td>
                <div class="fw-semibold">
                  <button class="btn btn-link p-0 text-decoration-none" data-act="details" data-slug="${attr(x.slug)}">${escapeHtml(x.name||'-')}</button>
                </div>
                <div class="text-muted small">/s/${escapeHtml(x.slug)}</div>
              </td>
              <td>${escapeHtml(x.owner_name||'-')}</td>
              <td class="text-end">GHS ${money(x.sales_today)}</td>
              <td class="text-end text-success">GHS ${money(x.profit_today)}</td>
              <td class="text-end">GHS ${money(x.total_sales)}</td>
              <td class="text-end text-success">GHS ${money(x.total_profit)}</td>
              <td class="text-center">${x.orders_count||0}</td>
              <td class="text-end"><span class="pill">GHS ${money(x.withdrawable)}</span></td>
              <td>${statusBadge(x.status)}</td>
              <td class="text-end">
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-secondary" data-act="details" data-slug="${attr(x.slug)}" title="Details"><i class="bi bi-info-circle"></i></button>
                  <button class="btn btn-sm btn-outline-success" data-act="withdraw" data-slug="${attr(x.slug)}" data-name="${attr(x.name)}" data-avail="${attr(x.withdrawable)}" title="Withdraw"><i class="bi bi-wallet2"></i></button>
                  <button class="btn btn-sm btn-outline-warning" data-act="suspend" data-slug="${attr(x.slug)}" title="Suspend"><i class="bi bi-pause-circle"></i></button>
                  <button class="btn btn-sm btn-outline-primary" data-act="resume" data-slug="${attr(x.slug)}" title="Resume"><i class="bi bi-play-circle"></i></button>
                  <button class="btn btn-sm btn-outline-danger" data-act="delete" data-slug="${attr(x.slug)}" title="Delete"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>`
          );
        }
        tbody.innerHTML = out.join('');
      }

      async function suspendAll(){
        if(!confirm('Suspend ALL non-deleted stores?')) return;
        try{
          const r = await fetch('/admin/api/stores/suspend_all', {method:'POST'});
          const j = await r.json();
          if(j.success){ tell('Suspended '+(j.affected||0)+' stores'); load(); }
          else tell(j.message || 'Failed.');
        }catch(e){ tell('Network error.'); }
      }

      /* ---------- Row actions ---------- */
      tbody.addEventListener('click', async (e)=>{
        const b = e.target.closest('button[data-act],a[data-act],.btn-link[data-act]');
        if(!b) return;
        const act = b.getAttribute('data-act');
        const slug = b.getAttribute('data-slug');

        if(act === 'details'){ openDetails(slug); return; }
        if(act === 'withdraw'){
          const name = b.getAttribute('data-name') || slug;
          const avail = Number(b.getAttribute('data-avail') || 0);
          openWithdrawModal(slug, name, avail);
          return;
        }
        if(act === 'suspend' || act === 'resume' || act === 'delete'){
          if(act === 'delete' && !confirm('Delete this store?')) return;
          try{
            const r = await fetch('/admin/api/stores/'+encodeURIComponent(slug)+'/status', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({action: act})
            });
            const j = await r.json();
            if(j.success){ tell('Done: '+act); load(); }
            else tell(j.message || 'Failed.');
          }catch(e){ tell('Network error.'); }
        }
      });

      /* ---------- Withdraw modal ---------- */
      const wdrModal = new bootstrap.Modal(document.getElementById('wdrModal'));
      const wdrStoreEl = document.getElementById('wdrStore');
      const wdrAvailEl = document.getElementById('wdrAvail');
      const wdrAmountEl = document.getElementById('wdrAmount');
      const wdrGo = document.getElementById('wdrGo');
      // payout fields inside modal
      const wdrPayName = document.getElementById('wdrPayName');
      const wdrPayPhone = document.getElementById('wdrPayPhone');
      const wdrPayNetwork = document.getElementById('wdrPayNetwork');
      const wdrPayUpdated = document.getElementById('wdrPayUpdated');
      const wdrPayAll = document.getElementById('wdrPayAll');

      let wdrSlug = null;
      let currentPayout = null; // cache last loaded payout for modal

      function setWdrPayout(p){
        const name    = p?.name    || p?.account_name || '—';
        const phone   = p?.phone   || p?.msisdn || '—';
        const network = p?.network || p?.provider || '—';
        wdrPayName.textContent = name;
        wdrPayPhone.textContent = phone;
        wdrPayNetwork.textContent = network;
        wdrPayUpdated.textContent = p?.updated_at ? ('Updated '+ new Date(p.updated_at).toLocaleString()) : '';
        wdrPayAll.textContent = `${name} • ${phone} • ${network}`;
        bindCopyClicks(document);
      }

      function openWithdrawModal(slug, name, avail){
        wdrSlug = slug;
        wdrStoreEl.textContent = name + ' (/s/'+slug+')';
        wdrAvailEl.textContent = money(avail);
        wdrAmountEl.value = '';
        // If we already loaded details for this slug, reuse payout; otherwise it will be set when drawer loads.
        if(currentDetailSlug === slug && currentPayout){
          setWdrPayout(currentPayout);
        }else{
          // lightweight fetch just to populate payout quickly
          fetch('/admin/api/stores/'+encodeURIComponent(slug)).then(r=>r.json()).then(j=>{
            const s = j.store || {};
            const p = s.payout || s.payout_settings || {};
            setWdrPayout(p);
          }).catch(()=>{ /* ignore */ });
        }
        wdrModal.show();
      }
      function setLoading(btn,on){
        const txt = btn.querySelector('.btn-text');
        const sp  = btn.querySelector('.spinner-border');
        btn.disabled = !!on;
        if(on){ if(txt) txt.classList.add('d-none'); if(sp) sp.classList.remove('d-none'); }
        else  { if(txt) txt.classList.remove('d-none'); if(sp) sp.classList.add('d-none'); }
      }
      wdrGo.addEventListener('click', async ()=>{
        if(!wdrSlug) return;
        const raw = wdrAmountEl.value.trim();
        const payload = raw ? {amount: Number(raw)} : {amount: 'all'};
        setLoading(wdrGo,true);
        try{
          const r = await fetch('/admin/api/stores/'+encodeURIComponent(wdrSlug)+'/withdraw', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const j = await r.json();
          if(j.success){
            tell('Credited GHS '+money(j.credited)+' to owner wallet.');
            wdrModal.hide();
            load();
            if(currentDetailSlug === wdrSlug){ loadDetailsSummary(wdrSlug); loadWithdrawals(wdrSlug, currentWPage); }
          }else{
            tell(j.message || 'Withdraw failed.');
          }
        }catch(e){ tell('Network error.'); }
        setLoading(wdrGo,false);
      });

      /* ---------- Details Drawer & tabs ---------- */
      const drawerEl = document.getElementById('detailsDrawer');
      const drawer = new bootstrap.Offcanvas(drawerEl);
      let currentDetailSlug = null;

      // Summary elements
      const d_name = document.getElementById('d_name');
      const d_slug = document.getElementById('d_slug');
      const d_owner = document.getElementById('d_owner');
      const d_wallet = document.getElementById('d_wallet');
      const d_withdrawable = document.getElementById('d_withdrawable');
      const d_withdrawn = document.getElementById('d_withdrawn');
      const d_status_chip = document.getElementById('d_status_chip');
      const d_updated = document.getElementById('d_updated');
      const d_today_sales = document.getElementById('d_today_sales');
      const d_today_profit = document.getElementById('d_today_profit');
      const d_today_orders = document.getElementById('d_today_orders');
      const d_all_sales = document.getElementById('d_all_sales');
      const d_all_profit = document.getElementById('d_all_profit');
      const d_all_orders = document.getElementById('d_all_orders');

      // Payout drawer fields
      const p_name = document.getElementById('p_name');
      const p_phone = document.getElementById('p_phone');
      const p_network = document.getElementById('p_network');
      const p_updated = document.getElementById('p_updated');
      const p_all = document.getElementById('p_all');
      const p_history_hint = document.getElementById('p_history_hint');

      const d_act_withdraw = document.getElementById('d_act_withdraw');
      const d_act_suspend  = document.getElementById('d_act_suspend');
      const d_act_resume   = document.getElementById('d_act_resume');
      const d_act_delete   = document.getElementById('d_act_delete');
      const d_open_store   = document.getElementById('d_open_store');

      function setDrawerPayout(p){
        const name    = p?.name    || p?.account_name || '—';
        const phone   = p?.phone   || p?.msisdn || '—';
        const network = p?.network || p?.provider || '—';
        p_name.textContent = name;
        p_phone.textContent = phone;
        p_network.textContent = network;
        p_all.textContent = `${name} • ${phone} • ${network}`;
        p_updated.textContent = p?.updated_at ? new Date(p.updated_at).toLocaleString() : '—';
        const histN = Number(p?.history_count || p?.changes_count || 0);
        p_history_hint.textContent = histN > 0 ? (`${histN} change${histN===1?'':'s'} logged for this payout account`) : 'No change history recorded';
        currentPayout = p; // cache for modal reuse
        bindCopyClicks(document);
      }

      async function loadDetailsSummary(slug){
        try{
          const r = await fetch('/admin/api/stores/'+encodeURIComponent(slug));
          const j = await r.json();
          if(!r.ok || !j.success){ tell(j.message || 'Failed to load store.'); return; }
          const s = j.store || {};
          d_name.textContent = s.name || slug;
          d_slug.textContent = slug;
          d_owner.textContent = s.owner_name || '—';
          d_wallet.textContent = money(s.owner_wallet);
          d_withdrawable.textContent = money(s.withdrawable);
          d_withdrawn.textContent = money(s.withdrawn_so_far || (s.all_time?.profit - s.withdrawable));
          d_status_chip.innerHTML = statusBadge(s.status);
          d_updated.textContent = s.updated_at ? new Date(s.updated_at).toLocaleString() : '—';
          d_today_sales.textContent = money(s.today?.sales);
          d_today_profit.textContent = money(s.today?.profit);
          d_today_orders.textContent = Number(s.today?.orders||0);
          d_all_sales.textContent = money(s.all_time?.sales);
          d_all_profit.textContent = money(s.all_time?.profit);
          d_all_orders.textContent = Number(s.all_time?.orders||0);

          // Payout details
          const payout = s.payout || s.payout_settings || {};
          setDrawerPayout(payout);

          // Drawer action buttons
          d_act_withdraw.onclick = ()=> openWithdrawModal(slug, s.name || slug, s.withdrawable || 0);
          d_act_suspend.onclick  = ()=> updateStatus(slug, 'suspend');
          d_act_resume.onclick   = ()=> updateStatus(slug, 'resume');
          d_act_delete.onclick   = ()=> { if(confirm('Delete this store?')) updateStatus(slug, 'delete'); };
          d_open_store.href      = '/s/'+encodeURIComponent(slug);
        }catch(e){
          tell('Network error.');
        }
      }

      async function updateStatus(slug, action){
        try{
          const r = await fetch('/admin/api/stores/'+encodeURIComponent(slug)+'/status', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({action})
          });
          const j = await r.json();
          if(j.success){ tell('Done: '+action); load(); loadDetailsSummary(slug); }
          else tell(j.message || 'Failed.');
        }catch(e){ tell('Network error.'); }
      }

      // Withdrawals tab
      const w_body  = document.getElementById('w_body');
      const w_pager = document.getElementById('w_pager');
      let currentWPage = 1, currentWLimit = 10;

      async function loadWithdrawals(slug, page=1){
        currentWPage = page;
        w_body.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Loading…</td></tr>';
        w_pager.innerHTML = '';
        try{
          const r = await fetch(`/admin/api/stores/${encodeURIComponent(slug)}/withdrawals?limit=${currentWLimit}&page=${page}`);
          const j = await r.json();
          if(!r.ok || !j.success){ w_body.innerHTML = '<tr><td colspan="6" class="text-danger text-center py-3">Failed to load.</td></tr>'; return; }
          const items = j.items || [];
          if(!items.length){
            w_body.innerHTML = '<tr><td colspan="6" class="text-muted text-center py-3">No withdrawals yet.</td></tr>';
          }else{
            const rows = items.map(it => `
              <tr>
                <td>${escapeHtml(it.reference||'-')}</td>
                <td class="text-end">${money(it.amount)}</td>
                <td>${statusBadge(it.status)}</td>
                <td>${it.created_at ? new Date(it.created_at).toLocaleString() : '-'}</td>
                <td>${it.verified_at ? new Date(it.verified_at).toLocaleString() : '-'}</td>
                <td class="text-muted small">${escapeHtml(it.note||'')}</td>
              </tr>
            `);
            w_body.innerHTML = rows.join('');
          }
          // pager
          const total = Number(j.total||0);
          const pages = Math.max(1, Math.ceil(total / currentWLimit));
          const parts=[];
          const mk = (p, lbl, dis=false, act=false)=>`
            <li class="page-item ${dis?'disabled':''} ${act?'active':''}">
              <button class="page-link" data-wpage="${p}" ${dis?'tabindex="-1" aria-disabled="true"':''}>${lbl}</button>
            </li>`;
          parts.push(mk(Math.max(1, page-1), '&laquo;', page<=1, false));
          for(let p=1;p<=pages && p<=8;p++){ parts.push(mk(p, String(p), false, p===page)); }
          if(pages>8){ parts.push(`<li class="page-item disabled"><span class="page-link">…</span></li>`); parts.push(mk(pages, String(pages), false, page===pages)); }
          parts.push(mk(Math.min(pages, page+1), '&raquo;', page>=pages, false));
          w_pager.innerHTML = parts.join('');
        }catch(e){
          w_body.innerHTML = '<tr><td colspan="6" class="text-danger text-center py-3">Network error.</td></tr>';
        }
      }

      w_pager.addEventListener('click', (e)=>{
        const b = e.target.closest('button[data-wpage]');
        if(!b) return;
        const p = Number(b.getAttribute('data-wpage')||'1');
        loadWithdrawals(currentDetailSlug, p);
      });

      function openDetails(slug){
        currentDetailSlug = slug;
        const tabTrigger = document.querySelector('#tab-actions');
        if(tabTrigger){ new bootstrap.Tab(tabTrigger).show(); }
        drawer.show();
        loadDetailsSummary(slug);
        loadWithdrawals(slug, 1);
      }

      // Bind global copy buttons (drawer + modal)
      bindCopyClicks(document);

      // initial load
      load();
    })();
  </script>
</body>
</html>
