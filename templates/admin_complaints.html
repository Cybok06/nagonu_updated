<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Complaints</title>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .table td, .table th { vertical-align: middle; }
    .thumb {
      width: 100px; height: auto; border-radius: 6px;
      border: 1px solid #e5e7eb; background: #f9fafb;
    }
    .filter-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 1.5rem; }
    @media (max-width: 576px) { .filter-bar { flex-direction: column; align-items: stretch; } }
    .badge-status { font-weight: 600; }
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' %}

  <div class="container py-4">
    <h2 class="text-primary fw-bold mb-4">ðŸ›‘ Customer Complaints</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Filter Form -->
    <form method="get" class="filter-bar">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label mb-0">Status:</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">All</option>
          <option value="pending"  {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
          <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Resolved</option>
          <option value="refund"   {% if status_filter == 'refund' %}selected{% endif %}>Refund</option>
          <option value="false"    {% if status_filter == 'false' %}selected{% endif %}>False</option>
          <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
        </select>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label mb-0">Start Date:</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="form-control form-control-sm">
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label mb-0">End Date:</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="form-control form-control-sm">
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-outline-primary btn-sm">Filter</button>
        <a href="{{ url_for('admin_complaints.admin_view_complaints', status=status_filter, start_date=start_date, end_date=end_date, export='excel') }}"
           class="btn btn-success btn-sm">ðŸ“¥ Excel</a>
        <a href="{{ url_for('admin_complaints.admin_view_complaints', status=status_filter, start_date=start_date, end_date=end_date, export='pdf') }}"
           class="btn btn-danger btn-sm">ðŸ“„ PDF</a>
      </div>
    </form>

    <!-- Complaints Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>#</th>
            <th>Customer</th>
            <th>Store</th>
            <th>Order Ref</th>
            <th>Payment Date</th>
            <th>Service / Offer</th>
            <th>Proofs</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for c in complaints %}
          <tr>
            <td class="text-center">{{ ((page - 1) * per_page) + loop.index }}</td>

            <!-- Customer -->
            <td>
              <strong>{{ c.customer_name or 'â€”' }}</strong><br>
              <small>{{ c.customer_phone or 'â€”' }}</small>
            </td>

            <!-- Store -->
            <td>
              {% if c.store_name %}
                <strong>{{ c.store_name }}</strong><br>
              {% endif %}
              <small>{{ c.store_slug or 'â€”' }}</small>
            </td>

            <!-- Order Ref -->
            <td>
              {% if c.order_ref and c.order_ref.order_no %}
                <div><span class="text-muted">order_no:</span> <code>{{ c.order_ref.order_no }}</code></div>
              {% endif %}
              {% if c.order_ref and c.order_ref.order_id %}
                <div><span class="text-muted">order_id:</span> <code>{{ c.order_ref.order_id }}</code></div>
              {% endif %}
              {% if c.paystack_reference %}
                <div><span class="text-muted">paystack:</span> <code>{{ c.paystack_reference }}</code></div>
                {% if c.flagged_ref_exists %}
                  <div class="mt-1">
                    <span class="badge text-bg-danger">
                      Ref already has order{% if c.flagged_ref_order_id %}: {{ c.flagged_ref_order_id }}{% endif %}
                    </span>
                  </div>
                {% else %}
                  <div class="mt-1"><span class="badge text-bg-success">No order for ref</span></div>
                {% endif %}
              {% endif %}
              {% if c.flagged_ref_exists %}
                <div class="text-danger small mt-1">
                  There is order with this paystack ref{% if c.flagged_ref_order_id %}, order id: <code>{{ c.flagged_ref_order_id }}</code>{% endif %}
                </div>
              {% endif %}
              {% if c.order_date_str %}
                <div><span class="text-muted">Order Date:</span> {{ c.order_date_str }}</div>
              {% endif %}
            </td>

            <!-- Payment Date -->
            <td class="text-center">
              {{ c.payment_date or 'â€”' }}
            </td>

            <!-- Service / Offer -->
            <td>
              {{ c.service_name or 'â€”' }}
              {% if c.offer %}<br><small class="text-muted">{{ c.offer }}</small>{% endif %}
            </td>

            <!-- Proofs -->
            <td class="text-center">
              {% if c.screenshots and (c.screenshots.data_balance or c.screenshots.phone_msisdn) %}
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                  {% if c.screenshots.data_balance %}
                    <a href="{{ c.screenshots.data_balance }}" target="_blank" title="Data balance">
                      <img src="{{ c.screenshots.data_balance }}" class="thumb" alt="Data balance proof">
                    </a>
                  {% endif %}
                  {% if c.screenshots.phone_msisdn %}
                    <a href="{{ c.screenshots.phone_msisdn }}" target="_blank" title="Phone number">
                      <img src="{{ c.screenshots.phone_msisdn }}" class="thumb" alt="Phone number proof">
                    </a>
                  {% endif %}
                </div>
              {% elif c.image_path %}
                <!-- Legacy single image -->
                <a href="{{ c.image_path }}" target="_blank">
                  <img src="{{ c.image_path }}" class="thumb" alt="Proof">
                </a>
              {% else %}
                <span class="text-muted">No Proof</span>
              {% endif %}

              {% if c.description %}
                <!-- Legacy description shown small if present -->
                <div class="mt-1"><small class="text-muted">{{ c.description }}</small></div>
              {% endif %}
            </td>

            <!-- Status -->
            <td class="text-center">
              <span class="badge badge-status
                {% if c.status == 'pending' %} text-bg-warning
                {% elif c.status == 'resolved' %} text-bg-success
                {% elif c.status == 'refund' %} text-bg-danger
                {% elif c.status == 'false' %} text-bg-secondary
                {% elif c.status == 'rejected' %} text-bg-dark
                {% else %} text-bg-secondary {% endif %}">
                {{ c.status|capitalize }}
              </span>
            </td>

            <!-- Submitted -->
            <td class="text-center">
              {{ c.submitted_at_str or 'N/A' }}
            </td>

            <!-- Action -->
            <td class="text-center">
              <div class="d-grid gap-2">
                <form method="POST" action="{{ url_for('admin_complaints.update_complaint_status', complaint_id=c._id) }}">
                  <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                    <option value="">Update</option>
                    <option value="resolved">Resolved</option>
                    <option value="refund">Refund</option>
                    <option value="false">False</option>
                    <option value="rejected">Rejected</option>
                  </select>
                </form>
                {% if c.store_slug and c.cart_snapshot and c.status == 'pending' %}
                  <a class="btn btn-sm btn-primary" href="{{ url_for('admin_complaints.open_complaint_store', complaint_id=c._id) }}">
                    Open Store to Process
                  </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="text-center text-muted">No complaints found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if total_pages and total_pages > 1 %}
    <nav aria-label="Complaints pagination" class="mt-3">
      <ul class="pagination justify-content-center pagination-sm">
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_complaints.admin_view_complaints', page=page-1) }}{% if filters_query %}&{{ filters_query }}{% endif %}">Prev</a>
        </li>
        {% set start_page = (page - 2) if (page - 2) > 1 else 1 %}
        {% set end_page = (page + 2) if (page + 2) < total_pages else total_pages %}
        {% for p in range(start_page, end_page + 1) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('admin_complaints.admin_view_complaints', page=p) }}{% if filters_query %}&{{ filters_query }}{% endif %}">{{ p }}</a>
          </li>
        {% endfor %}
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('admin_complaints.admin_view_complaints', page=page+1) }}{% if filters_query %}&{{ filters_query }}{% endif %}">Next</a>
        </li>
      </ul>
    </nav>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
