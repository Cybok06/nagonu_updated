<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Complaints</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .table td, .table th { vertical-align: middle; }
    .thumb {
      width: 100px; height: auto; border-radius: 6px;
      border: 1px solid #e5e7eb; background: #f9fafb;
    }
    .filter-bar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 1.5rem; }
    @media (max-width: 576px) { .filter-bar { flex-direction: column; align-items: stretch; } }
    .badge-status { font-weight: 600; }
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' %}

  <div class="container py-4">
    <h2 class="text-primary fw-bold mb-4">ðŸ›‘ Customer Complaints</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Filter Form -->
    <form method="get" class="filter-bar">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label mb-0">Status:</label>
        <select name="status" class="form-select form-select-sm">
          <option value="">All</option>
          <option value="pending"  {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
          <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Resolved</option>
          <option value="refund"   {% if status_filter == 'refund' %}selected{% endif %}>Refund</option>
        </select>
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label mb-0">Start Date:</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="form-control form-control-sm">
      </div>

      <div class="d-flex flex-wrap gap-2 align-items-center">
        <label class="form-label mb-0">End Date:</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="form-control form-control-sm">
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-outline-primary btn-sm">Filter</button>
        <a href="{{ url_for('admin_complaints.admin_view_complaints', status=status_filter, start_date=start_date, end_date=end_date, export='excel') }}"
           class="btn btn-success btn-sm">ðŸ“¥ Excel</a>
        <a href="{{ url_for('admin_complaints.admin_view_complaints', status=status_filter, start_date=start_date, end_date=end_date, export='pdf') }}"
           class="btn btn-danger btn-sm">ðŸ“„ PDF</a>
      </div>
    </form>

    <!-- Complaints Table -->
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark text-center">
          <tr>
            <th>#</th>
            <th>Customer</th>
            <th>Order Ref</th>
            <th>Service / Offer</th>
            <th>Proofs</th>
            <th>Status</th>
            <th>Submitted</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for c in complaints %}
          <tr>
            <td class="text-center">{{ loop.index }}</td>

            <!-- Customer -->
            <td>
              <strong>{{ c.customer_name or 'â€”' }}</strong><br>
              <small>{{ c.customer_phone or 'â€”' }}</small>
            </td>

            <!-- Order Ref -->
            <td>
              {% if c.order_no_display %}
                <div><span class="text-muted">Entered:</span> <code>{{ c.order_no_display }}</code></div>
              {% endif %}
              {% if c.order_ref and c.order_ref._id %}
                <div><span class="text-muted">_id:</span> <code>{{ c.order_ref._id }}</code></div>
              {% endif %}
              {% if c.order_ref and c.order_ref.order_no %}
                <div><span class="text-muted">order_no:</span> <code>{{ c.order_ref.order_no }}</code></div>
              {% endif %}
              {% if c.order_ref and c.order_ref.order_id %}
                <div><span class="text-muted">order_id:</span> <code>{{ c.order_ref.order_id }}</code></div>
              {% endif %}
              {% if c.order_date_str %}
                <div><span class="text-muted">Order Date:</span> {{ c.order_date_str }}</div>
              {% endif %}
            </td>

            <!-- Service / Offer -->
            <td>
              {{ c.service_name or 'â€”' }}
              {% if c.offer %}<br><small class="text-muted">{{ c.offer }}</small>{% endif %}
            </td>

            <!-- Proofs -->
            <td class="text-center">
              {% if c.screenshots and (c.screenshots.data_balance or c.screenshots.phone_msisdn) %}
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                  {% if c.screenshots.data_balance %}
                    <a href="{{ c.screenshots.data_balance }}" target="_blank" title="Data balance">
                      <img src="{{ c.screenshots.data_balance }}" class="thumb" alt="Data balance proof">
                    </a>
                  {% endif %}
                  {% if c.screenshots.phone_msisdn %}
                    <a href="{{ c.screenshots.phone_msisdn }}" target="_blank" title="Phone number">
                      <img src="{{ c.screenshots.phone_msisdn }}" class="thumb" alt="Phone number proof">
                    </a>
                  {% endif %}
                </div>
              {% elif c.image_path %}
                <!-- Legacy single image -->
                <a href="{{ c.image_path }}" target="_blank">
                  <img src="{{ c.image_path }}" class="thumb" alt="Proof">
                </a>
              {% else %}
                <span class="text-muted">No Proof</span>
              {% endif %}

              {% if c.description %}
                <!-- Legacy description shown small if present -->
                <div class="mt-1"><small class="text-muted">{{ c.description }}</small></div>
              {% endif %}
            </td>

            <!-- Status -->
            <td class="text-center">
              <span class="badge badge-status
                {% if c.status == 'pending' %} text-bg-warning
                {% elif c.status == 'resolved' %} text-bg-success
                {% elif c.status == 'refund' %} text-bg-danger
                {% else %} text-bg-secondary {% endif %}">
                {{ c.status|capitalize }}
              </span>
            </td>

            <!-- Submitted -->
            <td class="text-center">
              {{ c.submitted_at_str or 'N/A' }}
            </td>

            <!-- Action -->
            <td class="text-center">
              <form method="POST" action="{{ url_for('admin_complaints.update_complaint_status', complaint_id=c._id) }}">
                <select name="status" class="form-select form-select-sm" onchange="this.form.submit()">
                  <option value="">Update</option>
                  <option value="resolved">Resolved</option>
                  <option value="refund">Refund</option>
                </select>
              </form>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center text-muted">No complaints found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
