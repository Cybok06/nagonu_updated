<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Check Order Status â€” Nagonu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,follow" />
<link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <style>
    :root{ --sea:#0ea5e9; --sea-deep:#0b6fa1; }
    .navbar{ background: linear-gradient(90deg, var(--sea-deep), var(--sea)); }
    .navbar-brand img{ height:46px; width:46px; border-radius:10px; object-fit:cover; border:2px solid #fff3; }
    .status-card{ border:none; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.06); }
    .badge-status{ font-weight:600; }
    .table thead th{ white-space: nowrap; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark px-3">
    <a class="navbar-brand d-flex align-items-center" href="/">
      <img src="https://res.cloudinary.com/dcmewvlyx/image/upload/v1754392905/Ngonu_Logo_xntvbm.jpg" alt="Nagonu">
      <span class="ms-2 fw-semibold text-white">Nagonu</span>
    </a>
    <a href="/" class="btn btn-light btn-sm">Back to Home</a>
  </nav>

  <main class="container my-4 my-md-5">
    <div class="card status-card p-3 p-md-4">
      <h1 class="h4 mb-3">Check your order status</h1>
      <form class="row g-2" method="get" action="/check-status" onsubmit="return normalizeAndSubmit(event)">
        <div class="col-12 col-md-6 col-lg-5">
          <label for="phone" class="form-label mb-1">Phone number used for the order</label>
          <input type="tel" id="phone" name="phone" class="form-control form-control-lg" placeholder="0xxxxxxxxx"
                 value="{{ phone or '' }}" inputmode="numeric" maxlength="14" required />
        </div>
        <div class="col-12 col-md-6 col-lg-3 d-flex align-items-end">
          <button class="btn btn-primary btn-lg w-100" type="submit">
            <i class="bi bi-search"></i> Check Status
          </button>
        </div>
      </form>
    </div>

    {% if phone %}
    <div class="mt-4">
      <h2 class="h5">Results for <span class="text-primary fw-semibold">{{ phone }}</span></h2>

      {% if not results %}
        <div class="alert alert-info mt-3">No orders found for this phone number.</div>
      {% else %}
        {% for od in results %}
          <div class="card status-card p-3 p-md-4 mt-3">
            <div class="d-flex flex-column flex-md-row justify-content-between">
              <div>
                <div class="fw-semibold">Order ID: {{ od.order_id }}</div>
                <div class="text-muted small">Created: {{ od.created_at }} &middot; Updated: {{ od.updated_at }}</div>
              </div>
              <div class="mt-2 mt-md-0 text-md-end">
                <span class="badge rounded-pill bg-secondary me-1">{{ od.paid_from }}</span>

                {# --- NEW: amount shown as round(nearest) + 1 --- #}
                {% set shown_amt = ((od.charged_amount or 0)|round(0,'common')) + 1 %}
                <span class="badge rounded-pill bg-info text-dark me-1">GHS {{ shown_amt|int }}</span>

                {% set st = (od.status or '').lower() %}
                {% if st == 'completed' %}
                  <span class="badge badge-status rounded-pill bg-success">Completed</span>
                {% elif st == 'failed' %}
                  <span class="badge badge-status rounded-pill bg-danger">Failed</span>
                {% elif st == 'processing' %}
                  <span class="badge badge-status rounded-pill bg-warning text-dark">Processing</span>
                {% else %}
                  <span class="badge badge-status rounded-pill bg-secondary">{{ od.status }}</span>
                {% endif %}
              </div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Service</th>
                    <th>Offer</th>
                    <th>Provider</th>
                    <th>Line Status</th>
                    <th>API Status</th>
                    <th>Ref</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in od.lines %}
                    <tr>
                      <td>{{ it.service }}</td>
                      <td>{{ it.value }}</td>
                      <td>{{ it.provider }}</td>
                      <td>{{ it.line_status }}</td>
                      <td>{{ it.api_status }}</td>
                      <td class="text-break">{{ it.trx_ref }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>
    {% endif %}
  </main>

  <script>
    function normalizeAndSubmit(ev){
      ev.preventDefault();
      var inp = document.getElementById('phone');
      var d = (inp.value||'').replace(/\D+/g,'');
      if (d.startsWith('233')) d = '0'+d.slice(3);
      if (d.length > 10) d = d.slice(-10);
      inp.value = d;
      ev.target.submit();
      return false;
    }
  </script>
</body>
</html>
