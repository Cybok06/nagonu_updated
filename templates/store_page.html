<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>{{ store.name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  {% set t = store.theme or {} %}
  <meta name="theme-color" content="{{ t.primary or '#0ea5e9' }}"/>

  <link rel="icon" type="image/png"
        href="{{ (store.logo_url or '') if (store.logo_url and store.logo_url|length>0) else 'https://via.placeholder.com/256?text=Store' }}">

  <style>
    :root{
      --primary: {{ t.primary or '#0ea5e9' }};
      --accent:  {{ t.accent  or '#0b6fa1' }};
      --bg:      {{ t.bg      or '#f7fbfe' }};
      --text:    {{ t.text    or '#06354a' }};
      --ink:     #0b3b52;
      --muted:   #6b7280;
      --card:    #ffffff;
      --ring:    #e7eef7;
      --shadow:  0 14px 34px rgba(2,6,23,.09);
    }

    html,body{ height:100%; }
    body{
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      background:#fafcff;
    }
    .container-wide{ max-width:1160px; }

    /* Navbar */
    .navbar{ background:linear-gradient(90deg,var(--accent),var(--primary)); }
    .brand-wrap{ display:flex; align-items:center; gap:.75rem; color:#fff; text-decoration:none; }
    .brand-logo{
      width:48px; height:48px; border-radius:14px;
      border:2px solid rgba(255,255,255,.45); object-fit:cover; display:block; background:#fff;
      box-shadow:0 6px 16px rgba(2,6,23,.15);
    }
    .brand-text{ color:#fff; font-weight:800; letter-spacing:.2px; line-height:1.1; }
    .nav-link{ color:#eaf7ff !important; font-weight:500; }

    /* Hero */
    .hero{
      position:relative; min-height:48vh; display:grid; place-items:center; text-align:center; color:#fff;
    }
    .hero-inner{ padding:2.5rem 1rem; }
    .hero h1{ font-weight:800; letter-spacing:.2px; }
    .hero .lead{ opacity:.98; }

    /* Services */
    .services-section{ background:var(--bg); }
    .section-title{ font-weight:800; color:#07344a; letter-spacing:.2px; }

    .service-card{
      background:var(--card); border:1px solid var(--ring);
      border-radius:18px; overflow:hidden; height:100%;
      box-shadow:var(--shadow);
      transition: transform .14s ease, box-shadow .14s ease;
    }
    .service-card:hover{ transform: translateY(-2px); box-shadow:0 18px 38px rgba(2,6,23,.14); }

    .service-thumb{
      height:168px; background:linear-gradient(90deg,#eef6ff,#f6fbff);
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .service-thumb img{ width:100%; height:100%; object-fit:cover; }
    .service-body{ padding:14px 16px 18px; display:flex; flex-direction:column; }
    .service-title{ font-weight:800; color:var(--ink); font-size:1.08rem; margin-bottom:.3rem; }
    .service-meta{ color:var(--muted); }
    .badge-soft{ background:#eef6ff; color:#0b6fa1; border:1px solid #e4effc; }

    /* Quick form */
    .quick-form{ display:none; background:#f8fbff; border:1px dashed #cfe1f3; border-radius:12px; padding:12px; margin-top:10px; }
    .quick-form.show{ display:block; animation:fadeIn .18s ease-in; }
    .quick-form .form-control, .quick-form .form-select{ border-radius:10px; }
    .quick-form .form-control-lg{ font-size:1.05rem; padding:.78rem 1rem; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(6px);} to{opacity:1; transform:none;} }

    /* FAB Cart */
    .fab-cart{
      position:fixed; right:22px; bottom:22px; z-index:1050;
      width:58px; height:58px; border-radius:50%;
      display:inline-flex; align-items:center; justify-content:center;
      background:#fff; border:1px solid var(--ring); box-shadow:0 10px 26px rgba(2,6,23,.18);
      cursor:pointer;
      transition: transform .1s ease, box-shadow .1s ease;
    }
    .fab-cart:hover{ transform: translateY(-1px); box-shadow:0 14px 32px rgba(2,6,23,.22); }
    .fab-cart i{ font-size:1.35rem; color:#0b3b52; }
    .fab-cart .badge{
      position:absolute; top:-6px; right:-6px;
      background:#ef4444; color:#fff; font-weight:700;
      border-radius:999px; padding:.3rem .5rem; font-size:.75rem;
      box-shadow:0 4px 10px rgba(239,68,68,.4);
    }

    .btn-primary{ background:var(--primary); border-color:var(--primary); font-weight:600; }
    .btn-primary:hover{ filter:brightness(.96); }
    .btn-success{ font-weight:600; }

    .status-note{ font-size:.92rem; color:var(--muted); }

    /* Footer */
    .footer{ background:linear-gradient(90deg,var(--accent),var(--primary)); color:#eaf7ff; }

    .table thead th{ white-space:nowrap; font-weight:700; color:#07344a; }
  </style>

  {% set hero_bg = (store.hero.bg_image if store.hero and store.hero.bg_image else None) %}
  {% if hero_bg %}
  <style>
    .hero{
      background:
        linear-gradient(0deg, rgba(0,0,0,.45), rgba(0,0,0,.45)),
        url('{{ hero_bg }}') center/cover no-repeat;
    }
  </style>
  {% else %}
  <style>
    .hero{ background: linear-gradient(90deg,var(--accent),var(--primary)); }
  </style>
  {% endif %}

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

  <!-- Paystack Inline -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script>
    // HARD-CODED Paystack Public Key (no .env)
    window.PAYSTACK_PUBLIC_KEY = "pk_live_4c909336372002195e900f36649a37c56d0b8cdb";
  </script>
</head>

<body
  data-auth="{{ '1' if session and session.get('user_id') else '0' }}"
  data-slug="{{ store.slug }}"
>
  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container container-wide">
      <a class="brand-wrap" href="#">
        <img class="brand-logo"
             src="{{ store.logo_url or 'https://via.placeholder.com/256?text=Logo' }}"
             alt="{{ store.name }} logo" loading="eager" fetchpriority="high">
        <span class="brand-text">{{ store.name }}</span>
      </a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#services">Services</a></li>
          {% if request.args.get('preview') and session and session.get('user_id') and (store.owner_id == session.get('user_id') or store.owner_id|string == session.get('user_id')) %}
          <li class="nav-item"><span class="nav-link"><i class="bi bi-eye"></i> Preview</span></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-inner container container-wide">
      <h1 class="display-6">{{ (store.hero.title if store.hero else '') or 'Affordable, Reliable Data—Anytime' }}</h1>
      <p class="lead mb-4">{{ (store.hero.subtitle if store.hero else '') or 'Fund once, order instantly, and track everything.' }}</p>
      <a href="#services" class="btn btn-light btn-lg px-4">Shop Now</a>
    </div>
  </section>

  <!-- SERVICES -->
  <section id="services" class="services-section py-5">
    <div class="container container-wide">
      <h2 class="section-title text-center mb-4">Services</h2>

      {% macro card(svc) -%}
        {% set can_order = svc.can_order %}
        {% set reason = svc.disabled_reason %}
        <div class="card service-card h-100">
          <div class="service-thumb">
            {% if svc.image_url %}
              <img src="{{ svc.image_url }}" alt="{{ svc.name }}" loading="lazy">
            {% else %}
              <img src="https://via.placeholder.com/800x450?text={{ svc.name | urlencode }}" alt="{{ svc.name }}" loading="lazy">
            {% endif %}
          </div>
          <div class="service-body">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <h3 class="service-title m-0">{{ svc.name }}</h3>
                <div class="service-meta small">
                  {{ (svc.service_category or 'Service') | title }}
                </div>
              </div>
              {% if not can_order %}
                <span class="badge bg-danger-subtle text-danger d-inline-flex align-items-center gap-1">
                  <i class="bi bi-exclamation-triangle-fill"></i>
                  {{ reason or 'Unavailable' }}
                </span>
              {% else %}
                <span class="badge badge-soft">Available</span>
              {% endif %}
            </div>

            {% set visible_offers = (svc.offers or [])[:3] %}
            {% if visible_offers %}
              <ul class="small text-muted mb-2 ps-3">
                {% for o in visible_offers %}
                  <li data-offer-preview="1">
                    {{ o.value_text or '-' }} — <strong>GHS {{ '%.2f'|format(o.total or 0) }}</strong>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}

            <div class="mt-auto">
              <button class="btn btn-primary w-100 select-btn"
                data-service='{{ {"_id_str":svc._id_str,"name":svc.name,"offers":svc.offers or []} | tojson }}'
                data-can="{{ 1 if can_order else 0 }}"
                data-reason="{{ reason or '' }}">
                Buy
              </button>
              <div class="quick-form mt-2" aria-hidden="true"></div>
            </div>
          </div>
        </div>
      {%- endmacro %}

      <div class="row g-4">
        {% if not services %}
          <div class="col-12 text-center text-muted">No services available.</div>
        {% else %}
          {% for svc in services %}
            {% set colClass = 'col-12 col-lg-6' if (store.layout or 'grid-2') == 'grid-2' else 'col-12' %}
            <div class="{{ colClass }}">
              {{ card(svc) }}
            </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </section>

  <!-- FAB CART -->
  <button type="button" class="fab-cart" data-bs-toggle="modal" data-bs-target="#cartModal" aria-label="Cart">
    <i class="bi bi-cart3"></i>
    <span class="badge" id="cartCount">0</span>
  </button>

  <!-- CART MODAL -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ store.name }} — Cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="cartEmpty" class="text-muted">Your cart is empty.</div>
          <div id="cartWrap" class="d-none">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Service</th>
                    <th>Phone</th>
                    <th>Offer</th>
                    <th class="text-end">Pay (GHS)</th>
                    <th style="width:80px"></th>
                  </tr>
                </thead>
                <tbody id="cartBody"></tbody>
              </table>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-2 gap-2">
              <div class="status-note" id="paymentNote" aria-live="polite">
                Payment required before processing. Click “Pay Now”.
              </div>
              <div class="text-end">
                <div class="fw-bold">Cart Total: GHS <span id="cartTotal">0.00</span></div>
                <!-- NEW: fee heads-up -->
                <div class="small text-muted mt-1" id="feeNote">
                  Heads-up: Paystack adds ~2% processing fee at checkout (e.g. GHS 4.95 → charged about GHS 5.05).
                  That extra is okay — we’ll still process your exact order total automatically.
                </div>
              </div>
            </div>

            <div class="text-end d-flex flex-wrap gap-2 justify-content-end">
              <button class="btn btn-outline-danger" id="btnClear">Clear</button>

              <button class="btn btn-primary" id="btnPay">
                <span class="btn-text">Pay Now</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              </button>

              <!-- Kept for manual retry; auto-processing happens right after payment -->
              <button class="btn btn-success" id="btnProcess" disabled>
                <span class="btn-text">Process Order</span>
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer small text-muted">
          If a service shows “Unavailable”, you can’t add it to the cart.
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER (© only) -->
  <footer class="footer mt-5 py-4">
    <div class="container container-wide d-flex justify-content-between align-items-center">
      <div>&copy; <span id="y"></span> {{ store.name }}.</div>
      <div></div>
    </div>
  </footer>

  <!-- Toast -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="appToast" class="toast text-bg-dark border-0">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Done</div>
        <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function(){
      const toastEl = document.getElementById('appToast');
      const toast = new bootstrap.Toast(toastEl,{delay:2400});
      function tell(m){ document.getElementById('toastBody').textContent = m || 'Done'; toast.show(); }
      document.getElementById('y').textContent = new Date().getFullYear();

      const SLUG = document.body.getAttribute('data-slug') || '';
      const CART_KEY = "store_cart_" + SLUG;
      const PAY_CONFIRMED_KEY = "store_ps_confirmed_" + SLUG;

      // Fixed Paystack payer info (adjust if you want to collect from user)
      const PS_EMAIL = "cytech76@gmail.com";
      const PS_FIRST = "CYTECH";
      const PS_LAST  = "CYBOK";

      // ---------- Helpers
      function money(n){ return Number(n||0).toFixed(2); }
      function pesewas(n){ return Math.round(Number(n||0) * 100); }

      function normalizePhone(s){
        let d = String(s || '').replace(/\D+/g,'');
        if(d.startsWith('233')) d = '0' + d.slice(3);
        if(d.length > 10) d = d.slice(-10);
        return d;
      }
      function setLoading(btn,on){
        const txt = btn.querySelector('.btn-text');
        const sp  = btn.querySelector('.spinner-border');
        if(!btn) return;
        btn.disabled = !!on;
        if(on){ if(txt) txt.classList.add('d-none'); if(sp) sp.classList.remove('d-none'); }
        else  { if(txt) txt.classList.remove('d-none'); if(sp) sp.classList.add('d-none'); }
      }

      // ---------- Offer label normalization (preview list)
      function _formatGb(n){
        if(n == null || isNaN(n)) return "-";
        const r = Math.round(n);
        return (Math.abs(n - r) < 1e-9 ? String(r) : String(parseFloat(n.toFixed(2)).toString())) + " GB";
      }
      function _extractGb(raw){
        if(!raw) return null;
        const s = String(raw).trim();
        var m = s.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*gb\s*$/i);
        if(m) return parseFloat(m[1]);
        m = s.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*mb\s*$/i);
        if(m) return parseFloat(m[1]) / 1000;

        if(s.startsWith("{") && s.endsWith("}")){
          try {
            const j = JSON.parse(
              s.replace(/'/g,'"').replace(/\bNone\b/g,'null').replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false')
            );
            if(j && typeof j === "object"){
              if(j.gb != null && !isNaN(parseFloat(j.gb))) return parseFloat(j.gb);
              if(j.offer != null && !isNaN(parseFloat(j.offer))) return parseFloat(j.offer)/1000;
              if(j.volume != null && !isNaN(parseFloat(j.volume))) return parseFloat(j.volume)/1000;
            }
          }catch(_){}
        }
        return null;
      }
      function normalizeServerPreviewOfferLabels(){
        var items = document.querySelectorAll('li[data-offer-preview="1"]');
        for (var i=0;i<items.length;i++){
          var li = items[i];
          var strong = li.querySelector('strong');
          var priceHTML = strong ? strong.outerHTML : '';
          var clone = li.cloneNode(true);
          var st = clone.querySelector('strong'); if(st) st.remove();
          var leftText = clone.textContent.split('—')[0].trim();
          var gb = _extractGb(leftText);
          var label = gb != null ? _formatGb(gb) : (leftText || '-');
          li.innerHTML = label + ' — ' + priceHTML;
        }
      }
      normalizeServerPreviewOfferLabels();

      // ---------- Buy form helpers
      function parseMaybeObject(v){
        if(v && typeof v === "object") return v;
        if(typeof v !== "string") return null;
        const s = v.trim();
        if(!(s.startsWith("{") && s.endsWith("}"))) return null;
        try{ return JSON.parse(s); }catch(_){}
        try{
          const fixed = s.replace(/'/g,'"').replace(/\bNone\b/g,'null').replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false');
          return JSON.parse(fixed);
        }catch(_){ return null; }
      }
      function gbLabelFromOffer(o){
        if(o && typeof o.value_text === "string" && o.value_text.trim()){
          const vt = o.value_text.trim();
          const mbMatch = vt.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*mb\s*$/i);
          if(mbMatch) return _formatGb(parseFloat(mbMatch[1]) / 1000);
        }
        let v = o ? o.value : undefined;
        const maybeObj = parseMaybeObject(v);
        if(maybeObj) v = maybeObj;

        let gb = null;
        if(v && typeof v === "object"){
          if(v.gb != null && !isNaN(parseFloat(v.gb))) gb = parseFloat(v.gb);
          else if(v.offer != null && !isNaN(parseFloat(v.offer))) gb = parseFloat(v.offer) / 1000;
          else if(v.volume != null && !isNaN(parseFloat(v.volume))) gb = parseFloat(v.volume) / 1000;
        }
        if(gb == null && typeof v === "string"){
          const g = v.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*gb\s*$/i); if(g) gb = parseFloat(g[1]);
          const m = v.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*mb\s*$/i); if(m) gb = parseFloat(m[1]) / 1000;
        }
        if(gb != null) return _formatGb(gb);
        if(typeof v === "string") return v.replace(/gb/ig,"GB");
        return "-";
      }

      // ---------- Cart store
      const cart = {
        _data: [],
        load(){ try{ this._data = JSON.parse(localStorage.getItem(CART_KEY) || "[]") || []; }catch(e){ this._data = []; } },
        save(){ try{ localStorage.setItem(CART_KEY, JSON.stringify(this._data)); }catch(e){} },
        add(line){ this._data.push(line); this.save(); renderCart(); },
        remove(i){ this._data.splice(i,1); this.save(); renderCart(); },
        clear(){ this._data = []; this.save(); renderCart(); },
        total(){ return this._data.reduce((t,i)=> t + Number(i.amount || 0), 0); }
      };

      // ---------- Build quick form
      function buildForm(uid, svc){
        const opts = (svc.offers || []).filter(o => o && o.total != null);
        let options = '<option value="">Choose offer</option>';
        for (let i=0;i<opts.length;i++){
          const o = opts[i];
          const lab = gbLabelFromOffer(o);
          options += '<option value="'+i+'" data-total="'+(o.total ?? '')+'" data-base="'+(o.amount ?? '')+'">GHS '+Number(o.total||0).toFixed(2)+' — '+(lab || '-')+'</option>';
        }
        return ''
          + '<div class="row g-2 align-items-end">'
          + '  <div class="col-12"><div class="small text-muted">Choose an offer, then enter phone (starts with 0)</div></div>'
          + '  <div class="col-12 col-lg-6">'
          + '    <label class="form-label mb-1" for="qf_offer_'+uid+'">Offer</label>'
          + '    <select class="form-select form-select-lg" id="qf_offer_'+uid+'">'+options+'</select>'
          + '  </div>'
          + '  <div class="col-12 col-lg-6">'
          + '    <label class="form-label mb-1" for="qf_phone_'+uid+'">Phone</label>'
          + '    <input class="form-control form-control-lg" id="qf_phone_'+uid+'" placeholder="0xxxxxxxxx" inputmode="numeric" maxlength="14">'
          + '  </div>'
          + '  <div class="col-12 d-flex gap-2">'
          + '    <button class="btn btn-primary" id="qf_add_'+uid+'">'
          + '      <span class="btn-text">Add to Cart</span>'
          + '      <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>'
          + '    </button>'
          + '    <button class="btn btn-outline-secondary" id="qf_cancel_'+uid+'">Cancel</button>'
          + '  </div>'
          + '</div>';
      }

      // ---------- Buy buttons
      document.querySelectorAll('.select-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const can = btn.getAttribute('data-can') === '1';
          if(!can){ tell(btn.getAttribute('data-reason') || 'This service is unavailable.'); return; }

          let svc = {};
          try{ svc = JSON.parse(btn.getAttribute('data-service') || '{}'); }catch(e){}

          svc.offers = (svc.offers || []).map(o => {
            const amountNum = Number(o.amount);
            const amount = Number.isFinite(amountNum) ? amountNum : 0;
            return Object.assign({}, o, { amount: amount, value_text: gbLabelFromOffer(o) });
          });

          const card = btn.closest('.service-card');
          const qf   = card.querySelector('.quick-form');

          document.querySelectorAll('.quick-form.show').forEach(el => {
            if(el !== qf){ el.classList.remove('show'); el.innerHTML=''; el.setAttribute('aria-hidden','true'); }
          });

          const uid = String(Date.now()) + Math.floor(Math.random()*1000);
          qf.innerHTML = buildForm(uid, svc);
          qf.classList.add('show'); qf.setAttribute('aria-hidden','false');

          const offerEl   = qf.querySelector('#qf_offer_'+uid);
          const phoneEl   = qf.querySelector('#qf_phone_'+uid);
          const addBtn    = qf.querySelector('#qf_add_'+uid);
          const cancelBtn = qf.querySelector('#qf_cancel_'+uid);

          if(phoneEl){
            phoneEl.addEventListener('input', ()=>{ phoneEl.value = normalizePhone(phoneEl.value); });
          }

          if(addBtn){
            addBtn.addEventListener('click', ()=>{
              const idx   = Number(offerEl ? offerEl.value : '');
              const of    = (svc.offers || [])[idx];
              const phone = normalizePhone(phoneEl ? phoneEl.value : '');
              if(isNaN(idx) || !of){ tell('Please choose an offer.'); if(offerEl) offerEl.focus(); return; }
              if(!/^0\d{9}$/.test(phone)){ tell('Phone must be 10 digits (e.g. 0530393625)'); if(phoneEl) phoneEl.focus(); return; }

              setLoading(addBtn,true);
              setTimeout(()=>{
                cart.add({
                  serviceId:   svc._id_str,
                  serviceName: svc.name,
                  phone:       phone,
                  value:       of.value_text || '-',
                  value_obj:   of.value || null,
                  base_amount: Number(of.amount || 0),
                  amount:      Number(of.total || 0)   // exact fetched total (server expects this)
                });
                setLoading(addBtn,false);
                tell('Added to cart');
                qf.classList.remove('show'); qf.innerHTML=''; qf.setAttribute('aria-hidden','true');
              },100);
            });
          }

          if(cancelBtn){
            cancelBtn.addEventListener('click', ()=>{
              qf.classList.remove('show'); qf.innerHTML=''; qf.setAttribute('aria-hidden','true');
            });
          }
        });
      });

      // ---------- Cart UI
      const cartBody    = document.getElementById('cartBody');
      const cartTotalEl = document.getElementById('cartTotal');
      const cartEmpty   = document.getElementById('cartEmpty');
      const cartWrap    = document.getElementById('cartWrap');
      const cartCount   = document.getElementById('cartCount');
      const paymentNote = document.getElementById('paymentNote');
      const btnPay      = document.getElementById('btnPay');
      const btnProcess  = document.getElementById('btnProcess');

      function renderCart(){
        cartBody.innerHTML = '';
        cart._data.forEach((it,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>'+it.serviceName+'</td>'+
            '<td>'+it.phone+'</td>'+
            '<td>'+(it.value||'-')+'</td>'+
            '<td class="text-end"><strong>GHS '+money(it.amount || 0)+'</strong></td>'+
            '<td class="text-end"><button class="btn btn-sm btn-outline-danger" data-rm="'+i+'">Remove</button></td>';
          cartBody.appendChild(tr);
        });
        const n = cart._data.length;
        cartCount.textContent = String(n);
        const payTotal = cart.total();
        cartTotalEl.textContent = money(payTotal);
        cartEmpty.classList.toggle('d-none', n !== 0);
        cartWrap.classList.toggle('d-none', n === 0);
        lockProcessUntilPayment();
      }

      cartBody.addEventListener('click', e=>{
        const b = e.target.closest('button[data-rm]');
        if(!b) return;
        cart.remove(Number(b.getAttribute('data-rm')));
        tell('Removed');
      });

      const btnClear = document.getElementById('btnClear');
      if(btnClear){
        btnClear.addEventListener('click', ()=>{
          if(!cart._data.length) return;
          if(confirm('Clear all items?')){ cart.clear(); tell('Cart cleared'); }
        });
      }

      // ---------- Paystack confirm cache
      function saveConfirmedPayment(obj){ try{ localStorage.setItem(PAY_CONFIRMED_KEY, JSON.stringify(obj||{})); }catch(e){} }
      function getConfirmedPayment(){ try{ return JSON.parse(localStorage.getItem(PAY_CONFIRMED_KEY)||"{}"); }catch(e){ return {}; } }
      function clearConfirmedPayment(){ try{ localStorage.removeItem(PAY_CONFIRMED_KEY); }catch(e){} }

      // We accept any paid >= cart total (server verifies exact paid amount via Paystack).
      function isPaidEnough(confirmedAmtGhs, requiredGhs){
        return Number(confirmedAmtGhs || 0) + 1e-2 >= Number(requiredGhs || 0);
      }

      function lockProcessUntilPayment(){
        const payTotal = cart.total();
        const confirmed = getConfirmedPayment();
        const ok = confirmed && confirmed.amount_ghs!=null && isPaidEnough(confirmed.amount_ghs, payTotal);
        if(btnProcess) btnProcess.disabled = !ok;
        if(paymentNote){
          paymentNote.textContent = ok
            ? ("Payment confirmed (Ref: " + (confirmed.reference||"") + "). Verifying & processing…")
            : "Payment required before processing. Click “Pay Now”.";
        }
      }

      // ---------- Pay Now (we send EXACT cart total; Paystack may add ~2% on their side)
      if(btnPay){
        btnPay.addEventListener('click', ()=>{
          if(!cart._data.length){ tell('Cart is empty.'); return; }
          const pk = (window.PAYSTACK_PUBLIC_KEY || '').trim();
          if(!pk){ tell('Payment is not configured. Contact support.'); return; }

          const payTotalGhs = cart.total();
          const amountPesewas = pesewas(payTotalGhs);
          const ref = "PS-" + Date.now() + "-" + Math.floor(Math.random()*1e6);

          const items = cart._data.map(c => ({
            s: c.serviceName, p: c.phone, v: c.value,
            a: Number(c.amount||0) // exact amount (store total)
          }));

          setLoading(btnPay,true);

          const handler = PaystackPop.setup({
            key: pk,
            email: PS_EMAIL,
            amount: amountPesewas,      // do NOT add +2% here; Paystack fee (if borne by customer) appears on their side
            currency: "GHS",
            firstname: PS_FIRST,
            lastname: PS_LAST,
            reference: ref,
            metadata: {
              payer: { email: PS_EMAIL, first_name: PS_FIRST, last_name: PS_LAST },
              cart_snapshot: items,
              pay_total_ghs: Number(payTotalGhs.toFixed(2)),
              fee_note: "Paystack may add ~2% processing fee; backend accepts any paid >= cart total.",
              source: "nagonu_store_inline_checkout",
              slug: SLUG
            },
            callback: function(response){
              // We don't get the final paid amount here — server will verify via Paystack.
              const confirmedObj = {
                reference: response.reference || ref,
                amount_pesewas: amountPesewas,   // the cart total we asked to charge
                amount_ghs: payTotalGhs,
                confirmed_at: new Date().toISOString(),
                via_inline: true
              };
              saveConfirmedPayment(confirmedObj);
              setLoading(btnPay,false);
              tell('Payment received — verifying…');
              lockProcessUntilPayment();
              proceedCheckoutAuto(); // auto-process right away
            },
            onClose: function(){
              setLoading(btnPay,false);
            }
          });

          try { handler.openIframe(); } catch(e){ setLoading(btnPay,false); tell('Unable to open payment window.'); }
        });
      }

      // Manual click fallback (still allowed)
      if(btnProcess){
        btnProcess.addEventListener('click', ()=> proceedCheckoutAuto());
      }

      // ---------- Process Order (auto after pay)
      async function proceedCheckoutAuto(){
        const confirmed = getConfirmedPayment();
        if(!cart._data.length){ tell('Cart is empty.'); return; }
        const payNow = cart.total();

        if(!confirmed || confirmed.amount_ghs == null){
          tell('Please pay first.'); return;
        }
        if(!isPaidEnough(confirmed.amount_ghs, payNow)){
          tell('Amount paid is less than required. Please complete full payment.');
          if(btnProcess) btnProcess.disabled = true;
          return;
        }

        if(btnProcess) setLoading(btnProcess,true);

        try{
          const r = await fetch('/store-checkout/'+encodeURIComponent(SLUG), {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              cart: cart._data,
              method: "paystack_inline",
              paystack: {
                reference: confirmed.reference || "",
                amount_pesewas: Math.round(payNow*100),
                amount_ghs: payNow,
                via_inline: true,
                payer: { email: PS_EMAIL, first_name: PS_FIRST, last_name: PS_LAST }
              }
            })
          });
          const j = await r.json();
          if(r.ok && j.success){
            tell('✅ Order received: ' + (j.order_id || ''));
            cart.clear();
            clearConfirmedPayment();
            const modalEl = document.getElementById('cartModal');
            const inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            if(inst){ inst.hide(); }
            // Optional quick confirmation pop already shown; go to status
            const first = j.items && j.items[0];
            if(first && first.phone){
              window.location.href = '/check-status?phone=' + encodeURIComponent(first.phone);
            }
          }else{
            tell(j.message || 'Checkout failed.');
          }
        }catch(_e){
          tell('Network error.');
        }
        if(btnProcess) setLoading(btnProcess,false);
      }

      // Init
      cart.load();
      renderCart();

    })();
  </script>
</body>
</html>
