<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .kpi { font-variant-numeric: tabular-nums; }
    .card h6 { margin-bottom: .25rem; }
    .chart-wrap { position: relative; width: 100%; height: 360px; }
    @media (min-width: 1400px) { .chart-wrap { height: 420px; } }
    .table td, .table th { vertical-align: middle; }
    .card-icon {
      width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center;
      border-radius: .75rem; background: rgba(13,110,253,.12);
    }
    .card-icon.success { background: rgba(25,135,84,.12); }
    .card-icon.warning { background: rgba(255,193,7,.15); }
    .card-icon.info    { background: rgba(13,202,240,.12); }
    
  </style>
  <style>
  /* Blink / glow for the KPI count */
  .blink {
    animation: kpi-blink 1.2s steps(2, start) infinite;
  }
  @keyframes kpi-blink { 50% { opacity: .35; } }

  /* Subtle bump when the number updates */
  .bump {
    animation: kpi-bump .6s ease-out;
  }
  @keyframes kpi-bump {
    0% { transform: scale(1); }
    35% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }

  .card-icon.afa { background: rgba(13,110,253,.12); }
</style>

</head>
<body>
  {% include 'admin_sidebar.html' %}

  <!-- Content area respects the fixed sidebar margins from your include -->
  <div class="customer-content">
    <div class="container-fluid">
      <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <h3 class="mb-2 mb-sm-0">Admin Dashboard</h3>
      </div>

     
        <!-- KPI: Total Customers (clickable with sub-links for blocked/active) -->
<div class="row g-3 mb-3">
  <!-- KPI: AFA Registrations (blinking) -->
<div class="col-12 col-sm-6 col-xl-3">
  <a href="{{ url_for('admin_afa.admin_afa_page') }}" class="text-decoration-none text-reset">
    <div class="card h-100 border-0 shadow-lg" style="background: linear-gradient(135deg, #e0f2ff, #f5fbff);">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">AFA Registrations</h6>
          <span class="card-icon afa">
            <i class="bi bi-card-checklist text-primary fs-4"></i>
          </span>
        </div>
        <div class="display-6 kpi mt-2 fw-bold text-dark">
          <!-- The number blinks, and will "bump" when auto-refresh updates it -->
          <span id="afa-total" class="blink" data-val="{{ (afa_total or 0) if afa_total is defined else 0 }}">
            {{ afa_total if afa_total is defined else 0 }}
          </span>
        </div>
        <div class="small mt-2 text-muted">
          Pending:
          <span id="afa-pending">{{ afa_pending if afa_pending is defined else 0 }}</span>
          · Today:
          <span id="afa-today">{{ afa_today if afa_today is defined else 0 }}</span>
        </div>
      </div>
    </div>
  </a>
</div>


  <div class="col-12 col-sm-6 col-xl-3">
    <a href="{{ url_for('admin_customers.view_customers') }}" class="text-decoration-none text-reset">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="text-muted mb-0">Total Customers</h6>
            <span class="card-icon"><i class="bi bi-people-fill text-primary"></i></span>
          </div>
          <div class="display-6 kpi mt-2">{{ total_customers or 0 }}</div>
          <div class="small mt-2">
            <a class="badge text-bg-danger text-decoration-none"
               href="{{ url_for('admin_customers.view_customers') }}?status=blocked">
              Blocked: {{ blocked_customers or 0 }}
            </a>
            <a class="badge text-bg-success ms-2 text-decoration-none"
               href="{{ url_for('admin_customers.view_customers') }}?status=active">
              Active: {{ active_customers or 0 }}
            </a>
          </div>
        </div>
      </div>
    </a>
  </div>

  <!-- Existing KPIs remain as-is -->
  <!-- Total Orders -->
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">Total Orders</h6>
          <span class="card-icon"><i class="bi bi-bag-check-fill text-primary"></i></span>
        </div>
        <div class="display-6 kpi mt-2">{{ total_orders or 0 }}</div>
        <div class="small text-muted">All-time orders across customers</div>
      </div>
    </div>
  </div>
<!-- KPI: Transactions -->
<div class="col-12 col-sm-6 col-xl-3">
  <a href="{{ url_for('admin_transactions.admin_view_transactions') }}" class="text-decoration-none text-reset">
    <div class="card h-100 border-0 shadow-lg" style="background: linear-gradient(135deg, #e8f4ff, #f6fbff);">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">Transactions</h6>
          <span class="card-icon" style="background: rgba(13,110,253,.12);">
            <i class="bi bi-cash-coin text-primary fs-4"></i>
          </span>
        </div>

        <!-- Big number: all-time successful transactions -->
        <div class="display-6 kpi mt-2 fw-bold text-dark">
          {{ txn_total_count if txn_total_count is defined else 0 }}
        </div>

        <!-- Small line: today's count + sums for quick context -->
        <div class="small mt-2 text-muted">
          Today: <strong>{{ txn_today_count if txn_today_count is defined else 0 }}</strong>
          <span class="d-block d-sm-inline ms-sm-2">
            · Sum: <span class="ghs" data-amt="{{ (txn_total_amount or 0)|float }}">GHS 0.00</span>
            (Today <span class="ghs" data-amt="{{ (txn_today_amount or 0)|float }}">GHS 0.00</span>)
          </span>
        </div>
      </div>
    </div>
  </a>
</div>

  <!-- Total Amount -->
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">Total Amount</h6>
          <span class="card-icon info"><i class="bi bi-currency-exchange text-info"></i></span>
        </div>
        <div class="display-6 kpi mt-2">
          <span class="ghs" data-amt="{{ (sum_total_amount or 0)|float }}">GHS 0.00</span>
        </div>
        <div class="small text-muted">Sum of order totals</div>
      </div>
    </div>
  </div>

  <!-- Total Charged -->
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">Total Charged</h6>
          <span class="card-icon warning"><i class="bi bi-credit-card-2-front text-warning"></i></span>
        </div>
        <div class="display-6 kpi mt-2">
          <span class="ghs" data-amt="{{ (sum_charged_amount or 0)|float }}">GHS 0.00</span>
        </div>
        <div class="small text-muted">What customers actually paid</div>
      </div>
    </div>
  </div>

  <!-- Total Profit -->
  <div class="col-12 col-sm-6 col-xl-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">Total Profit</h6>
          <span class="card-icon success"><i class="bi bi-graph-up-arrow text-success"></i></span>
        </div>
        <div class="display-6 kpi mt-2">
          <span class="ghs" data-amt="{{ (sum_profit_amount or 0)|float }}">GHS 0.00</span>
        </div>
        <div class="small text-muted">Cumulative profit from all orders</div>
      </div>
    </div>
  </div>
</div>

<!-- Wallet Flows (Deposits / Deductions) -->
<div class="col-12 col-xl-6">
  <a href="{{ url_for('admin_balance.view_balances') }}" class="text-decoration-none text-reset">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="text-muted mb-0">Wallet Flows</h6>
          <span class="card-icon info"><i class="bi bi-wallet2 text-info"></i></span>
        </div>

        <!-- Overall -->
        <div class="row mt-3">
          <div class="col-6">
            <div class="small text-muted">Total Deposits</div>
            <div class="h4 kpi">
              <span class="ghs" data-amt="{{ (deposits_overall or 0)|float }}">GHS 0.00</span>
            </div>
          </div>
          <div class="col-6 text-end">
            <div class="small text-muted">Total Deductions</div>
            <div class="h4 kpi">
              <span class="ghs" data-amt="{{ (withdrawals_overall or 0)|float }}">GHS 0.00</span>
            </div>
          </div>
        </div>

        <hr class="my-3">

        <!-- Today -->
        <div class="row">
          <div class="col-6">
            <div class="small text-muted">Today’s Deposits</div>
            <div class="h5 kpi">
              <span class="ghs" data-amt="{{ (deposits_today or 0)|float }}">GHS 0.00</span>
            </div>
          </div>
          <div class="col-6 text-end">
            <div class="small text-muted">Today’s Deductions</div>
            <div class="h5 kpi">
              <span class="ghs" data-amt="{{ (withdrawals_today or 0)|float }}">GHS 0.00</span>
            </div>
          </div>
        </div>

        <div class="small text-muted mt-2">Click to view balances</div>
      </div>
    </div>
  </a>
</div>


      <!-- Charts + Top Offers -->
      <div class="row g-3">
        <!-- Top customers by orders -->
        <div class="col-12 col-xxl-6">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Top Customers by Orders</span>
              <span class="text-muted small">Top 10</span>
            </div>
            <div class="card-body">
              {% if chart_values and chart_values|length > 0 %}
                <div class="chart-wrap">
                  <canvas id="ordersBarChart" aria-label="Top customers by orders" role="img"></canvas>
                </div>
              {% else %}
                <div class="text-center text-muted py-5">
                  <div class="mb-2">No order data yet.</div>
                  <small>When orders come in, you’ll see your top customers here.</small>
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Top customers by profit -->
        <div class="col-12 col-xxl-6">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Top Customers by Profit</span>
              <span class="text-muted small">Top 10</span>
            </div>
            <div class="card-body">
              {% if profit_chart_values and profit_chart_values|length > 0 %}
                <div class="chart-wrap">
                  <canvas id="profitBarChart" aria-label="Top customers by profit" role="img"></canvas>
                </div>
              {% else %}
                <div class="text-center text-muted py-5">
                  <div class="mb-2">No profit data yet.</div>
                  <small>As profits accrue, this chart will populate.</small>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <!-- Top Offers Purchased -->
        <div class="col-12">
          <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Top Offers Purchased</span>
              <span class="text-muted small">Top 3</span>
            </div>
            <div class="card-body">
              {% if top_offers and top_offers|length %}
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th style="width:40px;">#</th>
                        <th>Service</th>
                        <th>Offer</th>
                        <th class="text-end">Purchases</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in top_offers %}
                        <tr>
                          <td>{{ loop.index }}</td>
                          <td>{{ row.service }}</td>
                          <td>{{ row.offer }}</td>
                          <td class="text-end">{{ row.count }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="text-center text-muted py-5">
                  <div class="mb-2">No purchases to rank yet.</div>
                  <small>Once completed orders exist, this list will update.</small>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- JSON data blobs for lint-safe JS consumption -->
      <script id="orders-chart-data" type="application/json">
        {{ {'labels': chart_labels or [], 'values': chart_values or []} | tojson }}
      </script>
      <script id="profit-chart-data" type="application/json">
        {{ {'labels': profit_chart_labels or [], 'values': profit_chart_values or []} | tojson }}
      </script>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // Format any .ghs amounts as "GHS 12,345.00"
    document.querySelectorAll('.ghs').forEach(el => {
      const raw = (el.getAttribute('data-amt') || '').toString().replace(/[^\d.-]/g,'');
      const n = parseFloat(raw);
      if (!isNaN(n)) {
        el.textContent = 'GHS ' + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }
    });

    function renderBarChart(canvasId, blobId, labelText, valueFormatter) {
      const blob = document.getElementById(blobId);
      if (!blob) return;
      let data;
      try { data = JSON.parse(blob.textContent || '{}'); } catch { data = {}; }
      const labels = Array.isArray(data.labels) ? data.labels : [];
      const values = Array.isArray(data.values) ? data.values : [];
      if (!values.length) return;

      const ctx = document.getElementById(canvasId);
      if (!ctx) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: labelText,
            data: values,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { maxRotation: 45, minRotation: 0, autoSkip: true }
            },
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0,
                callback: (v) => valueFormatter ? valueFormatter(v) : v
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y;
                  return valueFormatter ? `${labelText}: ${valueFormatter(v)}` : `${labelText}: ${v}`;
                }
              }
            }
          }
        }
      });
    }

    // Orders chart
    renderBarChart('ordersBarChart', 'orders-chart-data', 'Orders');

    // Profit chart (format y-axis as currency)
    const fmtMoney = (n) => 'GHS ' + Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    renderBarChart('profitBarChart', 'profit-chart-data', 'Profit', fmtMoney);
  </script>
</body>
</html>
