<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .stat { font-variant-numeric: tabular-nums; }
    .table td, .table th { vertical-align: middle; }
    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .5rem; border-radius:999px; font-size:.8rem; }
    .chip-success { background:rgba(25,135,84,.12); color:#198754; }
    .chip-fail { background:rgba(220,53,69,.12); color:#dc3545; }
    .chip-role { background:rgba(13,110,253,.12); color:#0d6efd; }
    .wrap { word-break: break-word; }
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' %}

  <div class="customer-content">
    <div class="container-fluid">
      <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <h3 class="mb-2 mb-sm-0"><i class="bi bi-shield-lock me-2 text-primary"></i> Login Logs</h3>
      </div>

      <!-- Filters -->
      <form class="card mb-3" method="get" action="{{ url_for('login_logs.view_login_logs') }}">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-sm-6 col-lg-3">
              <label class="form-label">Start date</label>
              <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
              <label class="form-label">End date</label>
              <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
              <label class="form-label">Per page</label>
              <select name="per_page" class="form-select">
                {% for n in [10,20,50,100] %}
                  <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-sm-6 col-lg-3 d-flex gap-2">
              <button class="btn btn-primary flex-grow-1" type="submit">
                <i class="bi bi-funnel me-1"></i> Apply
              </button>
              <a class="btn btn-outline-secondary" href="{{ url_for('login_logs.view_login_logs') }}">Reset</a>
            </div>
          </div>
        </div>
        <div class="card-footer text-muted small">
          Showing page <span class="stat">{{ page }}</span> of <span class="stat">{{ total_pages }}</span>
          — <span class="stat">{{ total_count }}</span> total log(s)
        </div>
      </form>

      {% if logs %}
        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th style="min-width: 140px;">When</th>
                <th>User</th>
                <th class="d-none d-md-table-cell">Role</th>
                <th>Status</th>
                <th>IP</th>
                <th class="d-none d-lg-table-cell">Location</th>
                <th class="d-none d-xl-table-cell">Device</th>
                <th class="d-none d-xl-table-cell">Browser / Platform</th>
                <th class="d-none d-lg-table-cell">Reason</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
                {% set device = log.get('device', {}) %}
                {% set location = log.get('location', {}) %}
                <tr>
                  <td class="text-nowrap">
                    {% if log.get('created_at') %}
                      {{ log['created_at'].strftime('%d %b %Y, %I:%M %p') }}
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td class="wrap">
                    <div class="fw-semibold">{{ log.get('username','—') }}</div>
                    <div class="small text-muted d-md-none">
                      {{ log.get('role','customer') }}
                    </div>
                  </td>
                  <td class="d-none d-md-table-cell">
                    <span class="chip chip-role">
                      <i class="bi bi-person-badge"></i>{{ log.get('role','customer')|capitalize }}
                    </span>
                  </td>
                  <td>
                    {% if log.get('success') %}
                      <span class="chip chip-success"><i class="bi bi-check2-circle"></i> Success</span>
                    {% else %}
                      <span class="chip chip-fail"><i class="bi bi-x-circle"></i> Failed</span>
                    {% endif %}
                  </td>
                  <td class="wrap">
                    <div>{{ log.get('ip','—') }}</div>
                    {% if log.get('forwarded_for') %}
                      <div class="small text-muted">XFF: {{ log.get('forwarded_for') }}</div>
                    {% endif %}
                  </td>
                  <td class="d-none d-lg-table-cell wrap">
                    {% if location %}
                      <div>{{ location.get('city') or '—' }}, {{ location.get('region') or '—' }}</div>
                      <div class="small text-muted">{{ location.get('country_name') or location.get('country') or '—' }}</div>
                      {% if location.get('timezone') %}<div class="small text-muted">{{ location.get('timezone') }}</div>{% endif %}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="d-none d-xl-table-cell">
                    {% set label = device.get('device_label') or ('mobile' if device.get('is_mobile') else 'desktop') %}
                    <div class="text-capitalize">{{ label }}</div>
                    <div class="small text-muted">{{ device.get('ua_string','')[:40] ~ ('…' if (device.get('ua_string','')|length > 40) else '') }}</div>
                  </td>
                  <td class="d-none d-xl-table-cell">
                    <div class="text-capitalize">{{ device.get('browser') or '—' }} {{ device.get('version') or '' }}</div>
                    <div class="small text-muted text-capitalize">{{ device.get('platform') or '—' }}</div>
                  </td>
                  <td class="d-none d-lg-table-cell">
                    <span class="small">{{ log.get('reason') or '—' }}</span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Login logs pagination" class="mt-3">
          <ul class="pagination">
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('login_logs.view_login_logs', page=1, start_date=start_date, end_date=end_date, per_page=per_page) }}">&laquo; First</a>
            </li>
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('login_logs.view_login_logs', page=page-1 if page>1 else 1, start_date=start_date, end_date=end_date, per_page=per_page) }}">Prev</a>
            </li>

            {% for p in page_numbers %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('login_logs.view_login_logs', page=p, start_date=start_date, end_date=end_date, per_page=per_page) }}">{{ p }}</a>
              </li>
            {% endfor %}

            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('login_logs.view_login_logs', page=page+1 if page<total_pages else total_pages, start_date=start_date, end_date=end_date, per_page=per_page) }}">Next</a>
            </li>
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('login_logs.view_login_logs', page=total_pages, start_date=start_date, end_date=end_date, per_page=per_page) }}">Last &raquo;</a>
            </li>
          </ul>
        </nav>
      {% else %}
        <div class="alert alert-info">No login logs found for the current filters.</div>
      {% endif %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
