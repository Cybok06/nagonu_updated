<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Create Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">
  <style>
    :root{ --primary:#0ea5e9; --accent:#0b6fa1; --bg:#f7fbfe; --text:#06354a; }
    *{ box-sizing:border-box; }
    body{ background:#fff; color:#0f172a; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .page-header{ background:linear-gradient(90deg,var(--accent),var(--primary)); color:#eaf7ff; padding:1.25rem 0; }
    .card-clean{ border:none; border-radius:16px; box-shadow:0 10px 24px rgba(2,6,23,.08); }
    .form-section-title{ font-weight:800; letter-spacing:.2px; color:#0b6fa1; }
    .logo-preview{ width:64px; height:64px; object-fit:cover; border-radius:14px; border:2px solid #0002; }
    .hero-preview{ height:140px; border-radius:14px; background:#eef6ff center/cover no-repeat; }
    .small-muted{ color:#6b7280; }
    .sticky-actions{ position:sticky; bottom:0; z-index:10; background:#fff; border-top:1px solid #edf2f7; }
    .kbd{ font-size:.85rem; border:1px solid #e2e8f0; border-bottom-width:2px; border-radius:6px; padding:0 6px; background:#f8fafc; }
    .svc-card{ border:1px solid #edf2f7; border-radius:14px; padding:14px; }
    .offer-row{ display:grid; grid-template-columns: 1fr 140px 160px; gap:10px; align-items:center; }
    @media (max-width: 576px){ .offer-row{ grid-template-columns: 1fr 120px 130px; } }
    .offer-row input[type="number"]{ text-align:right; }
    .badge-soft{ background:#eef6ff; color:#0b6fa1; }
    .actions-right .btn{ min-width:120px; }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a href="/customer/store" class="btn btn-sm btn-light"><i class="bi bi-arrow-left"></i></a>
        <h1 class="h5 m-0 fw-bold">Create / Edit Store</h1>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" id="btnSuspend" type="button" hidden>Suspended</button>
        <button class="btn btn-outline-light btn-sm" id="btnResume" type="button" hidden>Resume</button>
        <button class="btn btn-outline-light btn-sm" id="btnDelete" type="button" hidden>Delete</button>
      </div>
    </div>
  </header>

  <main class="container my-4">
    <form id="storeForm" class="row g-4" autocomplete="off">
      <!-- Branding -->
      <div class="col-12 col-xl-4">
        <div class="card card-clean p-3 h-100">
          <h2 class="form-section-title h6 mb-3">Branding</h2>

          <div class="mb-3">
            <label class="form-label">Store name</label>
            <input class="form-control" id="name" maxlength="80" placeholder="e.g. Cytech Store" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Slug (URL)</label>
            <div class="input-group">
              <span class="input-group-text">/s/</span>
              <input class="form-control" id="slug" maxlength="64" pattern="[a-z0-9-]+" placeholder="cytech-store" required>
            </div>
            <div class="small small-muted mt-1">Lowercase letters, numbers, and dashes only.</div>
          </div>

          <!-- Logo with GridFS -->
          <div class="mb-3">
            <label class="form-label">Logo</label>
            <div class="d-flex align-items-center gap-2 mb-2">
              <img id="logoPreview" class="logo-preview" alt="Logo" src="https://via.placeholder.com/128x128?text=Logo">
              <input type="file" id="logo_file" accept="image/*" class="form-control form-control-sm" style="max-width: 260px;">
              <button type="button" class="btn btn-outline-primary btn-sm" id="btnUploadLogo">
                <i class="bi bi-cloud-upload"></i> Upload
              </button>
            </div>
            <input class="form-control" id="logo_url" placeholder="or paste an image URL (optional)">
            <div class="small small-muted mt-1">If you upload a file, we’ll store it and fill this field with a /media/… link.</div>
          </div>

          <div class="mb-2">
            <label class="form-label">Layout</label>
            <select class="form-select" id="layout">
              <option value="grid-2">Two per row (compact)</option>
              <option value="grid-1">One per row (tall cards)</option>
              <option value="cards">Masonry cards</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Theme + Hero -->
      <div class="col-12 col-xl-8">
        <div class="card card-clean p-3">
          <h2 class="form-section-title h6 mb-3">Theme & Hero</h2>
          <div class="row g-3">
            <div class="col-6 col-md-3">
              <label class="form-label">Primary</label>
              <input type="color" class="form-control form-control-color w-100" id="theme_primary" value="#0ea5e9">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Accent</label>
              <input type="color" class="form-control form-control-color w-100" id="theme_accent" value="#0b6fa1">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Background</label>
              <input type="color" class="form-control form-control-color w-100" id="theme_bg" value="#f7fbfe">
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label">Text</label>
              <input type="color" class="form-control form-control-color w-100" id="theme_text" value="#06354a">
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">Hero title</label>
              <input class="form-control" id="hero_title" maxlength="120" placeholder="Affordable, Reliable Data—Anytime">
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label">Hero subtitle</label>
              <input class="form-control" id="hero_subtitle" maxlength="180" placeholder="Fund once, order instantly.">
            </div>

            <!-- Hero with GridFS -->
            <div class="col-12">
              <label class="form-label">Hero background</label>
              <div class="d-flex align-items-center gap-2 mb-2">
                <div class="hero-preview flex-grow-1" id="heroPreview" role="img" aria-label="Hero preview"></div>
              </div>
              <div class="d-flex align-items-center gap-2 mb-2">
                <input type="file" id="hero_file" accept="image/*" class="form-control">
                <button type="button" class="btn btn-outline-primary" id="btnUploadHero">
                  <i class="bi bi-cloud-upload"></i> Upload
                </button>
              </div>
              <input class="form-control" id="hero_bg" placeholder="or paste an image URL (optional)">
              <div class="small small-muted mt-1">Uploads are stored and the field is set to a /media/… link.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Services & Pricing -->
      <div class="col-12">
        <div class="card card-clean p-3">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
            <h2 class="form-section-title h6 m-0">Services & Pricing</h2>
            <div class="small small-muted">
              <span class="kbd">/</span> to focus search • Pick a service → Set a <strong>%</strong> or manual per-offer totals
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-12 col-md-4">
              <label class="form-label">Default percent (seed)</label>
              <div class="input-group">
                <input type="number" step="0.1" min="0" max="100" class="form-control" id="default_percent" value="10.0">
                <span class="input-group-text">%</span>
              </div>
              <div class="small small-muted mt-1">Prefills the percent for each newly added service.</div>
            </div>

            <div class="col-12 col-md-8">
              <label class="form-label">Add service</label>
              <div class="d-flex gap-2">
                <input id="svcSearch" class="form-control" placeholder="Search services (press / to focus)" />
                <select id="svcPicker" class="form-select" style="max-width:380px;">
                  <option value="">Choose service…</option>
                  {% for s in services %}
                    <option value="{{ s._id_str }}" data-index="{{ loop.index0 }}">{{ s.name }}</option>
                  {% endfor %}
                </select>
                <button class="btn btn-outline-primary" type="button" id="btnAddSvc"><i class="bi bi-plus-circle"></i> Add</button>
              </div>
              <div class="small small-muted mt-1">Only services you add will appear in your store.</div>
            </div>
          </div>

          <hr class="my-3"/>
          <div id="pickedWrap" class="d-grid gap-3"></div>
        </div>
      </div>
    </form>
  </main>

  <div class="sticky-actions">
    <div class="container py-3 d-flex flex-wrap gap-2 justify-content-end actions-right">
      <div class="me-auto small small-muted d-flex align-items-center gap-2">
        <i class="bi bi-shield-check"></i> Preview opens your store in a new tab before publishing
      </div>
      <button class="btn btn-outline-secondary" id="btnPreview" type="button">Preview</button>
      <button class="btn btn-primary" id="btnPublish" type="button">
        <span class="btn-text">Publish</span>
        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="toast" class="toast text-bg-dark border-0">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Done</div>
        <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script id="svc-data" type="application/json">
    {{ services | tojson }}
  </script>
  <script id="store-prefill" type="application/json">
    {{ (store or {}) | tojson }}
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    const t = new bootstrap.Toast(document.getElementById('toast'), {delay:2200});
    const toast = (msg)=>{ document.getElementById('toastBody').textContent = msg || 'Done'; t.show(); };
    const el = (id)=>document.getElementById(id);
    const fmt = (n)=> (Number(n||0)).toFixed(2);

    // Slugify + previews
    const slugify=(s)=> (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'') || 'store';
    el('name').addEventListener('input', ()=>{ const s=slugify(el('name').value); if(!el('slug').dataset.touched) el('slug').value=s; });
    el('slug').addEventListener('input', ()=>{ el('slug').dataset.touched='1'; });

    // Logo URL preview
    el('logo_url').addEventListener('input', ()=>{ el('logoPreview').src = el('logo_url').value || 'https://via.placeholder.com/128x128?text=Logo'; });

    // Hero URL preview
    const setHeroBg = (u)=>{ el('heroPreview').style.backgroundImage = u ? 'url('+u+')' : 'none'; };
    el('hero_bg').addEventListener('input', ()=> setHeroBg(el('hero_bg').value.trim()));

    // ---------- GridFS upload helper ----------
    async function uploadFile(inputEl){
      const f = inputEl.files && inputEl.files[0];
      if(!f){ toast('Choose a file first'); return null; }
      const fd = new FormData();
      fd.append('file', f, f.name);
      const res = await fetch('/api/media', { method:'POST', body: fd });
      const j = await res.json().catch(()=>({success:false}));
      if(!j || !j.success){ toast(j && j.message || 'Upload failed'); return null; }
      return j.url; // /media/<id>
    }

    // Logo upload
    el('btnUploadLogo').addEventListener('click', async ()=>{
      const url = await uploadFile(el('logo_file'));
      if(url){ el('logo_url').value = url; el('logoPreview').src = url; toast('Logo uploaded'); }
    });

    // Hero upload
    el('btnUploadHero').addEventListener('click', async ()=>{
      const url = await uploadFile(el('hero_file'));
      if(url){ el('hero_bg').value = url; setHeroBg(url); toast('Hero uploaded'); }
    });

    // ---------- Robust GB label helpers ----------
    function formatGb(n){ if(n == null || isNaN(n)) return "-"; const r=Math.round(n); return (Math.abs(n-r)<1e-9?String(r):String(parseFloat(n.toFixed(2))))+" GB"; }
    function parseMaybeObject(v){
      if(v && typeof v === "object") return v;
      if(typeof v !== "string") return null;
      const s = v.trim();
      if(!(s.startsWith("{") && s.endsWith("}"))) return null;
      try{ return JSON.parse(s); }catch(_){}
      try{
        const fixed = s.replace(/'/g,'"').replace(/\bNone\b/g,'null').replace(/\bTrue\b/g,'true').replace(/\bFalse\b/g,'false');
        return JSON.parse(fixed);
      }catch(_){ return null; }
    }
    function gbLabelFromOffer(o){
      if(o && typeof o.value_text === "string" && o.value_text.trim()){
        const vt=o.value_text.trim(); const mb=vt.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*mb\s*$/i);
        if(mb) return formatGb(parseFloat(mb[1])/1000); if(/gb/i.test(vt)) return vt.replace(/gb/ig,"GB");
      }
      let v = o ? o.value : undefined;
      const maybe = parseMaybeObject(v); if(maybe) v = maybe;
      let gb = null;
      if(v && typeof v === "object"){
        if(v.gb != null && !isNaN(parseFloat(v.gb))) gb = parseFloat(v.gb);
        else if(v.offer != null && !isNaN(parseFloat(v.offer))) gb = parseFloat(v.offer)/1000;
        else if(v.volume != null && !isNaN(parseFloat(v.volume))) gb = parseFloat(v.volume)/1000;
      }
      if(gb == null && o && o.volume != null && !isNaN(parseFloat(o.volume))) gb = parseFloat(o.volume)/1000;
      if(gb == null && typeof v === "string"){
        const g=v.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*gb\s*$/i); if(g) gb=parseFloat(g[1]);
        const m=v.match(/^\s*([0-9]+(?:\.[0-9]+)?)\s*mb\s*$/i); if(m) gb=parseFloat(m[1])/1000;
      }
      if(gb != null) return formatGb(gb);
      if(typeof v === "string") return v.replace(/gb/ig,"GB");
      return "-";
    }

    // Build services master list
    let SVC = [];
    try{
      const arr = JSON.parse(document.getElementById('svc-data')?.textContent || '[]') || [];
      SVC = arr.map(s => ({
        _id_str: s._id_str,
        name: s.name,
        offers: (s.offers || []).map(o => ({
          amount: Number.isFinite(Number(o.amount)) ? Number(o.amount) : 0,
          value: o.value,
          volume: o.volume,
          value_text: gbLabelFromOffer(o)
        }))
      }));
    }catch(e){ SVC = []; }

    // UI helpers
    function setLoading(btn, on){
      btn.disabled = !!on;
      const txt = btn.querySelector('.btn-text'); const sp = btn.querySelector('.spinner-border');
      if(on){ txt && txt.classList.add('d-none'); sp && sp.classList.remove('d-none'); }
      else  { txt && txt.classList.remove('d-none'); sp && sp.classList.add('d-none'); }
    }
    function escapeHtml(s){ return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // Search focus + filter
    const svcSearch = el('svcSearch');
    document.addEventListener('keydown',(e)=>{ if(e.key==='/' && !e.target.closest('input,textarea,select')){ e.preventDefault(); svcSearch.focus(); }});
    svcSearch.addEventListener('input',()=>{
      const q=(svcSearch.value||'').toLowerCase(); const picker=el('svcPicker');
      for(const opt of picker.options){ if(!opt.value){ opt.hidden=false; continue; } opt.hidden = !opt.textContent.toLowerCase().includes(q); }
    });

    // Picked services
    const pickedWrap = el('pickedWrap'); const picker = el('svcPicker'); const added = new Map();
    el('btnAddSvc').addEventListener('click', addSelectedService); picker.addEventListener('change', ()=>{ if(picker.value) addSelectedService(); });

    function addSelectedService(sidFromPrefill){
      const sid = sidFromPrefill || picker.value; if(!sid) return;
      if(added.has(sid)){ if(!sidFromPrefill) { toast('Service already added.'); picker.value=''; } return; }
      const s = SVC.find(x=>x._id_str===sid); if(!s){ toast('Service not found.'); return; }

      const startPercent = Number(el('default_percent').value||0);
      const card = document.createElement('div'); card.className='svc-card'; card.dataset.sid=sid;

      const rowsHtml = s.offers.map((o,idx)=>{
        const base = Number.isFinite(Number(o.amount)) ? Number(o.amount) : 0;
        const total = base + base * (startPercent/100);
        return (
          '<div class="offer-row" data-idx="'+idx+'">'+
            '<div class="text-truncate">'+escapeHtml(o.value_text||'-')+'</div>'+
            '<input class="form-control form-control-sm base" type="number" value="'+fmt(base)+'" disabled>'+
            '<input class="form-control form-control-sm total" type="number" min="0" step="0.01" value="'+fmt(total)+'" disabled>'+
          '</div>'
        );
      }).join('');

      card.innerHTML =
        '<div class="d-flex flex-wrap justify-content-between align-items-center gap-2">'
        +  '<div class="fw-bold">'+escapeHtml(s.name)+'</div>'
        +  '<div class="d-flex align-items-center gap-2">'
        +    '<span class="badge badge-soft"><span class="me-1">Offers:</span>'+s.offers.length+'</span>'
        +    '<button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="bi bi-x"></i></button>'
        +  '</div>'
        +'</div>'
        +'<div class="row g-3 mt-1">'
        +  '<div class="col-12 col-md-5">'
        +    '<label class="form-label mb-1">Percent for this service</label>'
        +    '<div class="input-group">'
        +      '<input type="number" step="0.1" min="0" max="100" class="form-control svc-percent" value="'+startPercent+'">'
        +      '<span class="input-group-text">%</span>'
        +    '</div>'
        +    '<div class="form-text">Applied to base unless you switch to manual per-offer totals.</div>'
        +  '</div>'
        +  '<div class="col-12 col-md-7 d-flex align-items-end">'
        +    '<div class="form-check form-switch ms-md-3">'
        +      '<input class="form-check-input svc-manual" type="checkbox" id="manual_'+sid+'">'
        +      '<label class="form-check-label" for="manual_'+sid+'">Manual per-offer amounts</label>'
        +    '</div>'
        +  '</div>'
        +'</div>'
        +'<div class="mt-3">'
        +  '<div class="row fw-semibold small text-muted px-2">'
        +    '<div class="col-6 col-sm-6">Offer</div>'
        +    '<div class="col-3 col-sm-3 text-end">System Base</div>'
        +    '<div class="col-3 col-sm-3 text-end">Customer Price</div>'
        +  '</div>'
        +  '<div class="d-grid gap-2 mt-1">'+ rowsHtml + '</div>'
        +  '<div class="d-flex justify-content-end mt-2 small">'
        +    '<span class="text-muted">Sum: GHS <span class="svc-sum">0.00</span></span>'
        +  '</div>'
        +'</div>';

      pickedWrap.appendChild(card); added.set(sid, card);
      if(!sidFromPrefill){ const opt = picker.querySelector('option[value="'+sid.replace(/"/g,'\\"')+'"]'); if(opt) opt.remove(); picker.value=''; }

      const percentInput = card.querySelector('.svc-percent');
      const manualCheck  = card.querySelector('.svc-manual');
      const totalInputs  = Array.from(card.querySelectorAll('.total'));
      const baseInputs   = Array.from(card.querySelectorAll('.base'));
      const sumEl        = card.querySelector('.svc-sum');

      const recalcByPercent = ()=>{
        const p = Number(percentInput.value||0);
        for(let i=0;i<totalInputs.length;i++){
          const base = Number(baseInputs[i].value||0);
          if(!manualCheck.checked){
            const totalVal = base + base*p/100;
            totalInputs[i].value = fmt(Number.isFinite(totalVal) ? totalVal : 0);
          }
        }
        let sum = 0; for(const ti of totalInputs){ sum += Number(ti.value||0); }
        sumEl.textContent = fmt(sum);
      };
      recalcByPercent();
      percentInput.addEventListener('input', recalcByPercent);
      manualCheck.addEventListener('change', ()=>{ const on=manualCheck.checked; totalInputs.forEach(inp=>inp.disabled=!on); if(!on) recalcByPercent(); });
      totalInputs.forEach(inp=>inp.addEventListener('input', ()=>{ let sum=0; totalInputs.forEach(x=> sum += Number(x.value||0)); sumEl.textContent=fmt(sum); }));
      card.querySelector('.btn-remove').addEventListener('click', ()=>{ added.delete(sid); card.remove(); const svc=SVC.find(x=>x._id_str===sid); if(svc){ const o=document.createElement('option'); o.value=svc._id_str; o.textContent=svc.name; picker.appendChild(o); }});
    }

    // Collect payload
    function collectPayload(statusWanted){
      const service_ids = [];
      const per_service = [];
      added.forEach((card, sid)=>{
        service_ids.push(sid);
        const manual = card.querySelector('.svc-manual').checked;
        if(manual){
          const rows = Array.from(card.querySelectorAll('.offer-row'));
          const svc = SVC.find(x=>x._id_str===sid);
          const offers = rows.map(r=>{
            const idx = Number(r.getAttribute('data-idx'));
            const total = Number(r.querySelector('.total').value || 0);
            const vt = (svc && svc.offers && svc.offers[idx] && svc.offers[idx].value_text) ? svc.offers[idx].value_text : '-';
            return { index: idx, value_text: vt, total: Number(total.toFixed(2)) };
          });
          per_service.push({ service_id: sid, offers });
        }else{
          const p = Number(card.querySelector('.svc-percent').value || 0);
          per_service.push({ service_id: sid, percent: Number(p.toFixed(2)) });
        }
      });
      return {
        name: el('name').value.trim(),
        slug: el('slug').value.trim(),
        logo_url: el('logo_url').value.trim(),              // may be /media/<id>
        layout: el('layout').value,
        theme: {
          primary: el('theme_primary').value, accent: el('theme_accent').value,
          bg: el('theme_bg').value, text: el('theme_text').value
        },
        hero: { title: el('hero_title').value.trim(), subtitle: el('hero_subtitle').value.trim(), bg_image: el('hero_bg').value.trim() }, // may be /media/<id>
        service_scope: "selected",
        service_ids,
        pricing: { mode: "mixed", percent_default: Number(el('default_percent').value || 0), per_service },
        status: statusWanted
      };
    }

    // API helpers
    async function upsert(payload){ const r=await fetch('/api/stores',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); return r.json(); }
    async function saveDraft(){ const payload=collectPayload('draft'); const r=await fetch('/api/stores/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); return r.json(); }
    async function changeStatus(slug, status){ const r=await fetch('/api/stores/'+encodeURIComponent(slug)+'/status',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({status})}); return r.json(); }
    async function deleteStore(slug){ const r=await fetch('/api/stores/'+encodeURIComponent(slug),{method:'DELETE'}); return r.json(); }

    // Buttons
    el('btnPreview').addEventListener('click', async ()=>{
      const j = await saveDraft();
      if(j.success){
        const slug = (el('slug').value||'store').trim();
        window.open('/s/'+encodeURIComponent(slug)+'?preview=1','_blank');
      }else{
        toast(j.message || 'Preview failed.');
      }
    });

    el('btnPublish').addEventListener('click', async ()=>{
      if(!document.getElementById('storeForm').reportValidity()) return;
      const btn = el('btnPublish'); btn.disabled = true; const txt = btn.querySelector('.btn-text'); const sp = btn.querySelector('.spinner-border'); txt.classList.add('d-none'); sp.classList.remove('d-none');
      try{
        const payload = collectPayload('published');
        const j = await upsert(payload);
        if(j.success){ toast('Store published!'); window.location.href = '/s/'+encodeURIComponent(j.slug); }
        else toast(j.message || 'Could not publish.');
      }catch(_){ toast('Network error.'); }
      txt.classList.remove('d-none'); sp.classList.add('d-none'); btn.disabled = false;
    });

    const btnSuspend = el('btnSuspend'), btnResume = el('btnResume'), btnDelete = el('btnDelete');
    function updateHeaderControls(status, slug){
      const hasSlug = !!(slug || el('slug').value.trim());
      btnDelete.hidden = !hasSlug;
      if(status === 'suspended'){
        btnSuspend.hidden = false; btnSuspend.textContent = 'Suspended'; btnSuspend.disabled = true;
        btnResume.hidden = false; btnResume.disabled = false;
      }else if(status === 'published'){
        btnSuspend.hidden = false; btnSuspend.textContent = 'Suspend'; btnSuspend.disabled = false;
        btnResume.hidden = true;
      }else{
        btnSuspend.hidden = true; btnResume.hidden = true;
      }
    }
    btnSuspend.addEventListener('click', async ()=>{
      const slug = el('slug').value.trim(); if(!slug) return;
      if(btnSuspend.disabled) return;
      const j = await changeStatus(slug, 'suspended');
      if(j.success){ toast('Store suspended.'); updateHeaderControls('suspended', slug); } else toast(j.message || 'Failed to suspend.');
    });
    btnResume.addEventListener('click', async ()=>{
      const slug = el('slug').value.trim(); if(!slug) return;
      const j = await changeStatus(slug, 'published');
      if(j.success){ toast('Store resumed.'); updateHeaderControls('published', slug); } else toast(j.message || 'Failed to resume.');
    });
    btnDelete.addEventListener('click', async ()=>{
      const slug = el('slug').value.trim(); if(!slug) return;
      if(!confirm('Delete this store?')) return;
      const j = await deleteStore(slug);
      if(j.success){ toast('Store deleted.'); location.href = '/customer_dashboard'; } else toast(j.message || 'Delete failed.');
    });

    // Prefill existing store
    async function prefill(){
      let store = {};
      try{ store = JSON.parse(document.getElementById('store-prefill')?.textContent || '{}') || {}; }catch(_){}
      if(!store || !store.slug){
        try{
          const r = await fetch('/api/stores/mine'); const j = await r.json();
          if(j.success && j.store) store = j.store || {};
        }catch(_){}
      }
      if(!store || !store.slug) { updateHeaderControls('draft',''); return; }

      el('name').value = store.name || '';
      el('slug').value = store.slug || '';
      el('slug').dataset.touched = '1';

      el('logo_url').value = store.logo_url || '';
      el('logoPreview').src = store.logo_url || 'https://via.placeholder.com/128x128?text=Logo';

      el('layout').value = store.layout || 'grid-2';

      const theme = store.theme || {};
      el('theme_primary').value = theme.primary || '#0ea5e9';
      el('theme_accent').value  = theme.accent  || '#0b6fa1';
      el('theme_bg').value      = theme.bg      || '#f7fbfe';
      el('theme_text').value    = theme.text    || '#06354a';

      const hero = store.hero || {};
      el('hero_title').value    = hero.title    || '';
      el('hero_subtitle').value = hero.subtitle || '';
      el('hero_bg').value       = hero.bg_image || '';
      setHeroBg(hero.bg_image || '');

      const pricing = store.pricing || {};
      el('default_percent').value = Number(pricing.percent_default || 0).toFixed(1);

      const svcIds = (store.service_ids || []);
      const perMap = {};
      for(const x of (pricing.per_service || [])){ perMap[String(x.service_id)] = { percent: x.percent, offers: x.offers || [] }; }

      for(const sid of svcIds){
        addSelectedService(sid);
        const card = [...document.querySelectorAll('.svc-card')].find(c=>c.dataset.sid===sid);
        if(!card) continue;

        const cfg = perMap[sid] || {};
        const percentInput = card.querySelector('.svc-percent');
        const manualCheck  = card.querySelector('.svc-manual');
        const totals = [...card.querySelectorAll('.total')];

        if(cfg.offers && cfg.offers.length){
          manualCheck.checked = true; totals.forEach(inp=> inp.disabled=false);
          cfg.offers.forEach(o=>{ const row = card.querySelector('.offer-row[data-idx="'+o.index+'"]'); if(row){ const ti = row.querySelector('.total'); ti.value = Number(o.total||0).toFixed(2); }});
          let sum=0; totals.forEach(x=> sum += Number(x.value||0)); card.querySelector('.svc-sum').textContent = fmt(sum);
        }else if(cfg.percent != null){
          percentInput.value = Number(cfg.percent||0).toFixed(1);
          percentInput.dispatchEvent(new Event('input'));
        }
      }

      updateHeaderControls(store.status || 'draft', store.slug);
    }

    prefill();
  })();
  </script>
</body>
</html>
