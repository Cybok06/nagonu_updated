<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin · AFA Registrations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root { --sea-blue:#0ea5e9; --soft:#f6f8fb; --ink:#0b1320; }
    body { background: var(--soft); }
    .page-card { border:1px solid #e9ecef; border-radius:14px; background:#fff; }
    .status-badge { font-size:.75rem; padding:.35rem .55rem; border-radius:999px; border:1px solid transparent; }
    .st-pending    { background:rgba(255,193,7,.15);  color:#b58100; border-color:rgba(255,193,7,.35); }
    .st-completed  { background:rgba(25,135,84,.12);  color:#198754; border-color:rgba(25,135,84,.30); }
    .st-failed,
    .st-rejected   { background:rgba(220,53,69,.12);  color:#dc3545; border-color:rgba(220,53,69,.30); }
    .st-processing,
    .st-inprogress { background:rgba(13,110,253,.10); color:#0d6efd; border-color:rgba(13,110,253,.25); }
    .st-delivered  { background:rgba(13,110,253,.10); color:#0b5ed7; border-color:rgba(13,110,253,.25); }
    .table > :not(caption) > * > * { vertical-align: middle; }
    .small-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.85rem; }
  </style>
</head>
<body>
  {% include 'admin_sidebar.html' ignore missing %}

  <main class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-list-check me-2 fs-4 text-primary"></i>
      <h3 class="mb-0">AFA Registrations (Admin)</h3>
    </div>

    <!-- Filters -->
    <div class="page-card p-3 mb-3">
      <form id="filter-form" class="row g-2 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label" for="q">Search</label>
          <input id="q" class="form-control" placeholder="name, phone, Ghana card, location">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label" for="status">Status</label>
          <select id="status" class="form-select">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="processing">Processing</option>
            <option value="delivered">Delivered</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label" for="charged">Charged</label>
          <select id="charged" class="form-select">
            <option value="">Any</option>
            <option value="true">Charged</option>
            <option value="false">Not charged</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label" for="date_from">From</label>
          <input id="date_from" type="date" class="form-control">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label" for="date_to">To</label>
          <input id="date_to" type="date" class="form-control">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label" for="page_size">Per page</label>
          <select id="page_size" class="form-select">
            <option>25</option><option>50</option><option>100</option>
          </select>
        </div>
        <div class="col-12 d-flex gap-2">
          <button class="btn btn-primary" type="submit">Filter</button>
          <button class="btn btn-outline-secondary" type="button" id="btn-reset">Reset</button>
        </div>
      </form>
    </div>

    <!-- Stats -->
    <div class="page-card p-3 mb-3">
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <div class="fw-semibold">Total (filtered)</div>
          <div><span id="stat-total" class="small-mono">0</span> orders</div>
        </div>
        <div class="col-12 col-md-3">
          <div class="fw-semibold">Sum Amount</div>
          <div>GHS <span id="stat-sum" class="small-mono">0.00</span></div>
        </div>
        <div class="col-12 col-md-6">
          <div class="fw-semibold">By Status</div>
          <div class="small">
            Pending: <span id="st-pending">0</span> ·
            Processing: <span id="st-processing">0</span> ·
            Delivered: <span id="st-delivered">0</span> ·
            Completed: <span id="st-completed">0</span> ·
            Failed: <span id="st-failed">0</span> ·
            Rejected: <span id="st-rejected">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="page-card p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:48px">#</th>
              <th>Customer</th>
              <th>Name</th>
              <th>Phone</th>
              <th>Ghana Card</th>
              <th>DoB</th>
              <th>Location</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Charged</th>
              <th>Created</th>
              <th style="width:210px">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center p-3">
        <div class="text-muted" id="results-info"></div>
        <div class="btn-group">
          <button class="btn btn-outline-primary btn-sm" id="prev">Prev</button>
          <button class="btn btn-outline-primary btn-sm" id="next">Next</button>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      var page = 1;

      function money(n){ return Number(n || 0).toFixed(2); }
      function badge(st){
        var s = (st || "pending").toLowerCase();
        var cls = "status-badge ";
        if (s === "completed") cls += "st-completed";
        else if (s === "failed" || s === "rejected") cls += "st-rejected";
        else if (s === "processing" || s === "inprogress") cls += "st-processing";
        else if (s === "delivered") cls += "st-delivered";
        else cls += "st-pending";
        return '<span class="'+cls+'">'+ s.charAt(0).toUpperCase()+s.slice(1) +'</span>';
      }

      function load(){
        var q = document.getElementById("q").value || "";
        var status = document.getElementById("status").value || "";
        var charged = document.getElementById("charged").value || "";
        var df = document.getElementById("date_from").value || "";
        var dt = document.getElementById("date_to").value || "";
        var pageSize = document.getElementById("page_size").value || "25";

        var params = ["page="+encodeURIComponent(page), "page_size="+encodeURIComponent(pageSize)];
        if (q) params.push("q="+encodeURIComponent(q));
        if (status) params.push("status="+encodeURIComponent(status));
        if (charged) params.push("charged="+encodeURIComponent(charged));
        if (df) params.push("date_from="+encodeURIComponent(df));
        if (dt) params.push("date_to="+encodeURIComponent(dt));

        fetch("/admin/api/afa/list?"+params.join("&"))
          .then(function(r){ return r.json(); })
          .then(function(res){
            if (!res || !res.success){ alert((res && res.error) || "Failed to load"); return; }

            document.getElementById("stat-total").textContent = res.total;
            document.getElementById("stat-sum").textContent = money(res.total_amount || 0);
            var sc = res.status_counts || {};
            document.getElementById("st-pending").textContent   = sc.pending   || 0;
            document.getElementById("st-processing").textContent= sc.processing|| 0;
            document.getElementById("st-delivered").textContent = sc.delivered || 0;
            document.getElementById("st-completed").textContent = sc.completed || 0;
            document.getElementById("st-failed").textContent    = sc.failed    || 0;
            document.getElementById("st-rejected").textContent  = sc.rejected  || 0;

            var tbody = document.getElementById("rows");
            tbody.innerHTML = "";
            for (var i=0;i<res.items.length;i++){
              var it = res.items[i];
              var idx = (res.page - 1) * res.page_size + i + 1;
              var custName = (it.customer && (it.customer.name || it.customer.phone)) || "-";
              var st = it.status || "pending";
              var chargedText = it.charged ? "Yes" : "No";

              var disableDeliver = (st === "delivered" || st === "completed" || st === "rejected" || st === "failed");
              var disableCharge  = it.charged === true;

              var tr = document.createElement("tr");
              tr.innerHTML =
                "<td>"+idx+"</td>"+
                "<td>"+custName+"</td>"+
                "<td>"+(it.name||"")+"</td>"+
                "<td>"+(it.phone||"")+"</td>"+
                "<td>"+(it.ghana_card||"")+"</td>"+
                "<td>"+(it.dob||"")+"</td>"+
                "<td>"+(it.location||"")+"</td>"+
                "<td>GHS "+money(it.amount)+"</td>"+
                "<td>"+badge(st)+"</td>"+
                "<td>"+chargedText+"</td>"+
                "<td>"+(it.created_at_display||"")+"</td>"+
                '<td>'+
                  '<div class="btn-group btn-group-sm" role="group">'+
                    '<button class="btn btn-outline-success btn-deliver" data-id="'+it.id+'" '+(disableDeliver?'disabled':'')+'>Mark Delivered</button>'+
                    '<button class="btn btn-outline-danger btn-charge" data-id="'+it.id+'" '+(disableCharge?'disabled':'')+'>Charge GHS 2</button>'+
                  '</div>'+
                '</td>';
              tbody.appendChild(tr);
            }

            var start = res.total ? ((res.page - 1) * res.page_size + 1) : 0;
            var end   = Math.min(res.total, res.page * res.page_size);
            document.getElementById("results-info").textContent =
              "Showing "+start+"-"+end+" of "+res.total;

            document.getElementById("prev").disabled = (res.page <= 1);
            document.getElementById("next").disabled = (res.page * res.page_size >= res.total);
          })
          .catch(function(){ alert("Network error"); });
      }

      // filters
      document.getElementById("filter-form").addEventListener("submit", function(e){
        e.preventDefault(); page=1; load();
      });
      document.getElementById("btn-reset").addEventListener("click", function(){
        document.getElementById("q").value="";
        document.getElementById("status").value="";
        document.getElementById("charged").value="";
        document.getElementById("date_from").value="";
        document.getElementById("date_to").value="";
        page=1; load();
      });
      document.getElementById("page_size").addEventListener("change", function(){
        page=1; load();
      });

      document.getElementById("prev").addEventListener("click", function(){ if(page>1){ page--; load(); }});
      document.getElementById("next").addEventListener("click", function(){ page++; load(); });

      // actions
      document.addEventListener("click", function(e){
        var b1 = e.target.closest(".btn-deliver");
        if (b1){
          var id = b1.getAttribute("data-id");
          b1.disabled = true;
          fetch("/admin/api/afa/"+encodeURIComponent(id)+"/status", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({status: "delivered"})
          }).then(function(r){ return r.json(); })
            .then(function(res){
              if(!res || !res.success){ alert((res && res.error) || "Failed"); }
              load();
            }).catch(function(){ alert("Network error"); })
            .finally(function(){ b1.disabled=false; });
          return;
        }

        var b2 = e.target.closest(".btn-charge");
        if (b2){
          var id = b2.getAttribute("data-id");
          if (!confirm("Charge this customer GHS 2.00 for AFA registration?")) return;
          b2.disabled = true;
          fetch("/admin/api/afa/"+encodeURIComponent(id)+"/charge", {
            method: "POST"
          }).then(function(r){ return r.json(); })
            .then(function(res){
              if(!res || !res.success){ alert((res && res.error) || "Charge failed"); }
              else { alert("Charged successfully."); }
              load();
            }).catch(function(){ alert("Network error"); })
            .finally(function(){ b2.disabled=false; });
          return;
        }
      });

      load(); // initial
    })();
  </script>
</body>
</html>
