{% set current = request.endpoint or "" %}
{% set username = session.get("username", "Customer") %}
{% set role = session.get("role", "customer") %}

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
  :root{
    --sea-blue:#0ea5e9; --dark-bg:#053047; --light-text:#e9eef6;
    --sidebar-w:260px; --mobile-navbar-h:56px;
  }

  /* --- Sidebar --- */
  .admin-sidebar{ width:var(--sidebar-w); background:var(--dark-bg); color:var(--light-text); }
  .sidebar-fixed{ position:fixed; top:0; left:0; height:100vh; overflow-y:auto; -webkit-overflow-scrolling:touch; z-index:1030; transform:translateX(0); transition:transform .3s ease; }
  @media (min-width:992px){ .sidebar-hidden .admin-sidebar.sidebar-fixed{ transform:translateX(-100%); } }

  .admin-avatar{ width:42px; height:42px; border-radius:50%; overflow:hidden; border:2px solid var(--sea-blue); flex:0 0 42px; }
  .admin-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* Unified nav-link layout: Icon | Label | Badge */
  .admin-sidebar .nav-link,
  .offcanvas-body .nav-link{
    color:#c9d6e3;
    border-radius:.6rem;
    padding:.6rem .75rem;
    display:flex;
    align-items:center;
    gap:.5rem;
    text-decoration:none;
  }
  .admin-sidebar .nav-link .nav-ico,
  .offcanvas-body .nav-link .nav-ico{
    width:1.25rem; /* fixed icon box so labels align */
    display:inline-flex; align-items:center; justify-content:center;
    flex:0 0 1.25rem;
    font-size:1.05rem;
    margin-right:.35rem;
  }
  .admin-sidebar .nav-link .nav-label,
  .offcanvas-body .nav-link .nav-label{
    flex:1 1 auto;
    min-width:0;                /* allows ellipsis */
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-weight:500;
    letter-spacing:.2px;
  }
  .admin-sidebar .nav-link .badge,
  .offcanvas-body .nav-link .badge{
    margin-left:auto;
    flex:0 0 auto;
  }

  .nav-link.active,
  .nav-link:hover{
    background:var(--sea-blue);
    color:#fff !important;
  }
  .nav-link:focus-visible{
    outline:2px solid #8fd3ff;
    outline-offset:2px;
  }

  .nav .collapse .nav-link{ padding-left:2.35rem; }

  /* Content layout */
  .customer-content{ padding:1rem; }
  @media (max-width:991.98px){ .customer-content{ padding-top:calc(var(--mobile-navbar-h) + 1rem); } }
  @media (min-width:992px){
    .customer-content{ margin-left:var(--sidebar-w); padding:2rem; transition:margin-left .3s ease; }
    .sidebar-hidden .customer-content{ margin-left:0; }
  }

  /* Mobile Top Navbar */
  .customer-topbar{ background:var(--dark-bg); height:var(--mobile-navbar-h); }

  /* Desktop toggle */
  .sidebar-toggle-lg{
    position:fixed; top:12px; left:calc(var(--sidebar-w) + 12px);
    z-index:1050; transition:left .3s ease, box-shadow .2s;
    box-shadow:0 2px 10px rgba(0,0,0,.15);
  }
  .sidebar-hidden .sidebar-toggle-lg{ left:12px; }
  .sidebar-toggle-lg .bi{ font-size:1.2rem; }
</style>

<!-- Top Navbar (Mobile) -->
<nav class="navbar navbar-dark customer-topbar d-lg-none fixed-top">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <div class="fw-bold text-white fs-5">Nagonu</div>
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#adminDrawer" aria-controls="adminDrawer">
      <span class="navbar-toggler-icon"></span>
    </button>
  </div>
</nav>

<!-- Offcanvas Sidebar (Mobile) -->
<div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="adminDrawer" style="width:var(--sidebar-w); background:var(--dark-bg);">
  <div class="offcanvas-header">
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column">
    <!-- User -->
    <div class="d-flex align-items-center mb-3">
      <div class="admin-avatar me-2">
        <img src="https://res.cloudinary.com/dcmewvlyx/image/upload/v1754392905/Ngonu_Logo_xntvbm.jpg" alt="Logo">
      </div>
      <div>
        <div class="fw-semibold">{{ username }}</div>
        <div class="text-white-50 text-capitalize small">{{ role }}</div>
      </div>
    </div>

    <hr class="border-secondary">

    <!-- Mobile Nav -->
    <ul class="nav flex-column mb-auto">
      <li class="nav-item">
        <a class="nav-link" href="/admin/dashboard">
          <i class="bi bi-speedometer2 nav-ico"></i><span class="nav-label">Dashboard</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_customers.view_customers') }}" class="nav-link {% if current == 'admin_customers.view_customers' %}active{% endif %}">
          <i class="bi bi-people-fill nav-ico"></i><span class="nav-label">Customers</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_services.manage_services') }}" class="nav-link {% if current == 'admin_services.manage_services' %}active{% endif %}">
          <i class="bi bi-collection nav-ico"></i><span class="nav-label">Services</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_orders.admin_view_orders') }}"
           class="nav-link {% if current == 'admin_orders.admin_view_orders' %}active{% endif %}"
           {% if undelivered_orders_count > 0 %}
             data-bs-toggle="tooltip"
             data-bs-placement="right"
             title="You have {{ undelivered_orders_count }} order{% if undelivered_orders_count != 1 %}s{% endif %} undelivered"
           {% endif %}>
          <i class="bi bi-bag-check-fill nav-ico"></i>
          <span class="nav-label">Orders</span>
          {% if undelivered_orders_count > 0 %}
            <span class="badge bg-warning text-dark">{{ undelivered_orders_count }}</span>
          {% endif %}
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_store.admin_stores_page') }}"
           class="nav-link {% if current == 'admin_store.admin_stores_page' %}active{% endif %}">
          <i class="bi bi-shop-window nav-ico"></i><span class="nav-label">Stores</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_transactions.admin_view_transactions') }}" class="nav-link {% if current == 'admin_transactions.admin_view_transactions' %}active{% endif %}">
          <i class="bi bi-cash-stack nav-ico"></i><span class="nav-label">Transactions</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_referrals.admin_referrals') }}" class="nav-link {% if current == 'admin_referrals.admin_referrals' %}active{% endif %}">
          <i class="bi bi-person-lines-fill nav-ico"></i><span class="nav-label">Referrals</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_balance.view_balances') }}" class="nav-link {% if current == 'admin_balance.view_balances' %}active{% endif %}">
          <i class="bi bi-wallet2 nav-ico"></i><span class="nav-label">Balances</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('shares.shares_dashboard') }}" class="nav-link {% if is_shares %}active{% endif %}">
          <i class="bi bi-graph-up-arrow nav-ico"></i>
          <span class="nav-label">Shares / Wallet</span>
          {% if wallet_available is defined %}
            <span class="badge bg-info text-dark">GHS {{ '%.2f'|format(wallet_available) }}</span>
          {% endif %}
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_wassce_checker.admin_wassce_checker') }}" class="nav-link {% if current == 'admin_wassce_checker.admin_wassce_checker' %}active{% endif %}">
          <i class="bi bi-book nav-ico"></i><span class="nav-label">Results Checker</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_purchases.view_all_purchases') }}" class="nav-link {% if current == 'admin_purchases.view_all_purchases' %}active{% endif %}">
          <i class="bi bi-basket2 nav-ico"></i><span class="nav-label">All Purchases</span>
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('admin_complaints.admin_view_complaints') }}" class="nav-link {% if current == 'admin_complaints.admin_view_complaints' %}active{% endif %}">
          <i class="bi bi-chat-dots nav-ico"></i><span class="nav-label">Complaints</span>
          {% if pending_complaints_count > 0 %}<span class="badge bg-danger">{{ pending_complaints_count }}</span>{% endif %}
        </a>
      </li>

      <li class="nav-item">
        <a href="{{ url_for('login_logs.view_login_logs') }}" class="nav-link {% if current == 'login_logs.view_login_logs' %}active{% endif %}">
          <i class="bi bi-shield-lock nav-ico"></i><span class="nav-label">Login Logs</span>
        </a>
      </li>
    </ul>

    <div class="mt-auto">
      <hr class="border-secondary">
      <a href="{{ url_for('login.logout') }}" class="btn btn-outline-light w-100">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </a>
    </div>
  </div>
</div>

<!-- Desktop Sidebar -->
<aside class="admin-sidebar sidebar-fixed d-none d-lg-flex flex-column p-3">
  <div class="d-flex align-items-center mb-3">
    <div class="admin-avatar me-2">
      <img src="https://res.cloudinary.com/dcmewvlyx/image/upload/v1754392905/Ngonu_Logo_xntvbm.jpg" alt="Logo">
    </div>
    <div>
      <div class="fw-semibold">{{ username }}</div>
      <div class="text-white-50 text-capitalize small">{{ role }}</div>
    </div>
  </div>

  <hr class="border-secondary">

  <ul class="nav flex-column mb-auto">
    <li class="nav-item">
      <a class="nav-link" href="/admin/dashboard">
        <i class="bi bi-speedometer2 nav-ico"></i><span class="nav-label">Dashboard</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_customers.view_customers') }}" class="nav-link {% if current == 'admin_customers.view_customers' %}active{% endif %}">
        <i class="bi bi-people-fill nav-ico"></i><span class="nav-label">Customers</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_services.manage_services') }}" class="nav-link {% if current == 'admin_services.manage_services' %}active{% endif %}">
        <i class="bi bi-collection nav-ico"></i><span class="nav-label">Services</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_store.admin_stores_page') }}"
         class="nav-link {% if current == 'admin_store.admin_stores_page' %}active{% endif %}">
        <i class="bi bi-shop-window nav-ico"></i><span class="nav-label">Stores</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_orders.admin_view_orders') }}"
         class="nav-link {% if current == 'admin_orders.admin_view_orders' %}active{% endif %}"
         {% if undelivered_orders_count > 0 %}
           data-bs-toggle="tooltip"
           data-bs-placement="right"
           title="You have {{ undelivered_orders_count }} order{% if undelivered_orders_count != 1 %}s{% endif %} undelivered"
         {% endif %}>
        <i class="bi bi-bag-check-fill nav-ico"></i>
        <span class="nav-label">Orders</span>
        {% if undelivered_orders_count > 0 %}
          <span class="badge bg-warning text-dark">{{ undelivered_orders_count }}</span>
        {% endif %}
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_transactions.admin_view_transactions') }}" class="nav-link {% if current == 'admin_transactions.admin_view_transactions' %}active{% endif %}">
        <i class="bi bi-cash-stack nav-ico"></i><span class="nav-label">Transactions</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_referrals.admin_referrals') }}" class="nav-link {% if current == 'admin_referrals.admin_referrals' %}active{% endif %}">
        <i class="bi bi-person-lines-fill nav-ico"></i><span class="nav-label">Referrals</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_balance.view_balances') }}" class="nav-link {% if current == 'admin_balance.view_balances' %}active{% endif %}">
        <i class="bi bi-wallet2 nav-ico"></i><span class="nav-label">Balances</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('shares.shares_dashboard') }}" class="nav-link {% if is_shares %}active{% endif %}">
        <i class="bi bi-graph-up-arrow nav-ico"></i>
        <span class="nav-label">Shares / Wallet</span>
        {% if wallet_available is defined %}
          <span class="badge bg-info text-dark">GHS {{ '%.2f'|format(wallet_available) }}</span>
        {% endif %}
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_wassce_checker.admin_wassce_checker') }}" class="nav-link {% if current == 'admin_wassce_checker.admin_wassce_checker' %}active{% endif %}">
        <i class="bi bi-book nav-ico"></i><span class="nav-label">Results Checker</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_purchases.view_all_purchases') }}" class="nav-link {% if current == 'admin_purchases.view_all_purchases' %}active{% endif %}">
        <i class="bi bi-basket2 nav-ico"></i><span class="nav-label">All Purchases</span>
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('admin_complaints.admin_view_complaints') }}" class="nav-link {% if current == 'admin_complaints.admin_view_complaints' %}active{% endif %}">
        <i class="bi bi-chat-dots nav-ico"></i><span class="nav-label">Complaints</span>
        {% if pending_complaints_count > 0 %}<span class="badge bg-danger">{{ pending_complaints_count }}</span>{% endif %}
      </a>
    </li>

    <li class="nav-item">
      <a href="{{ url_for('login_logs.view_login_logs') }}" class="nav-link {% if current == 'login_logs.view_login_logs' %}active{% endif %}">
        <i class="bi bi-shield-lock nav-ico"></i><span class="nav-label">Login Logs</span>
      </a>
    </li>
  </ul>

  <div class="mt-auto">
    <a href="{{ url_for('login.logout') }}" class="btn btn-outline-light w-100 mt-3">
      <i class="bi bi-box-arrow-right me-1"></i> Logout
    </a>
  </div>
</aside>

<!-- Desktop toggle (visible on lg+) -->
<button type="button" class="btn btn-light d-none d-lg-inline-flex align-items-center gap-2 sidebar-toggle-lg" id="sidebarToggleLg" aria-label="Toggle sidebar">
  <i class="bi bi-layout-sidebar-inset-reverse"></i>
  <span class="d-none d-xl-inline">Menu</span>
</button>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  (function(){
    const root=document.documentElement;
    const KEY='customerSidebarHidden';
    const toggleBtn=document.getElementById('sidebarToggleLg');

    function applySavedState(){
      try{
        const hidden=localStorage.getItem(KEY);
        if(hidden==='1') root.classList.add('sidebar-hidden');
        else root.classList.remove('sidebar-hidden');
      }catch(e){}
    }
    applySavedState();

    toggleBtn?.addEventListener('click',function(){
      root.classList.toggle('sidebar-hidden');
      try{
        const isHidden=root.classList.contains('sidebar-hidden');
        localStorage.setItem(KEY, isHidden?'1':'0');
      }catch(e){}
    });
  })();

  // Enable Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function () {
    if (window.bootstrap) {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }
  });
</script>
