<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Services - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    :root { --sea-blue:#0ea5e9; }

    /* Layout */
    @media (min-width: 992px) { .admin-content { margin-left: 260px; padding: 2rem; } }
    @media (max-width: 991px) { .admin-content { margin-top: 1rem; padding: 1rem; } }

    .btn-seablue { background-color: var(--sea-blue); border-color: var(--sea-blue); color:#fff; }
    .btn-seablue:hover { filter:brightness(0.95); color:#fff; }
    .small-muted { font-size:.9rem; color:#6c757d; }

    /* Service cards grid */
    .svc-card-img { width:100%; height:140px; object-fit:cover; border-radius:12px; background:#f3f6f9; }
    .svc-chip { background:#f8fafc; border:1px solid #e9ecef; border-radius:999px; padding:.2rem .55rem; font-size:.8rem; }

    /* Badges (Type/Status/Availability) */
    .svc-badge { font-size:.75rem; padding:.35rem .5rem; border-radius:999px; border:1px solid transparent; display:inline-block; }
    /* Type */
    .svc-type-API { background:rgba(25,135,84,.12); color:#198754; border-color:rgba(25,135,84,.3); }
    .svc-type-OFF { background:rgba(220,53,69,.12); color:#dc3545; border-color:rgba(220,53,69,.3); }
    /* Status (OPEN/CLOSED) */
    .svc-status-OPEN { background:rgba(25,135,84,.12); color:#198754; border-color:rgba(25,135,84,.3); }
    .svc-status-CLOSED { background:rgba(220,53,69,.12); color:#dc3545; border-color:rgba(220,53,69,.3); }
    /* Availability (AVAILABLE/OUT_OF_STOCK) */
    .svc-avail-AVAILABLE { background:rgba(13,110,253,.12); color:#0d6efd; border-color:rgba(13,110,253,.3); }
    .svc-avail-OUT_OF_STOCK { background:rgba(255,193,7,.15); color:#9a6e00; border-color:rgba(255,193,7,.35); }

    /* Modal: long-friendly with sticky header + footer */
    .modal-header { position: sticky; top: 0; background: #fff; z-index: 3; border-bottom: 1px solid rgba(0,0,0,.125); }
    .modal-footer { position: sticky; bottom: 0; background: #fff; z-index: 3; border-top: 1px solid rgba(0,0,0,.125); }
    .modal-dialog-xxl { max-width: min(1200px, 96vw); } /* roomy */
    .img-preview-lg { width:100%; height:220px; object-fit:cover; border-radius:10px; background:#f3f6f9; }

    /* Offers grid inside modals */
    .offers-grid thead th { position: sticky; top: 0; background: #fff; z-index: 2; }
    .offers-grid input { min-width: 110px; }
    .offers-grid .row-actions { width: 48px; }
    .paste-hint { font-size: .85rem; color:#6c757d; }

    @media (max-width: 380px) {
      .btn-sm { padding: .25rem .5rem; font-size: .8rem; }
      .badge { font-size: .7rem; }
    }
  </style>
</head>

<body>
  {% include 'admin_sidebar.html' %}

  <div class="admin-content">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h2 class="mb-0">Services</h2>
      <div class="d-flex gap-2">
        <input id="svcSearch" type="text" class="form-control" placeholder="Search services...">
        <select id="typeFilter" class="form-select" style="max-width:180px">
          <option value="">All Types</option>
          <option value="API">API (On)</option>
          <option value="OFF">OFF</option>
        </select>
        <button class="btn btn-seablue" data-bs-toggle="modal" data-bs-target="#addServiceModal">+ Add Service</button>
      </div>
    </div>

    <!-- Cards grid -->
    <div id="servicesGrid" class="row g-3">
      {% for svc in services %}
        {% set sid = svc._id_str %}
        {% set count = svc.offers|length if svc.offers else 0 %}
        {% set t = (svc.type or 'API') %}
        {% set s = (svc.status or 'OPEN') %}
        {% set a = (svc.availability or 'AVAILABLE') %}
        <div class="col-12 col-sm-6 col-lg-4 col-xxl-3 svc-card"
             data-name="{{ (svc.name or '')|lower }}"
             data-type="{{ t }}"
             data-status="{{ s }}"
             data-availability="{{ a }}">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <img src="{{ svc.image_url or '' }}" alt="" class="svc-card-img mb-3">
              <div class="d-flex align-items-start justify-content-between">
                <div class="me-2">
                  <div class="h6 mb-1 text-break">{{ svc.name }}</div>
                  <div class="d-flex flex-wrap gap-2">
                    <span class="svc-chip">Default: {{ (svc.default_profit_percent if svc.default_profit_percent is not none else 0) | round(2) }}%</span>
                    <span class="svc-chip">{{ count }} offer{{ '' if count == 1 else 's' }}</span>
                  </div>
                </div>
                <div class="text-end">
                  <div class="mb-1">
                    <span class="svc-badge {{ 'svc-type-API' if t=='API' else 'svc-type-OFF' }}" data-role="type-badge">{{ t }}</span>
                  </div>
                  <div class="mb-1">
                    <span class="svc-badge {{ 'svc-status-OPEN' if s=='OPEN' else 'svc-status-CLOSED' }}" data-role="status-badge">{{ s }}</span>
                  </div>
                  <div>
                    <span class="svc-badge {{ 'svc-avail-AVAILABLE' if a=='AVAILABLE' else 'svc-avail-OUT_OF_STOCK' }}" data-role="availability-badge">{{ a }}</span>
                  </div>
                </div>
              </div>

              <div class="small text-muted mt-2">
                Created: {{ svc.created_at.strftime('%Y-%m-%d %H:%M') if svc.created_at else '-' }}
              </div>

              <div class="mt-3 d-grid gap-2">
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editServiceModal-{{ sid }}">Edit</button>
                  <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#offersModal-{{ sid }}">Offers</button>
                  <button class="btn btn-sm btn-outline-dark" data-bs-toggle="modal" data-bs-target="#setCustomerProfitModal-{{ sid }}">Customer Profit</button>
                </div>

                <div class="d-flex flex-wrap gap-2">
                  <!-- Type toggle -->
                  <button
                    class="btn btn-sm {{ 'btn-success' if t=='OFF' else 'btn-outline-secondary' }}"
                    onclick="toggleType('{{ sid }}', '{{ t }}', this)">
                    {{ 'Turn ON (API)' if t=='OFF' else 'Turn OFF' }}
                  </button>

                  <!-- Status toggle -->
                  <button
                    class="btn btn-sm {{ 'btn-outline-warning' if s=='OPEN' else 'btn-success' }}"
                    onclick="toggleStatus('{{ sid }}', '{{ s }}', this)">
                    {{ 'Close' if s=='OPEN' else 'Reopen' }}
                  </button>

                  <!-- Availability toggle -->
                  <button
                    class="btn btn-sm {{ 'btn-outline-warning' if a=='AVAILABLE' else 'btn-success' }}"
                    onclick="toggleAvailability('{{ sid }}', '{{ a }}', this)">
                    {{ 'Mark Out of Stock' if a=='AVAILABLE' else 'Mark Available' }}
                  </button>

                  <form method="post" action="{{ url_for('admin_services.delete_service', service_id=sid) }}"
                        onsubmit="return confirm('Delete this service?');" class="ms-auto">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}

      {% if services|length == 0 %}
        <div class="col-12 text-center text-muted">No services found.</div>
      {% endif %}
    </div>
  </div>

  <!-- Add Service (roomy & long-friendly) -->
  <div class="modal fade" id="addServiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down modal-dialog-centered modal-dialog-xxl">
      <div class="modal-content">
        <form method="post" action="{{ url_for('admin_services.create_service') }}">
          <div class="modal-header">
            <h5 class="modal-title">Add Service</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <img id="create_img_preview" class="img-preview-lg mb-2" src="" alt="">
                <input type="hidden" name="image_url" id="create_image_url">
                <div class="d-grid gap-2">
                  <input type="file" id="create_image_file" accept="image/*" class="form-control">
                  <small class="small-muted">Upload from your device (stored on server)</small>
                  <div id="create_upload_status" class="small-muted"></div>
                </div>
              </div>
              <div class="col-md-8">
                <label class="form-label">Service Name</label>
                <input type="text" name="service_name" class="form-control" placeholder="e.g., MTN" required>

                <div class="row g-3 mt-1">
                  <div class="col-sm-6">
                    <label class="form-label">Default Profit (%)</label>
                    <input type="number" step="0.01" min="0" name="default_profit_percent" class="form-control" placeholder="e.g., 50">
                    <small class="small-muted">Used when a customer-specific profit is not set.</small>
                  </div>
                </div>
              </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Offers</h6>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-secondary add-offer-btn" data-target-container="#create_offers_tbody">+ Add</button>
                <button type="button" class="btn btn-sm btn-outline-dark" data-paste-target="#create_offers_tbody">Paste CSV</button>
              </div>
            </div>

            <div class="table-responsive" style="max-height: 60vh;">
              <table class="table table-sm offers-grid align-middle">
                <thead>
                  <tr>
                    <th style="width: 220px;">Amount</th>
                    <th>Value (e.g., 1GB or {'id':1,'volume':1000})</th>
                    <th class="row-actions"></th>
                  </tr>
                </thead>
                <tbody id="create_offers_tbody">
                  <!-- seeded by JS -->
                </tbody>
              </table>
            </div>

            <div class="paste-hint">Tip: Paste rows like <code>20,1GB</code> (Amount,Value).</div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-seablue">Save Service</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% for svc in services %}
    {% set sid = svc._id_str %}
    {% set count = svc.offers|length if svc.offers else 0 %}

    <!-- Offers viewer -->
    <div class="modal fade" id="offersModal-{{ sid }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down modal-dialog-centered modal-dialog-xxl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Offers — {{ svc.name }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {% if count > 0 %}
              <div class="table-responsive">
                <table class="table table-sm table-striped align-middle">
                  <thead>
                    <tr>
                      <th style="width:160px;">Amount</th>
                      <th>Value</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for of in svc.offers %}
                      <tr>
                        <td>{{ of.amount if of.amount is not none else "-" }}</td>
                        <td class="text-break">{{ of.value_text | default(of.value) | default("-") }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted">No offers for this service.</div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button class="btn btn-outline-primary" data-bs-target="#editServiceModal-{{ sid }}" data-bs-toggle="modal" data-bs-dismiss="modal">
              Edit Offers
            </button>
            <button class="btn btn-seablue" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Service -->
    <div class="modal fade" id="editServiceModal-{{ sid }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-md-down modal-dialog-centered modal-dialog-xxl">
        <div class="modal-content">
          <form method="post" action="{{ url_for('admin_services.update_service', service_id=sid) }}">
            <div class="modal-header">
              <h5 class="modal-title">Edit Service — {{ svc.name }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="row g-3 mb-3">
                <div class="col-md-4">
                  <img id="edit_img_preview_{{ sid }}" class="img-preview-lg mb-2" src="{{ svc.image_url or '' }}" alt="">
                  <input type="hidden" name="image_url" id="edit_image_url_{{ sid }}" value="{{ svc.image_url or '' }}">
                  <div class="d-grid gap-2">
                    <input type="file" id="edit_image_file_{{ sid }}" accept="image/*" class="form-control edit-image-file" data-sid="{{ sid }}">
                    <small class="small-muted">Upload from your device (stored on server)</small>
                    <div id="edit_upload_status_{{ sid }}" class="small-muted"></div>
                  </div>
                </div>

                <div class="col-md-8">
                  <label class="form-label">Service Name</label>
                  <input type="text" name="service_name" value="{{ svc.name }}" class="form-control" required>

                  <div class="row g-3 mt-1">
                    <div class="col-sm-6">
                      <label class="form-label">Default Profit (%)</label>
                      <input type="number" step="0.01" min="0" name="default_profit_percent" class="form-control"
                             value="{{ (svc.default_profit_percent if svc.default_profit_percent is not none else 0) | round(2) }}">
                      <small class="small-muted">Used when a customer-specific profit is not set.</small>
                    </div>
                  </div>
                </div>
              </div>

              <hr>

              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Offers</h6>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-secondary add-offer-btn" data-target-container="#offers_container_{{ sid }}">+ Add</button>
                  <button type="button" class="btn btn-sm btn-outline-dark" data-paste-target="#offers_container_{{ sid }}">Paste CSV</button>
                </div>
              </div>

              <div class="table-responsive" style="max-height: 60vh;">
                <table class="table table-sm offers-grid align-middle">
                  <thead>
                    <tr>
                      <th style="width: 220px;">Amount</th>
                      <th>Value (e.g., 1GB or {'id':1,'volume':1000})</th>
                      <th class="row-actions"></th>
                    </tr>
                  </thead>
                  <tbody id="offers_container_{{ sid }}">
                    {% if svc.offers and svc.offers|length > 0 %}
                      {% for of in svc.offers %}
                        <tr class="offer-row">
                          <td><input type="number" step="0.01" min="0" class="form-control" name="offers_amount[]" value="{{ of.amount if of.amount is not none else '' }}" placeholder="Amount"></td>
                          <td><input type="text" class="form-control" name="offers_value[]" value="{{ of.value or of.value_text or '' }}" placeholder="Value"></td>
                          <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-offer-btn">&times;</button></td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr class="offer-row">
                        <td><input type="number" step="0.01" min="0" class="form-control" name="offers_amount[]" placeholder="Amount"></td>
                        <td><input type="text" class="form-control" name="offers_value[]" placeholder="Value"></td>
                        <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-offer-btn">&times;</button></td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
              <div class="paste-hint">Tip: Click “Paste CSV” and paste rows like <code>20,1GB</code> (Amount,Value).</div>
            </div>

            <div class="modal-footer">
              <button type="submit" class="btn btn-seablue">Update Service</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Customer Profit -->
    <div class="modal fade" id="setCustomerProfitModal-{{ sid }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down modal-dialog-centered modal-dialog-xxl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Customer Profit — {{ svc.name }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <!-- Add / Update -->
            <div class="border rounded p-3 mb-3">
              <h6 class="mb-3">Add / Update Customer Profit</h6>
              <form class="row g-2 align-items-end" method="post" action="{{ url_for('admin_services.set_customer_profit_for_service', service_id=sid) }}">
                <div class="col-12 col-md-6">
                  <label class="form-label">Customer</label>
                  {% if customers %}
                    <input type="text" class="form-control mb-2" placeholder="Search customers..." data-filter-select="#customer_select_{{ sid }}">
                    <select id="customer_select_{{ sid }}" name="customer_id" class="form-select" required>
                      <option value="" selected disabled>Select customer</option>
                      {% for c in customers %}<option value="{{ c._id }}">{{ c.name }}</option>{% endfor %}
                    </select>
                  {% else %}
                    <input type="text" name="customer_id" class="form-control" placeholder="Customer ObjectId" required>
                  {% endif %}
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Profit (%)</label>
                  <input type="number" name="profit_percent" step="0.01" min="0" class="form-control" placeholder="e.g., 50" required>
                </div>
                <div class="col-12 col-md-2 d-grid">
                  <button class="btn btn-seablue" type="submit">Save</button>
                </div>
                <div class="col-12">
                  <small class="small-muted">Creates or updates an override for the chosen customer.</small>
                </div>
              </form>
            </div>

            <!-- Existing overrides -->
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <h6 class="mb-0">Existing Customer Overrides</h6>
              <input type="text" class="form-control form-control-sm" style="max-width:280px"
                     placeholder="Filter overrides..." data-filter-table="#cp_table_{{ sid }}">
            </div>

            {% set overrides = svc.customer_profits if svc.customer_profits else [] %}
            {% if overrides|length > 0 %}
              <div class="table-responsive">
                <table id="cp_table_{{ sid }}" class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Customer</th>
                      <th style="width:180px;">Profit (%)</th>
                      <th style="width:160px;">Updated</th>
                      <th style="width:200px;" class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for ov in overrides %}
                    <tr>
                      <td class="text-break">
                        <div class="fw-semibold override-name">{{ ov.customer_name }}</div>
                        <div class="text-muted small override-id">{{ ov.customer_id }}</div>
                      </td>
                      <td>
                        <form class="d-flex gap-2" method="post" action="{{ url_for('admin_services.set_customer_profit_for_service', service_id=sid) }}">
                          <input type="hidden" name="customer_id" value="{{ ov.customer_id }}">
                          <input type="number" name="profit_percent" step="0.01" min="0" class="form-control" value="{{ (ov.profit_percent or 0) | round(2) }}" required>
                          <button class="btn btn-outline-primary btn-sm" type="submit">Save</button>
                        </form>
                      </td>
                      <td class="text-nowrap">
                        {% if ov.updated_at %}{{ ov.updated_at.strftime('%Y-%m-%d %H:%M') }}{% else %}-{% endif %}
                      </td>
                      <td class="text-end">
                        <form method="post" action="{{ url_for('admin_services.delete_customer_profit_for_service', service_id=sid, customer_id=ov.customer_id) }}" onsubmit="return confirm('Remove override for this customer?');" class="d-inline">
                          <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                        </form>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-muted">No customer-specific overrides yet.</div>
            {% endif %}
          </div>

          <div class="modal-footer">
            <button class="btn btn-seablue" data-bs-dismiss="modal">Done</button>
          </div>
        </div>
      </div>
    </div>
  {% endfor %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ---------------- Search & Filter ---------------- */
    const svcSearch = document.getElementById('svcSearch');
    const typeFilter = document.getElementById('typeFilter');
    function applyFilter() {
      const q = (svcSearch?.value || '').toLowerCase();
      const t = (typeFilter?.value || '');
      document.querySelectorAll('.svc-card').forEach(card => {
        const name = card.getAttribute('data-name') || '';
        const type = card.getAttribute('data-type') || '';
        const okName = !q || name.includes(q);
        const okType = !t || t === type;
        card.style.display = (okName && okType) ? '' : 'none';
      });
    }
    svcSearch?.addEventListener('input', applyFilter);
    typeFilter?.addEventListener('change', applyFilter);

    /* ---------------- Badge helpers ---------------- */
    function setBadge(el, classesRemove, classAdd, text) {
      if (!el) return;
      classesRemove.forEach(c => el.classList.remove(c));
      if (classAdd) el.classList.add(classAdd);
      if (text) el.textContent = text;
    }

    /* ---------------- Toggle Type (API <-> OFF) ---------------- */
    async function toggleType(id, current, btn) {
      try {
        const desired = current === 'OFF' ? 'API' : 'OFF';
        btn?.setAttribute('disabled', 'disabled');
        const res = await fetch(`/admin/services/${id}/type`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
          body: JSON.stringify({ type: desired })
        });
        const data = await res.json();
        if (data.success) {
          const card = btn.closest('.svc-card');
          if (card) {
            card.setAttribute('data-type', data.type);
            const typeBadge = card.querySelector('[data-role="type-badge"]');
            setBadge(typeBadge, ['svc-type-API','svc-type-OFF'], data.type === 'API' ? 'svc-type-API' : 'svc-type-OFF', data.type);
            // flip button label/style
            btn.classList.toggle('btn-success', data.type === 'OFF');
            btn.classList.toggle('btn-outline-secondary', data.type !== 'OFF');
            btn.textContent = (data.type === 'OFF') ? 'Turn ON (API)' : 'Turn OFF';
            btn.setAttribute('onclick', `toggleType('${id}', '${data.type}', this)`);
          }
          applyFilter();
        } else {
          alert(data.error || 'Failed to update type.');
        }
      } catch (e) {
        alert('Network error.');
      } finally {
        btn?.removeAttribute('disabled');
      }
    }

    /* ---------------- Toggle Status (OPEN <-> CLOSED) ---------------- */
    async function toggleStatus(id, current, btn) {
      try {
        const desired = current === 'CLOSED' ? 'OPEN' : 'CLOSED';
        btn?.setAttribute('disabled', 'disabled');
        const res = await fetch(`/admin/services/${id}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
          body: JSON.stringify({ status: desired })
        });
        const data = await res.json();
        if (data.success) {
          const card = btn.closest('.svc-card');
          if (card) {
            card.setAttribute('data-status', data.status);
            const badge = card.querySelector('[data-role="status-badge"]');
            setBadge(badge, ['svc-status-OPEN','svc-status-CLOSED'], data.status === 'OPEN' ? 'svc-status-OPEN' : 'svc-status-CLOSED', data.status);
            // button visuals + next label
            const isOpen = data.status === 'OPEN';
            btn.classList.toggle('btn-outline-warning', isOpen);
            btn.classList.toggle('btn-success', !isOpen);
            btn.textContent = isOpen ? 'Close' : 'Reopen';
            btn.setAttribute('onclick', `toggleStatus('${id}', '${data.status}', this)`);
          }
        } else {
          alert(data.error || 'Failed to update status.');
        }
      } catch (e) {
        alert('Network error.');
      } finally {
        btn?.removeAttribute('disabled');
      }
    }

    /* -------- Toggle Availability (AVAILABLE <-> OUT_OF_STOCK) --- */
    async function toggleAvailability(id, current, btn) {
      try {
        const desired = current === 'OUT_OF_STOCK' ? 'AVAILABLE' : 'OUT_OF_STOCK';
        btn?.setAttribute('disabled', 'disabled');
        const res = await fetch(`/admin/services/${id}/availability`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
          body: JSON.stringify({ availability: desired })
        });
        const data = await res.json();
        if (data.success) {
          const card = btn.closest('.svc-card');
          if (card) {
            card.setAttribute('data-availability', data.availability);
            const badge = card.querySelector('[data-role="availability-badge"]');
            setBadge(badge, ['svc-avail-AVAILABLE','svc-avail-OUT_OF_STOCK'], data.availability === 'AVAILABLE' ? 'svc-avail-AVAILABLE' : 'svc-avail-OUT_OF_STOCK', data.availability);
            // button visuals + next label
            const isAvail = data.availability === 'AVAILABLE';
            btn.classList.toggle('btn-outline-warning', isAvail);
            btn.classList.toggle('btn-success', !isAvail);
            btn.textContent = isAvail ? 'Mark Out of Stock' : 'Mark Available';
            btn.setAttribute('onclick', `toggleAvailability('${id}', '${data.availability}', this)`);
          }
        } else {
          alert(data.error || 'Failed to update availability.');
        }
      } catch (e) {
        alert('Network error.');
      } finally {
        btn?.removeAttribute('disabled');
      }
    }

    /* ---------------- Image upload (create + edit) ---------------- */
    async function uploadToServer(file, { statusEl, previewEl, hiddenInputEl }) {
      if (!file) return;
      const formData = new FormData();
      formData.append("image", file);
      if (statusEl) statusEl.textContent = "Uploading...";
      try {
        const res = await fetch("/upload_service_image", { method: "POST", body: formData });
        const data = await res.json();
        if (data.success) {
          hiddenInputEl.value = data.url;
          if (previewEl) previewEl.src = data.url;
          if (statusEl) statusEl.textContent = "✅ Image uploaded.";
        } else {
          statusEl.textContent = "❌ Upload failed.";
          console.error("Server error:", data.error);
        }
      } catch (err) {
        statusEl.textContent = "❌ Upload error.";
        console.error(err);
      }
    }

    /* ---------------- Offers grid helpers ---------------- */
    function addOfferRow(container) {
      const tr = document.createElement("tr");
      tr.className = "offer-row";
      tr.innerHTML = `
        <td><input type="number" step="0.01" min="0" class="form-control" name="offers_amount[]" placeholder="Amount"></td>
        <td><input type="text" class="form-control" name="offers_value[]" placeholder="Value (e.g., 1GB or {'id':1,'volume':1000})"></td>
        <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-offer-btn">&times;</button></td>
      `;
      container.appendChild(tr);
    }

    function seedCreateOffers() {
      const tbody = document.getElementById("create_offers_tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      addOfferRow(tbody);
    }

    // CSV paste helper: “Amt,Value” per line
    function wireCsvPasteButtons() {
      document.querySelectorAll('[data-paste-target]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const targetSel = btn.getAttribute('data-paste-target');
          const tbody = document.querySelector(targetSel);
          if (!tbody) return;

          const text = await navigator.clipboard.readText().catch(() => "");
          const pasted = text || prompt("Paste CSV rows here (Amount,Value) and click OK:", "");
          if (!pasted) return;

          const lines = pasted.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
          lines.forEach(line => {
            const [amt, val] = line.split(",").map(s => (s ?? "").trim());
            const tr = document.createElement("tr");
            tr.className = "offer-row";
            tr.innerHTML = `
              <td><input type="number" step="0.01" min="0" class="form-control" name="offers_amount[]" value="${amt || ""}" placeholder="Amount"></td>
              <td><input type="text" class="form-control" name="offers_value[]" value="${val || ""}" placeholder="Value"></td>
              <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-offer-btn">&times;</button></td>
            `;
            tbody.appendChild(tr);
          });
        });
      });
    }

    /* ---------------- Filters for selects & tables ---------------- */
    document.addEventListener('input', function(e) {
      const inp = e.target.closest('[data-filter-select]');
      if (!inp) return;
      const sel = document.querySelector(inp.getAttribute('data-filter-select'));
      if (!sel) return;
      const q = inp.value.toLowerCase();
      Array.from(sel.options).forEach(opt => {
        if (!opt.value) return; // keep placeholder
        const txt = (opt.textContent || '').toLowerCase();
        opt.hidden = q && !txt.includes(q);
      });
      if (!sel.value) {
        const vis = Array.from(sel.options).find(o => !o.hidden && o.value);
        if (vis) sel.value = vis.value;
      }
    });

    document.addEventListener('input', function(e) {
      const box = e.target.closest('[data-filter-table]');
      if (!box) return;
      const tbl = document.querySelector(box.getAttribute('data-filter-table'));
      if (!tbl) return;
      const q = (e.target.value || '').toLowerCase();
      tbl.querySelectorAll('tbody tr').forEach(tr => {
        const name = (tr.querySelector('.override-name')?.textContent || '').toLowerCase();
        const id = (tr.querySelector('.override-id')?.textContent || '').toLowerCase();
        tr.style.display = (name.includes(q) || id.includes(q)) ? '' : 'none';
      });
    });

    /* ---------------- Page wiring ---------------- */
    document.addEventListener("DOMContentLoaded", function () {
      // Seed create modal offers each time it's opened
      const addModal = document.getElementById("addServiceModal");
      if (addModal) {
        addModal.addEventListener("show.bs.modal", () => {
          const hidden = document.getElementById("create_image_url");
          const prev   = document.getElementById("create_img_preview");
          const stat   = document.getElementById("create_upload_status");
          if (hidden) hidden.value = "";
          if (prev) prev.src = "";
          if (stat) stat.textContent = "";
          seedCreateOffers();
        });
      }

      // Add Service image upload
      const createFile = document.getElementById("create_image_file");
      const createHidden = document.getElementById("create_image_url");
      const createPrev = document.getElementById("create_img_preview");
      const createStat = document.getElementById("create_upload_status");
      if (createFile) {
        createFile.addEventListener("change", (e) => {
          uploadToServer(e.target.files[0], { statusEl: createStat, previewEl: createPrev, hiddenInputEl: createHidden });
        });
      }

      // Edit modals image uploads (delegated)
      document.addEventListener("change", function (e) {
        if (e.target.classList.contains("edit-image-file")) {
          const sid = e.target.dataset.sid;
          uploadToServer(e.target.files[0], {
            statusEl: document.getElementById(`edit_upload_status_${sid}`),
            previewEl: document.getElementById(`edit_img_preview_${sid}`),
            hiddenInputEl: document.getElementById(`edit_image_url_${sid}`)
          });
        }
      });

      // Add-offer buttons
      document.querySelectorAll(".add-offer-btn").forEach(addBtn => {
        const containerSel = addBtn.getAttribute("data-target-container");
        if (!containerSel) return;
        addBtn.addEventListener("click", function () {
          const cont = document.querySelector(containerSel);
          if (!cont) return;
          addOfferRow(cont);
        });
      });

      // Remove-offer buttons
      document.body.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-offer-btn")) {
          const row = e.target.closest(".offer-row");
          const container = row?.parentElement;
          if (!row || !container) return;
          const rows = container.querySelectorAll(".offer-row");
          if (rows.length > 1) row.remove();
          else row.querySelectorAll("input").forEach(i => i.value = "");
        }
      });

      // CSV paste helpers
      wireCsvPasteButtons();
    });
  </script>
</body>
</html>
