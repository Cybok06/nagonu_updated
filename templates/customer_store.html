<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>{{ (store and store.name) or 'My Store' }} — Store Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- OG tags omitted (same as your current file) -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <style>
    :root{
      --primary: {{ (store.theme.primary if store and store.theme else '#0ea5e9') }};
      --accent:  {{ (store.theme.accent  if store and store.theme else '#0b6fa1') }};
      --bg:      {{ (store.theme.bg      if store and store.theme else '#f7fbfe') }};
      --text:    {{ (store.theme.text    if store and store.theme else '#06354a') }};
      --muted:#6b7b8c; --soft:#eef6ff; --ring:#e6eef7; --ink:#0b3b52; --card:#fff;
    }
    body{ color:var(--text); background:#fff; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    .navbar{ background:linear-gradient(90deg,var(--accent),var(--primary)); box-shadow:0 10px 28px rgba(0,0,0,.10) }
    .navbar-brand{ color:#fff!important; font-weight:800 }
    .sticky-actions{ position:sticky; top:0; z-index:1020; background:#fff; border-bottom:1px solid var(--ring) }
    .nav-actions .btn{ --bs-btn-padding-y:.48rem; --bs-btn-padding-x:.9rem; --bs-btn-font-weight:600 }

    .kpi-card{ border:1px solid var(--ring); border-radius:18px; padding:18px; background:var(--card); box-shadow:0 12px 30px rgba(0,0,0,.06); height:100% }
    .kpi-label{ text-transform:uppercase; font-size:.78rem; color:var(--muted); letter-spacing:.08rem }
    .kpi-value{ font-weight:800; font-size:1.7rem; color:var(--ink) }
    .kpi-icon{ width:38px; height:38px; border-radius:12px; display:inline-grid; place-items:center; background:var(--soft); color:var(--accent); border:1px solid #e8f1ff }

    .section-title{ font-weight:800; color:#07344a; display:flex; align-items:center; gap:.5rem }
    .section-title .dot{ width:10px; height:10px; border-radius:50%; background:var(--primary); opacity:.9 }
    .badge-soft{ background:var(--soft); color:var(--ink); border:1px solid #e6f0fb; font-weight:700 }
    .empty{ border:1px dashed var(--ring); border-radius:18px; padding:28px; background:var(--card) }
    .muted{ color:var(--muted) }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-shop"></i>
        <span>{{ (store and store.name) or 'My Store' }} — Dashboard</span>
      </a>
      <div class="ms-auto text-white-50 small d-none d-md-block">
        Hello, {{ owner_name }}
      </div>
    </div>
  </nav>

  <!-- Action bar -->
  <div class="sticky-actions">
    <div class="container py-2">
      <div class="d-flex flex-wrap gap-2 align-items-center nav-actions">
        <a href="{{ url_for('stores.create_store_page') }}" class="btn btn-primary">
          <i class="bi bi-pencil-square me-1"></i> Create / Edit Store
        </a>

        {% if store and store.slug %}
          <a href="{{ url_for('stores.store_public_page', slug=store.slug) }}" target="_blank" rel="noopener" class="btn btn-outline-primary">
            <i class="bi bi-box-arrow-up-right me-1"></i> View Store
          </a>
          <a href="{{ url_for('customer_store.customer_store_payout_page', slug=store.slug) }}" class="btn btn-success">
            <i class="bi bi-wallet2 me-1"></i> Payout Settings
          </a>
          <div class="ms-auto small text-muted d-none d-lg-block">
            Store URL: <code class="text-dark">/s/{{ store.slug }}</code>
          </div>
        {% else %}
          <div class="text-muted small">No store yet — click “Create / Edit Store” to get started.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <main class="container py-4">
    {% if not store or not store.slug %}
      <div class="empty text-center my-4">
        <h5 class="fw-bold mb-2">You haven’t set up a store yet</h5>
        <p class="text-muted mb-3">Create your store to start tracking sales, profits, and top-performing offers.</p>
        <a href="{{ url_for('stores.create_store_page') }}" class="btn btn-primary btn-lg">
          <i class="bi bi-plus-circle me-1"></i> Create Your Store
        </a>
      </div>
    {% else %}

      <!-- KPIs -->
      <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card">
            <div class="d-flex align-items-center justify-content-between">
              <div class="kpi-label">Total Sales (All-time)</div>
              <div class="kpi-icon"><i class="bi bi-cash-coin"></i></div>
            </div>
            <div class="kpi-value mt-1">GHS {{ '%.2f'|format(all_time_sales) }}</div>
            <div class="small muted">All orders via <code>/s/{{ store.slug }}</code></div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card">
            <div class="d-flex align-items-center justify-content-between">
              <div class="kpi-label">Profit (Today)</div>
              <div class="kpi-icon"><i class="bi bi-graph-up-arrow"></i></div>
            </div>
            <div class="kpi-value mt-1">GHS {{ '%.2f'|format(profit_today) }}</div>
            <div class="small muted">{{ today_str }}</div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card">
            <div class="d-flex align-items-center justify-content-between">
              <div class="kpi-label">Profit (All-time)</div>
              <div class="kpi-icon"><i class="bi bi-piggy-bank"></i></div>
            </div>
            <div class="kpi-value mt-1">GHS {{ '%.2f'|format(all_time_profit) }}</div>
            <div class="small muted">{{ orders_count }} total orders</div>
          </div>
        </div>

        <!-- NEW: Withdrawable & Wallet -->
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card">
            <div class="d-flex align-items-center justify-content-between">
              <div class="kpi-label">Withdrawable</div>
              <div class="kpi-icon"><i class="bi bi-bank"></i></div>
            </div>
            <div class="kpi-value mt-1">GHS {{ '%.2f'|format(withdrawable or 0) }}</div>
            <div class="small muted">Not yet credited to wallet</div>
          </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3">
          <div class="kpi-card">
            <div class="d-flex align-items-center justify-content-between">
              <div class="kpi-label">Wallet Balance</div>
              <div class="kpi-icon"><i class="bi bi-wallet2"></i></div>
            </div>
            <div class="kpi-value mt-1">GHS {{ '%.2f'|format(wallet_balance or 0) }}</div>
            <div class="small muted">Available to withdraw to MoMo</div>
          </div>
        </div>
      </div>

      <!-- Withdrawals history preview -->
      <section class="mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h2 class="section-title h5 m-0"><span class="dot"></span>Recent Withdrawals</h2>
          <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('customer_store.customer_store_payout_page', slug=store.slug) }}">
            View all & payout settings
          </a>
        </div>
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th>Reference</th>
                <th class="text-end">Amount (GHS)</th>
                <th>Created</th>
                <th>Verified</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody id="wRows">
              <tr><td colspan="5" class="text-muted">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Top Offers -->
      <section class="mb-4">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h2 class="section-title h5 m-0"><span class="dot"></span>Top Offers</h2>
        </div>
        {% if not top_offers %}
          <div class="text-muted">No orders yet.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Service</th>
                  <th>Offer</th>
                  <th class="text-end">Orders</th>
                  <th class="text-end">Revenue (GHS)</th>
                </tr>
              </thead>
              <tbody>
                {% for o in top_offers %}
                  <tr>
                    <td><span class="badge-soft px-3 py-2">{{ o.service }}</span></td>
                    <td>{{ o.label or '-' }}</td>
                    <td class="text-end">{{ o.count }}</td>
                    <td class="text-end"><strong>{{ '%.2f'|format(o.revenue) }}</strong></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </section>

      <!-- Last 10 Orders (unchanged) -->
      <section>
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h2 class="section-title h5 m-0"><span class="dot"></span>Last 10 Orders</h2>
        </div>
        {% if not recent_orders %}
          <div class="text-muted">No recent orders.</div>
        {% else %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Status</th>
                  <th class="text-end">Items</th>
                  <th class="text-end">Charged (GHS)</th>
                  <th class="text-end">Profit (GHS)</th>
                  <th class="text-end">Total (GHS)</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                {% for o in recent_orders %}
                  <tr>
                    <td class="text-break"><code>{{ o.order_id }}</code></td>
                    <td>
                      {% if o.status == 'processing' %}
                        <span class="badge text-bg-warning">processing</span>
                      {% elif o.status == 'completed' %}
                        <span class="badge text-bg-success">completed</span>
                      {% elif o.status == 'failed' %}
                        <span class="badge text-bg-danger">failed</span>
                      {% else %}
                        <span class="badge text-bg-secondary">{{ o.status or '-' }}</span>
                      {% endif %}
                    </td>
                    <td class="text-end">{{ o.items_count }}</td>
                    <td class="text-end">{{ '%.2f'|format(o.charged_amount or 0) }}</td>
                    <td class="text-end">{{ '%.2f'|format(o.profit_amount_total or 0) }}</td>
                    <td class="text-end"><strong>{{ '%.2f'|format(o.total_amount or 0) }}</strong></td>
                    <td>
                      {% if o.created_at %}
                        {{ o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at.__class__.__name__ == 'datetime' else o.created_at }}
                      {% else %}-{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </section>

    {% endif %}
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  {% if store and store.slug %}
  <script>
    // Load last withdrawals preview
    (async () => {
      try{
        const r = await fetch("{{ url_for('customer_store.api_customer_store_withdrawals', slug=store.slug) }}?limit=5");
        const j = await r.json();
        const body = document.getElementById('wRows');
        if (!j.success || !j.items || !j.items.length){
          body.innerHTML = '<tr><td colspan="5" class="text-muted">No withdrawals yet.</td></tr>';
          return;
        }
        body.innerHTML = j.items.map(it => `
          <tr>
            <td>${it.reference || '-'}</td>
            <td class="text-end">${Number(it.amount||0).toFixed(2)}</td>
            <td>${it.created_at || '-'}</td>
            <td>${it.verified_at || '-'}</td>
            <td class="text-muted small">${(it.note||'')}</td>
          </tr>
        `).join('');
      }catch(e){
        document.getElementById('wRows').innerHTML = '<tr><td colspan="5" class="text-danger">Failed to load withdrawals.</td></tr>';
      }
    })();
  </script>
  {% endif %}
</body>
</html>

