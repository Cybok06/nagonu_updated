<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg">

  <style>
    :root { --sea-blue:#0ea5e9; --soft:#f6f8fb; --ink:#0b1320; }
    body { background: var(--soft); }

    .scrolling-wrapper { -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: var(--sea-blue) #f1f1f1; }
    .scrolling-wrapper::-webkit-scrollbar { height: 8px; }
    .scrolling-wrapper::-webkit-scrollbar-track { background: #f1f1f1; }
    .scrolling-wrapper::-webkit-scrollbar-thumb { background-color: var(--sea-blue); border-radius: 10px; }

    .svc-card { border:1px solid #e9ecef; border-radius:14px; padding:1rem; height:100%; background:#fff; }
    .svc-img  { width:100%; height:140px; object-fit:cover; border-radius:10px; background:#f3f6f9; }

    /* Flags */
    .svc-flags { gap: .35rem; }
    .svc-flag { font-size:.75rem; padding:.35rem .55rem; border-radius:999px; border:1px solid transparent; }
    .flag-open { background:rgba(25,135,84,.12); color:#198754; border-color:rgba(25,135,84,.30); }
    .flag-closed { background:rgba(220,53,69,.12); color:#dc3545; border-color:rgba(220,53,69,.30); }
    .flag-available { background:rgba(13,110,253,.08); color:#0d6efd; border-color:rgba(13,110,253,.20); }
    .flag-oos { background:rgba(108,117,125,.15); color:#6c757d; border-color:rgba(108,117,125,.25); }

    .floating-cart { position:fixed; right:16px; bottom:16px; z-index:1055; }
    .btn-cart { position:relative; border-radius:999px; padding:.75rem 1rem; font-weight:600;
                background:var(--sea-blue); color:#fff; border:none;
                box-shadow:0 8px 24px rgba(14,165,233,.35); }
    .btn-cart .badge { position:absolute; top:-6px; right:-6px; }

    .bulk-trigger { cursor:text; }
    .amount-cell { min-width: 110px; text-align:right; }

    @media (max-width:576px){
      .svc-img{height:120px}
      .btn-cart{padding:.6rem .9rem}
      .input-group>.form-select{min-width: 150px;}
    }

    /* Loader overlay */
    .loader-overlay {
      position: fixed; inset: 0; background: rgba(11,19,32,.35);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000; backdrop-filter: blur(1.5px);
      transition: opacity .2s ease;
    }
    .loader-card {
      background: #fff; border-radius: 14px; padding: 1.25rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      display: flex; align-items: center; gap: .75rem; min-width: 260px;
    }
    .loader-text { font-weight: 600; color: var(--ink); }
    .loader-sub { font-size: .9rem; color: #6c757d; margin-top: -6px; }

    .modal-content { border: 0; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .table > :not(caption) > * > * { vertical-align: middle; }

    /* invalid phone highlight */
    .phone-input.is-invalid { border-color: #dc3545; padding-right: calc(1.5em + .75rem); background-image: none; }
    .store-notify-new { background: #e8f4ff; border-color: #cfe9ff; }
    .store-notify-new + .list-group-item { border-top-color: #cfe9ff; }

    /* Viewport overlay for fixed UI */
    #viewport-overlays{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1045;
    }

    /* Store notifications FAB */
    .store-notify-fab{
      position: absolute;
      top: max(12px, env(safe-area-inset-top));
      right: max(12px, env(safe-area-inset-right));
      pointer-events: auto;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(148, 163, 184, 0.28);
      backdrop-filter: blur(10px) saturate(1.2);
      -webkit-backdrop-filter: blur(10px) saturate(1.2);
      box-shadow: 0 10px 24px rgba(2, 8, 23, 0.18);
      color: #0f172a;
    }
    .store-notify-badge{
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: .65rem;
      min-width: 20px;
      height: 20px;
      padding: 0 .35rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    @keyframes notifShake{
      0%, 100% { transform: translateX(0); }
      10% { transform: translateX(-1.5px); }
      20% { transform: translateX(1.5px); }
      30% { transform: translateX(-1.5px); }
      40% { transform: translateX(1.5px); }
      50% { transform: translateX(0); }
    }
    .notif-has-new{
      box-shadow: 0 0 0 4px rgba(14,165,233,.18), 0 10px 24px rgba(2, 8, 23, 0.22);
      animation: notifShake .5s ease-in-out 0s 1, notifShake .5s ease-in-out 4s 1;
    }
    @media (max-width: 575.98px){
      .store-notify-fab{
        top: max(10px, env(safe-area-inset-top));
        right: max(10px, env(safe-area-inset-right));
      }
    }
    @media (prefers-reduced-motion: reduce){
      .notif-has-new{ animation: none; }
    }

    /* Section background (ocean) */
    .wallet-hero { position: relative; }
    .wallet-hero-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: saturate(1.05) contrast(1.02); z-index: 0; }
    .wallet-hero::before { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom right, rgba(6, 24, 38, 0.55), rgba(6, 24, 38, 0.25) 40%, rgba(6, 24, 38, 0.15)); z-index: 1; }
    .wallet-hero-card { position: relative; z-index: 2; border-radius: 16px; padding: 24px; background: rgba(5, 48, 71, 0.35); backdrop-filter: blur(4px) saturate(1.1); -webkit-backdrop-filter: blur(4px) saturate(1.1); overflow: hidden; }
    .wallet-hero-card::after { content: ""; position: absolute; top: 50%; right: 24px; transform: translateY(-50%); width: clamp(120px, 26vw, 220px); height: clamp(120px, 26vw, 220px); border-radius: 50%; pointer-events: none; background:
      radial-gradient(circle at center, rgba(6,24,38,0.18), rgba(6,24,38,0) 55%),
      url("https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg") no-repeat center/cover;
      opacity: 0.42; filter: drop-shadow(0 1px 0 rgba(0,0,0,0.18)); }
    .wallet-hero-card .eyebrow { letter-spacing: .02em; }
    .wallet-hero-card .title { font-weight: 700; }
    .wallet-hero-card .balance-amount { font-size: clamp(1.35rem, 2.6vw, 2rem); font-weight: 800; }
    .wallet-hero-card .pill { background: rgba(255,255,255,0.15); color: #fff; padding: 8px 12px; border-radius: 999px; backdrop-filter: blur(2px); }
    .wallet-hero-card .title, .wallet-hero-card .balance-label, .wallet-hero-card .balance-amount, .wallet-hero-card .eyebrow { text-shadow: 0 1px 0 rgba(0,0,0,0.35); }
    @media (max-width: 575.98px) {
      .wallet-hero-card { padding: 20px 18px; }
      .wallet-hero-card::after { right: 16px; width: clamp(110px, 40vw, 180px); height: clamp(110px, 40vw, 180px); }
    }

    /* Pro ad modal polish */
    .ad-hero {
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid rgba(13,110,253,.12);
      box-shadow: 0 14px 36px rgba(2,8,23,.14);
      background: #fff;
    }
    .ad-hero img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      background: #f7f9fc;
    }
    .ad-badge {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      font-size: .8rem;
      padding: .35rem .6rem;
      border-radius: 999px;
      border: 1px solid rgba(14,165,233,.25);
      background: rgba(14,165,233,.10);
      color: #055b82;
      font-weight: 600;
    }
    .howto-tile {
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, #ffffff, #fbfcfe);
    }
    .ratio-16x9 { border-radius: 14px; overflow: hidden; }
  </style>
</head>

<body>
  <div id="viewport-overlays">
    <button id="storeNotifyBtn" type="button" class="store-notify-fab" data-bs-toggle="modal" data-bs-target="#storeNotifyModal">
      <i class="bi bi-bell-fill"></i>
      <span id="storeNotifyBadge" class="store-notify-badge badge rounded-pill bg-danger">
        {{ (store_recent_orders_view|length) if store_recent_orders_view else 0 }}
      </span>
    </button>
  </div>

  {% include 'customer_sidebar.html' %}

  <main class="customer-content">
    <section class="wallet-hero my-4">
      <div class="wallet-hero-bg" style="background-image:url('https://e1.pxfuel.com/desktop-wallpaper/586/807/desktop-wallpaper-1920x1080-beautiful-ocean-pics-data-id-115186-ocean-sea.jpg');"></div>

      <div class="container position-relative">
        <!-- Wallet only (Flyer is now a popup modal on page load) -->
        <div class="wallet-hero-card shadow-lg">
          <div class="row align-items-center g-3">
            <div class="col-12 col-md">
              <div class="eyebrow text-white-50">Welcome back</div>
              <h2 class="title mb-2 text-white">{{ customer_username or username }}</h2>

              <div class="balance-label text-white-50">Wallet Balance</div>
              <div class="balance-amount text-white">GHS {{ '%.2f'|format(balance) }}</div>

              <!-- JSON blob for the mini chart -->
              <script id="cust-daily-sales-data" type="application/json">
                {{ {'labels': daily_sales_labels or [], 'values': daily_sales_values or []} | tojson }}
              </script>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="container pb-3">
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="svc-card shadow-sm p-3 h-100">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Outstanding Payouts</div>
                <div class="fs-5 fw-bold text-success">GHS {{ '%.2f'|format(outstanding_payouts or 0) }}</div>
              </div>
              <div class="text-danger fs-3"><i class="bi bi-cash-stack"></i></div>
            </div>
            <div class="small text-muted mt-2">Total profit balance across your store accounts.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Make an Order -->
    <div class="container py-4" id="services">
      <h2 class="text-center mb-4">Make an Order</h2>

      {# collect all services then render by fixed order #}
      {% set _services = services if services is defined else [] %}
      {% set _express  = express_services if express_services is defined else [] %}
      {% set all_services = _services + _express %}

      {# CARD-ONLY macro (no column wrapper!) #}
      {% macro service_card(svc) -%}
        {% set status = (svc.status or 'OPEN')|upper %}
        {% set availability = (svc.availability or 'AVAILABLE')|upper %}
        {% set is_closed = status != 'OPEN' %}
        {% set is_oos    = availability != 'AVAILABLE' %}
        {% set can_order = (not is_closed) and (not is_oos) %}
        <div class="svc-card h-100 shadow-sm p-2 rounded bg-white d-flex flex-column">
          {% if svc.image_url %}
            <img src="{{ svc.image_url }}" class="svc-img mb-2 w-100" alt="{{ svc.name }}" style="border-radius:8px;object-fit:cover;max-height:160px;">
          {% endif %}

          <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
            <div class="fw-semibold text-truncate">{{ svc.name }}</div>
            <div class="d-flex flex-wrap svc-flags">
              <span class="svc-flag {{ 'flag-open' if not is_closed else 'flag-closed' }}">{{ 'Open' if not is_closed else 'Closed' }}</span>
              <span class="svc-flag {{ 'flag-available' if not is_oos else 'flag-oos' }}">{{ 'Available' if not is_oos else 'Out of Stock' }}</span>
            </div>
          </div>

          {% if is_closed and is_oos %}
            <div class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>{{ svc.disabled_reason or 'This service is currently unavailable.' }}</div>
          {% elif is_closed %}
            <div class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>This service is temporarily closed.</div>
          {% elif is_oos %}
            <div class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>This service is currently out of stock.</div>
          {% endif %}

          <div class="mt-auto d-flex justify-content-end">
            <button
              class="btn btn-sm {{ 'btn-outline-primary' if can_order else 'btn-outline-secondary' }} select-service-btn"
              {% if not can_order %}disabled data-disabled="true"{% endif %}
              data-service='{{ {
                "_id_str": svc._id_str,
                "name": svc.name,
                "offers": svc.offers or []
              } | tojson }}'>
              Buy
            </button>
          </div>
        </div>
      {%- endmacro %}

      {# exact order to display #}
      {% set desired_order = [
        'MTN NORMAL',
        'TELECEL',
        'MTN EXPRESS',
        'AT - iSHare',
        'AT - BigTime',
        'AFA TALKTIME'
      ] %}

      {# pick first two services in that order #}
      {% set first_two = [] %}
      {% for nm in desired_order %}
        {% if first_two|length < 2 %}
          {% set svc = (all_services | selectattr('name','equalto', nm) | list | first) %}
          {% if svc %}{% set _ = first_two.append(svc) %}{% endif %}
        {% endif %}
      {% endfor %}

      <div class="row g-4">
        {% if first_two|length == 0 %}
          <div class="col-12"><div class="text-muted">No services available.</div></div>
        {% elif first_two|length == 1 %}
          <div class="col-12 col-lg-6">
            {{ service_card(first_two[0]) }}
          </div>
        {% else %}
          <div class="col-12 col-lg-6">
            {{ service_card(first_two[0]) }}
          </div>
          <div class="col-12 col-lg-6">
            {{ service_card(first_two[1]) }}
          </div>
        {% endif %}
      </div>

      {# compute the rest in the same fixed order #}
      {% set remaining = [] %}
      {% for nm in desired_order %}
        {% set svc = (all_services | selectattr('name','equalto', nm) | list | first) %}
        {% if svc and (first_two|selectattr('_id_str','equalto', svc._id_str)|list|length == 0) %}
          {% set _ = remaining.append(svc) %}
        {% endif %}
      {% endfor %}

      {% if remaining|length > 0 %}
        <div class="mt-4">
          <div class="row g-4">
            {% for svc in remaining %}
              <div class="col-12 col-sm-6 col-lg-4">
                {{ service_card(svc) }}
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <hr class="my-4">
    </div>

    <!-- AFA Registration Card -->
    <div class="row g-3" id="afa-registration-block">
      <div class="col-12 col-sm-8 col-md-6">
        <div class="svc-card h-100 shadow-sm p-2 rounded bg-white">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSOEyqVS2uvAp3IbIJne8QmDwXurDtldBMy9w&s"
               class="svc-img mb-2 w-100" alt="AFA Registration"
               style="border-radius: 8px; object-fit: cover; max-height: 160px;">

          <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
            <div class="fw-semibold text-truncate">AFA Registration</div>
            <div class="d-flex svc-flags">
              {% set is_open = afa.is_open if afa is defined else true %}
              {% set in_stock = afa.in_stock if afa is defined else true %}
              <span class="svc-flag {{ 'flag-open' if is_open else 'flag-closed' }}">{{ 'Open' if is_open else 'Closed' }}</span>
              <span class="svc-flag {{ 'flag-available' if in_stock else 'flag-oos' }}">{{ 'Available' if in_stock else 'Out of Stock' }}</span>
            </div>
          </div>

          {% if not is_open or not in_stock %}
            <div class="small text-danger mb-2">
              <i class="bi bi-exclamation-triangle me-1"></i>
              {{ afa.disabled_reason or ('This service is currently unavailable.' if not is_open else 'This service is currently out of stock.') }}
            </div>
          {% endif %}

          {% set show_price = (afa.price if afa is defined and afa.price is not none else 3.00) %}
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="text-muted small">
              AFA Registration @ <strong>GHS {{ '%.2f'|format(show_price) }}</strong>
              {% if is_open and in_stock and can_buy_afa is defined and not can_buy_afa %}
                <span class="text-danger ms-2">(Insufficient funds)</span>
              {% endif %}
            </div>
            <div class="d-flex gap-2">
              <a href="{{ url_for('afa.afa_list_page') }}"
                 class="btn btn-sm btn-outline-secondary">
                View Registrations
              </a>

              {% set buy_disabled = (not is_open) or (not in_stock) or (can_buy_afa is defined and not can_buy_afa) %}
              <button type="button"
                      class="btn btn-sm {{ 'btn-outline-primary' if not buy_disabled else 'btn-outline-secondary' }}"
                      data-bs-toggle="{{ '' if buy_disabled else 'modal' }}"
                      data-bs-target="{{ '' if buy_disabled else '#afaModal' }}"
                      {% if buy_disabled %}disabled{% endif %}>
                Buy
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal uses dynamic price in title -->
    <div class="modal fade" id="afaModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="afa-form" autocomplete="off" novalidate>
            <div class="modal-header">
              <h5 class="modal-title">
                AFA Registration (GHS {{ '%.2f'|format((afa.price if afa is defined and afa.price is not none else 3.00)) }})
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-semibold">Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="afa-name" required>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Phone number <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="afa-phone" inputmode="numeric" maxlength="10" placeholder="e.g. 0530393625" required>
                <div class="form-text">Format: 0xxxxxxxxx (10 digits, starts with 0)</div>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Date of Birth (optional)</label>
                <input type="date" class="form-control" id="afa-dob">
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Location (optional)</label>
                <input type="text" class="form-control" id="afa-location">
              </div>

              <div class="mb-2">
                <label class="form-label fw-semibold">Ghana Card Number (optional) GHA-XXXXXXXXX-X</label>
                <input type="text" class="form-control" id="afa-ghana-card">
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary" id="afa-submit">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <hr class="my-5">

    <!-- Work area -->
    <div id="work-area" class="d-none">
      <div class="card border-0 shadow-sm rounded-4 p-4 mb-5 bg-white">

        <!-- Header -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
          <h4 class="mb-2 mb-md-0 fw-bold">
            <i class="bi bi-gear-fill text-primary me-2"></i>
            Service: <span id="chosen-service-name" class="text-primary"></span>
          </h4>
        </div>

        <!-- Bulk Input Trigger -->
        <div class="mb-4">
          <input id="bulk-trigger" type="text" class="form-control bulk-trigger"
                 placeholder="üìã Paste bulk orders (e.g. 0241234567 1)">
          <small class="text-muted">Click to expand and paste orders in bulk.</small>
        </div>

        <!-- Bulk Paste Area -->
        <div id="bulk-card" class="card mb-4 d-none">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row gap-4">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label fw-semibold mb-0">Bulk Paste (one per line)</label>
                  <button type="button" id="hide-bulk-btn" class="btn btn-sm btn-outline-secondary">Hide</button>
                </div>
                <textarea id="bulk-paste" class="form-control" rows="5"
                          placeholder="Example:
0241234567 1
0559876543 5"></textarea>
                <small class="text-muted">
                  Format: <code>PHONE VALUE</code> (e.g. <code>0284039645 5</code> ‚Üí 5 GB). We‚Äôll match VALUE to an offer for the selected service.
                </small>
              </div>
              <div class="align-self-end">
                <button id="apply-bulk-btn" class="btn btn-outline-primary mt-3">
                  <i class="bi bi-check2-square me-1"></i> Apply to Rows
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Entry Rows -->
        <div id="form-rows-wrapper" class="mb-4">
          <div class="row g-3 align-items-end mb-3" id="rows-body">
            <!-- JS appends rows -->
          </div>
        </div>

        <!-- Add to Cart -->
        <div class="text-end">
          <button id="add-all-to-cart" class="btn btn-success btn-lg px-4">
            <i class="bi bi-cart-plus me-1"></i> Add All to Cart
          </button>
        </div>

      </div>
    </div>

    <!-- Recent Orders -->
    <div class="container mb-5">
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-box-seam-fill me-2 fs-4 text-primary"></i>
        <h4 class="mb-0">Recent Orders</h4>
      </div>

      {% if recent_orders %}
        <div class="card shadow-sm">
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Order ID</th>
                  <th>Service</th>
                  <th>Phone Number(s)</th>
                  <th>Total (GHS)</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% for order in recent_orders %}
                  <tr>
                    <td>
                      <a href="/invoice/{{ order.order_id }}" class="text-decoration-none">
                        <span class="badge bg-primary">{{ order.order_id or "N/A" }}</span>
                      </a>
                    </td>
                    <td>
                      {% if order["items"] and order["items"][0]["serviceName"] %}
                        {{ order["items"][0]["serviceName"] }}
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>{{ order["items"]|length }} phone number{{ 's' if order["items"]|length > 1 }}</td>
                    <td>GHS {{ '%.2f'|format(order.total_amount or 0) }}</td>
                    <td>
                      {% if order.status == "pending" %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% elif order.status == "completed" %}
                        <span class="badge bg-success">Completed</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ order.status|capitalize }}</span>
                      {% endif %}
                    </td>
                    <td>{{ order.created_at.strftime('%d %b %Y, %I:%M %p') if order.created_at }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="text-muted">No recent orders yet.</div>
      {% endif %}
    </div>

    {% include 'customer_footer.html' %}
  </main>

  <!-- Store notifications modal -->
  <div class="modal fade" id="storeNotifyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-bell me-2"></i>Latest Store Orders</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="storeNotifyList" class="list-group list-group-flush"></div>
          <div id="storeNotifyEmpty" class="text-muted">No recent store orders yet.</div>
          <div class="d-grid mt-3">
            <button id="storeNotifyMore" type="button" class="btn btn-outline-primary">View more</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script id="store-notify-data" type="application/json">
    {{ (store_recent_orders_view or []) | tojson }}
  </script>

  <!-- ==========================
       AD FLYER MODAL (AUTO SHOW)
       - "Don't show again" is DAILY per device (localStorage with today's date)
  =========================== -->
  <div class="modal fade" id="flyerAdModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <div class="d-flex align-items-center gap-2">
            <span class="ad-badge"><i class="bi bi-megaphone-fill"></i> Announcement</span>
            <span class="text-muted small d-none d-sm-inline">Tap the flyer to open the store page</span>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <a href="/customer/store" class="text-decoration-none" aria-label="Open store page">
            <div class="ad-hero mb-3">
              <img
                src="https://imagedelivery.net/h9fmMoa1o2c2P55TcWJGOg/1da27af0-964e-4085-1f51-d52d3dd0d000/public"
                alt="Store Flyer"
                loading="eager"
              />
            </div>
          </a>

          <!-- How-to video tile -->
          <div class="howto-tile p-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
              <div>
                <div class="fw-semibold"><i class="bi bi-youtube me-1 text-danger"></i> How to create store</div>
                <div class="text-muted small">Watch the quick guide video inside the app.</div>
              </div>
              <button type="button" id="openHowToVideoBtn" class="btn btn-outline-primary">
                <i class="bi bi-play-circle me-1"></i> Play Video
              </button>
            </div>
          </div>

          <div class="text-muted small mt-3">
            Tip: If you select ‚ÄúDon‚Äôt show again‚Äù, this popup will hide only for today and return tomorrow.
          </div>
        </div>

        <div class="modal-footer d-flex flex-wrap justify-content-between gap-2">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="dontShowAgainToday">
            <label class="form-check-label" for="dontShowAgainToday">
              Don‚Äôt show again 
            </label>
          </div>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
            <i class="bi bi-check2-circle me-1"></i> Continue
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ==========================
       VIDEO MODAL (YOUTUBE)
  =========================== -->
  <div class="modal fade" id="howToStoreModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-shop me-2 text-primary"></i> How to create store
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="ratio ratio-16x9">
            <iframe
              id="howToStoreIframe"
              src="https://www.youtube.com/embed/Gz9w8yZyP1U?rel=0"
              title="How to create store"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen>
            </iframe>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Cart -->
  <div class="floating-cart">
    <button type="button" class="btn-cart" data-bs-toggle="modal" data-bs-target="#cartModal">
      üõí Cart <span class="badge bg-danger" id="cart-count">0</span>
    </button>
  </div>

  <!-- Cart / Checkout Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Your Cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div id="cart-empty" class="text-muted">Your cart is empty.</div>

          <div id="cart-list-wrapper" class="d-none">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Service</th>
                    <th>Phone</th>
                    <th>Offer (Value)</th>
                    <th>Total (GHS)</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="cart-list"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <button id="clear-cart-btn" class="btn btn-outline-danger btn-sm">Clear Cart</button>
              <div class="fs-5 fw-semibold">Total: GHS <span id="cart-total">0.00</span></div>
            </div>

            <div class="text-end mb-3">
              <button id="checkout-btn" class="btn btn-primary">Proceed to Checkout</button>
            </div>

            <!-- Checkout Section (hidden until proceed) -->
            <div id="checkout-section" class="border-top pt-3 d-none">
              <h5 class="mb-3">Checkout</h5>
              <div class="mb-3">
                <label class="form-label fw-semibold">Payment Method</label>
                <select class="form-select" id="payment-method" aria-label="Payment method">
                  <option value="from_account" selected>From Account</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Total Payable</label>
                <div class="fs-5 fw-bold text-success">GHS <span id="checkout-total">0.00</span></div>
              </div>
              <div class="text-end">
                <button id="confirm-payment-btn" class="btn btn-success">
                  <span class="btn-label">Confirm Payment</span>
                  <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                </button>
              </div>
            </div>
          </div>
        </div> <!-- /modal-body -->
      </div> <!-- /modal-content -->
    </div> <!-- /modal-dialog -->
  </div> <!-- /modal -->

  <!-- Full-page loader -->
  <div id="page-loader" class="loader-overlay d-none" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div>
        <div class="loader-text">Processing payment...</div>
        <div class="loader-sub">Please don‚Äôt close this window</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  (function(){
    function readJsonScript(id, fallback){
      try{
        var el = document.getElementById(id);
        if(!el) return fallback;
        var txt = (el.textContent || "").trim();
        if(!txt) return fallback;
        return JSON.parse(txt);
      }catch(_e){ return fallback; }
    }

    var data = readJsonScript("store-notify-data", []);
    var listEl = document.getElementById("storeNotifyList");
    var emptyEl = document.getElementById("storeNotifyEmpty");
    var moreBtn = document.getElementById("storeNotifyMore");
    var badgeEl = document.getElementById("storeNotifyBadge");
    var modalEl = document.getElementById("storeNotifyModal");
    var PAGE_SIZE = 5;
    var page = 1;
    var lastSeen = 0;

    function getLastSeen(){
      try{ return Number(localStorage.getItem("store_notify_last_seen") || 0); }catch(_e){ return 0; }
    }

    function statusBadge(status){
      var s = String(status || "").toLowerCase();
      if(s === "pending") return '<span class="badge bg-warning text-dark">Pending</span>';
      if(s === "completed") return '<span class="badge bg-success">Completed</span>';
      if(!s) return '<span class="badge bg-secondary">Unknown</span>';
      return '<span class="badge bg-secondary">' + s.charAt(0).toUpperCase() + s.slice(1) + '</span>';
    }

    function renderList(){
      if(!listEl || !emptyEl || !moreBtn) return;
      var total = data.length;
      var end = Math.min(total, page * PAGE_SIZE);
      listEl.innerHTML = "";
      if(total === 0){
        emptyEl.classList.remove("d-none");
        moreBtn.classList.add("d-none");
        return;
      }
      emptyEl.classList.add("d-none");
      for(var i = 0; i < end; i++){
        var o = data[i] || {};
        var item = document.createElement("div");
        var createdAt = Date.parse(o.created_at_iso || "");
        var isNew = createdAt && createdAt > lastSeen;
        item.className = "list-group-item d-flex justify-content-between align-items-start" + (isNew ? " store-notify-new" : "");
        var phone = o.phone || "phone N/A";
        var ref = (o.paystack_reference || "").trim();
        var refLine = ref ? '<div class="small text-muted">Paystack Ref: ' + ref + '</div>' : "";
        item.innerHTML =
          '<div>' +
            '<div class="fw-semibold">Order ' + (o.order_id || "N/A") + '</div>' +
            '<div class="small text-muted">' + (o.store_slug || "store") + ' ‚Ä¢ ' + phone + '</div>' +
            refLine +
            '<div class="small text-muted">' + (o.created_at_fmt || "") + '</div>' +
          '</div>' +
          '<div class="text-end">' +
            '<div class="fw-semibold">GHS ' + Number(o.total_amount || 0).toFixed(2) + '</div>' +
            statusBadge(o.status) +
          '</div>';
        listEl.appendChild(item);
      }
      moreBtn.classList.toggle("d-none", end >= total);
    }

    function updateBadge(){
      if(!badgeEl) return;
      var unseen = data.filter(function(o){
        var t = Date.parse(o.created_at_iso || "");
        return t && t > lastSeen;
      }).length;
      badgeEl.textContent = String(unseen);
      badgeEl.classList.toggle("d-none", unseen <= 0);
      var btn = document.getElementById("storeNotifyBtn");
      if(btn) btn.classList.toggle("notif-has-new", unseen > 0);
    }

    if(moreBtn){
      moreBtn.addEventListener("click", function(){
        page += 1;
        renderList();
      });
    }

    if(modalEl){
      modalEl.addEventListener("show.bs.modal", function(){
        page = 1;
        lastSeen = getLastSeen();
        renderList();
        try{ localStorage.setItem("store_notify_last_seen", String(Date.now())); }catch(_e){}
        if(badgeEl) badgeEl.textContent = "0";
        if(badgeEl) badgeEl.classList.add("d-none");
        var btn = document.getElementById("storeNotifyBtn");
        if(btn) btn.classList.remove("notif-has-new");
      });
    }

    lastSeen = getLastSeen();
    renderList();
    updateBadge();
  })();
  </script>

  <!-- ========= DAILY AD MODAL LOGIC + VIDEO MODAL HANDLING ========= -->
  <script>
  (function(){
    var HIDE_KEY = "nndata_flyer_hide_date_v1";

    function pad2(n){ return (n < 10 ? "0" : "") + String(n); }
    function localTodayYYYYMMDD(){
      // local date (per device timezone)
      var d = new Date();
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }

    function shouldShowToday(){
      try {
        var saved = localStorage.getItem(HIDE_KEY) || "";
        return saved !== localTodayYYYYMMDD();
      } catch(e){
        return true;
      }
    }

    function markHiddenForToday(){
      try { localStorage.setItem(HIDE_KEY, localTodayYYYYMMDD()); } catch(e){}
    }

    function clearHidden(){
      try { localStorage.removeItem(HIDE_KEY); } catch(e){}
    }

    function initAdModal(){
      if (!window.bootstrap) return;

      var adEl = document.getElementById("flyerAdModal");
      if (!adEl) return;

      var chk = document.getElementById("dontShowAgainToday");
      var openVideoBtn = document.getElementById("openHowToVideoBtn");

      var adModal = bootstrap.Modal.getOrCreateInstance(adEl, { backdrop: "static", keyboard: false });

      // show immediately after reload (if not hidden for today)
      if (shouldShowToday()) {
        // small delay to let layout settle
        setTimeout(function(){ adModal.show(); }, 200);
      }

      // when closing the ad modal: store daily "don't show again" if checked
      adEl.addEventListener("hidden.bs.modal", function(){
        if (chk && chk.checked) markHiddenForToday();
      });

      // if user unchecks, allow showing again (same day) on refresh
      if (chk) {
        chk.addEventListener("change", function(){
          if (!chk.checked) clearHidden();
        });
      }

      // open video modal from inside ad modal (clean, no stacked modals)
      var videoEl = document.getElementById("howToStoreModal");
      var iframe = document.getElementById("howToStoreIframe");
      var videoModal = videoEl ? bootstrap.Modal.getOrCreateInstance(videoEl) : null;

      function resetVideo(){
        if (!iframe) return;
        var src = iframe.getAttribute("src") || "";
        // reload iframe to stop playback
        iframe.setAttribute("src", src);
      }

      if (videoEl) {
        videoEl.addEventListener("hidden.bs.modal", resetVideo);
      }

      if (openVideoBtn && videoEl && videoModal) {
        openVideoBtn.addEventListener("click", function(){
          // close ad, then open video
          var openAfter = function(){
            try { videoModal.show(); } catch(e){}
            adEl.removeEventListener("hidden.bs.modal", openAfter);
          };
          adEl.addEventListener("hidden.bs.modal", openAfter);
          try { adModal.hide(); } catch(e){ openAfter(); }
        });
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initAdModal);
    } else {
      initAdModal();
    }
  })();
  </script>

  <script>
  var chosenService = null;
  var rowsBody = document.getElementById("rows-body");
  var workArea = document.getElementById("work-area");
  var chosenNameEl = document.getElementById("chosen-service-name");

  // ---- Cart + persistence ----
  var CART_KEY = "nndata_cart_v1";
  var cart = [];

  function money(n) { return Number(n || 0).toFixed(2); }

  function loadCart() {
    try {
      var saved = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
      if (Object.prototype.toString.call(saved) === "[object Array]") cart = saved;
    } catch (e) {}
  }
  function saveCart() {
    try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch (e) {}
  }

  function formatVolumeLabel(value) {
    if (value && typeof value === "string") return value;
    if (value && typeof value === "object") {
      var vol = Number(value.volume || 0);
      return vol >= 1000 ? (String(vol / 1000).replace(/\.0+$/, "") + "GB") : (vol + "MB");
    }
    return "-";
  }

  function renderOfferOptions(offers) {
    offers = offers || [];
    var html = '<option value="">-- Choose Offer --</option>';
    for (var i = 0; i < offers.length; i++) {
      var o = offers[i];
      var label = o.value_text ? o.value_text : formatVolumeLabel(o.value);
      var disabled = (o.amount == null || o.total == null) ? ' disabled' : '';
      var totalVal = (o.total != null ? o.total : '');
      var baseVal = (o.amount != null ? o.amount : '');
      var idxAttr = ' data-idx="' + i + '"';
      html += '<option' + disabled +
              ' value="' + totalVal + '"' +
              ' data-base="' + baseVal + '"' +
              ' data-total="' + totalVal + '"' +
              idxAttr + '>' +
              'GHS ' + money(totalVal || 0) + ' - ' + label +
              '</option>';
    }
    return html;
  }

  // ---------- PHONE FORMAT ----------
  var PHONE_RE = /^0\d{9}$/;

  function attachPhoneMask(container) {
    var inputs = container.querySelectorAll(".phone-input");
    for (var i = 0; i < inputs.length; i++) {
      (function(inp){
        inp.setAttribute("inputmode", "numeric");
        inp.setAttribute("maxlength", "10");
        inp.placeholder = "e.g. 0530393625";
        function handle() {
          var digits = (inp.value || "").replace(/\D+/g, "");
          if (digits.length > 10) digits = digits.slice(0, 10);
          inp.value = digits;
          if (!PHONE_RE.test(digits)) inp.classList.add("is-invalid");
          else inp.classList.remove("is-invalid");
        }
        inp.addEventListener("input", handle);
        handle();
      })(inputs[i]);
    }
  }

  function addRow(phone, selectedIdx) {
    phone = phone || "";

    var col = document.createElement("div");
    col.className = "col-12";

    var card = document.createElement("div");
    card.className = "card border rounded-3 p-3 shadow-sm mb-2";
    col.appendChild(card);

    var row = document.createElement("div");
    row.className = "row g-3 align-items-center";
    card.appendChild(row);

    // phone
    var c1 = document.createElement("div");
    c1.className = "col-12 col-md-5";
    var phoneInput = document.createElement("input");
    phoneInput.type = "text";
    phoneInput.className = "form-control phone-input";
    phoneInput.placeholder = "e.g. 0530393625";
    phoneInput.value = (phone.replace(/\D+/g,"").slice(0,10));
    c1.appendChild(phoneInput);
    row.appendChild(c1);

    // offer select
    var c2 = document.createElement("div");
    c2.className = "col-12 col-md-5";
    var sel = document.createElement("select");
    sel.className = "form-select offer-select";
    sel.innerHTML = chosenService ? renderOfferOptions(chosenService.offers) : '<option>-- Choose Offer --</option>';
    c2.appendChild(sel);
    row.appendChild(c2);

    // right side
    var c3 = document.createElement("div");
    c3.className = "col-12 col-md-2 d-flex justify-content-between align-items-center";
    var amt = document.createElement("div");
    amt.className = "amount-cell fw-semibold text-primary";
    amt.textContent = "-";
    var rm = document.createElement("button");
    rm.className = "btn btn-sm btn-outline-danger remove-row-btn";
    rm.innerHTML = '<i class="bi bi-x-lg"></i>';
    c3.appendChild(amt);
    c3.appendChild(rm);
    row.appendChild(c3);

    rowsBody.appendChild(col);

    attachPhoneMask(col);

    sel.addEventListener("change", function(){ amt.textContent = ""; });

    if (typeof selectedIdx === "number") {
      var opt = sel.querySelector('option[data-idx="' + selectedIdx + '"]');
      if (opt) {
        sel.value = opt.value;
        var evt = document.createEvent("HTMLEvents");
        evt.initEvent("change", true, false);
        sel.dispatchEvent(evt);
      }
    }
  }

  function clearRows() { rowsBody.innerHTML = ""; }

  function updateCartUI() {
    var list = document.getElementById("cart-list");
    var count = document.getElementById("cart-count");
    var empty = document.getElementById("cart-empty");
    var wrap = document.getElementById("cart-list-wrapper");
    var totalEl = document.getElementById("cart-total");

    list.innerHTML = "";
    var total = 0;
    for (var i = 0; i < cart.length; i++) {
      var item = cart[i];
      total += Number(item.amount || 0);
      var tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" + item.serviceName + "</td>" +
        "<td>" + item.phone + "</td>" +
        "<td>" + item.value + "</td>" +
        "<td>GHS " + money(item.amount) + "</td>" +
        '<td><button class="btn btn-sm btn-outline-danger" data-remove="' + i + '">Remove</button></td>';
      list.appendChild(tr);
    }

    count.textContent = String(cart.length);
    totalEl.textContent = money(total);
    empty.classList.toggle("d-none", cart.length !== 0);
    wrap.classList.toggle("d-none", cart.length === 0);

    saveCart();
  }

  function addAllRowsToCart() {
    var rowCards = rowsBody.querySelectorAll(".card");
    if (!rowCards.length) { alert("Add at least one row."); return; }

    var bad = [];
    for (var i = 0; i < rowCards.length; i++) {
      var row = rowCards[i];
      var phoneRawInp = row.querySelector(".phone-input");
      var sel = row.querySelector(".offer-select");
      var phoneRaw = phoneRawInp ? (phoneRawInp.value || "") : "";
      var phone = phoneRaw.replace(/\D+/g, "");
      var opt = null;
      if (sel && typeof sel.selectedIndex === "number" && sel.selectedIndex >= 0) {
        opt = sel.options[sel.selectedIndex];
      }

      if (!PHONE_RE.test(phone) || !opt || !sel.value) { bad.push(i + 1); continue; }

      var valueText = (opt.textContent || "").replace(/^.*-\s*/, "") || "-";
      var total = Number(opt.getAttribute("data-total") || sel.value || 0);
      var base  = Number(opt.getAttribute("data-base") || 0);

      var idxAttr = opt.getAttribute("data-idx");
      var offerIdx = typeof idxAttr === "string" ? Number(idxAttr) : null;
      var offer = (chosenService && chosenService.offers && typeof offerIdx === "number") ? chosenService.offers[offerIdx] : null;
      var valueObj = (offer && offer.value) ? offer.value : null;

      cart.push({
        serviceId: chosenService._id_str,
        serviceName: chosenService.display_name || chosenService.name,
        phone: phone,
        value: valueText,
        value_obj: valueObj,
        base_amount: base,
        amount: total,
        total: total
      });
    }

    if (bad.length) {
      alert("Some rows were incomplete or invalid (phone must be 0xxxxxxxxx): " + bad.join(", "));
      return;
    }
    updateCartUI();
    clearRows();
    addRow();
  }

  function parseGBFromValue(value) {
    if (value && typeof value === "object" && value.volume != null) {
      var vol = Number(value.volume);
      return vol / 1000;
    }
    var m = String(value || "").match(/(\d+(?:\.\d+)?)/);
    return m ? Number(m[1]) : null;
  }

  function findOfferIndexByGB(offers, gbNumber) {
    offers = offers || [];
    var candidates = [];
    for (var i = 0; i < offers.length; i++) {
      var gb = parseGBFromValue(offers[i].value);
      if (gb !== null && Number(gb) === Number(gbNumber)) {
        candidates.push({ idx: i, price: (offers[i].total != null ? offers[i].total : (offers[i].amount || 0)) });
      }
    }
    if (!candidates.length) return null;
    candidates.sort(function(a,b){ return a.price - b.price; });
    return candidates[0].idx;
  }

  // ---- Overlay/Backdrop safety cleanup ----
  function cleanupOverlays() {
    var pl = document.getElementById("page-loader");
    if (pl && !pl.classList.contains("d-none")) pl.classList.add("d-none");
    document.querySelectorAll(".modal-backdrop").forEach(function(el){ el.remove(); });
    document.body.classList.remove("modal-open");
    document.body.style.removeProperty("overflow");
    document.body.style.removeProperty("paddingRight");
  }

  // Service selection (uses display_name if provided)
  function wireSelectButtons() {
    var btns = document.querySelectorAll(".select-service-btn");
    for (var i = 0; i < btns.length; i++) {
      (function(btn){
        btn.addEventListener("click", function () {
          if (btn.hasAttribute("disabled")) return;
          var svcDataStr = btn.getAttribute("data-service") || "{}";
          try { chosenService = JSON.parse(svcDataStr); } catch(e){ chosenService = null; }
          if (!chosenService) return;

          chosenNameEl.textContent = (chosenService.display_name || chosenService.name || "");

          var cardCol = btn.closest(".col-12");
          if (cardCol && workArea) {
            cardCol.parentNode.insertBefore(workArea, cardCol.nextSibling);
          }

          workArea.classList.remove("d-none");
          clearRows();
          addRow();

          var bulkCard = document.getElementById("bulk-card");
          if (bulkCard) bulkCard.classList.add("d-none");
          var bulkTrigger = document.getElementById("bulk-trigger");
          if (bulkTrigger) bulkTrigger.value = "";

          var firstPhone = rowsBody.querySelector(".phone-input");
          if (firstPhone && typeof firstPhone.focus === "function") {
            setTimeout(function(){ firstPhone.focus(); }, 50);
          }
          if (typeof workArea.scrollIntoView === "function") {
            workArea.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      })(btns[i]);
    }
  }

  // Row actions
  rowsBody.addEventListener("click", function(e){
    var rm = e.target.closest ? e.target.closest(".remove-row-btn") : null;
    if (rm) {
      var col = rm.closest(".col-12");
      if (col && col.parentNode) col.parentNode.removeChild(col);
    }
  });

  // Bulk paste
  (function wireBulk(){
    var bulkTrigger = document.getElementById("bulk-trigger");
    var bulkCard = document.getElementById("bulk-card");
    var hideBulkBtn = document.getElementById("hide-bulk-btn");
    function showBulk(){ if (bulkCard) bulkCard.classList.remove("d-none"); var t = document.getElementById("bulk-paste"); if (t) setTimeout(function(){ t.focus(); }, 0); }
    function hideBulk(){ if (bulkCard) bulkCard.classList.add("d-none"); }
    if (bulkTrigger) {
      bulkTrigger.addEventListener("focus", showBulk);
      bulkTrigger.addEventListener("click", showBulk);
      bulkTrigger.addEventListener("keydown", function(e){ if (e.key === "Enter") { e.preventDefault(); addRow(); }});
    }
    if (hideBulkBtn) hideBulkBtn.addEventListener("click", hideBulk);

    var applyBtn = document.getElementById("apply-bulk-btn");
    if (applyBtn) applyBtn.addEventListener("click", function(){
      if (!chosenService) { alert("Choose a service first."); return; }
      var ta = document.getElementById("bulk-paste");
      var text = ta ? ta.value : "";
      var lines = text.split(/\r?\n/).map(function(l){ return l.trim(); }).filter(function(x){ return !!x; });
      if (!lines.length) { alert("Nothing to paste."); return; }

      var need = lines.length - rowsBody.querySelectorAll(".card").length;
      while (need-- > 0) addRow();

      var rows = rowsBody.querySelectorAll(".card");
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var parts = line.split(/[\s,;\t]+/).filter(function(x){ return !!x; });
        var phoneDigits = (parts[0] || "").replace(/\D+/g, "").slice(0,10);
        var gbNum = parts[1] ? Number(parts[1]) : null;

        var row = rows[i];
        if (!row) continue;
        var phoneInput = row.querySelector(".phone-input");
        var sel = row.querySelector(".offer-select");

        if (phoneInput) {
          phoneInput.value = phoneDigits;
          var ev = document.createEvent("HTMLEvents");
          ev.initEvent("input", true, false);
          phoneInput.dispatchEvent(ev);
        }

        if (gbNum !== null && sel) {
          var idx = findOfferIndexByGB(chosenService.offers, gbNum);
          if (idx !== null) {
            var opt = sel.querySelector('option[data-idx="' + idx + '"]');
            if (opt) sel.value = opt.value;
          }
          var ev2 = document.createEvent("HTMLEvents");
          ev2.initEvent("change", true, false);
          sel.dispatchEvent(ev2);
        }
      }
    });
  })();

  // Add all rows to cart
  var addAllBtn = document.getElementById("add-all-to-cart");
  if (addAllBtn) addAllBtn.addEventListener("click", addAllRowsToCart);

  // Cart interactions
  var cartModal = document.getElementById("cartModal");
  if (cartModal) {
    cartModal.addEventListener("click", function(e){
      var btn = e.target.closest ? e.target.closest("button[data-remove]") : null;
      if (!btn) return;
      var idx = Number(btn.getAttribute("data-remove"));
      if (!isNaN(idx)) { cart.splice(idx, 1); updateCartUI(); }
    });
    cartModal.addEventListener("hidden.bs.modal", cleanupOverlays);
  }

  // Clear cart
  var clearBtn = document.getElementById("clear-cart-btn");
  if (clearBtn) clearBtn.addEventListener("click", function(){
    if (!cart.length) return;
    if (confirm("Clear all items in the cart?")) { cart = []; updateCartUI(); }
  });

  // Proceed to checkout
  var checkoutBtn = document.getElementById("checkout-btn");
  if (checkoutBtn) checkoutBtn.addEventListener("click", function(){
    if (!cart.length) { alert("Your cart is empty."); return; }
    var section = document.getElementById("checkout-section");
    var total = document.getElementById("cart-total").textContent;
    document.getElementById("checkout-total").textContent = total;
    if (section) section.classList.remove("d-none");
    setTimeout(function(){ if (section && section.scrollIntoView) section.scrollIntoView({ behavior: "smooth" }); }, 100);
  });

  // --- Loading helpers ---
  var pageLoader = document.getElementById("page-loader");
  var confirmBtn = document.getElementById("confirm-payment-btn");
  function setProcessing(on) {
    if (pageLoader) pageLoader.classList.toggle("d-none", !on);
    if (confirmBtn) {
      var spinner = confirmBtn.querySelector(".spinner-border");
      var label = confirmBtn.querySelector(".btn-label");
      confirmBtn.disabled = !!on;
      if (spinner) spinner.classList.toggle("d-none", !on);
      if (label) label.textContent = on ? "Processing..." : "Confirm Payment";
    }
    var dis = document.querySelectorAll("#checkout-section input, #checkout-section select, #checkout-section button");
    for (var i = 0; i < dis.length; i++) { if (dis[i] !== confirmBtn) dis[i].disabled = !!on; }
  }

  // Confirm payment (with loader) + overlay safety ordering
  if (confirmBtn) confirmBtn.addEventListener("click", function(){
    var methodSel = document.getElementById("payment-method");
    var method = methodSel ? methodSel.value : "from_account";
    var total = document.getElementById("checkout-total").textContent;

    Swal.fire({
      title: "Confirm payment?",
      html: "You're about to pay <b>GHS " + total + "</b> from your wallet.",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, Pay",
      cancelButtonText: "Cancel",
      confirmButtonColor: "#0ea5e9"
    }).then(function(res){
      if (!res.isConfirmed) return;

      setProcessing(true);
      var controller = new AbortController();
      var aborted = false;
      var timer = setTimeout(function(){ aborted = true; if (controller && controller.abort) controller.abort(); }, 60000);

      fetch("/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cart: cart, method: method }),
        signal: controller.signal
      }).then(function(response){
        clearTimeout(timer);
        return response.json().then(function(json){ return { ok: response.ok, json: json }; })
          .catch(function(){ return { ok: response.ok, json: {} }; });
      }).then(function(result){
        if (result.ok && result.json && result.json.success) {
          // ‚úÖ Auto-clear cart & auto-redirect, no "OK" click needed
          try {
            cart = [];
            localStorage.removeItem(CART_KEY);
          } catch(e){}
          if (typeof updateCartUI === "function") updateCartUI();

          setProcessing(false);
          cleanupOverlays();

          var redirectUrl = (result.json.redirect_url || ("/invoice/" + (result.json.order_id || "")));
          if (redirectUrl) {
            window.location.href = redirectUrl;
          }

        } else {
          setProcessing(false);
          cleanupOverlays();

          Swal.fire({
            title: "Failed",
            text: (result.json && (result.json.message || result.json.error)) || "Payment failed. Please try again.",
            icon: "error"
          }).then(cleanupOverlays);
        }
      }).catch(function(err){
        setProcessing(false);
        cleanupOverlays();

        var msg = aborted
          ? "The request took too long and was cancelled. Please check your network and try again."
          : "Something went wrong while processing payment.";
        Swal.fire({ title: "Error", text: msg, icon: "error" }).then(cleanupOverlays);
      }).finally(function(){
        setProcessing(false);
        cleanupOverlays();
      });
    });
  });

  // ---- Init ----
  loadCart();
  updateCartUI();
  wireSelectButtons();

  var addRowBtn = document.getElementById("add-row-btn");
  if (addRowBtn) addRowBtn.addEventListener("click", function(){ addRow(); });

  window.addEventListener("load", cleanupOverlays);
  </script>

  <!-- AFA modal script (submits to /api/afa/register and deducts wallet) -->
  <script>
  (function(){
    if (typeof PHONE_RE === "undefined") {
      window.PHONE_RE = /^0\d{9}$/;
    }

    var afaPhone = document.getElementById("afa-phone");
    if (afaPhone) {
      afaPhone.addEventListener("input", function(){
        var digits = (afaPhone.value || "").replace(/\D+/g, "");
        if (digits.length > 10) digits = digits.slice(0, 10);
        afaPhone.value = digits;
        if (!PHONE_RE.test(digits)) {
          afaPhone.classList.add("is-invalid");
        } else {
          afaPhone.classList.remove("is-invalid");
        }
      });
    }

    var form = document.getElementById("afa-form");
    if (!form) return;

    form.addEventListener("submit", function(e){
      e.preventDefault();

      var name = (document.getElementById("afa-name").value || "").trim();
      var phone = (document.getElementById("afa-phone").value || "").trim();
      var dob = (document.getElementById("afa-dob").value || "").trim();
      var location = (document.getElementById("afa-location").value || "").trim();
      var ghanaCard = (document.getElementById("afa-ghana-card").value || "").trim();

      var phoneDigits = phone.replace(/\D+/g, "");
      if (!name) {
        if (window.Swal) Swal.fire("Missing", "Name is required", "warning"); else alert("Name is required");
        return;
      }
      if (!PHONE_RE.test(phoneDigits)) {
        if (window.Swal) Swal.fire("Invalid phone", "Phone must be 0xxxxxxxxx (10 digits, starts with 0).", "warning");
        else alert("Phone must be 0xxxxxxxxx (10 digits, starts with 0).");
        return;
      }

      var payload = {
        name: name,
        phone: phoneDigits,
        dob: dob || null,
        location: location || null,
        ghana_card: ghanaCard || null
      };

      var submitBtn = document.getElementById("afa-submit");
      if (submitBtn) submitBtn.disabled = true;

      fetch("/api/afa/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
      .then(function(r){
        return r.json().then(function(j){ return { ok: r.ok, json: j }; })
                 .catch(function(){ return { ok: r.ok, json: {} }; });
      })
      .then(function(res){
        if (res.ok && res.json && res.json.success) {
          if (window.Swal) Swal.fire("Submitted", "AFA registration submitted. Status: pending.", "success");
          else alert("AFA registration submitted. Status: pending.");

          // reset form
          form.reset();
          if (afaPhone) afaPhone.classList.remove("is-invalid");

          // close modal
          var modalEl = document.getElementById("afaModal");
          if (modalEl && window.bootstrap) {
            var inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            if (inst && inst.hide) inst.hide();
          }

          // If server returned new balance, reflect it (optional)
          try {
            if (res.json.balance != null) {
              var balEls = document.querySelectorAll(".balance-amount");
              for (var i=0;i<balEls.length;i++){
                balEls[i].textContent = "GHS " + Number(res.json.balance).toFixed(2);
              }
            }
          } catch(e){}
        } else {
          var msg = (res.json && (res.json.error || res.json.message)) || "Could not submit registration.";
          if (window.Swal) Swal.fire("Error", msg, "error"); else alert(msg);
        }
      })
      .catch(function(){
        if (window.Swal) Swal.fire("Error", "Network error. Please try again.", "error");
        else alert("Network error. Please try again.");
      })
      .finally(function(){
        if (submitBtn) submitBtn.disabled = false;
      });
    });
  })();
  </script>

  <!-- Chart init (single source) -->
  <script>
  (function () {
    const fmt = (n) => {
      const v = Number(n || 0);
      return 'GHS ' + v.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    };
    document.querySelectorAll('.ghs[data-amt]').forEach(el => {
      el.textContent = fmt(el.getAttribute('data-amt'));
    });

    const blob = document.getElementById('cust-daily-sales-data');
    if (!blob) return;
    let parsed = {};
    try { parsed = JSON.parse(blob.textContent || '{}'); } catch (e) {}
    const labels = Array.isArray(parsed.labels) ? parsed.labels : [];
    const values = Array.isArray(parsed.values) ? parsed.values : [];
    if (!values.length) return;

    const ctx = document.getElementById('custDailySalesChart');
    if (!ctx || !window.Chart) return;

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          data: values,
          borderWidth: 2,
          tension: 0.35,
          pointRadius: 0,
          fill: true,
          backgroundColor: 'rgba(255,255,255,0.12)',
          borderColor: 'rgba(255,255,255,0.9)',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true, callbacks: {
          label: (c) => fmt(c.parsed.y)
        } } },
        scales: {
          x: { display: true, grid: { display: false }, ticks: { color: 'rgba(255,255,255,.75)' } },
          y: { display: false, beginAtZero: true }
        },
        elements: { line: { capBezierPoints: true } }
      }
    });
  })();
  </script>

  <!-- Server cart sync layer (kept exactly as you provided, with fixes) -->
  <script>
  /* --- Server Cart Sync (fixed to keep cart visible after "Proceed") ---------------- */
  (function(){
    if (!window.fetch) return;

    let CART_SYNCING = false;
    let CART_MUTE    = false;
    let CART_LOCKED  = false;
    let lockedCart   = null;

    async function pullServerCart() {
      try {
        const r = await fetch("/api/cart", { credentials: "same-origin" });
        const j = await r.json();
        if (!j.success || !Array.isArray(j.items)) return;

        const serverHas = j.items.length > 0;
        const localHas  = Array.isArray(window.cart) && window.cart.length > 0;

        if (!serverHas && localHas) {
          await fetch("/api/cart/replace", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ items: window.cart })
          });

          const r2 = await fetch("/api/cart", { credentials: "same-origin" });
          const j2 = await r2.json();
          if (j2.success && Array.isArray(j2.items)) {
            CART_MUTE = true;
            window.cart = j2.items.map(stripServerItemForClient);
            if (typeof updateCartUI === "function") updateCartUI();
            CART_MUTE = false;
          }
          return;
        }

        CART_MUTE = true;
        window.cart = j.items.map(stripServerItemForClient);
        if (typeof updateCartUI === "function") updateCartUI();
        CART_MUTE = false;
      } catch (e) {
        // ignore
      }
    }

    function stripServerItemForClient(it){
      return {
        _id: it._id,
        serviceId: it.serviceId,
        serviceName: it.serviceName,
        phone: it.phone,
        value: it.value,
        value_obj: it.value_obj,
        base_amount: Number(it.base_amount || 0),
        amount: Number(it.amount || it.total || 0),
        total: Number(it.total || it.amount || 0)
      };
    }

    if (typeof saveCart === "function") {
      const _saveCartOrig = saveCart;
      window.saveCart = async function(){
        try { _saveCartOrig(); } catch(e) {}

        if (CART_MUTE || CART_SYNCING || CART_LOCKED) return;

        try {
          CART_SYNCING = true;
          const r = await fetch("/api/cart/replace", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "same-origin",
            body: JSON.stringify({ items: (window.cart || []) })
          });
          const j = await r.json();
          if (j.success && Array.isArray(j.items)) {
            window.cart = j.items.map(stripServerItemForClient);
          }
        } catch(e) {
        } finally {
          CART_SYNCING = false;
        }
      };
    }

    const cartModalEl = document.getElementById("cartModal");
    if (cartModalEl) {
      cartModalEl.addEventListener("click", async function(e){
        const btn = e.target.closest ? e.target.closest("button[data-remove]") : null;
        if (!btn || CART_LOCKED) return;

        const idx  = Number(btn.getAttribute("data-remove"));
        const item = (Array.isArray(window.cart) && !isNaN(idx)) ? window.cart[idx] : null;

        try {
          if (item && item._id) {
            await fetch("/api/cart/remove", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "same-origin",
              body: JSON.stringify({ item_id: item._id })
            });
          }
        } catch(e) {}
      });
    }

    const clearBtn = document.getElementById("clear-cart-btn");
    if (clearBtn) {
      clearBtn.addEventListener("click", async function(e){
        if (CART_LOCKED) { e.preventDefault(); e.stopPropagation(); return; }
        try { await fetch("/api/cart/clear", { method: "POST", credentials: "same-origin" }); } catch(e){}
      });
    }

    function freezeCartUI() {
      CART_LOCKED = true;
      const clearBtn = document.getElementById("clear-cart-btn");
      if (clearBtn) {
        clearBtn.disabled = true;
        clearBtn.classList.add("disabled");
      }
      document.querySelectorAll('#cart-list button[data-remove]').forEach(btn => {
        btn.disabled = true;
        btn.classList.add("disabled");
      });
    }

    const checkoutBtn = document.getElementById("checkout-btn");
    if (checkoutBtn) {
      const _oldClick = checkoutBtn.onclick;
      checkoutBtn.addEventListener("click", async function(evt){
        if (typeof _oldClick === "function") {
          try { _oldClick.call(this, evt); } catch(e){}
        }

        if (!Array.isArray(window.cart) || window.cart.length === 0) return;

        try {
          const r = await fetch("/api/cart/checkout_start", { method: "POST", credentials: "same-origin" });
          const j = await r.json();
          if (j.success) {
            lockedCart = Array.isArray(j.locked) ? j.locked : [];
            freezeCartUI();
            const totalEl = document.getElementById("checkout-total");
            if (totalEl) totalEl.textContent = Number(j.total || 0).toFixed(2);
          }
        } catch (e) {
          // fallback: client-only
        }
      });
    }

    const confirmBtn = document.getElementById("confirm-payment-btn");
    if (confirmBtn) {
      confirmBtn.addEventListener("click", function(){
        if (!lockedCart || !lockedCart.length) return;

        const _fetch = window.fetch;
        let injectedOnce = false;

        window.fetch = function(input, init) {
          try {
            if (!injectedOnce && typeof input === "string" && input.indexOf("/checkout") === 0 && init && init.body) {
              const orig = JSON.parse(init.body);
              orig.cart = lockedCart.map(function(it){
                return {
                  serviceId: it.serviceId,
                  serviceName: it.serviceName,
                  phone: it.phone,
                  value: it.value,
                  value_obj: it.value_obj,
                  base_amount: Number(it.base_amount || 0),
                  amount: Number(it.amount || it.total || 0),
                  total: Number(it.total || it.amount || 0)
                };
              });
              init.body = JSON.stringify(orig);
              injectedOnce = true;
            }
          } catch(e) {}
          return _fetch(input, init);
        };
      });
    }

    pullServerCart();
  })();
  </script>

</body>
</html>
