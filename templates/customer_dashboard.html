<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root { --sea-blue:#0ea5e9; --soft:#f6f8fb; --ink:#0b1320; }
    body { background: var(--soft); }

    .scrolling-wrapper { -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: var(--sea-blue) #f1f1f1; }
    .scrolling-wrapper::-webkit-scrollbar { height: 8px; }
    .scrolling-wrapper::-webkit-scrollbar-track { background: #f1f1f1; }
    .scrolling-wrapper::-webkit-scrollbar-thumb { background-color: var(--sea-blue); border-radius: 10px; }

    .svc-card { border:1px solid #e9ecef; border-radius:14px; padding:1rem; height:100%; background:#fff; }
    .svc-img  { width:100%; height:140px; object-fit:cover; border-radius:10px; background:#f3f6f9; }

    /* Flags */
    .svc-flags { gap: .35rem; }
    .svc-flag { font-size:.75rem; padding:.35rem .55rem; border-radius:999px; border:1px solid transparent; }
    .flag-open { background:rgba(25,135,84,.12); color:#198754; border-color:rgba(25,135,84,.30); }
    .flag-closed { background:rgba(220,53,69,.12); color:#dc3545; border-color:rgba(220,53,69,.30); }
    .flag-available { background:rgba(13,110,253,.08); color:#0d6efd; border-color:rgba(13,110,253,.20); }
    .flag-oos { background:rgba(108,117,125,.15); color:#6c757d; border-color:rgba(108,117,125,.25); }

    .floating-cart { position:fixed; right:16px; bottom:16px; z-index:1055; }
    .btn-cart { position:relative; border-radius:999px; padding:.75rem 1rem; font-weight:600;
                background:var(--sea-blue); color:#fff; border:none;
                box-shadow:0 8px 24px rgba(14,165,233,.35); }
    .btn-cart .badge { position:absolute; top:-6px; right:-6px; }

    .bulk-trigger { cursor:text; }
    .amount-cell { min-width: 110px; text-align:right; }

    @media (max-width:576px){
      .svc-img{height:120px}
      .btn-cart{padding:.6rem .9rem}
      .input-group>.form-select{min-width: 150px;}
    }

    /* Loader overlay */
    .loader-overlay {
      position: fixed; inset: 0; background: rgba(11,19,32,.35);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000; backdrop-filter: blur(1.5px);
      transition: opacity .2s ease;
    }
    .loader-card {
      background: #fff; border-radius: 14px; padding: 1.25rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      display: flex; align-items: center; gap: .75rem; min-width: 260px;
    }
    .loader-text { font-weight: 600; color: var(--ink); }
    .loader-sub { font-size: .9rem; color: #6c757d; margin-top: -6px; }

    .modal-content { border: 0; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .table > :not(caption) > * > * { vertical-align: middle; }

    /* invalid phone highlight */
    .phone-input.is-invalid { border-color: #dc3545; padding-right: calc(1.5em + .75rem); background-image: none; }
  </style>
  <style>
  /* Section background (ocean) */
  .wallet-hero { position: relative; }
  .wallet-hero-bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: saturate(1.05) contrast(1.02); z-index: 0; }
  .wallet-hero::before { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom right, rgba(6, 24, 38, 0.55), rgba(6, 24, 38, 0.25) 40%, rgba(6, 24, 38, 0.15)); z-index: 1; }
  .wallet-hero-card { position: relative; z-index: 2; border-radius: 16px; padding: 24px; background: rgba(5, 48, 71, 0.35); backdrop-filter: blur(4px) saturate(1.1); -webkit-backdrop-filter: blur(4px) saturate(1.1); overflow: hidden; }
  .wallet-hero-card::after { content: ""; position: absolute; top: 50%; right: 24px; transform: translateY(-50%); width: clamp(120px, 26vw, 220px); height: clamp(120px, 26vw, 220px); border-radius: 50%; pointer-events: none; background:
    radial-gradient(circle at center, rgba(6,24,38,0.18), rgba(6,24,38,0) 55%),
    url("https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg") no-repeat center/cover;
    opacity: 0.42; filter: drop-shadow(0 1px 0 rgba(0,0,0,0.18)); }
  .wallet-hero-card .eyebrow { letter-spacing: .02em; }
  .wallet-hero-card .title { font-weight: 700; }
  .wallet-hero-card .balance-amount { font-size: clamp(1.35rem, 2.6vw, 2rem); font-weight: 800; }
  .wallet-hero-card .pill { background: rgba(255,255,255,0.15); color: #fff; padding: 8px 12px; border-radius: 999px; backdrop-filter: blur(2px); }
  .wallet-hero-card .title, .wallet-hero-card .balance-label, .wallet-hero-card .balance-amount, .wallet-hero-card .eyebrow { text-shadow: 0 1px 0 rgba(0,0,0,0.35); }
  @media (max-width: 575.98px) {
    .wallet-hero-card { padding: 20px 18px; }
    .wallet-hero-card::after { right: 16px; width: clamp(110px, 40vw, 180px); height: clamp(110px, 40vw, 180px); }
  }
  </style>
</head>
<body>
  {% include 'customer_sidebar.html' %}

  <main class="customer-content">

  <section class="wallet-hero my-4">
    <div class="wallet-hero-bg" style="background-image:url('https://e1.pxfuel.com/desktop-wallpaper/586/807/desktop-wallpaper-1920x1080-beautiful-ocean-pics-data-id-115186-ocean-sea.jpg');"></div>
    <div class="container position-relative">
      <div class="wallet-hero-card shadow-lg">
        <div class="row align-items-center g-3">
          <div class="col-12 col-md">
            <div class="eyebrow text-white-50">Welcome back</div>
            <h2 class="title mb-2 text-white">{{ customer_username or username }}</h2>
            <div class="balance-label text-white-50">Wallet Balance</div>
            <div class="balance-amount text-white">GHS {{ '%.2f'|format(balance) }}</div>
          </div>
          <div class="col-12 col-md-auto"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Make an Order -->
  <div class="container py-4" id="services">
  <h2 class="text-center mb-4">Make an Order</h2>

  {# collect all services then render by fixed order #}
  {% set _services = services if services is defined else [] %}
  {% set _express  = express_services if express_services is defined else [] %}
  {% set all_services = _services + _express %}

  {# CARD-ONLY macro (no column wrapper!) #}
  {% macro service_card(svc) -%}
    {% set status = (svc.status or 'OPEN')|upper %}
    {% set availability = (svc.availability or 'AVAILABLE')|upper %}
    {% set is_closed = status != 'OPEN' %}
    {% set is_oos    = availability != 'AVAILABLE' %}
    {% set can_order = (not is_closed) and (not is_oos) %}
    <div class="svc-card h-100 shadow-sm p-2 rounded bg-white d-flex flex-column">
      {% if svc.image_url %}
        <img src="{{ svc.image_url }}" class="svc-img mb-2 w-100" alt="{{ svc.name }}" style="border-radius:8px;object-fit:cover;max-height:160px;">
      {% endif %}

      <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
        <div class="fw-semibold text-truncate">{{ svc.name }}</div>
        <div class="d-flex flex-wrap svc-flags">
          <span class="svc-flag {{ 'flag-open' if not is_closed else 'flag-closed' }}">{{ 'Open' if not is_closed else 'Closed' }}</span>
          <span class="svc-flag {{ 'flag-available' if not is_oos else 'flag-oos' }}">{{ 'Available' if not is_oos else 'Out of Stock' }}</span>
        </div>
      </div>

      {% if is_closed and is_oos %}
        <div class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>{{ svc.disabled_reason or 'This service is currently unavailable.' }}</div>
      {% elif is_closed %}
        <div class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>This service is temporarily closed.</div>
      {% elif is_oos %}
        <div class="small text-danger mb-2"><i class="bi bi-exclamation-triangle me-1"></i>This service is currently out of stock.</div>
      {% endif %}

      <div class="mt-auto d-flex justify-content-end">
        <button
          class="btn btn-sm {{ 'btn-outline-primary' if can_order else 'btn-outline-secondary' }} select-service-btn"
          {% if not can_order %}disabled data-disabled="true"{% endif %}
          data-service='{{ {
            "_id_str": svc._id_str,
            "name": svc.name,
            "offers": svc.offers or []
          } | tojson }}'>
          Buy
        </button>
      </div>
    </div>
  {%- endmacro %}

  {# exact order to display #}
  {% set desired_order = [
    'MTN NORMAL',
    'TELECEL',
    'MTN EXPRESS',
    'AT - iSHare',
    'AT - BigTime',
    'AFA TALKTIME'
  ] %}

  {# pick first two services in that order #}
  {% set first_two = [] %}
  {% for nm in desired_order %}
    {% if first_two|length < 2 %}
      {% set svc = (all_services | selectattr('name','equalto', nm) | list | first) %}
      {% if svc %}{% set _ = first_two.append(svc) %}{% endif %}
    {% endif %}
  {% endfor %}

  <div class="row g-4">
    {% if first_two|length == 0 %}
      <div class="col-12"><div class="text-muted">No services available.</div></div>
    {% elif first_two|length == 1 %}
      <div class="col-12 col-lg-6">
        {{ service_card(first_two[0]) }}
      </div>
    {% else %}
      <div class="col-12 col-lg-6">
        {{ service_card(first_two[0]) }}
      </div>
      <div class="col-12 col-lg-6">
        {{ service_card(first_two[1]) }}
      </div>
    {% endif %}
  </div>

  {# compute the rest in the same fixed order #}
  {% set remaining = [] %}
  {% for nm in desired_order %}
    {% set svc = (all_services | selectattr('name','equalto', nm) | list | first) %}
    {% if svc and (first_two|selectattr('_id_str','equalto', svc._id_str)|list|length == 0) %}
      {% set _ = remaining.append(svc) %}
    {% endif %}
  {% endfor %}

  {% if remaining|length > 0 %}
    <div class="mt-4">
      <div class="row g-4">
        {% for svc in remaining %}
          <div class="col-12 col-sm-6 col-lg-4">
            {{ service_card(svc) }}
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <hr class="my-4">
</div>


<div class="row g-3" id="afa-registration-block">
  <div class="col-12 col-sm-8 col-md-6">
    <div class="svc-card h-100 shadow-sm p-2 rounded bg-white">
      <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSOEyqVS2uvAp3IbIJne8QmDwXurDtldBMy9w&s"
           class="svc-img mb-2 w-100" alt="AFA Registration"
           style="border-radius: 8px; object-fit: cover; max-height: 160px;">

      <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
        <div class="fw-semibold text-truncate">AFA Registration</div>
        <div class="d-flex svc-flags">
          <span class="svc-flag flag-open">Open</span>
          <span class="svc-flag flag-available">Available</span>
        </div>
      </div>

      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="text-muted small">
          AFA Registration @ <strong>GHS 2.00</strong>
        </div>
        <div class="d-flex gap-2">
          <!-- Use ONE of the hrefs below -->
          <!-- If using Jinja: -->
          <a href="{{ url_for('afa.afa_list_page') }}"
             class="btn btn-sm btn-outline-secondary">
            View Registrations
          </a>
          <!-- Or plain path: -->
          <!-- <a href="/customer/afa" class="btn btn-sm btn-outline-secondary">View Registrations</a> -->

          <button type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#afaModal">
            Buy
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="afaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="afa-form" autocomplete="off" novalidate>
        <div class="modal-header">
          <h5 class="modal-title">AFA Registration (GHS 2.00)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="afa-name" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Phone number <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="afa-phone" inputmode="numeric" maxlength="10" placeholder="e.g. 0530393625" required>
            <div class="form-text">Format: 0xxxxxxxxx (10 digits, starts with 0)</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Date of Birth (optional)</label>
            <input type="date" class="form-control" id="afa-dob">
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Location (optional)</label>
            <input type="text" class="form-control" id="afa-location">
          </div>

          <div class="mb-2">
            <label class="form-label fw-semibold">Ghana Card Number (optional) GHA-XXXXXXXXX-X</label>
            <input type="text" class="form-control" id="afa-ghana-card" >
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="afa-submit">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>


    <hr class="my-5">

    <!-- Work area -->
    <div id="work-area" class="d-none">
      <div class="card border-0 shadow-sm rounded-4 p-4 mb-5 bg-white">

        <!-- Header -->
       <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
  <h4 class="mb-2 mb-md-0 fw-bold">
    <i class="bi bi-gear-fill text-primary me-2"></i>
    Service: <span id="chosen-service-name" class="text-primary"></span>
  </h4>
</div>


        <!-- Bulk Input Trigger -->
        <div class="mb-4">
          <input id="bulk-trigger" type="text" class="form-control bulk-trigger"
                 placeholder="📋 Paste bulk orders (e.g. 0241234567 1)">
          <small class="text-muted">Click to expand and paste orders in bulk.</small>
        </div>

        <!-- Bulk Paste Area -->
        <div id="bulk-card" class="card mb-4 d-none">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row gap-4">
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <label class="form-label fw-semibold mb-0">Bulk Paste (one per line)</label>
                  <button type="button" id="hide-bulk-btn" class="btn btn-sm btn-outline-secondary">Hide</button>
                </div>
                <textarea id="bulk-paste" class="form-control" rows="5"
                          placeholder="Example:
0241234567 1
0559876543 5"></textarea>
                <small class="text-muted">
                  Format: <code>PHONE VALUE</code> (e.g. <code>0284039645 5</code> → 5 GB). We’ll match VALUE to an offer for the selected service.
                </small>
              </div>
              <div class="align-self-end">
                <button id="apply-bulk-btn" class="btn btn-outline-primary mt-3">
                  <i class="bi bi-check2-square me-1"></i> Apply to Rows
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Entry Rows -->
        <div id="form-rows-wrapper" class="mb-4">
          <div class="row g-3 align-items-end mb-3" id="rows-body">
            <!-- JS appends rows -->
          </div>
        </div>

        <!-- Add to Cart -->
        <div class="text-end">
          <button id="add-all-to-cart" class="btn btn-success btn-lg px-4">
            <i class="bi bi-cart-plus me-1"></i> Add All to Cart
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Recent Orders -->
  <div class="container mb-5">
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-box-seam-fill me-2 fs-4 text-primary"></i>
      <h4 class="mb-0">Recent Orders</h4>
    </div>

    {% if recent_orders %}
      <div class="card shadow-sm">
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Order ID</th>
                <th>Service</th>
                <th>Phone Number(s)</th>
                <th>Total (GHS)</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for order in recent_orders %}
                <tr>
                  <td><span class="badge bg-primary">{{ order.order_id or "N/A" }}</span></td>
                  <td>
                    {% if order["items"] and order["items"][0]["serviceName"] %}
                      {{ order["items"][0]["serviceName"] }}
                    {% else %}
                      <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>{{ order["items"]|length }} phone number{{ 's' if order["items"]|length > 1 }}</td>
                  <td>GHS {{ '%.2f'|format(order.total_amount or 0) }}</td>
                  <td>
                    {% if order.status == "pending" %}
                      <span class="badge bg-warning text-dark">Pending</span>
                    {% elif order.status == "completed" %}
                      <span class="badge bg-success">Completed</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ order.status|capitalize }}</span>
                    {% endif %}
                  </td>
                  <td>{{ order.created_at.strftime('%d %b %Y, %I:%M %p') if order.created_at }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="text-muted">No recent orders yet.</div>
    {% endif %}
  </div>

  {% include 'customer_footer.html' %}
  </main>

  <!-- Floating Cart -->
  <div class="floating-cart">
    <button type="button" class="btn-cart" data-bs-toggle="modal" data-bs-target="#cartModal">
      🛒 Cart <span class="badge bg-danger" id="cart-count">0</span>
    </button>
  </div>

  <!-- Cart / Checkout Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Your Cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div id="cart-empty" class="text-muted">Your cart is empty.</div>

          <div id="cart-list-wrapper" class="d-none">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Service</th>
                    <th>Phone</th>
                    <th>Offer (Value)</th>
                    <th>Total (GHS)</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="cart-list"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <button id="clear-cart-btn" class="btn btn-outline-danger btn-sm">Clear Cart</button>
              <div class="fs-5 fw-semibold">Total: GHS <span id="cart-total">0.00</span></div>
            </div>

            <div class="text-end mb-3">
              <button id="checkout-btn" class="btn btn-primary">Proceed to Checkout</button>
            </div>

            <!-- Checkout Section (hidden until proceed) -->
            <div id="checkout-section" class="border-top pt-3 d-none">
              <h5 class="mb-3">Checkout</h5>
              <div class="mb-3">
                <label class="form-label fw-semibold">Payment Method</label>
                <select class="form-select" id="payment-method" aria-label="Payment method">
                  <option value="from_account" selected>From Account</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Total Payable</label>
                <div class="fs-5 fw-bold text-success">GHS <span id="checkout-total">0.00</span></div>
              </div>
              <div class="text-end">
                <button id="confirm-payment-btn" class="btn btn-success">
                  <span class="btn-label">Confirm Payment</span>
                  <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                </button>
              </div>
            </div>
          </div>
        </div> <!-- /modal-body -->
      </div> <!-- /modal-content -->
    </div> <!-- /modal-dialog -->
  </div> <!-- /modal -->

  <!-- Full-page loader -->
  <div id="page-loader" class="loader-overlay d-none" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div>
        <div class="loader-text">Processing payment...</div>
        <div class="loader-sub">Please don’t close this window</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
  var chosenService = null;
  var rowsBody = document.getElementById("rows-body");
  var workArea = document.getElementById("work-area");
  var chosenNameEl = document.getElementById("chosen-service-name");
  // REMOVED: profitPctEl and all profit UI

  // ---- Cart + persistence ----
  var CART_KEY = "nndata_cart_v1";
  var cart = [];

  function money(n) { return Number(n || 0).toFixed(2); }

  function loadCart() {
    try {
      var saved = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
      if (Object.prototype.toString.call(saved) === "[object Array]") cart = saved;
    } catch (e) {}
  }
  function saveCart() {
    try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch (e) {}
  }

  function formatVolumeLabel(value) {
    if (value && typeof value === "string") return value;
    if (value && typeof value === "object") {
      var vol = Number(value.volume || 0);
      return vol >= 1000 ? (String(vol / 1000).replace(/\.0+$/, "") + "GB") : (vol + "MB");
    }
    return "-";
  }

  // No "Default Profit" in tooltips anymore
  function renderOfferOptions(offers) {
    offers = offers || [];
    var html = '<option value="">-- Choose Offer --</option>';
    for (var i = 0; i < offers.length; i++) {
      var o = offers[i];
      var label = o.value_text ? o.value_text : formatVolumeLabel(o.value);
      var disabled = (o.amount == null || o.total == null) ? ' disabled' : '';
      var totalVal = (o.total != null ? o.total : '');
      var baseVal = (o.amount != null ? o.amount : '');
      var idxAttr = ' data-idx="' + i + '"';
      html += '<option' + disabled +
              ' value="' + totalVal + '"' +
              ' data-base="' + baseVal + '"' +
              ' data-total="' + totalVal + '"' +
              idxAttr + '>' +
              'GHS ' + money(totalVal || 0) + ' - ' + label +
              '</option>';
    }
    return html;
  }

  // ---------- PHONE FORMAT ----------
  var PHONE_RE = /^0\d{9}$/;

  function attachPhoneMask(container) {
    var inputs = container.querySelectorAll(".phone-input");
    for (var i = 0; i < inputs.length; i++) {
      (function(inp){
        inp.setAttribute("inputmode", "numeric");
        inp.setAttribute("maxlength", "10");
        inp.placeholder = "e.g. 0530393625";
        function handle() {
          var digits = (inp.value || "").replace(/\D+/g, "");
          if (digits.length > 10) digits = digits.slice(0, 10);
          inp.value = digits;
          if (!PHONE_RE.test(digits)) inp.classList.add("is-invalid");
          else inp.classList.remove("is-invalid");
        }
        inp.addEventListener("input", handle);
        handle();
      })(inputs[i]);
    }
  }

  function addRow(phone, selectedIdx) {
    phone = phone || "";

    var col = document.createElement("div");
    col.className = "col-12";

    var card = document.createElement("div");
    card.className = "card border rounded-3 p-3 shadow-sm mb-2";
    col.appendChild(card);

    var row = document.createElement("div");
    row.className = "row g-3 align-items-center";
    card.appendChild(row);

    // phone
    var c1 = document.createElement("div");
    c1.className = "col-12 col-md-5";
    var phoneInput = document.createElement("input");
    phoneInput.type = "text";
    phoneInput.className = "form-control phone-input";
    phoneInput.placeholder = "e.g. 0530393625";
    phoneInput.value = (phone.replace(/\D+/g,"").slice(0,10));
    c1.appendChild(phoneInput);
    row.appendChild(c1);

    // offer select
    var c2 = document.createElement("div");
    c2.className = "col-12 col-md-5";
    var sel = document.createElement("select");
    sel.className = "form-select offer-select";
    sel.innerHTML = chosenService ? renderOfferOptions(chosenService.offers) : '<option>-- Choose Offer --</option>';
    c2.appendChild(sel);
    row.appendChild(c2);

    // right side
    var c3 = document.createElement("div");
    c3.className = "col-12 col-md-2 d-flex justify-content-between align-items-center";
    var amt = document.createElement("div");
    amt.className = "amount-cell fw-semibold text-primary";
    amt.textContent = "-";
    var rm = document.createElement("button");
    rm.className = "btn btn-sm btn-outline-danger remove-row-btn";
    rm.innerHTML = '<i class="bi bi-x-lg"></i>';
    c3.appendChild(amt);
    c3.appendChild(rm);
    row.appendChild(c3);

    rowsBody.appendChild(col);

    attachPhoneMask(col);

    sel.addEventListener("change", function(){ amt.textContent = ""; });

    if (typeof selectedIdx === "number") {
      var opt = sel.querySelector('option[data-idx="' + selectedIdx + '"]');
      if (opt) {
        sel.value = opt.value;
        var evt = document.createEvent("HTMLEvents");
        evt.initEvent("change", true, false);
        sel.dispatchEvent(evt);
      }
    }
  }

  function clearRows() { rowsBody.innerHTML = ""; }

  function updateCartUI() {
    var list = document.getElementById("cart-list");
    var count = document.getElementById("cart-count");
    var empty = document.getElementById("cart-empty");
    var wrap = document.getElementById("cart-list-wrapper");
    var totalEl = document.getElementById("cart-total");

    list.innerHTML = "";
    var total = 0;
    for (var i = 0; i < cart.length; i++) {
      var item = cart[i];
      total += Number(item.amount || 0);
      var tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" + item.serviceName + "</td>" +
        "<td>" + item.phone + "</td>" +
        "<td>" + item.value + "</td>" +
        "<td>GHS " + money(item.amount) + "</td>" +
        '<td><button class="btn btn-sm btn-outline-danger" data-remove="' + i + '">Remove</button></td>';
      list.appendChild(tr);
    }

    count.textContent = String(cart.length);
    totalEl.textContent = money(total);
    empty.classList.toggle("d-none", cart.length !== 0);
    wrap.classList.toggle("d-none", cart.length === 0);

    saveCart();
  }

  function addAllRowsToCart() {
    var rowCards = rowsBody.querySelectorAll(".card");
    if (!rowCards.length) { alert("Add at least one row."); return; }

    var bad = [];
    for (var i = 0; i < rowCards.length; i++) {
      var row = rowCards[i];
      var phoneRawInp = row.querySelector(".phone-input");
      var sel = row.querySelector(".offer-select");
      var phoneRaw = phoneRawInp ? (phoneRawInp.value || "") : "";
      var phone = phoneRaw.replace(/\D+/g, "");
      var opt = null;
      if (sel && typeof sel.selectedIndex === "number" && sel.selectedIndex >= 0) {
        opt = sel.options[sel.selectedIndex];
      }

      if (!PHONE_RE.test(phone) || !opt || !sel.value) { bad.push(i + 1); continue; }

      var valueText = (opt.textContent || "").replace(/^.*-\s*/, "") || "-";
      var total = Number(opt.getAttribute("data-total") || sel.value || 0);
      var base  = Number(opt.getAttribute("data-base") || 0);

      var idxAttr = opt.getAttribute("data-idx");
      var offerIdx = typeof idxAttr === "string" ? Number(idxAttr) : null;
      var offer = (chosenService && chosenService.offers && typeof offerIdx === "number") ? chosenService.offers[offerIdx] : null;
      var valueObj = (offer && offer.value) ? offer.value : null;

      cart.push({
        serviceId: chosenService._id_str,
        serviceName: chosenService.display_name || chosenService.name,
        phone: phone,
        value: valueText,
        value_obj: valueObj,
        base_amount: base,
        amount: total,
        total: total
      });
    }

    if (bad.length) {
      alert("Some rows were incomplete or invalid (phone must be 0xxxxxxxxx): " + bad.join(", "));
      return;
    }
    updateCartUI();
    clearRows();
    addRow();
  }

  function parseGBFromValue(value) {
    if (value && typeof value === "object" && value.volume != null) {
      var vol = Number(value.volume);
      return vol / 1000;
    }
    var m = String(value || "").match(/(\d+(?:\.\d+)?)/);
    return m ? Number(m[1]) : null;
  }

  function findOfferIndexByGB(offers, gbNumber) {
    offers = offers || [];
    var candidates = [];
    for (var i = 0; i < offers.length; i++) {
      var gb = parseGBFromValue(offers[i].value);
      if (gb !== null && Number(gb) === Number(gbNumber)) {
        candidates.push({ idx: i, price: (offers[i].total != null ? offers[i].total : (offers[i].amount || 0)) });
      }
    }
    if (!candidates.length) return null;
    candidates.sort(function(a,b){ return a.price - b.price; });
    return candidates[0].idx;
  }

  // Service selection (uses display_name if provided)
  function wireSelectButtons() {
    var btns = document.querySelectorAll(".select-service-btn");
    for (var i = 0; i < btns.length; i++) {
      (function(btn){
        btn.addEventListener("click", function () {
          if (btn.hasAttribute("disabled")) return;
          var svcDataStr = btn.getAttribute("data-service") || "{}";
          try { chosenService = JSON.parse(svcDataStr); } catch(e){ chosenService = null; }
          if (!chosenService) return;

          chosenNameEl.textContent = (chosenService.display_name || chosenService.name || "");

          var cardCol = btn.closest(".col-12");
          if (cardCol && workArea) {
            cardCol.parentNode.insertBefore(workArea, cardCol.nextSibling);
          }

          workArea.classList.remove("d-none");
          clearRows();
          addRow();

          var bulkCard = document.getElementById("bulk-card");
          if (bulkCard) bulkCard.classList.add("d-none");
          var bulkTrigger = document.getElementById("bulk-trigger");
          if (bulkTrigger) bulkTrigger.value = "";

          var firstPhone = rowsBody.querySelector(".phone-input");
          if (firstPhone && typeof firstPhone.focus === "function") {
            setTimeout(function(){ firstPhone.focus(); }, 50);
          }
          if (typeof workArea.scrollIntoView === "function") {
            workArea.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      })(btns[i]);
    }
  }

  // Row actions
  rowsBody.addEventListener("click", function(e){
    var rm = e.target.closest ? e.target.closest(".remove-row-btn") : null;
    if (rm) {
      var col = rm.closest(".col-12");
      if (col && col.parentNode) col.parentNode.removeChild(col);
    }
  });

  // Bulk paste
  (function wireBulk(){
    var bulkTrigger = document.getElementById("bulk-trigger");
    var bulkCard = document.getElementById("bulk-card");
    var hideBulkBtn = document.getElementById("hide-bulk-btn");
    function showBulk(){ if (bulkCard) bulkCard.classList.remove("d-none"); var t = document.getElementById("bulk-paste"); if (t) setTimeout(function(){ t.focus(); }, 0); }
    function hideBulk(){ if (bulkCard) bulkCard.classList.add("d-none"); }
    if (bulkTrigger) {
      bulkTrigger.addEventListener("focus", showBulk);
      bulkTrigger.addEventListener("click", showBulk);
      bulkTrigger.addEventListener("keydown", function(e){ if (e.key === "Enter") { e.preventDefault(); addRow(); }});
    }
    if (hideBulkBtn) hideBulkBtn.addEventListener("click", hideBulk);

    var applyBtn = document.getElementById("apply-bulk-btn");
    if (applyBtn) applyBtn.addEventListener("click", function(){
      if (!chosenService) { alert("Choose a service first."); return; }
      var ta = document.getElementById("bulk-paste");
      var text = ta ? ta.value : "";
      var lines = text.split(/\r?\n/).map(function(l){ return l.trim(); }).filter(function(x){ return !!x; });
      if (!lines.length) { alert("Nothing to paste."); return; }

      var need = lines.length - rowsBody.querySelectorAll(".card").length;
      while (need-- > 0) addRow();

      var rows = rowsBody.querySelectorAll(".card");
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var parts = line.split(/[\s,;\t]+/).filter(function(x){ return !!x; });
        var phoneDigits = (parts[0] || "").replace(/\D+/g, "").slice(0,10);
        var gbNum = parts[1] ? Number(parts[1]) : null;

        var row = rows[i];
        if (!row) continue;
        var phoneInput = row.querySelector(".phone-input");
        var sel = row.querySelector(".offer-select");

        if (phoneInput) {
          phoneInput.value = phoneDigits;
          var ev = document.createEvent("HTMLEvents");
          ev.initEvent("input", true, false);
          phoneInput.dispatchEvent(ev);
        }

        if (gbNum !== null && sel) {
          var idx = findOfferIndexByGB(chosenService.offers, gbNum);
          if (idx !== null) {
            var opt = sel.querySelector('option[data-idx="' + idx + '"]');
            if (opt) sel.value = opt.value;
          }
          var ev2 = document.createEvent("HTMLEvents");
          ev2.initEvent("change", true, false);
          sel.dispatchEvent(ev2);
        }
      }
    });
  })();

  // Add all rows to cart
  var addAllBtn = document.getElementById("add-all-to-cart");
  if (addAllBtn) addAllBtn.addEventListener("click", addAllRowsToCart);

  // Cart interactions
  var cartModal = document.getElementById("cartModal");
  if (cartModal) cartModal.addEventListener("click", function(e){
    var btn = e.target.closest ? e.target.closest("button[data-remove]") : null;
    if (!btn) return;
    var idx = Number(btn.getAttribute("data-remove"));
    if (!isNaN(idx)) { cart.splice(idx, 1); updateCartUI(); }
  });

  // Clear cart
  var clearBtn = document.getElementById("clear-cart-btn");
  if (clearBtn) clearBtn.addEventListener("click", function(){
    if (!cart.length) return;
    if (confirm("Clear all items in the cart?")) { cart = []; updateCartUI(); }
  });

  // Proceed to checkout
  var checkoutBtn = document.getElementById("checkout-btn");
  if (checkoutBtn) checkoutBtn.addEventListener("click", function(){
    if (!cart.length) { alert("Your cart is empty."); return; }
    var section = document.getElementById("checkout-section");
    var total = document.getElementById("cart-total").textContent;
    document.getElementById("checkout-total").textContent = total;
    if (section) section.classList.remove("d-none");
    setTimeout(function(){ if (section && section.scrollIntoView) section.scrollIntoView({ behavior: "smooth" }); }, 100);
  });

  // --- Loading helpers ---
  var pageLoader = document.getElementById("page-loader");
  var confirmBtn = document.getElementById("confirm-payment-btn");
  function setProcessing(on) {
    if (pageLoader) pageLoader.classList.toggle("d-none", !on);
    if (confirmBtn) {
      var spinner = confirmBtn.querySelector(".spinner-border");
      var label = confirmBtn.querySelector(".btn-label");
      confirmBtn.disabled = !!on;
      if (spinner) spinner.classList.toggle("d-none", !on);
      if (label) label.textContent = on ? "Processing..." : "Confirm Payment";
    }
    var dis = document.querySelectorAll("#checkout-section input, #checkout-section select, #checkout-section button");
    for (var i = 0; i < dis.length; i++) { if (dis[i] !== confirmBtn) dis[i].disabled = !!on; }
  }

  // Confirm payment (with loader)
  if (confirmBtn) confirmBtn.addEventListener("click", function(){
    var methodSel = document.getElementById("payment-method");
    var method = methodSel ? methodSel.value : "from_account";
    var total = document.getElementById("checkout-total").textContent;

    Swal.fire({
      title: "Confirm payment?",
      html: "You're about to pay <b>GHS " + total + "</b> from your wallet.",
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, Pay",
      cancelButtonText: "Cancel",
      confirmButtonColor: "#0ea5e9"
    }).then(function(res){
      if (!res.isConfirmed) return;

      setProcessing(true);
      var controller = new AbortController();
      var aborted = false;
      var timer = setTimeout(function(){ aborted = true; if (controller && controller.abort) controller.abort(); }, 60000);

      fetch("/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cart: cart, method: method }),
        signal: controller.signal
      }).then(function(response){
        clearTimeout(timer);
        return response.json().then(function(json){ return { ok: response.ok, json: json }; })
          .catch(function(){ return { ok: response.ok, json: {} }; });
      }).then(function(result){
        if (result.ok && result.json && result.json.success) {
          Swal.fire({ title: "Success!", text: result.json.message || "Payment completed.", icon: "success" });
          cart = [];
          localStorage.removeItem(CART_KEY);
          updateCartUI();
          var section = document.getElementById("checkout-section");
          if (section) section.classList.add("d-none");
          var modal = bootstrap.Modal.getInstance(document.getElementById("cartModal"));
          if (modal && modal.hide) modal.hide();
        } else {
          Swal.fire({ title: "Failed", text: (result.json && result.json.message) || "Payment failed. Please try again.", icon: "error" });
        }
      }).catch(function(err){
        var msg = aborted ? "The request took too long and was cancelled. Please check your network and try again." : "Something went wrong while processing payment.";
        Swal.fire({ title: "Error", text: msg, icon: "error" });
      }).finally(function(){ setProcessing(false); });
    });
  });

  // ---- Init ----
  loadCart();
  updateCartUI();
  wireSelectButtons();

  var addRowBtn = document.getElementById("add-row-btn");
  if (addRowBtn) addRowBtn.addEventListener("click", function(){ addRow(); });
</script>

  <script>
(function(){
  // Reuse your PHONE_RE if it already exists; else define it.
  if (typeof PHONE_RE === "undefined") {
    window.PHONE_RE = /^0\d{9}$/;
  }

  // simple mask for the AFA phone input (digits only, max 10)
  var afaPhone = document.getElementById("afa-phone");
  if (afaPhone) {
    afaPhone.addEventListener("input", function(){
      var digits = (afaPhone.value || "").replace(/\D+/g, "");
      if (digits.length > 10) digits = digits.slice(0, 10);
      afaPhone.value = digits;
      if (!PHONE_RE.test(digits)) {
        afaPhone.classList.add("is-invalid");
      } else {
        afaPhone.classList.remove("is-invalid");
      }
    });
  }

  var form = document.getElementById("afa-form");
  if (!form) return;

  form.addEventListener("submit", function(e){
    e.preventDefault();

    var name = (document.getElementById("afa-name").value || "").trim();
    var phone = (document.getElementById("afa-phone").value || "").trim();
    var dob = (document.getElementById("afa-dob").value || "").trim();
    var location = (document.getElementById("afa-location").value || "").trim();
    var ghanaCard = (document.getElementById("afa-ghana-card").value || "").trim();

    var phoneDigits = phone.replace(/\D+/g, "");
    if (!name) {
      if (window.Swal) Swal.fire("Missing", "Name is required", "warning"); else alert("Name is required");
      return;
    }
    if (!PHONE_RE.test(phoneDigits)) {
      if (window.Swal) Swal.fire("Invalid phone", "Phone must be 0xxxxxxxxx (10 digits, starts with 0).", "warning");
      else alert("Phone must be 0xxxxxxxxx (10 digits, starts with 0).");
      return;
    }

    var payload = {
      name: name,
      phone: phoneDigits,
      dob: dob || null,
      location: location || null,
      ghana_card: ghanaCard || null
    };

    var submitBtn = document.getElementById("afa-submit");
    if (submitBtn) submitBtn.disabled = true;

    fetch("/api/afa/register", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(function(r){
      return r.json().then(function(j){ return { ok: r.ok, json: j }; })
               .catch(function(){ return { ok: r.ok, json: {} }; });
    })
    .then(function(res){
      if (res.ok && res.json && res.json.success) {
        if (window.Swal) Swal.fire("Submitted", "AFA registration submitted. Status: pending.", "success");
        else alert("AFA registration submitted. Status: pending.");

        // reset form
        form.reset();
        if (afaPhone) afaPhone.classList.remove("is-invalid");

        // close modal
        var modalEl = document.getElementById("afaModal");
        if (modalEl && window.bootstrap) {
          var inst = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          if (inst && inst.hide) inst.hide();
        }
      } else {
        var msg = (res.json && (res.json.error || res.json.message)) || "Could not submit registration.";
        if (window.Swal) Swal.fire("Error", msg, "error"); else alert(msg);
      }
    })
    .catch(function(){
      if (window.Swal) Swal.fire("Error", "Network error. Please try again.", "error");
      else alert("Network error. Please try again.");
    })
    .finally(function(){
      if (submitBtn) submitBtn.disabled = false;
    });
  });
})();
</script>

</body>
</html>


