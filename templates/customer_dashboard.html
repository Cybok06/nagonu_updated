<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root { --sea-blue:#0ea5e9; --soft:#f6f8fb; --ink:#0b1320; }
    body { background: var(--soft); }

    .scrolling-wrapper { -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: var(--sea-blue) #f1f1f1; }
    .scrolling-wrapper::-webkit-scrollbar { height: 8px; }
    .scrolling-wrapper::-webkit-scrollbar-track { background: #f1f1f1; }
    .scrolling-wrapper::-webkit-scrollbar-thumb { background-color: var(--sea-blue); border-radius: 10px; }

    .svc-card { border:1px solid #e9ecef; border-radius:14px; padding:1rem; height:100%; background:#fff; }
    .svc-img  { width:100%; height:140px; object-fit:cover; border-radius:10px; background:#f3f6f9; }

    .floating-cart { position:fixed; right:16px; bottom:16px; z-index:1055; }
    .btn-cart { position:relative; border-radius:999px; padding:.75rem 1rem; font-weight:600;
                background:var(--sea-blue); color:#fff; border:none;
                box-shadow:0 8px 24px rgba(14,165,233,.35); }
    .btn-cart .badge { position:absolute; top:-6px; right:-6px; }

    .bulk-trigger { cursor:text; }
    .amount-cell { min-width: 110px; text-align:right; }

    @media (max-width:576px){
      .svc-img{height:120px}
      .btn-cart{padding:.6rem .9rem}
      .input-group>.form-select{min-width: 150px;}
    }

    /* Loader overlay */
    .loader-overlay {
      position: fixed; inset: 0; background: rgba(11,19,32,.35);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000; backdrop-filter: blur(1.5px);
      transition: opacity .2s ease;
    }
    .loader-card {
      background: #fff; border-radius: 14px; padding: 1.25rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      display: flex; align-items: center; gap: .75rem; min-width: 260px;
    }
    .loader-text { font-weight: 600; color: var(--ink); }
    .loader-sub { font-size: .9rem; color: #6c757d; margin-top: -6px; }

    .modal-content { border: 0; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .table > :not(caption) > * > * { vertical-align: middle; }
  </style>
 <style>
 /* Section background (ocean) */
.wallet-hero {
  position: relative;
}
.wallet-hero-bg {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  filter: saturate(1.05) contrast(1.02);
  z-index: 0;
}

/* Subtle overlay for legibility */
.wallet-hero::before {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(
    to bottom right,
    rgba(6, 24, 38, 0.55),
    rgba(6, 24, 38, 0.25) 40%,
    rgba(6, 24, 38, 0.15)
  );
  z-index: 1;
}

/* Card styling */
.wallet-hero-card {
  position: relative;
  z-index: 2;
  border-radius: 16px;
  padding: 24px;
  background: rgba(5, 48, 71, 0.35);
  backdrop-filter: blur(4px) saturate(1.1);
  -webkit-backdrop-filter: blur(4px) saturate(1.1);
  overflow: hidden;
}

/* Circular logo overlay */
.wallet-hero-card::after {
  content: "";
  position: absolute;
  top: 50%;
  right: 24px;
  transform: translateY(-50%);
  width: clamp(120px, 26vw, 220px);
  height: clamp(120px, 26vw, 220px);
  border-radius: 50%;
  pointer-events: none;

  background:
    radial-gradient(circle at center, rgba(6,24,38,0.18), rgba(6,24,38,0) 55%),
    url("https://res.cloudinary.com/dcmewvlyx/image/upload/v1755183040/logo_qmykvn.jpg") no-repeat center/cover;

  opacity: 0.42;
  filter: drop-shadow(0 1px 0 rgba(0,0,0,0.18));
}

/* Typography & pill styles */
.wallet-hero-card .eyebrow { letter-spacing: .02em; }
.wallet-hero-card .title { font-weight: 700; }
.wallet-hero-card .balance-amount {
  font-size: clamp(1.35rem, 2.6vw, 2rem);
  font-weight: 800;
}
.wallet-hero-card .pill {
  background: rgba(255,255,255,0.15);
  color: #fff;
  padding: 8px 12px;
  border-radius: 999px;
  backdrop-filter: blur(2px);
}

/* Text shadow for readability */
.wallet-hero-card .title,
.wallet-hero-card .balance-label,
.wallet-hero-card .balance-amount,
.wallet-hero-card .eyebrow {
  text-shadow: 0 1px 0 rgba(0,0,0,0.35);
}

/* Mobile adjustments */
@media (max-width: 575.98px) {
  .wallet-hero-card { padding: 20px 18px; }
  .wallet-hero-card::after {
    right: 16px;
    width: clamp(110px, 40vw, 180px);
    height: clamp(110px, 40vw, 180px);
  }
}

</style>
</head>
<body>
  {% include 'customer_sidebar.html' %}

  <main class="customer-content">

  <section class="wallet-hero my-4">
  <!-- Background image -->
  <div class="wallet-hero-bg"
       style="background-image:url('https://e1.pxfuel.com/desktop-wallpaper/586/807/desktop-wallpaper-1920x1080-beautiful-ocean-pics-data-id-115186-ocean-sea.jpg');">
  </div>

  <div class="container position-relative">
    <div class="wallet-hero-card shadow-lg">
      <div class="row align-items-center g-3">
        <div class="col-12 col-md">
          <div class="eyebrow text-white-50">Welcome back</div>
          <h2 class="title mb-2 text-white">{{ customer_username or username }}</h2>

          <div class="balance-label text-white-50">Wallet Balance</div>
          <div class="balance-amount text-white">
            GHS {{ '%.2f'|format(balance) }}
          </div>
        </div>

        <div class="col-12 col-md-auto">

        </div>
      </div>
    </div>
  </div>
</section>


  

    <!-- Make an Order -->
    <div class="container py-4" id="services">
      <h2 class="text-center mb-4">Make an Order</h2>

      <!-- Services -->
      <div class="mb-4">
  <label class="form-label fw-semibold">Service</label>

  <div class="row g-3">
    {% for svc in services %}
    <div class="col-12 col-sm-6">
      <div class="svc-card h-100 shadow-sm p-2 rounded bg-white">
        {% if svc.image_url %}
          <img src="{{ svc.image_url }}" class="svc-img mb-2 w-100" alt="{{ svc.name }}" style="border-radius: 8px; object-fit: cover; max-height: 160px;">
        {% endif %}
        <div class="d-flex justify-content-between align-items-center gap-2">
          <div class="fw-semibold text-truncate">{{ svc.name }}</div>
          <button
            class="btn btn-sm btn-outline-primary select-service-btn"
            data-service='{{ {
                "_id_str": svc._id_str,
                "name": svc.name,
                "effective_profit_percent": svc.effective_profit_percent | default(0),
                "offers": svc.offers or []
              } | tojson }}'>
            Buy
          </button>
        </div>
      </div>
    </div>
    {% endfor %}

    {% if services|length == 0 %}
      <div class="col-12 text-muted">No services available yet.</div>
    {% endif %}
  </div>
</div>

<hr class="my-5">

      <!-- Work area -->
      <div id="work-area" class="d-none">
        <div class="card border-0 shadow-sm rounded-4 p-4 mb-5 bg-white">

          <!-- Header -->
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h4 class="mb-2 mb-md-0 fw-bold">
              <i class="bi bi-gear-fill text-primary me-2"></i>
              Service: <span id="chosen-service-name" class="text-primary"></span>
            </h4>
            <div class="ms-auto">
              <span class="badge bg-light text-dark border" id="profit-hint">Profit: <span id="profit-pct">0</span>%</span>
            </div>
          </div>

          <!-- Bulk Input Trigger -->
          <div class="mb-4">
            <input id="bulk-trigger" type="text" class="form-control bulk-trigger"
                   placeholder="📋 Paste bulk orders (e.g. 0241234567 1)">
            <small class="text-muted">Click to expand and paste orders in bulk.</small>
          </div>

          <!-- Bulk Paste Area -->
          <div id="bulk-card" class="card mb-4 d-none">
            <div class="card-body">
              <div class="d-flex flex-column flex-md-row gap-4">
                <div class="flex-grow-1">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label fw-semibold mb-0">Bulk Paste (one per line)</label>
                    <button type="button" id="hide-bulk-btn" class="btn btn-sm btn-outline-secondary">Hide</button>
                  </div>
                  <textarea id="bulk-paste" class="form-control" rows="5"
                            placeholder="Example:
0241234567 1
0559876543 5"></textarea>
                  <small class="text-muted">
                    Format: <code>PHONE VALUE</code> (e.g. <code>0284039645 5</code> → 5 GB). We’ll match VALUE to an offer for the selected service.
                  </small>
                </div>
                <div class="align-self-end">
                  <button id="apply-bulk-btn" class="btn btn-outline-primary mt-3">
                    <i class="bi bi-check2-square me-1"></i> Apply to Rows
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Entry Rows -->
          <div id="form-rows-wrapper" class="mb-4">
            <div class="row g-3 align-items-end mb-3" id="rows-body">
              <!-- JS appends rows -->
            </div>
          </div>

          <!-- Add to Cart -->
          <div class="text-end">
            <button id="add-all-to-cart" class="btn btn-success btn-lg px-4">
              <i class="bi bi-cart-plus me-1"></i> Add All to Cart
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="container mb-5">
      <div class="d-flex align-items-center mb-3">
        <i class="bi bi-box-seam-fill me-2 fs-4 text-primary"></i>
        <h4 class="mb-0">Recent Orders</h4>
      </div>

      {% if recent_orders %}
        <div class="card shadow-sm">
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Order ID</th>
                  <th>Service</th>
                  <th>Phone Number(s)</th>
                  <th>Total (GHS)</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                {% for order in recent_orders %}
                  <tr>
                    <td><span class="badge bg-primary">{{ order.order_id or "N/A" }}</span></td>
                    <td>
                      {% if order["items"] and order["items"][0]["serviceName"] %}
                        {{ order["items"][0]["serviceName"] }}
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>{{ order["items"]|length }} phone number{{ 's' if order["items"]|length > 1 }}</td>
                    <td>GHS {{ '%.2f'|format(order.total_amount or 0) }}</td>
                    <td>
                      {% if order.status == "pending" %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% elif order.status == "completed" %}
                        <span class="badge bg-success">Completed</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ order.status|capitalize }}</span>
                      {% endif %}
                    </td>
                    <td>{{ order.created_at.strftime('%d %b %Y, %I:%M %p') if order.created_at }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="text-muted">No recent orders yet.</div>
      {% endif %}
    </div>

    {% include 'customer_footer.html' %}
  </main>

  <!-- Floating Cart -->
  <div class="floating-cart">
    <button type="button" class="btn-cart" data-bs-toggle="modal" data-bs-target="#cartModal">
      🛒 Cart <span class="badge bg-danger" id="cart-count">0</span>
    </button>
  </div>

  <!-- Cart / Checkout Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Your Cart</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div id="cart-empty" class="text-muted">Your cart is empty.</div>

          <div id="cart-list-wrapper" class="d-none">
            <div class="table-responsive">
              <table class="table align-middle">
                <thead>
                  <tr>
                    <th>Service</th>
                    <th>Phone</th>
                    <th>Offer (Value)</th>
                    <th>Total (GHS)</th>
                    <th style="width:80px;"></th>
                  </tr>
                </thead>
                <tbody id="cart-list"></tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-3">
              <button id="clear-cart-btn" class="btn btn-outline-danger btn-sm">Clear Cart</button>
              <div class="fs-5 fw-semibold">Total: GHS <span id="cart-total">0.00</span></div>
            </div>

            <div class="text-end mb-3">
              <button id="checkout-btn" class="btn btn-primary">Proceed to Checkout</button>
            </div>

            <!-- Checkout Section (hidden until proceed) -->
            <div id="checkout-section" class="border-top pt-3 d-none">
              <h5 class="mb-3">💳 Checkout</h5>
              <div class="mb-3">
                <label class="form-label fw-semibold">Payment Method</label>
                <select class="form-select" id="payment-method" aria-label="Payment method">
                  <option value="from_account" selected>From Account</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label fw-semibold">Total Payable</label>
                <div class="fs-5 fw-bold text-success">GHS <span id="checkout-total">0.00</span></div>
              </div>
              <div class="text-end">
                <button id="confirm-payment-btn" class="btn btn-success">
                  <span class="btn-label">✅ Confirm Payment</span>
                  <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
                </button>
              </div>
            </div>
          </div>
        </div> <!-- /modal-body -->
      </div> <!-- /modal-content -->
    </div> <!-- /modal-dialog -->
  </div> <!-- /modal -->

  <!-- Full-page loader -->
  <div id="page-loader" class="loader-overlay d-none" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <div>
        <div class="loader-text">Processing payment…</div>
        <div class="loader-sub">Please don’t close this window</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

 <script>
  let chosenService = null;
  const rowsBody = document.getElementById("rows-body");
  const workArea = document.getElementById("work-area");
  const chosenNameEl = document.getElementById("chosen-service-name");
  const profitPctEl = document.getElementById("profit-pct");

  // ---- Cart + persistence ----
  const CART_KEY = "nndata_cart_v1";
  const cart = [];

  function money(n) { return Number(n || 0).toFixed(2); }

  function loadCart() {
    try {
      const saved = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
      if (Array.isArray(saved)) {
        cart.splice(0, cart.length, ...saved);
      }
    } catch { /* ignore */ }
  }

  function saveCart() {
    try {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    } catch { /* ignore */ }
  }

function formatVolumeLabel(value) {
  if (value && typeof value === "string") return value;
  if (value && typeof value === "object") {
    const vol = Number(value.volume || 0);
    // Only show size (GB or MB), no package id
    return vol >= 1000
      ? `${(vol / 1000).toString().replace(/\.0+$/, '')}GB`
      : `${vol}MB`;
  }
  return "-";
}


  /**
   * We expect offers shaped like: { amount, total, profit_percent_used, value, value_text }
   * - "total" is what the customer pays (amount + %)
   * - "amount" is the base amount (for reference)
   */
  function renderOfferOptions(offers = []) {
    return `
      <option value="">-- Choose Offer --</option>
      ${offers.map((o, idx) => {
        const label = o.value_text ? o.value_text : formatVolumeLabel(o.value);
        const disabled = (o.amount == null || o.total == null) ? "disabled" : "";
        const tip = (o.amount != null && o.profit_percent_used != null)
          ? `Base GHS ${money(o.amount)} + ${o.profit_percent_used}%`
          : "";
        return `<option ${disabled}
                  value="${o.total}"
                  data-base="${o.amount ?? ''}"
                  data-total="${o.total ?? ''}"
                  data-pp="${o.profit_percent_used ?? ''}"
                  data-idx="${idx}"
                  title="${tip}">
                  GHS ${money(o.total ?? 0)} — ${label}
                </option>`;
      }).join("")}
    `;
  }

  function addRow(phone = "", selectedIdx = null) {
    const row = document.createElement("div");
    row.className = "col-12";
    row.innerHTML = `
      <div class="card border rounded-3 p-3 shadow-sm mb-2">
        <div class="row g-3 align-items-center">
          <div class="col-12 col-md-5">
            <input type="text" class="form-control phone-input" placeholder="Phone number" value="${phone}">
          </div>
          <div class="col-12 col-md-5">
            <select class="form-select offer-select">
              ${chosenService ? renderOfferOptions(chosenService.offers) : '<option>-- Choose Offer --</option>'}
            </select>
          </div>
          <div class="col-12 col-md-2 d-flex justify-content-between align-items-center">
            <div class="amount-cell fw-semibold text-primary">-</div>
            <button class="btn btn-sm btn-outline-danger remove-row-btn"><i class="bi bi-x-lg"></i></button>
          </div>
        </div>
      </div>
    `;
    rowsBody.appendChild(row);

    const sel = row.querySelector(".offer-select");
    const amtCell = row.querySelector(".amount-cell");
    sel.addEventListener("change", () => {
  amtCell.textContent = "";
});


    if (selectedIdx !== null) {
      const found = sel.querySelector(`option[data-idx="${selectedIdx}"]`);
      if (found) { sel.value = found.value; sel.dispatchEvent(new Event("change")); }
    }
  }

  function clearRows() { rowsBody.innerHTML = ""; }

  function updateCartUI() {
    const list = document.getElementById("cart-list");
    const count = document.getElementById("cart-count");
    const empty = document.getElementById("cart-empty");
    const wrap = document.getElementById("cart-list-wrapper");
    const totalEl = document.getElementById("cart-total");

    list.innerHTML = "";
    let total = 0;
    cart.forEach((item, idx) => {
      total += Number(item.amount || 0); // amount == total charged per line
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.serviceName}</td>
        <td>${item.phone}</td>
        <td>${item.value}</td>
        <td>GHS ${money(item.amount)}</td>
        <td><button class="btn btn-sm btn-outline-danger" data-remove="${idx}">Remove</button></td>
      `;
      list.appendChild(tr);
    });

    count.textContent = cart.length;
    totalEl.textContent = money(total);
    empty.classList.toggle("d-none", cart.length !== 0);
    wrap.classList.toggle("d-none", cart.length === 0);

    // persist after every UI refresh
    saveCart();
  }

  function addAllRowsToCart() {
    const rows = Array.from(rowsBody.querySelectorAll(".card"));
    if (rows.length === 0) { alert("Add at least one row."); return; }

    const bad = [];
    rows.forEach((row, i) => {
      const phone = row.querySelector(".phone-input").value.trim();
      const sel = row.querySelector(".offer-select");
      const opt = sel?.selectedOptions?.[0];

      if (!phone || phone.length < 9 || !opt || !sel.value) { bad.push(i + 1); return; }

      const valueDisplay = opt.textContent.replace(/^.*—\s*/, "") || "-";
      const total = Number(opt.getAttribute("data-total") || sel.value || 0);
      const base  = Number(opt.getAttribute("data-base") || 0);
      const pp    = Number(opt.getAttribute("data-pp") || 0);

      // map selected option to original offer to keep raw value object for backend
      const idx = Number(opt.getAttribute("data-idx"));
      const offer = Array.isArray(chosenService.offers) ? chosenService.offers[idx] : null;
      const valueObj = offer && offer.value ? offer.value : null;

      cart.push({
        serviceId: chosenService._id_str,
        serviceName: chosenService.name,
        phone,
        value: valueDisplay,   // for UI
        value_obj: valueObj,   // for backend (e.g., {id, volume})
        base_amount: base,
        profit_percent_used: pp,
        // IMPORTANT: backend expects "amount"
        amount: total,         // what we charge
        total                  // kept for readability; amount === total
      });
    });

    if (bad.length) alert("Some rows were incomplete: " + bad.join(", "));
    updateCartUI();
    clearRows();
    addRow();
  }

  function parseGBFromValue(value) {
    if (value && typeof value === "object" && value.volume != null) {
      const vol = Number(value.volume);
      return vol / 1000; // MB -> GB
    }
    const m = String(value || "").match(/(\d+(?:\.\d+)?)/);
    return m ? Number(m[1]) : null;
  }

  // Returns the offer index (to map to option[data-idx])
  function findOfferIndexByGB(offers, gbNumber) {
    const candidates = (offers || [])
      .map((o, idx) => ({ idx, gb: parseGBFromValue(o.value), o }))
      .filter(x => x.gb !== null && Number(x.gb) === Number(gbNumber));
    if (!candidates.length) return null;
    candidates.sort((a, b) => (a.o.total ?? a.o.amount ?? 0) - (b.o.total ?? b.o.amount ?? 0));
    return candidates[0].idx;
  }

  // Service selection
  document.querySelectorAll(".select-service-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      chosenService = JSON.parse(btn.getAttribute("data-service"));
      chosenNameEl.textContent = chosenService.name;
      profitPctEl.textContent = (chosenService.effective_profit_percent ?? 0).toFixed(2);
      workArea.classList.remove("d-none");
      clearRows(); addRow();
      document.getElementById("bulk-card").classList.add("d-none");
      document.getElementById("bulk-trigger").value = "";
      setTimeout(() => rowsBody.querySelector(".phone-input")?.focus(), 50);
    });
  });

  // Row actions
  rowsBody.addEventListener("click", (e) => {
    if (e.target.closest(".remove-row-btn")) e.target.closest(".col-12").remove();
  });
  // (bug fix) optional chaining so missing button doesn't break script
  document.getElementById("clear-rows-btn")?.addEventListener("click", clearRows);

  // Bulk paste
  (function wireBulk() {
    const bulkTrigger = document.getElementById("bulk-trigger");
    const bulkCard = document.getElementById("bulk-card");
    const hideBulkBtn = document.getElementById("hide-bulk-btn");
    function showBulk() { bulkCard.classList.remove("d-none"); setTimeout(() => document.getElementById("bulk-paste").focus(), 0); }
    function hideBulk() { bulkCard.classList.add("d-none"); }
    bulkTrigger.addEventListener("focus", showBulk);
    bulkTrigger.addEventListener("click", showBulk);
    hideBulkBtn.addEventListener("click", hideBulk);

    document.getElementById("apply-bulk-btn").addEventListener("click", () => {
      if (!chosenService) { alert("Choose a service first."); return; }
      const lines = document.getElementById("bulk-paste").value.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!lines.length) { alert("Nothing to paste."); return; }
      let needed = lines.length - rowsBody.querySelectorAll(".card").length;
      while (needed-- > 0) addRow();
      const rows = Array.from(rowsBody.querySelectorAll(".card"));
      lines.forEach((line, i) => {
        const parts = line.split(/[\s,;\t]+/).filter(Boolean);
        const phone = parts[0] || "";
        const gbNum = parts[1] ? Number(parts[1]) : null;
        const row = rows[i]; if (!row) return;
        const phoneInput = row.querySelector(".phone-input");
        const sel = row.querySelector(".offer-select");
        phoneInput.value = phone;

        if (gbNum !== null) {
          const idx = findOfferIndexByGB(chosenService.offers, gbNum);
          if (idx !== null) {
            const opt = sel.querySelector(`option[data-idx="${idx}"]`);
            if (opt) sel.value = opt.value;
          }
        }
        sel.dispatchEvent(new Event("change"));
      });
    });
  })();

  // Add all rows to cart
  document.getElementById("add-all-to-cart").addEventListener("click", addAllRowsToCart);

  // Cart interactions
  document.getElementById("cartModal").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-remove]");
    if (!btn) return;
    const idx = Number(btn.getAttribute("data-remove"));
    if (!Number.isNaN(idx)) {
      cart.splice(idx, 1);
      updateCartUI();
    }
  });

  // Clear cart (user-triggered)
  document.getElementById("clear-cart-btn").addEventListener("click", () => {
    if (!cart.length) return;
    if (confirm("Clear all items in the cart?")) {
      cart.length = 0;
      updateCartUI(); // also persists
    }
  });

  // Proceed to checkout
  document.getElementById("checkout-btn").addEventListener("click", () => {
    if (!cart.length) { alert("Your cart is empty."); return; }
    const section = document.getElementById("checkout-section");
    const total = document.getElementById("cart-total").textContent;
    document.getElementById("checkout-total").textContent = total;
    section.classList.remove("d-none");
    setTimeout(() => section.scrollIntoView({ behavior: "smooth" }), 100);
  });

  // --- Loading helpers ---
  const pageLoader = document.getElementById("page-loader");
  const confirmBtn = document.getElementById("confirm-payment-btn");
  function setProcessing(on) {
    pageLoader.classList.toggle("d-none", !on);
    const spinner = confirmBtn.querySelector(".spinner-border");
    const label = confirmBtn.querySelector(".btn-label");
    confirmBtn.disabled = on;
    spinner.classList.toggle("d-none", !on);
    label.textContent = on ? "Processing…" : "✅ Confirm Payment";
    document.querySelectorAll("#checkout-section input, #checkout-section select, #checkout-section button:not(#confirm-payment-btn)")
      .forEach(el => el.disabled = on);
  }

  // Confirm payment (with loader)
  document.getElementById("confirm-payment-btn").addEventListener("click", async () => {
    const method = document.getElementById("payment-method").value;
    const total = document.getElementById("checkout-total").textContent;

    const { isConfirmed } = await Swal.fire({
      title: "Confirm payment?",
      html: `You're about to pay <b>GHS ${total}</b> from your wallet.`,
      icon: "question",
      showCancelButton: true,
      confirmButtonText: "Yes, Pay",
      cancelButtonText: "Cancel",
      confirmButtonColor: "#0ea5e9"
    });
    if (!isConfirmed) return;

    setProcessing(true);

    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 60000);

    try {
      const response = await fetch("/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cart, method }),
        signal: controller.signal
      });
      clearTimeout(timer);

      const result = await response.json().catch(() => ({}));

      if (response.ok && result.success) {
        Swal.fire({ title: "✅ Success!", text: result.message || "Payment completed.", icon: "success" });
        // Clear cart ONLY on successful payment
        cart.length = 0;
        localStorage.removeItem(CART_KEY);
        updateCartUI();
        document.getElementById("checkout-section").classList.add("d-none");
        const modal = bootstrap.Modal.getInstance(document.getElementById("cartModal"));
        modal?.hide();
      } else {
        Swal.fire({ title: "❌ Failed", text: result.message || "Payment failed. Please try again.", icon: "error" });
      }
    } catch (err) {
      const msg = err.name === "AbortError"
        ? "The request took too long and was cancelled. Please check your network and try again."
        : "Something went wrong while processing payment.";
      Swal.fire({ title: "❌ Error", text: msg, icon: "error" });
    } finally {
      setProcessing(false);
    }
  });

  // Quick add on Enter in bulk trigger + (optional) Add Row button if present
  document.getElementById("add-row-btn")?.addEventListener("click", () => addRow());
  document.getElementById("bulk-trigger")?.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); addRow(); }
  });

  // ---- Init: restore cart from localStorage and render ----
  loadCart();
  updateCartUI();
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const serviceButtons = document.querySelectorAll(".select-service-btn");
  const workArea = document.getElementById("work-area");
  const chosenNameEl = document.getElementById("chosen-service-name");
  const profitPctEl = document.getElementById("profit-pct");

  serviceButtons.forEach(btn => {
    btn.addEventListener("click", function () {
      const svcData = JSON.parse(this.getAttribute("data-service"));
      
      // Set service name and profit
      chosenNameEl.textContent = svcData.name;
      profitPctEl.textContent = svcData.effective_profit_percent || 0;

      // Show work area if hidden
      workArea.classList.remove("d-none");

      // Smooth scroll to work area
      workArea.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  });
});
</script>

</body>
</html>
